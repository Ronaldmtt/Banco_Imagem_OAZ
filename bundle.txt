================================================================================
BUNDLE DO SISTEMA
================================================================================

Gerado em: 2026-01-05 11:39:01

ARQUIVOS INCLUIDOS:
================================================================================
001. .env.example (2 linhas)
002. .gitignore (53 linhas)
003. .replit (44 linhas)
004. MAPEAMENTO_ARQUIVOS.md (211 linhas)
005. README.md (53 linhas)
006. TUTORIAL_COMPLETO.md (527 linhas)
007. app.py (5335 linhas)
008. attached_assets/Pasted--2025-12-15-11-43-14-90-2fc88dfb-User-2025-12-15-14-43-_1765809821848.txt (160 linhas)
009. attached_assets/Pasted--fd-os-open-file-flags-0o600-OSError-Errno-122--1765494_1765494027393.txt (322 linhas)
010. attached_assets/Pasted-Comportamento-esperado-Recebe-um-DataFrame-lido-do-Exce_1764700901446.txt (166 linhas)
011. attached_assets/Pasted-Quero-que-voc-leia-o-c-digo-TODO-do-projeto-e-fa-a-as-s_1764700832050.txt (88 linhas)
012. attached_assets/Pasted-Sistema-de-Tutorial-Din-mico-Encapsulado-Objetivo-Criar_1765820177536.txt (246 linhas)
013. attached_assets/image_1764688431490.png (0 linhas)
014. attached_assets/image_1765222618160.png (0 linhas)
015. attached_assets/image_1765223269842.png (0 linhas)
016. attached_assets/image_1765388486682.png (0 linhas)
017. attached_assets/image_1765393861939.png (0 linhas)
018. attached_assets/image_1765393862388.png (0 linhas)
019. attached_assets/image_1765404585125.png (0 linhas)
020. attached_assets/image_1765404586694.png (0 linhas)
021. batch_processor.py (1084 linhas)
022. libs/rpa_monitor_client/.vs/ProjectSettings.json (3 linhas)
023. libs/rpa_monitor_client/.vs/VSWorkspaceState.json (9 linhas)
024. libs/rpa_monitor_client/.vs/rpa_monitor_client/v17/DocumentLayout.backup.json (98 linhas)
025. libs/rpa_monitor_client/.vs/rpa_monitor_client/v17/DocumentLayout.json (97 linhas)
026. libs/rpa_monitor_client/README.md (43 linhas)
027. libs/rpa_monitor_client/pyproject.toml (27 linhas)
028. libs/rpa_monitor_client/rpa_monitor_client/__init__.py (93 linhas)
029. libs/rpa_monitor_client/rpa_monitor_client/_client.py (508 linhas)
030. libs/rpa_monitor_client/rpa_monitor_client/_config.py (67 linhas)
031. libs/rpa_monitor_client/rpa_monitor_client/_logging_api.py (111 linhas)
032. oaz_logger.py (479 linhas)
033. object_storage.py (244 linhas)
034. replit.md (97 linhas)
035. requirements.txt (17 linhas)
036. reset_admin.py (23 linhas)
037. static/css/style.css (597 linhas)
038. static/js/tutorial.js (262 linhas)
039. templates/admin/settings.html (36 linhas)
040. templates/analytics/index.html (166 linhas)
041. templates/auditoria/historico_sku.html (74 linhas)
042. templates/auditoria/index.html (236 linhas)
043. templates/auditoria/skus_pendentes.html (73 linhas)
044. templates/auth/login.html (55 linhas)
045. templates/auth/register.html (58 linhas)
046. templates/base.html (168 linhas)
047. templates/batch/analyze_pending.html (226 linhas)
048. templates/batch/detail.html (524 linhas)
049. templates/batch/index.html (256 linhas)
050. templates/batch/new.html (743 linhas)
051. templates/batch/queue.html (784 linhas)
052. templates/brands/list.html (53 linhas)
053. templates/brands/new.html (32 linhas)
054. templates/carteira/importar.html (345 linhas)
055. templates/carteira/list.html (253 linhas)
056. templates/collections/detail.html (249 linhas)
057. templates/collections/edit.html (87 linhas)
058. templates/collections/list.html (149 linhas)
059. templates/collections/new.html (61 linhas)
060. templates/dashboard/index.html (185 linhas)
061. templates/images/catalog.html (987 linhas)
062. templates/images/detail.html (508 linhas)
063. templates/images/edit.html (112 linhas)
064. templates/images/upload.html (123 linhas)
065. templates/integrations/index.html (217 linhas)
066. templates/produtos/edit.html (193 linhas)
067. templates/produtos/list.html (220 linhas)
068. templates/produtos/new.html (76 linhas)
069. templates/reports/index.html (235 linhas)
070. templates/reports/skus_sem_foto.html (142 linhas)
071. templates/subcolecoes/edit.html (93 linhas)
072. templates/subcolecoes/list.html (85 linhas)
073. templates/subcolecoes/new.html (83 linhas)
074. test_login.py (12 linhas)
075. upload_orchestrator.py (647 linhas)

================================================================================
FILE: .env.example
================================================================================
GOOGLE_API_KEY=your_api_key_here

================================================================================
FILE: .gitignore
================================================================================
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
pip-wheel-metadata/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# Virtual Environment
venv/
ENV/
env/
.venv

# Flask
instance/
.webassets-cache

# Environment variables
.env
.flaskenv

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Logs
*.log

================================================================================
FILE: .replit
================================================================================
modules = ["web", "python-3.11", "postgresql-16"]
[agent]
expertMode = true
integrations = ["python_openai_ai_integrations:1.0.0"]

[nix]
channel = "stable-25_05"
packages = ["freetype", "glibcLocales", "lcms2", "libimagequant", "libjpeg", "libtiff", "libwebp", "libxcrypt", "openjpeg", "sqlite", "tcl", "tk", "zlib", "openssh_gssapi"]

[[ports]]
localPort = 5000
externalPort = 80

[workflows]
runButton = "Project"

[[workflows.workflow]]
name = "Project"
mode = "parallel"
author = "agent"

[[workflows.workflow.tasks]]
task = "workflow.run"
args = "Flask App"

[[workflows.workflow]]
name = "Flask App"
author = "agent"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python app.py"
waitForPort = 5000

[workflows.workflow.metadata]
outputType = "webview"

[deployment]
deploymentTarget = "autoscale"
run = ["python", "app.py"]

[objectStorage]
defaultBucketID = "replit-objstore-ad1ef735-1be2-430d-b333-ddfbce1cdf05"

================================================================================
FILE: MAPEAMENTO_ARQUIVOS.md
================================================================================
# Mapeamento dos Arquivos de Importa√ß√£o

## Resumo dos Arquivos Recebidos

| Arquivo | Descri√ß√£o | Total de SKUs |
|---------|-----------|---------------|
| Rela√ß√£oSKUsHOMESOUQVERAO.xlsx | SKUs de HOME Ver√£o 24-25 | 274 |
| Rela√ß√£oSKUsSOUQFotografadosMODA.xlsx | SKUs Moda Fotografados | 404 (288 Ver√£o + 116 Alto Ver√£o) |
| CARTEIRA_INVERNO_26_-_IMAGEM.xlsx | Carteira Completa Inverno 26 | 344 (289 Roupas + 48 Home + 7 Acess√≥rios) |
| Rela√ß√£oFotosAcessVer√£o.xlsx | Fotos Acess√≥rios Ver√£o | 298 |

**Total Geral: 1.320 registros**

---

## Estrutura Detalhada por Arquivo

### 1. Rela√ß√£oSKUsHOMESOUQVERAO.xlsx

**Prop√≥sito:** Lista de SKUs de produtos HOME que precisam de foto para a cole√ß√£o Ver√£o 24-25

| Aba | Conte√∫do |
|-----|----------|
| VER√ÉO | Lista simples de SKUs |

**Formato do SKU:** `XX.XX.XX.XXX.XXX` (ex: 01.03.25.346.011)

**Colunas:**
- Coluna √∫nica com SKUs

**Prefixos identificados:**
- `01.XX` = Produtos HOME

---

### 2. Rela√ß√£oSKUsSOUQFotografadosMODA.xlsx

**Prop√≥sito:** SKUs de moda que j√° foram fotografados

| Aba | Conte√∫do | Registros |
|-----|----------|-----------|
| VER√ÉO | SKUs fotografados Ver√£o 24-25 | 288 |
| Consulta | Metadados de arquivos de foto | 116 |
| ALTO VER√ÉO | SKUs fotografados Alto Ver√£o | 116 |

**Formato do SKU:** `XX.XX.XX.XXX.XXX` (ex: 04.23.02.581.007)

**Prefixos identificados:**
- `04.23.XX` = SOUQ Moda
- `04.26.XX` = SOUQ Moda (variante)

**Aba "Consulta" cont√©m:**
- Nome do arquivo da foto
- Data de acesso/modifica√ß√£o/cria√ß√£o
- Caminho da pasta

---

### 3. CARTEIRA_INVERNO_26_-_IMAGEM.xlsx (PRINCIPAL)

**Prop√≥sito:** Carteira de compras completa do Inverno 2026 com todos os metadados

| Aba | Conte√∫do | Registros |
|-----|----------|-----------|
| ROUPAS | Roupas Inverno 26 | 289 |
| HOME | Produtos Home Inverno 26 | 48 |
| ACESS√ìRIOS | Acess√≥rios Inverno 26 | 7 |

**Formato do SKU:** `XX.XX.XX.XXXX.XXX` (ex: 04.23.02.0001.053)

#### Colunas Detalhadas:

| Coluna | Tipo | Descri√ß√£o | Exemplo |
|--------|------|-----------|---------|
| REFER√äNCIA E COR | Texto | SKU completo do produto | 04.23.02.0001.053 |
| NOME | Texto | Nome do produto | BLUSA LOLA BLACK |
| NOME / COR | Texto | Cor/Estampa | LISTRADO, ESTAMPADO |
| GRUPO | Texto | Categoria principal | MALHA, TECIDO, BIJOUX |
| SUBGRUPO | Texto | Subcategoria | BLUSA, CAL√áA, VESTIDO, PULSEIRA |
| ENTRADA | Texto | Cole√ß√£o/Temporada | INVERNO 2026 |
| ESTILISTA | Texto | Respons√°vel pelo produto | 28 THAIS CAMPIONE... |
| FOTO | Texto | Status da foto | SIM, N√ÉO, SIM - MIGRADO |
| QUANDO | Texto | Shooting planejado | SHOOTING INVERNO 26 |
| OKR | Texto | Aprova√ß√£o | OK |
| OBS | Texto | Observa√ß√µes | Notas diversas |
| NACIONAL / IMPORTADO | Texto | Origem | NACIONAL, IMPORTADO |

---

### 4. Rela√ß√£oFotosAcessVer√£o.xlsx

**Prop√≥sito:** Lista de SKUs de acess√≥rios com foto para Ver√£o 24/25

| Aba | Conte√∫do |
|-----|----------|
| VER√ÉO | Lista de SKUs de acess√≥rios |

**Formato do SKU:** `XX.XX.XX.XXX.XXX` (ex: 02.16.03.205.035)

**Prefixos identificados:**
- `02.09.XX` = Bijoux
- `02.12.XX` = Bolsas
- `02.16.XX` = Outros acess√≥rios

---

## Decodifica√ß√£o do Formato de SKU

O SKU segue o padr√£o: `GG.SS.TT.RRRR.CCC`

| Posi√ß√£o | Significado | Exemplos |
|---------|-------------|----------|
| GG | Grupo/Divis√£o | 01=HOME, 02=Acess√≥rios, 04=Moda |
| SS | Subgrupo | 23=SOUQ, 26=Variante |
| TT | Tipo | 02=Blusa, 03=Cal√ßa, etc |
| RRRR | Refer√™ncia | N√∫mero sequencial |
| CCC | Cor | 053=Listrado, 054=Estampado |

---

## Mapeamento para o Sistema OAZ

### Campos da Carteira de Compras

| Campo Excel | Campo Sistema | Tipo |
|-------------|--------------|------|
| REFER√äNCIA E COR | sku | String |
| NOME | descricao | String |
| NOME / COR | cor | String |
| GRUPO | categoria | String |
| SUBGRUPO | subcategoria | String |
| ENTRADA | colecao | String |
| ESTILISTA | estilista | String |
| FOTO | status_foto | String (Com Foto/Sem Foto/Pendente) |
| QUANDO | shooting | String |
| OBS | observacoes | String |
| NACIONAL / IMPORTADO | origem | String |

### Regras de Importa√ß√£o

1. **Status da Foto:**
   - "SIM" ‚Üí "Com Foto"
   - "N√ÉO" ou vazio ‚Üí "Sem Foto"
   - "SIM - MIGRADO" ‚Üí "Com Foto"

2. **SKU:**
   - Remover espa√ßos extras
   - Normalizar formato (remover .00 final se existir)

3. **Valida√ß√£o:**
   - SKU √© obrigat√≥rio
   - Ignorar linhas com SKU vazio

---

## Arquivos para Importa√ß√£o Recomendada

### Ordem de Importa√ß√£o:

1. **CARTEIRA_INVERNO_26** (Primeiro - √© a carteira principal)
   - Importar aba ROUPAS
   - Importar aba HOME
   - Importar aba ACESS√ìRIOS

2. **Rela√ß√µes de SKUs** (Segundo - para cruzar com fotos existentes)
   - Rela√ß√£oSKUsHOMESOUQVERAO
   - Rela√ß√£oSKUsSOUQFotografadosMODA
   - Rela√ß√£oFotosAcessVer√£o

### Fluxo de Trabalho:

```
1. Importar Carteira Inverno 26 (todos os SKUs planejados)
       ‚Üì
2. Cruzar com SKUs Fotografados (atualizar status_foto)
       ‚Üì
3. Gerar relat√≥rio de diverg√™ncias
       ‚Üì
4. Identificar SKUs pendentes de foto
```

---

## Exemplo de Dados para Teste

### Amostra da Carteira (ROUPAS):

| SKU | Nome | Cor | Grupo | Subgrupo | Entrada |
|-----|------|-----|-------|----------|---------|
| 04.23.02.0001.053 | BLUSA LOLA BLACK | LISTRADO | MALHA | BLUSA | INVERNO 2026 |
| 04.23.02.0002.053 | BLUSA LOLA MARINE | LISTRADO | MALHA | BLUSA | INVERNO 2026 |
| 04.23.02.0003.054 | BLUSA DIARA BOTARA | ESTAMPADO | MALHA | BLUSA | INVERNO 2026 |

### Amostra da Carteira (ACESS√ìRIOS):

| SKU | Nome | Cor | Grupo | Subgrupo |
|-----|------|-----|-------|----------|
| 02.09.05.780.011.00 | PULSEIRA IMANI | DOURADO | BIJOUX | PULSEIRA |
| 02.09.05.781.011.00 | PULSEIRA SUKI | DOURADO | BIJOUX | PULSEIRA |
| 02.09.06.191.018.00 | COLAR MAKENA | PRATA ENVELHECIDA | BIJOUX | COLAR |

---

## Pr√≥ximos Passos

1. Atualizar o sistema para aceitar arquivos .xlsx
2. Adicionar novos campos ao modelo CarteiraCompras
3. Criar tela de importa√ß√£o com sele√ß√£o de aba
4. Implementar valida√ß√£o de formato de SKU
5. Criar relat√≥rio de cruzamento entre carteira e fotos

================================================================================
FILE: README.md
================================================================================
# OAZ Smart Image Bank

## Overview
Sistema inteligente de gerenciamento de banco de imagens para varejo de moda. Suporta cataloga√ß√£o de at√© 1 milh√£o de imagens com processamento paralelo, integra√ß√£o com Carteira de Compras e an√°lise via IA como fallback.

## Features
- **User Management**: Login e registro seguros
- **Dashboard**: Vis√£o geral com estat√≠sticas e gr√°ficos
- **Image Catalog**: Cat√°logo em grid com filtros avan√ßados
- **Smart Upload**: Interface drag & drop com extra√ß√£o de metadados
- **Batch Upload**: Upload em lote com processamento paralelo (5 workers)
- **Carteira de Compras**: Importa√ß√£o de Excel/CSV com auto-cria√ß√£o de entidades
- **SKU Matching**: Match autom√°tico entre imagens e Carteira de Compras
- **Produtos**: Cadastro completo de produtos com hist√≥rico de SKU
- **Auditoria**: Relat√≥rios de cruzamento e diverg√™ncias
- **Premium UI**: Dark mode com efeitos glassmorphism

## Setup

1. **Install Dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

2. **Run the Application**:
   ```bash
   python app.py
   ```
   The app will run on `http://0.0.0.0:5000`.

3. **Login**:
   - **Username**: `admin`
   - **Password**: `admin`
   (Or register a new account)

## Project Structure
- `app.py`: Main application logic and database models
- `batch_processor.py`: Parallel batch processing engine
- `object_storage.py`: Replit Object Storage integration
- `templates/`: HTML templates
- `static/`: CSS, JS, and legacy uploaded images

## Technologies
- Flask (Python 3.11)
- PostgreSQL (Neon-backed via Replit)
- SQLAlchemy ORM
- Replit Object Storage
- Chart.js
- Vanilla CSS (Custom Design System)

## Database
O sistema utiliza PostgreSQL (Replit Database) para armazenamento persistente. A conex√£o √© configurada automaticamente via vari√°vel de ambiente `DATABASE_URL`.

================================================================================
FILE: TUTORIAL_COMPLETO.md
================================================================================
# Tutorial Completo - OAZ Smart Image Bank

## Guia Passo a Passo para Testar Todas as Funcionalidades

---

## ANTES DE COME√áAR

### Credenciais de Acesso
- **Usu√°rio:** admin
- **Senha:** admin

### Requisitos para An√°lise IA
Para usar a an√°lise autom√°tica de imagens, voc√™ precisa de uma chave de API da OpenAI. Sem ela, as imagens ser√£o salvas mas sem an√°lise autom√°tica.

---

## PARTE 1: LOGIN E PRIMEIRO ACESSO

### Passo 1.1 - Acessar o Sistema
1. Abra o aplicativo (clique em "Open website" ou acesse a URL do projeto)
2. Voc√™ ver√° a tela de login

### Passo 1.2 - Fazer Login
1. No campo **Usu√°rio**, digite: `admin`
2. No campo **Senha**, digite: `admin`
3. Clique no bot√£o **Entrar**
4. Voc√™ ser√° redirecionado para o **Painel Principal (Dashboard)**

---

## PARTE 2: CONHECENDO O PAINEL PRINCIPAL

### O que voc√™ ver√° no Dashboard:
- **Estat√≠sticas gerais:** Total de imagens, aprovadas, pendentes, rejeitadas
- **Imagens recentes:** Miniaturas das √∫ltimas imagens cadastradas
- **Atividade recente:** Log das √∫ltimas a√ß√µes no sistema

### Navega√ß√£o pela Sidebar (Menu Lateral):
A barra lateral cont√©m todos os m√≥dulos do sistema:

| √çcone | Menu | Fun√ß√£o |
|-------|------|--------|
| üìä | Painel | Dashboard com estat√≠sticas |
| üñºÔ∏è | Biblioteca | Cat√°logo de todas as imagens |
| ‚¨ÜÔ∏è | Upload | Enviar novas imagens |
| üè∑Ô∏è | Cole√ß√µes | Gerenciar cole√ß√µes |
| üè¢ | Marcas | Gerenciar marcas |
| üì¶ | Produtos | Cadastro de produtos (SKU) |
| üõí | Carteira | Carteira de compras |
| üîç | Auditoria | Relat√≥rios de auditoria |
| üìà | Relat√≥rios | M√©tricas e exporta√ß√µes |
| ‚öôÔ∏è | Configura√ß√µes | API Key e configura√ß√µes |

---

## PARTE 3: CONFIGURAR API OPENAI (OPCIONAL, MAS RECOMENDADO)

### Passo 3.1 - Acessar Configura√ß√µes
1. No menu lateral, clique em **Configura√ß√µes** (√≠cone de engrenagem)

### Passo 3.2 - Inserir Chave API
1. No campo **Chave da API OpenAI**, cole sua chave (come√ßa com `sk-...`)
2. Clique em **Salvar Configura√ß√µes**
3. Uma mensagem de sucesso aparecer√°

> **Nota:** Sem a chave, o upload de imagens funcionar√°, mas n√£o ter√° an√°lise autom√°tica de IA.

---

## PARTE 4: CRIAR MARCAS

### Por que criar marcas primeiro?
As marcas s√£o usadas para categorizar imagens e produtos. Crie-as antes de fazer uploads.

### Passo 4.1 - Acessar Marcas
1. No menu lateral, clique em **Marcas**

### Passo 4.2 - Criar Nova Marca
1. Clique no bot√£o **+ Nova Marca** (canto superior direito)
2. Preencha os campos:
   - **Nome:** Ex: `OAZ Fashion`
   - **Descri√ß√£o:** Ex: `Marca principal de moda feminina`
3. Clique em **Salvar**

### Sugest√£o de Marcas para Teste:
| Nome | Descri√ß√£o |
|------|-----------|
| OAZ Fashion | Marca principal de moda feminina |
| OAZ Premium | Linha premium e luxo |
| OAZ Basic | Linha b√°sica e casual |

### Passo 4.3 - Editar/Excluir Marca
- Para **editar**: clique no √≠cone de l√°pis ao lado da marca
- Para **excluir**: clique no √≠cone de lixeira (s√≥ funciona se n√£o houver produtos vinculados)

---

## PARTE 5: CRIAR COLE√á√ïES

### Por que criar cole√ß√µes?
Cole√ß√µes organizam as imagens por temporada, campanha ou tema.

### Passo 5.1 - Acessar Cole√ß√µes
1. No menu lateral, clique em **Cole√ß√µes**

### Passo 5.2 - Criar Nova Cole√ß√£o
1. Clique no bot√£o **+ Nova Cole√ß√£o**
2. Preencha os campos:
   - **Nome:** Ex: `Ver√£o 2025`
   - **Ano:** Ex: `2025`
   - **Esta√ß√£o:** Selecione uma op√ß√£o (Primavera/Ver√£o, Outono/Inverno, etc.)
   - **Campanha:** Ex: `Lan√ßamento Ver√£o`
   - **Descri√ß√£o:** Ex: `Cole√ß√£o de ver√£o com pe√ßas leves e coloridas`
3. Clique em **Salvar**

### Sugest√£o de Cole√ß√µes para Teste:
| Nome | Ano | Esta√ß√£o | Campanha |
|------|-----|---------|----------|
| Ver√£o 2025 | 2025 | Primavera/Ver√£o | Lan√ßamento Ver√£o |
| Inverno 2025 | 2025 | Outono/Inverno | Alto Inverno |
| Basics 2025 | 2025 | Atemporal | Cole√ß√£o Permanente |

---

## PARTE 6: UPLOAD DE IMAGENS

### Passo 6.1 - Acessar Upload
1. No menu lateral, clique em **Upload**

### Passo 6.2 - Selecionar Imagem
1. Clique na √°rea de upload (ret√¢ngulo com linha pontilhada)
2. OU arraste uma imagem para a √°rea
3. Formatos aceitos: **PNG, JPG, JPEG, GIF**
4. A pr√©via da imagem aparecer√°

### Passo 6.3 - Preencher Metadados
Antes de enviar, preencha os campos opcionais:
- **Cole√ß√£o:** Selecione uma cole√ß√£o criada anteriormente
- **Marca:** Selecione uma marca
- **Fot√≥grafo:** Ex: `Jo√£o Silva`
- **Data do Shooting:** Selecione a data da sess√£o de fotos

### Passo 6.4 - Enviar
1. Clique no bot√£o **Enviar Imagem**
2. Aguarde o processamento (pode levar alguns segundos se a IA estiver ativa)
3. Voc√™ ser√° redirecionado para a p√°gina de detalhes da imagem

### O que a IA analisa automaticamente:
- Tipo de pe√ßa (vestido, blusa, cal√ßa, etc.)
- Cores predominantes
- Material/tecido
- Padr√µes e estampas
- Estilo (casual, formal, esportivo)
- Tags para SEO
- Descri√ß√£o detalhada em portugu√™s

---

## PARTE 7: CAT√ÅLOGO DE IMAGENS (BIBLIOTECA)

### Passo 7.1 - Acessar Biblioteca
1. No menu lateral, clique em **Biblioteca** (ou Biblioteca de Imagens)

### Passo 7.2 - Visualizar Imagens
- Voc√™ ver√° um grid com todas as imagens cadastradas
- Cada card mostra: miniatura, SKU, status (Pendente/Aprovado/Rejeitado)

### Passo 7.3 - Usar Filtros
Na barra superior, voc√™ pode filtrar por:
- **Busca:** Digite parte do SKU ou descri√ß√£o
- **Status:** Todos, Pendente, Aprovado, Rejeitado
- **Cole√ß√£o:** Selecione uma cole√ß√£o espec√≠fica
- **Marca:** Selecione uma marca espec√≠fica

Clique em **Filtrar** para aplicar.

### Passo 7.4 - Ver Detalhes
1. Clique em qualquer imagem
2. Voc√™ ver√° a p√°gina de detalhes com:
   - Imagem em tamanho maior
   - Todas as informa√ß√µes extra√≠das pela IA
   - Pe√ßas detectadas (se houver m√∫ltiplas)
   - Bot√µes de a√ß√£o

### Passo 7.5 - Aprovar ou Rejeitar Imagem
Na p√°gina de detalhes:
1. Para **aprovar**: clique no bot√£o verde **Aprovar**
2. Para **rejeitar**: clique no bot√£o vermelho **Rejeitar**
3. O status mudar√° automaticamente

### Passo 7.6 - Re-analisar com IA
Se quiser uma nova an√°lise:
1. Na p√°gina de detalhes, clique em **Re-analisar com IA**
2. Aguarde o processamento
3. Os dados ser√£o atualizados

---

## PARTE 8: EDITAR IMAGEM

### Passo 8.1 - Acessar Edi√ß√£o
1. Na p√°gina de detalhes da imagem, clique em **Editar**
2. OU na biblioteca, clique no √≠cone de l√°pis da imagem

### Passo 8.2 - Campos Edit√°veis
Voc√™ pode editar:
- **SKU:** C√≥digo √∫nico do produto
- **Descri√ß√£o:** Descri√ß√£o detalhada
- **Cole√ß√£o:** Vincular a outra cole√ß√£o
- **Marca:** Vincular a outra marca
- **Fot√≥grafo:** Nome do fot√≥grafo
- **Data do Shooting:** Data da sess√£o
- **Status:** Pendente, Aprovado ou Rejeitado

### Passo 8.3 - Salvar
1. Fa√ßa as altera√ß√µes desejadas
2. Clique em **Salvar Altera√ß√µes**
3. Voc√™ ser√° redirecionado para a p√°gina de detalhes

---

## PARTE 9: CADASTRO DE PRODUTOS

### O que s√£o Produtos?
Produtos s√£o itens com SKU √∫nico que podem ter uma ou mais imagens associadas. Diferente das imagens, produtos cont√™m informa√ß√µes comerciais.

### Passo 9.1 - Acessar Produtos
1. No menu lateral, clique em **Produtos**

### Passo 9.2 - Criar Novo Produto
1. Clique no bot√£o **+ Novo Produto**
2. Preencha os campos:

| Campo | Exemplo | Obrigat√≥rio |
|-------|---------|-------------|
| SKU | OAZ-VES-001 | Sim |
| Descri√ß√£o | Vestido longo estampado | Sim |
| Cor | Azul Marinho | N√£o |
| Categoria | Vestidos | N√£o |
| Marca | OAZ Fashion | N√£o |
| Cole√ß√£o | Ver√£o 2025 | N√£o |
| Atributos T√©cnicos | Tecido: Viscose, Forro: Sim | N√£o |

3. Clique em **Salvar**

### Sugest√£o de Produtos para Teste:
```
SKU: OAZ-VES-001
Descri√ß√£o: Vestido longo floral
Cor: Azul com flores
Categoria: Vestidos
Atributos: Tecido: Viscose, Comprimento: Longo, Decote: V

SKU: OAZ-BLU-002
Descri√ß√£o: Blusa manga bufante
Cor: Branco
Categoria: Blusas
Atributos: Tecido: Algod√£o, Manga: Bufante, Gola: Redonda

SKU: OAZ-CAL-003
Descri√ß√£o: Cal√ßa wide leg
Cor: Preto
Categoria: Cal√ßas
Atributos: Tecido: Alfaiataria, Cintura: Alta, Modelagem: Wide
```

### Passo 9.3 - Buscar Produtos
- Use o campo de busca para pesquisar por SKU, descri√ß√£o, cor ou categoria
- Clique em **Buscar**

### Passo 9.4 - Filtrar por Status de Foto
- Use o filtro **Status de Foto** para ver:
  - Todos
  - Com Foto
  - Sem Foto

### Passo 9.5 - Exportar Produtos
- Clique no bot√£o **Exportar CSV** para baixar uma planilha com todos os produtos

---

## PARTE 10: CARTEIRA DE COMPRAS

### O que √© a Carteira de Compras?
√â uma lista de SKUs importados de um arquivo CSV que representa os produtos planejados para compra. O sistema cruza automaticamente com as imagens existentes.

### Passo 10.1 - Acessar Carteira
1. No menu lateral, clique em **Carteira de Compras**

### Passo 10.2 - Importar CSV

#### Formato do Arquivo CSV:
O arquivo deve ter estas colunas (separadas por v√≠rgula ou ponto-e-v√≠rgula):

```csv
sku,descricao,quantidade,data_entrega,fornecedor
OAZ-VES-001,Vestido longo floral,50,2025-03-15,Fornecedor A
OAZ-BLU-002,Blusa manga bufante,100,2025-03-20,Fornecedor B
OAZ-CAL-003,Cal√ßa wide leg,80,2025-03-25,Fornecedor C
OAZ-SAI-004,Saia midi plissada,60,2025-04-01,Fornecedor A
OAZ-JAQ-005,Jaqueta jeans,40,2025-04-10,Fornecedor D
```

#### Para Importar:
1. Clique no bot√£o **Importar CSV**
2. Clique em **Escolher Arquivo** e selecione seu CSV
3. Clique em **Importar**
4. O sistema processar√° e mostrar√° quantos registros foram importados

### Passo 10.3 - Visualizar Carteira
Ap√≥s importar, voc√™ ver√°:
- Lista de todos os SKUs da carteira
- **Status de Foto:** Com Foto (verde), Sem Foto (vermelho), Pendente (amarelo)
- O status √© atualizado automaticamente baseado nas imagens existentes

### Passo 10.4 - Cruzar com Imagens
1. Clique no bot√£o **Cruzar com Imagens**
2. O sistema verifica quais SKUs da carteira j√° possuem fotos
3. Os status s√£o atualizados automaticamente

### Passo 10.5 - Filtrar Carteira
Use os filtros para ver:
- Todos os itens
- Apenas **Com Foto**
- Apenas **Sem Foto**
- Apenas **Pendente**

---

## PARTE 11: AUDITORIA

### Passo 11.1 - Acessar Auditoria
1. No menu lateral, clique em **Auditoria**

### O que voc√™ ver√°:

#### Se√ß√£o 1: Status dos Produtos
- **Total de Produtos:** Quantidade total cadastrada
- **Produtos com Foto:** Quantidade que tem imagem vinculada (verde)
- **Produtos sem Foto:** Quantidade pendente de foto (vermelho)

#### Se√ß√£o 2: Status da Carteira
- **Total na Carteira:** Itens importados
- **Com Foto:** SKUs que j√° possuem imagem
- **Sem Foto:** SKUs que precisam de foto
- **Pendente:** Aguardando verifica√ß√£o

#### Se√ß√£o 3: Altera√ß√µes de SKU
- Hist√≥rico das √∫ltimas mudan√ßas de nomenclatura de SKU
- Mostra: SKU antigo ‚Üí SKU novo ‚Üí Data

#### Se√ß√£o 4: Diverg√™ncias
- SKUs na carteira que foram alterados no cadastro de produtos
- Indica inconsist√™ncias entre carteira e cadastro atual

#### Se√ß√£o 5: SKUs Pendentes
- Lista de produtos sem foto
- Permite ver a lista completa ou exportar CSV

### Passo 11.2 - Exportar Relat√≥rios
Clique nos bot√µes de exporta√ß√£o:
- **Exportar lista** (Produtos com foto)
- **Exportar CSV** (SKUs pendentes)
- **Ver hist√≥rico completo** (Altera√ß√µes de SKU)

### Passo 11.3 - Ver SKUs Pendentes
1. Clique em **Ver Todos** na se√ß√£o de SKUs Pendentes
2. Voc√™ ver√° a lista completa de produtos sem foto
3. Use para priorizar os pr√≥ximos shootings

---

## PARTE 12: RELAT√ìRIOS

### Passo 12.1 - Acessar Relat√≥rios
1. No menu lateral, clique em **Relat√≥rios**

### O que voc√™ ver√°:

#### M√©tricas Gerais
- Total de imagens
- Distribui√ß√£o por status (gr√°fico)
- Imagens por cole√ß√£o
- Imagens por marca

#### Exporta√ß√µes Dispon√≠veis
- **Exportar Todas as Imagens (CSV)**
- **Exportar por Status (CSV)**
- **Exportar por Cole√ß√£o (CSV)**

### Passo 12.2 - Exportar CSV
1. Escolha o tipo de exporta√ß√£o desejado
2. Clique no bot√£o correspondente
3. O download come√ßar√° automaticamente

---

## PARTE 13: FLUXO DE TRABALHO COMPLETO (EXEMPLO PR√ÅTICO)

### Cen√°rio: Nova Cole√ß√£o Ver√£o 2025

#### Dia 1: Prepara√ß√£o
1. Login no sistema
2. Configurar API OpenAI (se ainda n√£o fez)
3. Criar Marca: "OAZ Fashion"
4. Criar Cole√ß√£o: "Ver√£o 2025" (Ano: 2025, Esta√ß√£o: Primavera/Ver√£o)

#### Dia 2: Cadastro de Produtos
1. Cadastrar produtos da cole√ß√£o:
   - OAZ-VES-001: Vestido longo floral
   - OAZ-BLU-002: Blusa manga bufante
   - OAZ-CAL-003: Cal√ßa wide leg
2. Importar CSV da Carteira de Compras com os SKUs planejados

#### Dia 3: Shooting de Fotos
1. Realizar sess√£o de fotos
2. Fazer upload das imagens no sistema
3. Vincular cada imagem ao produto/SKU correspondente
4. A IA ir√° analisar automaticamente cada pe√ßa

#### Dia 4: Revis√£o e Aprova√ß√£o
1. Acessar Biblioteca de Imagens
2. Filtrar por Status: Pendente
3. Revisar cada imagem:
   - Verificar se a an√°lise da IA est√° correta
   - Editar se necess√°rio
   - Aprovar ou Rejeitar

#### Dia 5: Auditoria e Relat√≥rios
1. Acessar Auditoria
2. Verificar quantos SKUs ainda est√£o sem foto
3. Exportar lista de pendentes para priorizar pr√≥ximo shooting
4. Acessar Relat√≥rios
5. Exportar relat√≥rio completo da cole√ß√£o

---

## ARQUIVOS DE EXEMPLO PARA IMPORTA√á√ÉO

### Arquivo: carteira_exemplo.csv
```csv
sku,descricao,quantidade,data_entrega,fornecedor
OAZ-VES-001,Vestido longo floral,50,2025-03-15,T√™xtil ABC
OAZ-VES-002,Vestido midi estampado,30,2025-03-15,T√™xtil ABC
OAZ-BLU-001,Blusa cropped,100,2025-03-20,Confec√ß√µes XYZ
OAZ-BLU-002,Blusa manga bufante,80,2025-03-20,Confec√ß√µes XYZ
OAZ-CAL-001,Cal√ßa wide leg,60,2025-03-25,Jeans Master
OAZ-CAL-002,Cal√ßa skinny,70,2025-03-25,Jeans Master
OAZ-SAI-001,Saia midi plissada,40,2025-04-01,T√™xtil ABC
OAZ-JAQ-001,Jaqueta jeans oversized,25,2025-04-10,Jeans Master
OAZ-MAC-001,Macac√£o longo,35,2025-04-10,Confec√ß√µes XYZ
OAZ-SHO-001,Short alfaiataria,90,2025-03-30,Confec√ß√µes XYZ
```

### Como usar este arquivo:
1. Copie o conte√∫do acima
2. Cole em um editor de texto (Bloco de Notas, VS Code)
3. Salve como `carteira_exemplo.csv`
4. Importe no sistema via **Carteira > Importar CSV**

---

## DICAS E BOAS PR√ÅTICAS

### Nomenclatura de SKU
Sugest√£o de padr√£o:
`MARCA-CATEGORIA-NUMERO`

Exemplos:
- OAZ-VES-001 (Vestido 001)
- OAZ-BLU-002 (Blusa 002)
- OAZ-CAL-003 (Cal√ßa 003)

### Organiza√ß√£o de Cole√ß√µes
- Use o campo **Ano** para facilitar buscas futuras
- Use **Esta√ß√£o** para agrupar por temporada
- Use **Campanha** para identificar lan√ßamentos espec√≠ficos

### Qualidade das Imagens
Para melhor an√°lise da IA:
- Use fundo neutro (branco ou cinza)
- Boa ilumina√ß√£o
- Pe√ßa centralizada
- Resolu√ß√£o m√≠nima: 800x800 pixels

### Workflow de Aprova√ß√£o
1. **Pendente:** Imagem rec√©m-enviada, aguardando revis√£o
2. **Aprovado:** Imagem validada e pronta para uso
3. **Rejeitado:** Imagem com problemas (qualidade, erro, etc.)

---

## SOLU√á√ÉO DE PROBLEMAS

### Problema: IA n√£o est√° analisando as imagens
**Solu√ß√£o:** Verifique se a API Key da OpenAI est√° configurada em Configura√ß√µes.

### Problema: Erro ao importar CSV
**Solu√ß√£o:** Verifique se o arquivo est√° no formato correto (UTF-8) e se as colunas est√£o separadas por v√≠rgula.

### Problema: Imagem n√£o aparece ap√≥s upload
**Solu√ß√£o:** Aguarde alguns segundos e atualize a p√°gina. Se persistir, verifique o formato da imagem (PNG, JPG, JPEG, GIF).

### Problema: Status da carteira n√£o atualiza
**Solu√ß√£o:** Clique no bot√£o "Cruzar com Imagens" para for√ßar a atualiza√ß√£o.

---

## SUPORTE

Para resetar a senha do admin:
```bash
python reset_admin.py
```

Para migrar o banco de dados ap√≥s atualiza√ß√µes:
```bash
python migrate_db.py
```

---

**Fim do Tutorial**

*OAZ Smart Image Bank - Sistema de Gerenciamento Inteligente de Imagens*

================================================================================
FILE: app.py
================================================================================
import os
import io
import csv
from datetime import datetime
from flask import Flask, render_template, redirect, url_for, flash, request, Response, make_response, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user
from werkzeug.security import generate_password_hash, check_password_hash
from werkzeug.utils import secure_filename
from werkzeug.exceptions import RequestEntityTooLarge
from openai import OpenAI
from dotenv import load_dotenv
import json
import base64
from PIL import Image as PILImage

# Sistema de Logging OAZ (local)
from oaz_logger import (
    info, debug, warn, error, success,
    log_start, log_end, log_progress, log_action, log_error, log_data,
    log_route, log_operation, log_separator, log_section,
    auth_log, batch_log, upload_log, carteira_log, catalog_log, crud_log, nav_log,
    M  # M√≥dulos
)

# RPA Monitor Client (monitoramento externo via WebSocket)
try:
    from rpa_monitor_client import auto_setup_rpa_monitor, rpa_log
    RPA_MONITOR_AVAILABLE = True
except ImportError:
    RPA_MONITOR_AVAILABLE = False
    rpa_log = None

# Load environment variables
load_dotenv()

# Inicializar RPA Monitor se dispon√≠vel (usa vari√°veis de ambiente automaticamente)
# Vari√°veis esperadas: RPA_MONITOR_ID, RPA_MONITOR_HOST, RPA_MONITOR_TRANSPORT, RPA_MONITOR_REGION
if RPA_MONITOR_AVAILABLE:
    try:
        auto_setup_rpa_monitor()
        rpa_id = os.environ.get('RPA_MONITOR_ID', 'N/A')
        rpa_host = os.environ.get('RPA_MONITOR_HOST', 'N/A')
        print(f"[RPA Monitor] Conectado: {rpa_id} -> {rpa_host}")
    except Exception as e:
        print(f"[RPA Monitor] Erro ao conectar: {e}")
        RPA_MONITOR_AVAILABLE = False

# Fun√ß√µes helper para RPA logging (envia para servidor externo)
def rpa_info(msg, regiao="geral"):
    """Log INFO para RPA Monitor externo"""
    if RPA_MONITOR_AVAILABLE and rpa_log:
        try:
            rpa_log.info(msg)
        except Exception:
            pass

def rpa_warn(msg, regiao="geral"):
    """Log WARNING para RPA Monitor externo"""
    if RPA_MONITOR_AVAILABLE and rpa_log:
        try:
            rpa_log.warn(msg)
        except Exception:
            pass

def rpa_error(msg, exc=None, regiao="geral", take_screenshot=True):
    """Log ERROR para RPA Monitor externo com screenshot autom√°tico"""
    if RPA_MONITOR_AVAILABLE and rpa_log:
        try:
            rpa_log.error(msg, exc=exc, regiao=regiao)
            if take_screenshot:
                import time
                rpa_log.screenshot(
                    filename=f"error_{int(time.time())}.png",
                    regiao=regiao,
                )
        except Exception:
            pass

def rpa_screenshot(regiao="manual"):
    """Captura screenshot para RPA Monitor externo"""
    if RPA_MONITOR_AVAILABLE and rpa_log:
        try:
            import time
            rpa_log.screenshot(
                filename=f"screen_{int(time.time())}.png",
                regiao=regiao,
            )
        except Exception:
            pass

# Configuration
class Config:
    SECRET_KEY = os.environ.get('FLASK_SECRET_KEY') or 'dev-secret-key-oaz-img'
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL', 'sqlite:///oaz_img.db')
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ENGINE_OPTIONS = {
        "pool_recycle": 300,
        "pool_pre_ping": True,
        "pool_size": 20,
        "max_overflow": 30,
        "pool_timeout": 60,
    }
    UPLOAD_FOLDER = 'static/uploads'
    ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'zip'}
    MAX_BATCH_WORKERS = 5  # N√∫mero de threads para processamento paralelo
    MAX_CONTENT_LENGTH = 3 * 1024 * 1024 * 1024  # 3GB - suporta uploads grandes

app = Flask(__name__)
app.config.from_object(Config)

# Ensure upload directory exists
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

db = SQLAlchemy(app)
login_manager = LoginManager(app)
login_manager.login_view = 'login'

# Error handler for large file uploads
@app.errorhandler(413)
@app.errorhandler(RequestEntityTooLarge)
def handle_file_too_large(e):
    flash('Arquivo muito grande! O limite m√°ximo √© 100MB por arquivo. Para lotes maiores, divida em arquivos ZIP menores.', 'error')
    return redirect(request.referrer or url_for('batch_list'))

# Models
class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(256))
    
    def set_password(self, password):
        self.password_hash = generate_password_hash(password)
        
    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

class SystemConfig(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    key = db.Column(db.String(50), unique=True, nullable=False)
    value = db.Column(db.Text, nullable=False)

class Brand(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False, unique=True)
    description = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    images = db.relationship('Image', backref='brand_ref', lazy=True)

class Collection(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.Text)
    season = db.Column(db.String(50))  # Esta√ß√£o: Primavera/Ver√£o, Outono/Inverno
    year = db.Column(db.Integer)  # Ano da cole√ß√£o
    campanha = db.Column(db.String(100))  # Nome da campanha (legado)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    images = db.relationship('Image', backref='collection', lazy=True)
    subcolecoes = db.relationship('Subcolecao', backref='colecao', lazy=True, cascade='all, delete-orphan')

class Subcolecao(db.Model):
    """Subcole√ß√£o/Campanha dentro de uma Cole√ß√£o (Ex: Dia das M√£es, Natal, R√©veillon)"""
    id = db.Column(db.Integer, primary_key=True)
    nome = db.Column(db.String(100), nullable=False)
    slug = db.Column(db.String(100))  # Nome normalizado para busca
    tipo_campanha = db.Column(db.String(50))  # DDM, LANCAMENTO, COLECAO, PREVIEW, etc.
    data_inicio = db.Column(db.Date)  # Data in√≠cio da campanha (opcional)
    data_fim = db.Column(db.Date)  # Data fim da campanha (opcional)
    colecao_id = db.Column(db.Integer, db.ForeignKey('collection.id'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class Image(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    filename = db.Column(db.String(255), nullable=False)
    original_name = db.Column(db.String(255), nullable=False)
    storage_path = db.Column(db.String(500))  # Path in Object Storage (e.g., /bucket/images/file.jpg)
    description = db.Column(db.Text)
    sku = db.Column(db.String(100))  # SKU completo do arquivo (ex: ABC123_01)
    sku_base = db.Column(db.String(100), index=True)  # SKU base para agrupamento (ex: ABC123)
    sequencia = db.Column(db.String(20))  # Sequ√™ncia/√¢ngulo (ex: 01, 02, A, B, FRENTE, COSTAS)
    brand_id = db.Column(db.Integer, db.ForeignKey('brand.id'))
    status = db.Column(db.String(20), default='Pendente')
    upload_date = db.Column(db.DateTime, default=datetime.utcnow)
    shooting_date = db.Column(db.Date)
    photographer = db.Column(db.String(100))
    unique_code = db.Column(db.String(50), unique=True)
    collection_id = db.Column(db.Integer, db.ForeignKey('collection.id'))
    subcolecao_id = db.Column(db.Integer, db.ForeignKey('subcolecao.id'))  # Subcole√ß√£o/Campanha
    uploader_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    tags = db.Column(db.Text)
    
    # Campos extras da Carteira (preenchidos no cruzamento SKU)
    nome_peca = db.Column(db.Text)  # Nome da pe√ßa vindo da Carteira (ex: "Jaqueta Reese")
    categoria = db.Column(db.String(100))  # GRUPO
    subcategoria = db.Column(db.String(100))  # SUBGRUPO
    tipo_peca = db.Column(db.String(50))  # TOP/BOTTOM/INTEIRO
    estilista = db.Column(db.String(255))
    origem = db.Column(db.String(50))  # NACIONAL/IMPORTADO
    referencia_estilo = db.Column(db.String(50))  # C√≥digo de estilo
    
    # AI-extracted attributes (legacy - mantido para retrocompatibilidade)
    ai_item_type = db.Column(db.String(100))
    ai_color = db.Column(db.String(50))
    ai_material = db.Column(db.String(100))
    ai_pattern = db.Column(db.String(50))
    ai_style = db.Column(db.String(50))
    
    # Relationship with individual items detected in image
    items = db.relationship('ImageItem', backref='image', lazy=True, cascade='all, delete-orphan')
    
    # Relationship with subcolecao
    subcolecao_rel = db.relationship('Subcolecao', backref='images', foreign_keys=[subcolecao_id])
    
    # √çndices para agrupamento e busca
    __table_args__ = (
        db.Index('idx_image_sku_base', 'sku_base'),
        db.Index('idx_image_sku_base_collection', 'sku_base', 'collection_id'),
    )
    
    @property
    def image_url(self):
        """Returns the URL to access the image (Object Storage or local fallback)"""
        if self.storage_path:
            return self.storage_path
        return f"/static/uploads/{self.filename}"

class ImageItem(db.Model):
    """Representa uma pe√ßa individual detectada em uma imagem"""
    id = db.Column(db.Integer, primary_key=True)
    image_id = db.Column(db.Integer, db.ForeignKey('image.id'), nullable=False)
    item_order = db.Column(db.Integer, default=1)  # Ordem da pe√ßa na imagem
    
    # Descri√ß√£o espec√≠fica desta pe√ßa
    description = db.Column(db.Text)
    tags = db.Column(db.Text)  # JSON array
    
    # Atributos IA espec√≠ficos desta pe√ßa
    ai_item_type = db.Column(db.String(100))
    ai_color = db.Column(db.String(50))
    ai_material = db.Column(db.String(100))
    ai_pattern = db.Column(db.String(50))
    ai_style = db.Column(db.String(50))
    
    # Refer√™ncia visual (ex: "pe√ßa superior", "pe√ßa inferior", "acess√≥rio")
    position_ref = db.Column(db.String(50))

class ImageThumbnail(db.Model):
    """Armazena thumbnails das imagens para exibi√ß√£o r√°pida em tela"""
    id = db.Column(db.Integer, primary_key=True)
    image_id = db.Column(db.Integer, db.ForeignKey('image.id'), nullable=False, unique=True)
    thumbnail_data = db.Column(db.LargeBinary, nullable=False)  # Dados bin√°rios do thumbnail
    width = db.Column(db.Integer)  # Largura do thumbnail
    height = db.Column(db.Integer)  # Altura do thumbnail
    file_size = db.Column(db.Integer)  # Tamanho em bytes
    mime_type = db.Column(db.String(50), default='image/jpeg')
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Relacionamento com Image
    image = db.relationship('Image', backref=db.backref('thumbnail', uselist=False))
    
    __table_args__ = (
        db.Index('idx_thumbnail_image_id', 'image_id'),
    )

class Produto(db.Model):
    """Modelo de Produto com SKU e atributos t√©cnicos"""
    id = db.Column(db.Integer, primary_key=True)
    sku = db.Column(db.String(50), unique=True, nullable=False)
    descricao = db.Column(db.String(255), nullable=False)
    cor = db.Column(db.String(50))
    categoria = db.Column(db.String(100))
    atributos_tecnicos = db.Column(db.Text)  # JSON com atributos extras
    
    # Relacionamentos
    marca_id = db.Column(db.Integer, db.ForeignKey('brand.id'))
    colecao_id = db.Column(db.Integer, db.ForeignKey('collection.id'))
    subcolecao_id = db.Column(db.Integer, db.ForeignKey('subcolecao.id'))  # Subcole√ß√£o/Campanha
    
    # Metadados
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Flags
    tem_foto = db.Column(db.Boolean, default=False)
    ativo = db.Column(db.Boolean, default=True)
    
    # Relationships
    marca = db.relationship('Brand', backref='produtos')
    colecao = db.relationship('Collection', backref='produtos')
    subcolecao = db.relationship('Subcolecao', backref='produtos')
    imagens = db.relationship('ImagemProduto', backref='produto', lazy=True, cascade='all, delete-orphan')
    historico_skus = db.relationship('HistoricoSKU', backref='produto', lazy=True)

class ImagemProduto(db.Model):
    """Associa√ß√£o entre Imagem e Produto (uma imagem pode ter v√°rios produtos)"""
    id = db.Column(db.Integer, primary_key=True)
    imagem_id = db.Column(db.Integer, db.ForeignKey('image.id'), nullable=False)
    produto_id = db.Column(db.Integer, db.ForeignKey('produto.id'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Relacionamentos
    imagem = db.relationship('Image', backref='produtos_associados')

class HistoricoSKU(db.Model):
    """Hist√≥rico de altera√ß√µes de SKU para rastreabilidade"""
    id = db.Column(db.Integer, primary_key=True)
    produto_id = db.Column(db.Integer, db.ForeignKey('produto.id'), nullable=False)
    sku_antigo = db.Column(db.String(50), nullable=False)
    sku_novo = db.Column(db.String(50), nullable=False)
    data_alteracao = db.Column(db.DateTime, default=datetime.utcnow)
    motivo = db.Column(db.String(255))
    usuario_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    
    usuario = db.relationship('User', backref='alteracoes_sku')

class CarteiraCompras(db.Model):
    """Carteira de compras importada para compara√ß√£o com itens fotografados"""
    id = db.Column(db.Integer, primary_key=True)
    sku = db.Column(db.String(50), nullable=False)
    descricao = db.Column(db.String(255))
    cor = db.Column(db.String(100))
    categoria = db.Column(db.String(100))  # GRUPO (MALHA, TECIDO PLANO, etc)
    subcategoria = db.Column(db.String(100))  # SUBGRUPO (Blusa, Cal√ßa, Vestido, etc)
    colecao_nome = db.Column(db.String(100))  # ENTRADA (ex: INVERNO 2026)
    estilista = db.Column(db.String(255))
    shooting = db.Column(db.String(100))  # QUANDO
    observacoes = db.Column(db.Text)  # OBS
    origem = db.Column(db.String(50))  # NACIONAL / IMPORTADO
    quantidade = db.Column(db.Integer, default=1)
    
    # Novos campos para moda/acess√≥rios/home
    tipo_carteira = db.Column(db.String(30), default='Moda')  # Moda, Acess√≥rios, Home
    material = db.Column(db.String(100))  # GRUPO normalizado (material do tecido)
    tipo_peca = db.Column(db.String(100))  # SUBGRUPO normalizado (tipo de pe√ßa)
    posicao_peca = db.Column(db.String(50))  # TOP/BOTTOM/INTEIRO
    referencia_estilo = db.Column(db.String(50))  # REFER√äNCIA ESTILO (c√≥digo interno)
    
    # Status
    status_foto = db.Column(db.String(30), default='Pendente')  # Pendente, Com Foto, Sem Foto
    okr = db.Column(db.String(20))  # Status de aprova√ß√£o
    produto_id = db.Column(db.Integer, db.ForeignKey('produto.id'))  # Link com produto se existir
    
    # Relacionamentos com entidades auto-criadas
    colecao_id = db.Column(db.Integer, db.ForeignKey('collection.id'))  # Cole√ß√£o associada
    subcolecao_id = db.Column(db.Integer, db.ForeignKey('subcolecao.id'))  # Subcole√ß√£o/Campanha
    marca_id = db.Column(db.Integer, db.ForeignKey('brand.id'))  # Marca associada
    
    # Metadados de importa√ß√£o
    data_importacao = db.Column(db.DateTime, default=datetime.utcnow)
    lote_importacao = db.Column(db.String(50))  # Identificador do lote de importa√ß√£o
    aba_origem = db.Column(db.String(50))  # Aba do Excel de origem
    
    # Relacionamentos
    produto = db.relationship('Produto', backref='itens_carteira')
    colecao = db.relationship('Collection', backref='itens_carteira')
    subcolecao = db.relationship('Subcolecao', backref='itens_carteira')
    marca = db.relationship('Brand', backref='itens_carteira')

class BatchUpload(db.Model):
    """Lote de upload de imagens para processamento em massa"""
    id = db.Column(db.Integer, primary_key=True)
    nome = db.Column(db.String(255))
    total_arquivos = db.Column(db.Integer, default=0)
    processados = db.Column(db.Integer, default=0)
    sucesso = db.Column(db.Integer, default=0)
    falhas = db.Column(db.Integer, default=0)
    status = db.Column(db.String(30), default='Pendente')  # Pendente, Processando, Conclu√≠do, Erro
    
    # Timestamps
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    started_at = db.Column(db.DateTime)
    finished_at = db.Column(db.DateTime)
    
    # Metadados
    usuario_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    colecao_id = db.Column(db.Integer, db.ForeignKey('collection.id'))
    marca_id = db.Column(db.Integer, db.ForeignKey('brand.id'))
    
    # Relacionamentos
    usuario = db.relationship('User', backref='batches')
    colecao = db.relationship('Collection', backref='batches')
    marca = db.relationship('Brand', backref='batches')
    items = db.relationship('BatchItem', backref='batch', lazy='dynamic', cascade='all, delete-orphan')
    
    @property
    def progresso(self):
        if self.total_arquivos == 0:
            return 0
        return round((self.processados / self.total_arquivos) * 100, 1)

class BatchItem(db.Model):
    """Item individual de um lote de upload - Sistema resiliente a falhas"""
    id = db.Column(db.Integer, primary_key=True)
    batch_id = db.Column(db.Integer, db.ForeignKey('batch_upload.id'), nullable=False)
    
    # Identifica√ß√£o
    sku = db.Column(db.String(100), nullable=False)  # Nome do arquivo = SKU
    filename_original = db.Column(db.String(255))
    file_size = db.Column(db.BigInteger)  # Tamanho do arquivo em bytes
    file_hash = db.Column(db.String(64))  # SHA256 para dedupe
    
    # FASE 1: Recep√ß√£o (Cliente ‚Üí Servidor)
    received_path = db.Column(db.String(500))  # Caminho tempor√°rio no servidor
    reception_status = db.Column(db.String(30), default='pending')  # pending, receiving, received, failed
    received_at = db.Column(db.DateTime)  # Quando foi recebido no servidor
    
    # FASE 2: Processamento (Servidor ‚Üí Object Storage)
    processing_status = db.Column(db.String(30), default='pending')  # pending, processing, completed, failed, retry
    storage_path = db.Column(db.String(500))  # Caminho final no Object Storage
    image_id = db.Column(db.Integer, db.ForeignKey('image.id'))
    
    # Controle de erros e retries
    status = db.Column(db.String(30), default='Pendente')  # Pendente, Processando, Sucesso, Erro (legado)
    erro_mensagem = db.Column(db.Text)
    retry_count = db.Column(db.Integer, default=0)
    max_retries = db.Column(db.Integer, default=3)
    next_retry_at = db.Column(db.DateTime)
    last_error = db.Column(db.Text)
    tentativas = db.Column(db.Integer, default=0)  # Legado
    
    # Resultado da an√°lise IA
    ai_description = db.Column(db.Text)
    ai_tags = db.Column(db.Text)  # JSON
    ai_attributes = db.Column(db.Text)  # JSON com todos os atributos
    
    # Timestamps
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    processed_at = db.Column(db.DateTime)
    
    # Heartbeat para detectar itens travados
    heartbeat_at = db.Column(db.DateTime)  # √öltima vez que o worker atualizou
    worker_id = db.Column(db.String(50))  # ID do worker processando
    
    # Relacionamento com imagem criada
    imagem = db.relationship('Image', backref='batch_item')
    
    # √çndices para fila FIFO e busca r√°pida
    __table_args__ = (
        db.Index('idx_batch_item_sku', 'sku'),
        db.Index('idx_batch_item_status', 'status'),
        db.Index('idx_batch_item_batch_status', 'batch_id', 'status'),
        db.Index('idx_batch_item_processing', 'batch_id', 'processing_status'),
        db.Index('idx_batch_item_reception', 'batch_id', 'reception_status'),
        db.Index('idx_batch_item_retry', 'next_retry_at', 'processing_status'),
    )

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

def get_openai_client():
    # First try Replit AI Integrations (no API key needed)
    base_url = os.getenv('AI_INTEGRATIONS_OPENAI_BASE_URL')
    ai_key = os.getenv('AI_INTEGRATIONS_OPENAI_API_KEY')
    if base_url and ai_key:
        return OpenAI(api_key=ai_key, base_url=base_url)
    
    # Fallback to user-configured API key in DB
    config = SystemConfig.query.filter_by(key='OPENAI_API_KEY').first()
    if config:
        return OpenAI(api_key=config.value)
    
    # Last fallback to env var
    api_key = os.getenv('OPENAI_API_KEY')
    if api_key:
        return OpenAI(api_key=api_key)
    
    return None

def encode_image(image_path):
    with open(image_path, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode('utf-8')

def analyze_image_with_ai(image_path):
    client = get_openai_client()
    if not client:
        return "AI Configuration missing. Please configure OpenAI API Key in Settings."
    
    try:
        base64_image = encode_image(image_path)
        
        prompt = """
        Voc√™ √© um especialista em moda e t√™xteis analisando imagens para o banco de imagens OAZ (varejo de moda profissional).
        Sua an√°lise deve ser EXTREMAMENTE PRECISA para cataloga√ß√£o e verifica√ß√£o de SKUs.
        
        RESPONDA TUDO EM PORTUGU√äS DO BRASIL.
        
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        1. TIPO DE ITEM - Identifique com precis√£o:
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        VESTIDOS (com modelagem):
        - Vestido Tubinho (justo, segue o corpo)
        - Vestido Evas√™ (cintura marcada, saia em A)
        - Vestido Ciganinha/Ombro a Ombro
        - Vestido Chemise (estilo camisa, com bot√µes)
        - Vestido Transpassado (amarra√ß√£o lateral)
        - Vestido Tomara que Caia
        - Vestido God√™ (saia rodada e ampla)
        - Vestido Peplum (babado na cintura)
        
        BLUSAS/TOPS:
        - Camiseta/T-shirt, Camisa Social, Regata, Top/Cropped
        - Blusa de Alcinha, Body, Blusa Ciganinha
        - Blusa de Renda/Laise, Bata, Polo
        
        CAL√áAS (com modelagem):
        - Skinny, Flare/Boca de Sino, Pantalona/Wide Leg
        - Reta, Cargo, Jogger, Legging, Alfaiataria, Cigarrete
        
        SAIAS: L√°pis, Evas√™, God√™, Plissada, Envelope/Transpassada
        
        OUTROS: Blazer, Jaqueta, Cardigan, Su√©ter, Macac√£o, Shorts, Bermuda
        
        COMPRIMENTOS: Curto, Midi, Longo, Cropped, Mini, Maxi
        
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        2. COR - Seja espec√≠fico com nuances:
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        Exemplos: Azul Marinho, Azul Royal, Azul Beb√™, Vermelho Vinho, 
        Vermelho Ferrari, Rosa Blush, Rosa Pink, Preto, Branco Off-White,
        Bege Areia, Marrom Chocolate, Marrom Caramelo, Verde Militar,
        Verde Esmeralda, Cinza Chumbo, Cinza Mescla, Nude, Terracota
        
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        3. MATERIAL/TECIDO - AN√ÅLISE CR√çTICA (mais importante!)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        ‚ñº‚ñº‚ñº TECIDOS TRANSPARENTES E DELICADOS (PRIORIDADE M√ÅXIMA) ‚ñº‚ñº‚ñº
        
        ‚òÖ‚òÖ‚òÖ AN√ÅLISE DE MATERIAIS EM CAMADAS (MUITO IMPORTANTE!) ‚òÖ‚òÖ‚òÖ
        
        Muitas pe√ßas t√™m M√öLTIPLOS materiais sobrepostos. Analise em DUAS ETAPAS:
        
        ETAPA 1 - IDENTIFIQUE A BASE (tecido que cobre o corpo):
        - Se h√° uma TELA/MALHA TRANSPARENTE cobrindo grande √°rea = BASE √© TULE
        - Sinais visuais: diferen√ßa no tom da pele entre √°reas cobertas (mais escuras/acinzentadas) 
          e √°reas descobertas (m√£os, pesco√ßo, rosto t√™m tom de pele natural)
        - Se a pele aparece "velada" ou com tom diferente = h√° uma camada de TULE por baixo
        
        ETAPA 2 - IDENTIFIQUE APLICA√á√ïES/DETALHES (sobre a base):
        - Bordados, desenhos florais, arabescos = APLICA√á√ÉO de RENDA
        - Pedrarias, paet√™s = aplica√ß√µes decorativas
        
        ‚òÖ REGRA DE NOMENCLATURA:
        - Base de tule + desenhos de renda = "Tule com renda aplicada" (N√ÉO apenas "Renda"!)
        - Base de tule + bordados = "Tule bordado"
        - Apenas malha transparente uniforme = "Tule"
        - Renda sem base transparente (autossustentada) = "Renda guipir"
        - Renda delicada com desenhos florais = "Renda chantilly"
        
        ‚ö†Ô∏è DICA VISUAL CR√çTICA:
        Se voc√™ observa que o TOM DA PELE √© diferente entre:
        - M√£os/pesco√ßo/rosto (tom natural, sem cobertura)
        - Bra√ßos/torso/pernas (tom mais escuro/velado)
        Isso indica que h√° uma CAMADA DE TULE como base, mesmo que tenha desenhos por cima!
        Neste caso, identifique como "Tule com renda" ou "Tule com detalhes de renda"
        
        TULE (base transparente):
        - Grade/rede transparente cobrindo grandes √°reas do corpo
        - Cria efeito "v√©u" na pele - altera o tom visual
        
        RENDA (aplica√ß√£o decorativa):
        - Desenhos ornamentais (flores, arabescos)
        - Geralmente aplicada SOBRE uma base (tule ou forro)
        
        ORGANZA:
        - Visual: Transparente, R√çGIDO, brilho acetinado
        - Estrutura: Armado, mant√©m forma, n√£o √© vazado como tule
        - Uso: Saias estruturadas, vestidos de festa
        
        CHIFFON:
        - Visual: Transparente, MUITO FLUIDO e esvoa√ßante
        - Estrutura: Leve, sem estrutura, cai naturalmente
        - Uso: Vestidos leves, blusas, len√ßos
        
        VOAL:
        - Visual: Semi-transparente, intermedi√°rio
        - Estrutura: Entre organza e chiffon
        
        ‚ñº‚ñº‚ñº FIBRAS NATURAIS (SEM BRILHO) ‚ñº‚ñº‚ñº
        
        ALGOD√ÉO:
        - Visual: OPACO, mate, sem brilho, trama uniforme
        - Toque: Macio, fresco, confort√°vel
        - Amassa: Sim, moderadamente
        - Uso: Camisetas, cal√ßas, roupas b√°sicas
        
        LINHO:
        - Visual: Textura R√öSTICA, aspecto AMASSADO natural
        - Toque: Fresco, levemente √°spero
        - Amassa: MUITO (√© caracter√≠stica do tecido)
        - Uso: Roupas de ver√£o, pe√ßas elegantes
        
        SEDA:
        - Visual: Brilho LUXUOSO e NATURAL, muito lisa
        - Toque: Extremamente macio e suave
        - Caimento: Fluido e delicado
        - Uso: Vestidos de festa, blusas finas
        
        L√É:
        - Visual: Textura peluda/felpuda, encorpado
        - Toque: Quente, pode ser √°spero ou macio
        - Uso: Casacos, su√©teres, inverno
        
        ‚ñº‚ñº‚ñº FIBRAS ARTIFICIAIS (de celulose) ‚ñº‚ñº‚ñº
        
        VISCOSE:
        - Visual: Brilho SUTIL sedoso, OPACA (n√£o transparente!)
        - Toque: Macio, fresco, similar ao algod√£o
        - Caimento: Fluido, molda o corpo
        - Amassa: Sim, facilmente
        - ATEN√á√ÉO: Viscose N√ÉO √© transparente! Se for transparente, √© outro tecido!
        
        MODAL:
        - Visual: Similar √† viscose, mais macio
        - Toque: Muito suave, sedoso
        - Uso: Roupas √≠ntimas, camisetas premium
        
        ‚ñº‚ñº‚ñº FIBRAS SINT√âTICAS (derivadas de petr√≥leo) ‚ñº‚ñº‚ñº
        
        POLI√âSTER:
        - Visual: Brilho ARTIFICIAL e direto, aspecto "pl√°stico"
        - Toque: Liso, levemente r√≠gido
        - Amassa: N√ÉO amassa
        - Uso: Roupas esportivas, uniformes, misturas
        
        POLIAMIDA/NYLON:
        - Visual: Liso, brilhante, leve
        - Uso: Roupas esportivas, meias, lingerie
        
        ‚ñº‚ñº‚ñº MALHAS ‚ñº‚ñº‚ñº
        
        TRIC√î:
        - Visual: Pontos ENTRELA√áADOS vis√≠veis, textura artesanal
        - Uso: Su√©teres, cardigans, vestidos de inverno
        
        MOLETOM:
        - Visual: Face externa lisa, interna felpuda
        - Uso: Moletons, casacos casuais
        
        RIBANA/CANELADA:
        - Visual: Nervuras VERTICAIS paralelas
        - Alta elasticidade
        - Uso: Punhos, golas, camisetas justas
        
        ‚ñº‚ñº‚ñº TECIDOS ESTRUTURADOS ‚ñº‚ñº‚ñº
        
        JEANS/DENIM:
        - Visual: Diagonal caracter√≠stica, resistente
        - Cores: Azul √≠ndigo (claro/escuro), preto, branco
        
        SARJA:
        - Visual: Linhas DIAGONAIS bem vis√≠veis (45¬∞)
        - Uso: Cal√ßas, uniformes, shorts
        
        GABARDINE:
        - Visual: Liso com brilho sutil, muito estruturado
        - Uso: Alfaiataria, uniformes, blazers
        
        CREPE:
        - Visual: Textura GRANULADA, opaco, caimento pesado
        - Uso: Vestidos elegantes, alfaiataria
        
        CETIM/SATIN:
        - Visual: MUITO BRILHANTE, liso, escorregadio
        - Uso: Vestidos de festa, lingerie
        
        VELUDO:
        - Visual: Superf√≠cie PELUDA/felpuda, brilho caracter√≠stico
        - Uso: Vestidos de festa, blazers, inverno
        
        COURO/COURINO:
        - Visual: Liso, brilhante ou fosco, aspecto de pele
        - Uso: Jaquetas, cal√ßas, saias
        
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        4. ESTAMPA/PADR√ÉO:
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        Liso, Listrado (horizontal/vertical), Floral (grande/pequeno/delicado),
        Xadrez, Po√°/Bolinhas, Geom√©trico, Animal Print (on√ßa/zebra/cobra),
        Abstrato, Tie-Dye, √âtnico, Tropical, Paisley, Camuflado
        
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        5. ESTILO (seja espec√≠fico e baseado no USO da pe√ßa):
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        Analise o CONTEXTO DE USO da pe√ßa, n√£o apenas sua apar√™ncia:
        
        - Festa/Gala: vestidos elegantes, pe√ßas brilhantes para eventos noturnos
        - Social/Trabalho: alfaiataria, camisas, pe√ßas formais para escrit√≥rio
        - Dia a Dia/Urbano: pe√ßas pr√°ticas para uso cotidiano
        - Streetwear: estilo de rua, oversized, t√™nis, bon√©s
        - Minimalista: linhas limpas, cores neutras, sem ornamentos
        - Boho/Bohemian: fluido, √©tnico, franjas, estampas naturais
        - Esportivo/Athleisure: confort√°vel, funcional, para exerc√≠cios ou lazer
        - Praia/Resort: leve, estampas tropicais, tecidos frescos
        - Vintage/Retr√¥: inspira√ß√£o em d√©cadas passadas
        - Balada/Noite: pe√ßas ousadas, recortes, transpar√™ncias
        
        ‚ö†Ô∏è EVITE estilos gen√©ricos. Use o contexto de USO real da pe√ßa.
        ‚ö†Ô∏è N√ÉO classifique como "Rom√¢ntico" apenas por ter renda/tule - analise o contexto.
        
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        6. DESCRI√á√ÉO DETALHADA (CR√çTICO para verifica√ß√£o de SKU):
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        INCLUA OBRIGATORIAMENTE:
        ‚ñ° Tipo exato e modelagem (tubinho, evas√™, skinny, etc.)
        ‚ñ° Comprimento preciso (curto, midi, longo, cropped, 7/8)
        ‚ñ° Cintura (alta, m√©dia, baixa)
        ‚ñ° Decote (V, redondo, quadrado, tomara que caia, ombro a ombro)
        ‚ñ° Mangas (sem manga, curta, 3/4, longa, bufante, sino)
        ‚ñ° Detalhes de design (bot√µes, z√≠peres, bolsos, pregas, franzidos)
        ‚ñ° Acabamentos (babados, rendas, bordados, recortes)
        ‚ñ° Aviamentos vis√≠veis (fivelas, argolas, ilhoses)
        ‚ñ° Caracter√≠sticas √öNICAS que diferenciam esta pe√ßa
        
        Exemplo de descri√ß√£o boa:
        "Vestido midi evas√™ em crepe preto com decote V profundo, mangas 3/4 
        bufantes com el√°stico no punho, cintura marcada com cinto remov√≠vel 
        de mesma cor com fivela dourada, saia fluida com comprimento abaixo 
        do joelho, fechamento por z√≠per invis√≠vel nas costas, forro completo."
        
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        7. DETEC√á√ÉO DE M√öLTIPLAS PE√áAS:
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        IMPORTANTE: Analise a imagem e identifique TODAS as pe√ßas de roupa vis√≠veis.
        
        - Se houver APENAS UMA pe√ßa: retorne um array "items" com 1 item
        - Se houver M√öLTIPLAS pe√ßas (ex: blusa + cal√ßa, vestido + bolsa): retorne cada uma separadamente
        - M√°ximo de 4 pe√ßas por imagem
        
        Para cada pe√ßa, identifique sua POSI√á√ÉO na imagem:
        - "Pe√ßa Superior" (blusas, camisas, tops, jaquetas)
        - "Pe√ßa Inferior" (cal√ßas, saias, shorts)
        - "Pe√ßa √önica" (vestidos, macac√µes)
        - "Acess√≥rio" (bolsas, cintos, chap√©us)
        - "Cal√ßado" (sapatos, t√™nis, sand√°lias)
        
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        FORMATO DE RESPOSTA (JSON estrito com M√öLTIPLAS PE√áAS):
        {
            "item_count": 1,
            "items": [
                {
                    "position_ref": "Pe√ßa Superior/Inferior/√önica/Acess√≥rio/Cal√ßado",
                    "description": "Descri√ß√£o ultra-detalhada desta pe√ßa...",
                    "attributes": {
                        "item_type": "Tipo + Modelagem + Comprimento",
                        "color": "Cor com nuance espec√≠fica",
                        "material": "Material identificado com precis√£o",
                        "pattern": "Estampa ou Liso",
                        "style": "Estilo espec√≠fico"
                    },
                    "seo_keywords": ["keyword1", "keyword2", "keyword3"]
                }
            ]
        }
        
        Se houver 2 pe√ßas (ex: blusa e cal√ßa):
        {
            "item_count": 2,
            "items": [
                {
                    "position_ref": "Pe√ßa Superior",
                    "description": "Descri√ß√£o da blusa...",
                    "attributes": {...},
                    "seo_keywords": [...]
                },
                {
                    "position_ref": "Pe√ßa Inferior",
                    "description": "Descri√ß√£o da cal√ßa...",
                    "attributes": {...},
                    "seo_keywords": [...]
                }
            ]
        }
        
        REGRAS PARA KEYWORDS:
        ‚úó PROIBIDO: casual, moda casual, roupa feminina, moda, fashion, look, outfit, estilo
        ‚úì USE: termos espec√≠ficos do produto (material, cor, modelagem, detalhes)
        """
        
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{base64_image}"
                            },
                        },
                    ],
                }
            ],
            response_format={"type": "json_object"},
            max_tokens=1200,
        )
        
        content = response.choices[0].message.content
        data = json.loads(content)
        
        # Tags gen√©ricas a serem filtradas (n√£o agregam valor)
        generic_tags = [
            'casual', 'moda casual', 'roupa feminina', 'roupa masculina',
            'moda feminina', 'moda masculina', 'vestu√°rio', 'roupa',
            'fashion', 'moda', 'look', 'outfit', 'estilo casual'
        ]
        
        def filter_tags(attributes, keywords):
            """Filtra e gera tags a partir de atributos e keywords"""
            tags = []
            for key, value in attributes.items():
                if value and value.lower() != 'none' and value.lower() != 'n/a':
                    if value.lower() not in generic_tags:
                        tags.append(value)
            for keyword in keywords:
                if keyword.lower() not in generic_tags:
                    tags.append(keyword)
            return list(set(tags))
        
        # Novo formato com m√∫ltiplas pe√ßas
        if 'items' in data and isinstance(data['items'], list):
            items_data = []
            for idx, item in enumerate(data['items']):
                item_attributes = item.get('attributes', {})
                item_keywords = item.get('seo_keywords', [])
                item_tags = filter_tags(item_attributes, item_keywords)
                
                items_data.append({
                    'order': idx + 1,
                    'position_ref': item.get('position_ref', f'Pe√ßa {idx + 1}'),
                    'description': item.get('description', ''),
                    'tags': item_tags,
                    'attributes': item_attributes
                })
            
            # Retorna lista de itens
            return items_data
        
        # Fallback: formato antigo (uma pe√ßa s√≥)
        description = data.get('description', '')
        attributes = data.get('attributes', {})
        keywords = data.get('seo_keywords', [])
        tags = filter_tags(attributes, keywords)
        
        # Retorna como lista com um item para compatibilidade
        return [{
            'order': 1,
            'position_ref': 'Pe√ßa √önica',
            'description': description,
            'tags': tags,
            'attributes': attributes
        }]
        
    except Exception as e:
        print(f"AI Analysis Error: {e}")
        return f"Erro ao analisar imagem: {str(e)}"


def get_carteira_taxonomy():
    """Extrai taxonomia real da Carteira de Compras para padroniza√ß√£o"""
    taxonomy = {
        'categorias': [],
        'subcategorias': [],
        'tipos_peca': [],
        'origens': ['NACIONAL', 'IMPORTADO'],
        'materiais': []
    }
    
    try:
        categorias = db.session.query(db.func.distinct(db.func.upper(CarteiraCompras.categoria))).filter(
            CarteiraCompras.categoria.isnot(None),
            CarteiraCompras.categoria != ''
        ).all()
        taxonomy['categorias'] = sorted([c[0].strip() for c in categorias if c[0]])
        
        subcategorias = db.session.query(db.func.distinct(db.func.upper(CarteiraCompras.subcategoria))).filter(
            CarteiraCompras.subcategoria.isnot(None),
            CarteiraCompras.subcategoria != ''
        ).all()
        taxonomy['subcategorias'] = sorted([s[0].strip() for s in subcategorias if s[0]])
        
        tipos = db.session.query(db.func.distinct(db.func.upper(CarteiraCompras.tipo_peca))).filter(
            CarteiraCompras.tipo_peca.isnot(None),
            CarteiraCompras.tipo_peca != ''
        ).all()
        taxonomy['tipos_peca'] = sorted([t[0].strip() for t in tipos if t[0]])
        
        materiais = db.session.query(db.func.distinct(db.func.upper(CarteiraCompras.material))).filter(
            CarteiraCompras.material.isnot(None),
            CarteiraCompras.material != ''
        ).all()
        taxonomy['materiais'] = sorted([m[0].strip() for m in materiais if m[0]])
        
    except Exception as e:
        print(f"[WARN] Error loading taxonomy: {e}")
    
    return taxonomy


def normalize_to_taxonomy(value, valid_values):
    """Normaliza um valor para corresponder √† taxonomia da Carteira"""
    if not value or not valid_values:
        return value
    
    value_upper = value.upper().strip()
    
    for valid in valid_values:
        if valid.upper() == value_upper:
            return valid
    
    for valid in valid_values:
        if value_upper in valid.upper() or valid.upper() in value_upper:
            return valid
    
    return value.upper()


def analyze_image_with_context(image_path_or_url, sku=None, collection_id=None, brand_id=None, subcolecao_id=None, is_url=False):
    """
    Analisa imagem com contexto das carteiras de compras importadas.
    Busca produtos similares para dar contexto ao GPT.
    Aceita caminho de arquivo local ou URL da imagem.
    Retorna dados padronizados no formato da Carteira.
    """
    client = get_openai_client()
    if not client:
        return "AI Configuration missing. Please configure OpenAI API Key in Settings."
    
    try:
        taxonomy = get_carteira_taxonomy()
        context_products = []
        
        query = CarteiraCompras.query.filter(
            CarteiraCompras.descricao.isnot(None),
            CarteiraCompras.descricao != ''
        )
        
        if collection_id:
            query = query.filter_by(colecao_id=collection_id)
        if brand_id:
            query = query.filter_by(marca_id=brand_id)
        if subcolecao_id:
            query = query.filter_by(subcolecao_id=subcolecao_id)
        
        produtos_referencia = query.order_by(db.func.random()).limit(10).all()
        
        for prod in produtos_referencia:
            context_products.append({
                'sku': prod.sku,
                'descricao': prod.descricao,
                'categoria': prod.categoria,
                'cor': prod.cor,
                'material': prod.material,
                'tipo_peca': prod.tipo_peca,
                'subcategoria': prod.subcategoria,
                'origem': prod.origem
            })
        
        taxonomy_text = """
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TAXONOMIA OFICIAL (VOC√ä DEVE USAR APENAS ESTES VALORES):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
"""
        if taxonomy['categorias']:
            taxonomy_text += f"\nCATEGORIAS PERMITIDAS: {', '.join(taxonomy['categorias'])}"
        if taxonomy['tipos_peca']:
            taxonomy_text += f"\nTIPOS DE PE√áA PERMITIDOS: {', '.join(taxonomy['tipos_peca'])}"
        if taxonomy['origens']:
            taxonomy_text += f"\nORIGENS PERMITIDAS: {', '.join(taxonomy['origens'])}"
        if taxonomy['materiais']:
            taxonomy_text += f"\nMATERIAIS CONHECIDOS: {', '.join(taxonomy['materiais'][:20])}"
        
        context_text = ""
        if context_products:
            context_text = """

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
EXEMPLOS DE PRODUTOS DO CAT√ÅLOGO (refer√™ncia de padr√£o):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
"""
            for i, p in enumerate(context_products[:5], 1):
                context_text += f"""
Produto {i}:
- Descri√ß√£o: {p.get('descricao', 'N/A')}
- Categoria: {p.get('categoria', 'N/A')}
- Subcategoria: {p.get('subcategoria', 'N/A')}
- Tipo Pe√ßa: {p.get('tipo_peca', 'N/A')}
- Cor: {p.get('cor', 'N/A')}
- Material: {p.get('material', 'N/A')}
- Origem: {p.get('origem', 'N/A')}
"""
        
        if is_url:
            image_content = {
                "type": "image_url",
                "image_url": {"url": image_path_or_url}
            }
        else:
            base64_image = encode_image(image_path_or_url)
            image_content = {
                "type": "image_url",
                "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}
            }
        
        prompt = f"""
        Voc√™ √© um especialista em moda analisando imagens para o banco de imagens OAZ.
        
        {taxonomy_text}
        {context_text}
        
        RESPONDA TUDO EM PORTUGU√äS DO BRASIL.
        
        REGRA CR√çTICA: Voc√™ DEVE usar APENAS os valores listados na TAXONOMIA OFICIAL acima.
        Para campos como categoria, tipo_peca e origem, escolha EXATAMENTE um dos valores permitidos.
        
        Analise a imagem e preencha TODOS os campos abaixo:
        
        1. CATEGORIA: Escolha da lista de categorias permitidas (ex: JEANS, MALHA, TECIDO PLANO, TRICOT)
        2. TIPO DE PE√áA: Escolha da lista de tipos permitidos (ex: VESTIDO, BLUSA, CAL√áA, SAIA, CAMISA)
        3. COR: Seja espec√≠fico (Azul Marinho, Rosa Blush, Preto, Bege Areia)
        4. MATERIAL: Identifique o tecido (Algod√£o, Linho, Crepe, Malha, Jeans, Cetim)
        5. ESTAMPA: Liso, Listrado, Floral, Animal Print, Geom√©trico
        6. ESTILO: Festa, Social/Trabalho, Dia a Dia, Streetwear, Praia
        7. DESCRI√á√ÉO DETALHADA: Inclua modelagem, comprimento, decote, mangas, detalhes
        
        FORMATO DE RESPOSTA (JSON):
        {{
            "item_count": 1,
            "items": [
                {{
                    "position_ref": "Pe√ßa Superior/Inferior/√önica",
                    "description": "Descri√ß√£o ultra-detalhada...",
                    "carteira": {{
                        "categoria": "ESCOLHA DA LISTA DE CATEGORIAS",
                        "subcategoria": "ESCOLHA DA LISTA DE TIPOS DE PE√áA",
                        "tipo_peca": "ESCOLHA DA LISTA DE TIPOS DE PE√áA",
                        "origem": "NACIONAL ou IMPORTADO"
                    }},
                    "attributes": {{
                        "item_type": "Tipo + Modelagem detalhada",
                        "color": "Cor espec√≠fica",
                        "material": "Material/Tecido",
                        "pattern": "Estampa ou Liso",
                        "style": "Estilo"
                    }},
                    "seo_keywords": ["keyword1", "keyword2", "keyword3"]
                }}
            ]
        }}
        
        N√ÉO use tags gen√©ricas como "casual", "moda", "fashion", "look".
        
        IMPORTANTE: Foque na PE√áA PRINCIPAL da imagem. Se houver uma modelo usando a roupa, analise APENAS a roupa principal sendo mostrada.
        N√ÉO inclua pe√ßas secund√°rias como cal√ßas b√°sicas ou acess√≥rios comuns, a menos que sejam o foco da imagem.
        Na maioria dos casos, detecte apenas 1 pe√ßa principal.
        """
        
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        image_content,
                    ],
                }
            ],
            response_format={"type": "json_object"},
            max_tokens=1200,
        )
        
        content = response.choices[0].message.content
        data = json.loads(content)
        
        generic_tags = ['casual', 'moda casual', 'roupa feminina', 'fashion', 'moda', 'look', 'outfit', 
                        'elegante', 'moderno', 'feminino', 'masculino', 'roupa', 'pe√ßa', 'ideal para']
        
        def filter_tags(attributes, keywords, max_tags=5):
            """Filtra e simplifica tags para m√°ximo de 5 tags curtas"""
            tags = []
            
            priority_keys = ['item_type', 'color', 'material', 'pattern']
            for key in priority_keys:
                value = attributes.get(key)
                if value and value.lower() not in ['none', 'n/a', 'liso']:
                    simple_value = value.split()[0] if len(value.split()) > 3 else value
                    if simple_value.lower() not in generic_tags and len(simple_value) < 30:
                        tags.append(simple_value)
            
            for keyword in keywords[:3]:
                if keyword.lower() not in generic_tags and len(keyword) < 20:
                    if keyword not in tags:
                        tags.append(keyword)
            
            unique_tags = []
            seen_lower = set()
            for tag in tags:
                tag_lower = tag.lower()
                if tag_lower not in seen_lower and len(tag) > 2:
                    seen_lower.add(tag_lower)
                    unique_tags.append(tag)
            
            return unique_tags[:max_tags]
        
        if 'items' in data and isinstance(data['items'], list):
            items_data = []
            for idx, item in enumerate(data['items']):
                item_attributes = item.get('attributes', {})
                item_keywords = item.get('seo_keywords', [])
                item_tags = filter_tags(item_attributes, item_keywords)
                
                carteira_data = item.get('carteira', {})
                normalized_carteira = {
                    'categoria': normalize_to_taxonomy(carteira_data.get('categoria'), taxonomy['categorias']),
                    'subcategoria': normalize_to_taxonomy(carteira_data.get('subcategoria'), taxonomy['tipos_peca']),
                    'tipo_peca': normalize_to_taxonomy(carteira_data.get('tipo_peca'), taxonomy['tipos_peca']),
                    'origem': normalize_to_taxonomy(carteira_data.get('origem'), taxonomy['origens'])
                }
                
                items_data.append({
                    'order': idx + 1,
                    'position_ref': item.get('position_ref', f'Pe√ßa {idx + 1}'),
                    'description': item.get('description', ''),
                    'tags': item_tags,
                    'attributes': item_attributes,
                    'carteira': normalized_carteira,
                    'analyzed_with_context': len(context_products) > 0
                })
            
            return items_data
        
        description = data.get('description', '')
        attributes = data.get('attributes', {})
        keywords = data.get('seo_keywords', [])
        tags = filter_tags(attributes, keywords)
        carteira_data = data.get('carteira', {})
        normalized_carteira = {
            'categoria': normalize_to_taxonomy(carteira_data.get('categoria'), taxonomy['categorias']),
            'subcategoria': normalize_to_taxonomy(carteira_data.get('subcategoria'), taxonomy['tipos_peca']),
            'tipo_peca': normalize_to_taxonomy(carteira_data.get('tipo_peca'), taxonomy['tipos_peca']),
            'origem': normalize_to_taxonomy(carteira_data.get('origem'), taxonomy['origens'])
        }
        
        return [{
            'order': 1,
            'position_ref': 'Pe√ßa √önica',
            'description': description,
            'tags': tags,
            'attributes': attributes,
            'carteira': normalized_carteira,
            'analyzed_with_context': len(context_products) > 0
        }]
        
    except Exception as e:
        print(f"AI Context Analysis Error: {e}")
        return f"Erro ao analisar imagem: {str(e)}"


# Endpoint para receber logs do frontend
@app.route('/api/log', methods=['POST'])
def frontend_log():
    """Recebe logs do frontend (JavaScript) e exibe no console do servidor"""
    try:
        data = request.get_json()
        module = data.get('module', 'FRONTEND')
        action = data.get('action', 'ACTION')
        message = data.get('message', '')
        level = data.get('level', 'INFO').upper()
        extras = data.get('extras', {})
        
        if level == 'ERROR':
            error(M.SYSTEM, action, f"[JS] {message}", **extras)
            rpa_error(f"[JS] {action}: {message}", regiao="frontend")
        elif level == 'WARN':
            warn(M.SYSTEM, action, f"[JS] {message}", **extras)
            rpa_warn(f"[JS] {action}: {message}")
        elif level == 'SUCCESS':
            success(M.SYSTEM, action, f"[JS] {message}", **extras)
            rpa_info(f"[JS] {action}: {message}")
        elif level == 'DEBUG':
            debug(M.SYSTEM, action, f"[JS] {message}", **extras)
        else:
            info(M.SYSTEM, action, f"[JS] {message}", **extras)
            rpa_info(f"[JS] {action}: {message}")
        
        return jsonify({'status': 'ok'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500


@app.route('/api/analyze-single', methods=['POST'])
@login_required
def api_analyze_single():
    """Endpoint para an√°lise individual de imagem via AJAX (usado no cat√°logo em lote)"""
    try:
        data = request.get_json()
        image_id = data.get('image_id')
        selected_fields = data.get('fields', ['descricao', 'tags', 'cor', 'tipo', 'material'])
        
        if not image_id:
            return jsonify({'success': False, 'error': 'ID da imagem n√£o fornecido'}), 400
        
        image = Image.query.get(image_id)
        if not image:
            return jsonify({'success': False, 'error': 'Imagem n√£o encontrada'}), 404
        
        rpa_info(f"[AI-BATCH] Analisando imagem ID:{image_id} | Campos: {selected_fields}")
        
        success, error_msg = analyze_single_image(image, selected_fields)
        
        if success:
            return jsonify({
                'success': True,
                'message': f'SKU {image.sku_base or image.sku or "sem SKU"} analisado',
                'image_id': image_id
            })
        else:
            return jsonify({
                'success': False,
                'error': error_msg or 'Erro desconhecido na an√°lise',
                'image_id': image_id
            })
    
    except Exception as e:
        rpa_error(f"[AI-BATCH] Erro ao analisar imagem: {e}", exc=e)
        return jsonify({'success': False, 'error': str(e)}), 500


# Routes
@app.route('/')
def index():
    if current_user.is_authenticated:
        return redirect(url_for('dashboard'))
    return redirect(url_for('login'))

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        auth_log.login_attempt(username)
        rpa_info(f"[AUTH] Tentativa de login: {username}")
        user = User.query.filter_by(username=username).first()
        if user:
            password_check = user.check_password(password)
            if password_check:
                login_user(user)
                auth_log.login_success(username, user.id)
                rpa_info(f"[AUTH] Login bem-sucedido: {username} (ID: {user.id})")
                return redirect(url_for('dashboard'))
        auth_log.login_failed(username, "Usu√°rio ou senha inv√°lidos")
        rpa_warn(f"[AUTH] Login falhou: {username}")
        flash('Usu√°rio ou senha inv√°lidos')
    else:
        nav_log.page_enter("Login")
        rpa_info("[NAV] P√°gina: Login")
    return render_template('auth/login.html')

@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        username = request.form.get('username')
        email = request.form.get('email')
        password = request.form.get('password')
        info(M.AUTH, 'ACTION', f"Tentativa de registro", username=username, email=email)
        rpa_info(f"[AUTH] Tentativa de registro: {username}")
        
        if User.query.filter_by(username=username).first():
            warn(M.AUTH, 'WARN', f"Registro falhou - usu√°rio j√° existe", username=username)
            rpa_warn(f"[AUTH] Registro falhou - usu√°rio j√° existe: {username}")
            flash('Nome de usu√°rio j√° existe')
            return redirect(url_for('register'))
            
        user = User(username=username, email=email)
        user.set_password(password)
        db.session.add(user)
        db.session.commit()
        success(M.AUTH, 'SUCCESS', f"Usu√°rio registrado com sucesso", username=username, user_id=user.id)
        rpa_info(f"[AUTH] Usu√°rio registrado: {username} (ID: {user.id})")
        login_user(user)
        return redirect(url_for('dashboard'))
    else:
        nav_log.page_enter("Registro")
        rpa_info("[NAV] P√°gina: Registro")
    return render_template('auth/register.html')

@app.route('/logout')
@login_required
def logout():
    username = current_user.username if current_user else "desconhecido"
    auth_log.logout(username)
    rpa_info(f"[AUTH] Logout: {username}")
    logout_user()
    return redirect(url_for('login'))

@app.route('/storage/<path:object_path>')
def serve_storage_image(object_path):
    """Serve images from Object Storage"""
    try:
        from object_storage import object_storage
        from flask import Response
        
        file_bytes = object_storage.download_file(object_path)
        
        if file_bytes is None:
            print(f"[WARN] Image not found in storage: {object_path}")
            return "Image not found", 404
        
        ext = object_path.split('.')[-1].lower()
        content_types = {
            'jpg': 'image/jpeg',
            'jpeg': 'image/jpeg',
            'png': 'image/png',
            'gif': 'image/gif',
            'webp': 'image/webp'
        }
        content_type = content_types.get(ext, 'application/octet-stream')
        
        return Response(
            file_bytes,
            mimetype=content_type,
            headers={
                'Cache-Control': 'public, max-age=31536000'
            }
        )
    except Exception as e:
        print(f"[ERROR] Failed to serve storage image {object_path}: {e}")
        return "Image not found", 404

def generate_thumbnail(image_data, max_width=300, quality=75):
    """Gera thumbnail a partir de dados de imagem
    
    Args:
        image_data: bytes da imagem original
        max_width: largura m√°xima do thumbnail (default 300px)
        quality: qualidade JPEG (default 75%)
    
    Returns:
        tuple: (thumbnail_bytes, width, height, file_size)
    """
    try:
        img = PILImage.open(io.BytesIO(image_data))
        
        if img.mode in ('RGBA', 'LA', 'P'):
            img = img.convert('RGB')
        
        original_width, original_height = img.size
        if original_width > max_width:
            ratio = max_width / original_width
            new_height = int(original_height * ratio)
            img = img.resize((max_width, new_height), PILImage.Resampling.LANCZOS)
        
        output = io.BytesIO()
        img.save(output, format='JPEG', quality=quality, optimize=True)
        thumbnail_bytes = output.getvalue()
        
        width, height = img.size
        file_size = len(thumbnail_bytes)
        
        print(f"[THUMBNAIL] Gerado: {width}x{height}, {file_size/1024:.1f}KB (original: {original_width}x{original_height})")
        
        return thumbnail_bytes, width, height, file_size
        
    except Exception as e:
        print(f"[ERROR] Falha ao gerar thumbnail: {e}")
        return None, None, None, None

def save_thumbnail_for_image(image_id, image_data):
    """Salva thumbnail no banco de dados para uma imagem
    
    Args:
        image_id: ID da imagem
        image_data: bytes da imagem original
    
    Returns:
        ImageThumbnail ou None
    """
    try:
        existing = ImageThumbnail.query.filter_by(image_id=image_id).first()
        if existing:
            print(f"[THUMBNAIL] J√° existe para imagem {image_id}, pulando...")
            return existing
        
        thumbnail_bytes, width, height, file_size = generate_thumbnail(image_data)
        
        if thumbnail_bytes is None:
            return None
        
        thumbnail = ImageThumbnail(
            image_id=image_id,
            thumbnail_data=thumbnail_bytes,
            width=width,
            height=height,
            file_size=file_size,
            mime_type='image/jpeg'
        )
        db.session.add(thumbnail)
        db.session.commit()
        
        print(f"[THUMBNAIL] Salvo para imagem {image_id}: {file_size/1024:.1f}KB")
        return thumbnail
        
    except Exception as e:
        print(f"[ERROR] Falha ao salvar thumbnail para imagem {image_id}: {e}")
        db.session.rollback()
        return None

@app.route('/thumbnail/<int:image_id>')
def serve_thumbnail(image_id):
    """Serve thumbnail de uma imagem do banco de dados"""
    try:
        thumbnail = ImageThumbnail.query.filter_by(image_id=image_id).first()
        
        if thumbnail and thumbnail.thumbnail_data:
            return Response(
                thumbnail.thumbnail_data,
                mimetype=thumbnail.mime_type or 'image/jpeg',
                headers={
                    'Cache-Control': 'public, max-age=31536000'
                }
            )
        
        image = Image.query.get(image_id)
        if image and image.storage_path:
            from object_storage import object_storage
            file_bytes = object_storage.download_file(image.storage_path)
            if file_bytes:
                save_thumbnail_for_image(image_id, file_bytes)
                thumbnail = ImageThumbnail.query.filter_by(image_id=image_id).first()
                if thumbnail:
                    return Response(
                        thumbnail.thumbnail_data,
                        mimetype='image/jpeg',
                        headers={'Cache-Control': 'public, max-age=31536000'}
                    )
        
        return Response(status=404)
        
    except Exception as e:
        print(f"[ERROR] Falha ao servir thumbnail {image_id}: {e}")
        return Response(status=404)

@app.route('/dashboard')
@login_required
def dashboard():
    nav_log.page_enter("Dashboard", user=current_user.username)
    rpa_info(f"[NAV] Dashboard - Usu√°rio: {current_user.username}")
    total_images = Image.query.count()
    pending_images = Image.query.filter_by(status='Pendente').count()
    pending_ia_images = Image.query.filter_by(status='Pendente An√°lise IA').count()
    approved_images = Image.query.filter_by(status='Aprovado').count()
    rejected_images = Image.query.filter_by(status='Rejeitado').count()
    total_collections = Collection.query.count()
    total_brands = Brand.query.count()
    recent_images = Image.query.order_by(Image.upload_date.desc()).limit(5).all()
    debug(M.DASHBOARD, 'DATA', f"M√©tricas carregadas", imagens=total_images, pendentes=pending_images, colecoes=total_collections)
    
    pending_skus = db.session.query(db.func.count(db.func.distinct(Image.sku_base))).filter(Image.status == 'Pendente').scalar() or 0
    pending_ia_skus = db.session.query(db.func.count(db.func.distinct(Image.sku_base))).filter(Image.status == 'Pendente An√°lise IA').scalar() or 0
    total_skus = db.session.query(db.func.count(db.func.distinct(Image.sku_base))).scalar() or 0
    
    skus_pendentes_foto = []
    total_skus_carteira = 0
    total_skus_sem_foto = 0
    
    colecoes = Collection.query.all()
    for col in colecoes:
        total_col = db.session.query(db.func.count(db.func.distinct(CarteiraCompras.sku))).filter(
            CarteiraCompras.colecao_id == col.id
        ).scalar() or 0
        
        if total_col == 0:
            continue
        
        com_foto_real = db.session.query(db.func.count(db.func.distinct(CarteiraCompras.sku))).filter(
            CarteiraCompras.colecao_id == col.id,
            db.exists().where(
                db.and_(
                    Image.sku_base == CarteiraCompras.sku,
                    Image.collection_id == col.id
                )
            )
        ).scalar() or 0
        
        sem_foto_real = total_col - com_foto_real
        total_skus_carteira += total_col
        total_skus_sem_foto += sem_foto_real
        
        skus_pendentes_foto.append({
            'colecao': col.name,
            'total': total_col,
            'com_foto': com_foto_real,
            'sem_foto': sem_foto_real,
            'percentual': round((com_foto_real / total_col * 100) if total_col > 0 else 0, 1)
        })
    
    return render_template('dashboard/index.html',
                          total_images=total_images,
                          total_skus=total_skus,
                          pending_images=pending_images,
                          pending_skus=pending_skus,
                          pending_ia_images=pending_ia_images,
                          pending_ia_skus=pending_ia_skus,
                          approved_images=approved_images,
                          rejected_images=rejected_images,
                          total_collections=total_collections,
                          total_brands=total_brands,
                          recent_images=recent_images,
                          skus_pendentes_foto=skus_pendentes_foto,
                          total_skus_carteira=total_skus_carteira,
                          total_skus_sem_foto=total_skus_sem_foto)

@app.route('/catalog')
@login_required
def catalog():
    status_filter = request.args.getlist('status')
    collection_filter = request.args.get('collection_id')
    brand_filter = request.args.get('brand_id')
    search_query = request.args.get('q', '').strip()
    page = request.args.get('page', 1, type=int)
    per_page = 20
    
    filters = {'status': status_filter, 'collection': collection_filter, 'brand': brand_filter, 'q': search_query}
    catalog_log.page_accessed(page, filters=filters)
    rpa_info(f"[NAV] Cat√°logo - P√°gina {page} - Usu√°rio: {current_user.username}")
    
    base_query = Image.query
    
    if status_filter:
        base_query = base_query.filter(Image.status.in_(status_filter))
    
    if collection_filter and collection_filter != 'all':
        base_query = base_query.filter_by(collection_id=collection_filter)
    
    if brand_filter and brand_filter != 'all':
        base_query = base_query.filter_by(brand_id=brand_filter)
    
    if search_query:
        search_term = f"%{search_query}%"
        base_query = base_query.filter(
            db.or_(
                Image.sku.ilike(search_term),
                Image.sku_base.ilike(search_term),
                Image.description.ilike(search_term),
                Image.original_name.ilike(search_term),
                Image.ai_item_type.ilike(search_term),
                Image.tags.ilike(search_term)
            )
        )
    
    sku_key_expr = db.func.coalesce(Image.sku_base, Image.sku, db.func.concat('no_sku_', Image.id.cast(db.String)))
    
    sku_subquery = base_query.with_entities(
        sku_key_expr.label('sku_key'),
        db.func.max(Image.upload_date).label('latest_upload')
    ).group_by(sku_key_expr).subquery()
    
    total_skus = db.session.query(db.func.count()).select_from(sku_subquery).scalar() or 0
    total_pages = max(1, (total_skus + per_page - 1) // per_page)
    
    page_skus_query = db.session.query(
        sku_subquery.c.sku_key
    ).order_by(sku_subquery.c.latest_upload.desc()).offset((page - 1) * per_page).limit(per_page).all()
    page_skus = [s[0] for s in page_skus_query]
    
    if page_skus:
        sku_key_filter = db.func.coalesce(Image.sku_base, Image.sku, db.func.concat('no_sku_', Image.id.cast(db.String)))
        page_images_query = Image.query.filter(sku_key_filter.in_(page_skus))
        if status_filter:
            page_images_query = page_images_query.filter(Image.status.in_(status_filter))
        if collection_filter and collection_filter != 'all':
            page_images_query = page_images_query.filter_by(collection_id=collection_filter)
        if brand_filter and brand_filter != 'all':
            page_images_query = page_images_query.filter_by(brand_id=brand_filter)
        if search_query:
            search_term = f"%{search_query}%"
            page_images_query = page_images_query.filter(
                db.or_(
                    Image.sku.ilike(search_term),
                    Image.sku_base.ilike(search_term),
                    Image.description.ilike(search_term),
                    Image.original_name.ilike(search_term),
                    Image.ai_item_type.ilike(search_term),
                    Image.tags.ilike(search_term)
                )
            )
        images_for_page = page_images_query.order_by(Image.sequencia, Image.upload_date.desc()).all()
    else:
        images_for_page = []
    
    sku_groups = {}
    for img in images_for_page:
        sku_key = img.sku_base or img.sku or f"no_sku_{img.id}"
        if sku_key not in sku_groups:
            try:
                tag_list = json.loads(img.tags) if img.tags else []
            except:
                tag_list = []
            sku_groups[sku_key] = {
                'sku_base': sku_key,
                'cover_image': img,
                'images': [],
                'brand': img.brand_ref.name if img.brand_ref else 'Sem Marca',
                'status': img.status,
                'tag_list': tag_list,
                'has_pending': False,
                'has_approved': False,
                'has_rejected': False
            }
        sku_groups[sku_key]['images'].append(img)
        if img.status == 'Pendente' or img.status == 'Pendente An√°lise IA':
            sku_groups[sku_key]['has_pending'] = True
        elif img.status == 'Aprovado':
            sku_groups[sku_key]['has_approved'] = True
        elif img.status == 'Rejeitado':
            sku_groups[sku_key]['has_rejected'] = True
    
    ordered_groups = []
    for sku in page_skus:
        if sku in sku_groups:
            ordered_groups.append(sku_groups[sku])
    
    collections = Collection.query.all()
    brands = Brand.query.order_by(Brand.name).all()
    
    return render_template('images/catalog.html', 
                          sku_groups=ordered_groups,
                          total_skus=total_skus,
                          page=page,
                          total_pages=total_pages,
                          per_page=per_page,
                          collections=collections, 
                          brands=brands, 
                          search_query=search_query)


@app.route('/upload', methods=['GET', 'POST'])
@login_required
def upload():
    rpa_info(f"[NAV] Upload - Usu√°rio: {current_user.username}")
    if request.method == 'POST':
        if 'image' not in request.files:
            flash('Nenhum arquivo enviado')
            return redirect(request.url)
        file = request.files['image']
        if file.filename == '':
            flash('Nenhum arquivo selecionado')
            return redirect(request.url)
        if file and file.filename.split('.')[-1].lower() in app.config['ALLOWED_EXTENSIONS']:
            filename = secure_filename(file.filename)
            timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
            unique_filename = f"{timestamp}_{filename}"
            
            temp_file_path = os.path.join(app.config['UPLOAD_FOLDER'], unique_filename)
            file.save(temp_file_path)
            
            ai_items = []
            try:
                ai_result = analyze_image_with_ai(temp_file_path)
                
                if isinstance(ai_result, str):
                    if ai_result.startswith("AI Configuration missing"):
                        print(f"[WARNING] AI not configured, using defaults")
                    else:
                        print(f"[ERROR] AI analysis failed: {ai_result}")
                    ai_items = []
                else:
                    ai_items = ai_result
            except Exception as e:
                print(f"[ERROR] Exception during AI analysis: {e}")
                ai_items = []
            
            storage_path = None
            try:
                from object_storage import object_storage
                with open(temp_file_path, 'rb') as f:
                    content_type = file.content_type or 'image/jpeg'
                    result = object_storage.upload_file(f, unique_filename, content_type)
                    storage_path = result['storage_path']
                    print(f"[INFO] Image uploaded to Object Storage: {storage_path}")
            except Exception as e:
                print(f"[ERROR] Object Storage upload failed: {e}")
                flash('Erro ao fazer upload para o armazenamento. Tente novamente.')
                return redirect(request.url)
            
            try:
                os.remove(temp_file_path)
                print(f"[INFO] Temporary file deleted: {temp_file_path}")
            except Exception as e:
                print(f"[WARNING] Could not delete temp file: {e}")
            
            import uuid
            unique_code = f"IMG-{uuid.uuid4().hex[:8].upper()}"
            
            first_item = ai_items[0] if ai_items else {}
            first_attrs = first_item.get('attributes', {}) if first_item else {}
            
            brand_id = request.form.get('brand_id')
            new_image = Image(
                filename=unique_filename,
                original_name=file.filename,
                storage_path=storage_path,
                collection_id=request.form.get('collection_id') if request.form.get('collection_id') else None,
                brand_id=int(brand_id) if brand_id else None,
                sku=request.form.get('sku'),
                photographer=request.form.get('photographer'),
                description=request.form.get('observations') or first_item.get('description', ''),
                tags=json.dumps(first_item.get('tags', [])) if first_item else json.dumps([]),
                ai_item_type=first_attrs.get('item_type'),
                ai_color=first_attrs.get('color'),
                ai_material=first_attrs.get('material'),
                ai_pattern=first_attrs.get('pattern'),
                ai_style=first_attrs.get('style'),
                uploader_id=current_user.id,
                unique_code=unique_code,
                status='Pendente'
            )
            db.session.add(new_image)
            db.session.flush()
            
            for item_data in ai_items:
                attrs = item_data.get('attributes', {})
                new_item = ImageItem(
                    image_id=new_image.id,
                    item_order=item_data.get('order', 1),
                    position_ref=item_data.get('position_ref', 'Pe√ßa √önica'),
                    description=item_data.get('description', ''),
                    tags=json.dumps(item_data.get('tags', [])),
                    ai_item_type=attrs.get('item_type'),
                    ai_color=attrs.get('color'),
                    ai_material=attrs.get('material'),
                    ai_pattern=attrs.get('pattern'),
                    ai_style=attrs.get('style')
                )
                db.session.add(new_item)
            
            db.session.commit()
            
            item_count = len(ai_items)
            storage_info = " (Object Storage)" if storage_path else ""
            if item_count > 1:
                flash(f'Imagem enviada com sucesso{storage_info}. {item_count} pe√ßas detectadas e analisadas.')
            elif item_count == 1:
                flash(f'Imagem enviada com sucesso{storage_info}. An√°lise de IA conclu√≠da.')
            else:
                flash(f'Imagem enviada com sucesso{storage_info}. Configure a chave OpenAI em Configura√ß√µes para an√°lise autom√°tica.')
            return redirect(url_for('catalog'))
        else:
            flash('Formato de arquivo n√£o permitido. Use: PNG, JPG, JPEG ou GIF')
            return redirect(request.url)
    collections = Collection.query.order_by(Collection.name).all()
    brands = Brand.query.order_by(Brand.name).all()
    return render_template('images/upload.html', collections=collections, brands=brands)


@app.route('/collections')
@login_required
def collections():
    nav_log.page_enter("Cole√ß√µes", user=current_user.username)
    rpa_info(f"[NAV] Cole√ß√µes - Usu√°rio: {current_user.username}")
    search = request.args.get('search', '')
    season = request.args.get('season', '')
    year = request.args.get('year', '')
    
    query = Collection.query
    
    if search:
        query = query.filter(Collection.name.ilike(f'%{search}%'))
    if season:
        query = query.filter_by(season=season)
    if year:
        query = query.filter_by(year=int(year))
    
    collections = query.order_by(Collection.created_at.desc()).all()
    return render_template('collections/list.html', collections=collections)

@app.route('/collections/<int:id>')
@login_required
def collection_detail(id):
    """P√°gina de detalhes da cole√ß√£o com filtros de subcole√ß√£o"""
    collection = Collection.query.get_or_404(id)
    nav_log.page_enter(f"Cole√ß√£o: {collection.name}", user=current_user.username)
    rpa_info(f"[NAV] Cole√ß√£o: {collection.name} - Usu√°rio: {current_user.username}")
    
    # Buscar subcole√ß√µes desta cole√ß√£o
    subcolecoes = Subcolecao.query.filter_by(colecao_id=id).order_by(Subcolecao.nome).all()
    
    # Filtros
    subcolecao_id = request.args.get('subcolecao_id', type=int)
    status = request.args.get('status', '')
    search = request.args.get('search', '')
    
    # Query de imagens desta cole√ß√£o
    query = Image.query.filter_by(collection_id=id)
    
    if subcolecao_id:
        query = query.filter_by(subcolecao_id=subcolecao_id)
    if status:
        query = query.filter_by(status=status)
    if search:
        query = query.filter(
            (Image.sku.ilike(f'%{search}%')) |
            (Image.description.ilike(f'%{search}%'))
        )
    
    images = query.order_by(Image.upload_date.desc()).all()
    
    # Estat√≠sticas
    total_images = Image.query.filter_by(collection_id=id).count()
    stats = {
        'total': total_images,
        'pendentes': Image.query.filter_by(collection_id=id, status='Pendente').count(),
        'aprovadas': Image.query.filter_by(collection_id=id, status='Aprovado').count(),
        'rejeitadas': Image.query.filter_by(collection_id=id, status='Rejeitado').count(),
        'pendente_ia': Image.query.filter_by(collection_id=id, status='Pendente An√°lise IA').count(),
    }
    
    return render_template('collections/detail.html', 
                           collection=collection, 
                           subcolecoes=subcolecoes,
                           images=images,
                           stats=stats,
                           subcolecao_id=subcolecao_id)

@app.route('/collections/<int:id>/edit', methods=['GET', 'POST'])
@login_required
def edit_collection(id):
    collection = Collection.query.get_or_404(id)
    rpa_info(f"[NAV] Editar Cole√ß√£o: {collection.name} - Usu√°rio: {current_user.username}")
    
    if request.method == 'POST':
        collection.name = request.form.get('name')
        collection.description = request.form.get('description')
        collection.season = request.form.get('season')
        year = request.form.get('year')
        collection.year = int(year) if year else None
        collection.campanha = request.form.get('campanha')
        
        db.session.commit()
        rpa_info(f"[CRUD] Cole√ß√£o atualizada: {collection.name} (ID: {id})")
        flash('Cole√ß√£o atualizada com sucesso!')
        return redirect(url_for('collections'))
    
    current_year = datetime.now().year
    years = list(range(current_year - 2, current_year + 3))
    return render_template('collections/edit.html', collection=collection, years=years)

@app.route('/collections/<int:id>/delete', methods=['POST'])
@login_required
def delete_collection(id):
    collection = Collection.query.get_or_404(id)
    nome = collection.name
    rpa_info(f"[CRUD] Deletando cole√ß√£o: {nome} (ID: {id})")
    db.session.delete(collection)
    db.session.commit()
    rpa_info(f"[CRUD] Cole√ß√£o deletada: {nome}")
    flash('Cole√ß√£o removida com sucesso!')
    return redirect(url_for('collections'))

def normalizar_sku(sku):
    """Normaliza SKU removendo zeros √† esquerda de cada bloco para compara√ß√£o"""
    if not sku:
        return ''
    sku = str(sku).strip().upper()
    partes = sku.split('.')
    normalizadas = []
    for parte in partes:
        if parte.isdigit():
            normalizadas.append(str(int(parte)))
        else:
            normalizadas.append(parte)
    return '.'.join(normalizadas)

def buscar_carteira_por_sku(sku_base):
    """Busca na Carteira com normaliza√ß√£o de SKU"""
    if not sku_base:
        return None
    
    carteira = CarteiraCompras.query.filter_by(sku=sku_base).first()
    if carteira:
        return carteira
    
    sku_normalizado = normalizar_sku(sku_base)
    
    carteiras = CarteiraCompras.query.all()
    for c in carteiras:
        if normalizar_sku(c.sku) == sku_normalizado:
            return c
    
    return None

@app.route('/collections/<int:id>/reprocessar', methods=['POST'])
@login_required
def reprocessar_colecao(id):
    """Reprocessa todas as imagens de uma cole√ß√£o, tentando match com Carteira"""
    collection = Collection.query.get_or_404(id)
    rpa_info(f"[BATCH] Reprocessando cole√ß√£o: {collection.name} (ID: {id})")
    
    carteiras_mesma_colecao = {}
    carteiras_global = {}
    
    for c in CarteiraCompras.query.filter_by(colecao_id=id).all():
        sku_norm = normalizar_sku(c.sku)
        if sku_norm not in carteiras_mesma_colecao:
            carteiras_mesma_colecao[sku_norm] = c
    
    for c in CarteiraCompras.query.all():
        sku_norm = normalizar_sku(c.sku)
        if sku_norm not in carteiras_global:
            carteiras_global[sku_norm] = c
    
    images = Image.query.filter_by(collection_id=id).all()
    reprocessadas = 0
    matched = 0
    matched_mesma_colecao = 0
    
    for img in images:
        if not img.sku_base:
            continue
        
        sku_norm = normalizar_sku(img.sku_base)
        
        carteira = carteiras_mesma_colecao.get(sku_norm)
        if carteira:
            matched_mesma_colecao += 1
        else:
            carteira = carteiras_global.get(sku_norm)
        
        if carteira:
            img.nome_peca = carteira.descricao
            
            if carteira.categoria:
                img.categoria = carteira.categoria
            if carteira.subcategoria:
                img.subcategoria = carteira.subcategoria
            if carteira.tipo_peca:
                img.tipo_peca = carteira.tipo_peca
            if carteira.origem:
                img.origem = carteira.origem
            if carteira.estilista:
                img.estilista = carteira.estilista
            if carteira.referencia_estilo:
                img.referencia_estilo = carteira.referencia_estilo
            
            if carteira.colecao_id:
                img.collection_id = carteira.colecao_id
            if carteira.subcolecao_id:
                img.subcolecao_id = carteira.subcolecao_id
            if carteira.marca_id:
                img.brand_id = carteira.marca_id
            
            if img.status == 'Pendente An√°lise IA':
                img.status = 'Pendente'
            
            carteira.status_foto = 'Com Foto'
            matched += 1
        
        reprocessadas += 1
    
    db.session.commit()
    
    total_carteira_colecao = CarteiraCompras.query.filter_by(colecao_id=id).count()
    rpa_info(f"[BATCH] Reprocessamento conclu√≠do: {reprocessadas} imagens, {matched} matches")
    flash(f'Reprocessadas {reprocessadas} imagens. {matched} com match ({matched_mesma_colecao} da mesma cole√ß√£o). Carteira desta cole√ß√£o: {total_carteira_colecao} itens.')
    return redirect(url_for('collection_detail', id=id))

@app.route('/collections/delete-all', methods=['POST'])
@login_required
def delete_all_collections():
    """Deleta todas as cole√ß√µes"""
    rpa_info("[CRUD] Iniciando dele√ß√£o de TODAS as cole√ß√µes")
    count = Collection.query.count()
    Collection.query.delete()
    db.session.commit()
    rpa_info(f"[CRUD] Todas cole√ß√µes deletadas: {count} removidas")
    flash(f'{count} cole√ß√µes removidas com sucesso!', 'success')
    return redirect(url_for('collections'))

@app.route('/collections/new', methods=['GET', 'POST'])
@login_required
def new_collection():
    nav_log.page_enter("Nova Cole√ß√£o", user=current_user.username)
    rpa_info(f"[NAV] Nova Cole√ß√£o - Usu√°rio: {current_user.username}")
    if request.method == 'POST':
        name = request.form.get('name')
        description = request.form.get('description')
        season = request.form.get('season')
        year = request.form.get('year')
        campanha = request.form.get('campanha')
        
        if not name:
            flash('Nome da cole√ß√£o √© obrigat√≥rio')
            return redirect(url_for('new_collection'))
            
        collection = Collection(
            name=name, 
            description=description,
            season=season,
            year=int(year) if year else None,
            campanha=campanha
        )
        db.session.add(collection)
        db.session.commit()
        crud_log.created("Cole√ß√£o", collection.id, name)
        rpa_info(f"[CRUD] Cole√ß√£o criada: {name} (ID: {collection.id})")
        
        flash('Cole√ß√£o criada com sucesso!')
        return redirect(url_for('collections'))
    
    current_year = datetime.now().year
    years = list(range(current_year - 2, current_year + 3))
    return render_template('collections/new.html', years=years)

# ==================== SUBCOLE√á√ïES / CAMPANHAS ====================

@app.route('/subcolecoes')
@login_required
def subcolecoes():
    rpa_info(f"[NAV] Subcole√ß√µes - Usu√°rio: {current_user.username}")
    colecao_id = request.args.get('colecao_id', '')
    
    query = Subcolecao.query
    
    if colecao_id:
        query = query.filter_by(colecao_id=int(colecao_id))
    
    subcolecoes = query.order_by(Subcolecao.created_at.desc()).all()
    colecoes = Collection.query.order_by(Collection.name).all()
    
    return render_template('subcolecoes/list.html', subcolecoes=subcolecoes, colecoes=colecoes)

@app.route('/subcolecoes/new', methods=['GET', 'POST'])
@login_required
def new_subcolecao():
    rpa_info(f"[NAV] Nova Subcole√ß√£o - Usu√°rio: {current_user.username}")
    # Pegar colecao_id da URL para pr√©-selecionar
    colecao_id_preselect = request.args.get('colecao_id', type=int)
    
    if request.method == 'POST':
        nome = request.form.get('nome', '').strip()
        colecao_id = request.form.get('colecao_id')
        tipo_campanha = request.form.get('tipo_campanha', '').strip() or None
        data_inicio = request.form.get('data_inicio')
        data_fim = request.form.get('data_fim')
        
        if not nome or not colecao_id:
            flash('Nome e Cole√ß√£o s√£o obrigat√≥rios', 'error')
            return redirect(url_for('new_subcolecao', colecao_id=colecao_id_preselect))
        
        # Criar slug
        import re
        slug = re.sub(r'[^a-zA-Z0-9]', '_', nome.upper()).strip('_').lower()
        
        subcolecao = Subcolecao(
            nome=nome,
            slug=slug,
            colecao_id=int(colecao_id),
            tipo_campanha=tipo_campanha,
            data_inicio=datetime.strptime(data_inicio, '%Y-%m-%d').date() if data_inicio else None,
            data_fim=datetime.strptime(data_fim, '%Y-%m-%d').date() if data_fim else None
        )
        db.session.add(subcolecao)
        db.session.commit()
        rpa_info(f"[CRUD] Subcole√ß√£o criada: {nome} (ID: {subcolecao.id})")
        
        flash('Subcole√ß√£o criada com sucesso!', 'success')
        # Redirecionar para p√°gina de detalhes da cole√ß√£o
        return redirect(url_for('collection_detail', id=int(colecao_id)))
    
    colecoes = Collection.query.order_by(Collection.name).all()
    return render_template('subcolecoes/new.html', colecoes=colecoes, colecao_id_preselect=colecao_id_preselect)

@app.route('/subcolecoes/<int:id>/edit', methods=['GET', 'POST'])
@login_required
def edit_subcolecao(id):
    subcolecao = Subcolecao.query.get_or_404(id)
    rpa_info(f"[NAV] Editar Subcole√ß√£o: {subcolecao.nome} - Usu√°rio: {current_user.username}")
    colecao_id_original = subcolecao.colecao_id
    
    if request.method == 'POST':
        subcolecao.nome = request.form.get('nome', '').strip()
        colecao_id = request.form.get('colecao_id')
        subcolecao.colecao_id = int(colecao_id) if colecao_id else subcolecao.colecao_id
        subcolecao.tipo_campanha = request.form.get('tipo_campanha', '').strip() or None
        
        data_inicio = request.form.get('data_inicio')
        data_fim = request.form.get('data_fim')
        subcolecao.data_inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date() if data_inicio else None
        subcolecao.data_fim = datetime.strptime(data_fim, '%Y-%m-%d').date() if data_fim else None
        
        # Atualizar slug
        import re
        subcolecao.slug = re.sub(r'[^a-zA-Z0-9]', '_', subcolecao.nome.upper()).strip('_').lower()
        
        db.session.commit()
        rpa_info(f"[CRUD] Subcole√ß√£o atualizada: {subcolecao.nome} (ID: {id})")
        flash('Subcole√ß√£o atualizada com sucesso!', 'success')
        # Redirecionar para p√°gina de detalhes da cole√ß√£o
        return redirect(url_for('collection_detail', id=subcolecao.colecao_id))
    
    colecoes = Collection.query.order_by(Collection.name).all()
    return render_template('subcolecoes/edit.html', subcolecao=subcolecao, colecoes=colecoes)

@app.route('/subcolecoes/<int:id>/delete', methods=['POST'])
@login_required
def delete_subcolecao(id):
    subcolecao = Subcolecao.query.get_or_404(id)
    nome = subcolecao.nome
    colecao_id = subcolecao.colecao_id
    rpa_info(f"[CRUD] Deletando subcole√ß√£o: {nome} (ID: {id})")
    db.session.delete(subcolecao)
    db.session.commit()
    rpa_info(f"[CRUD] Subcole√ß√£o deletada: {nome}")
    flash('Subcole√ß√£o removida com sucesso!', 'success')
    return redirect(url_for('collection_detail', id=colecao_id))


@app.route('/image/<int:id>')
@login_required
def image_detail(id):
    image = Image.query.get_or_404(id)
    rpa_info(f"[NAV] Detalhe Imagem ID:{id} SKU:{image.sku or 'N/A'} - Usu√°rio: {current_user.username}")
    try:
        image.tag_list = json.loads(image.tags) if image.tags else []
    except:
        image.tag_list = []
    
    for item in image.items:
        try:
            item.tag_list = json.loads(item.tags) if item.tags else []
        except:
            item.tag_list = []
    
    sku_key = image.sku_base or image.sku
    group_images = []
    if sku_key:
        group_images = Image.query.filter(
            db.or_(Image.sku_base == sku_key, Image.sku == sku_key)
        ).order_by(Image.sequencia, Image.upload_date).all()
    
    if len(group_images) <= 1:
        group_images = []
    
    current_index = 0
    for i, img in enumerate(group_images):
        if img.id == image.id:
            current_index = i
            break
    
    prev_image = group_images[current_index - 1] if group_images and current_index > 0 else None
    next_image = group_images[current_index + 1] if group_images and current_index < len(group_images) - 1 else None
    
    return render_template('images/detail.html', 
                          image=image, 
                          group_images=group_images,
                          current_index=current_index,
                          prev_image=prev_image,
                          next_image=next_image)

@app.route('/image/<int:id>/delete', methods=['POST'])
@login_required
def delete_image(id):
    image = Image.query.get_or_404(id)
    sku = image.sku or 'N/A'
    rpa_info(f"[CRUD] Deletando imagem ID:{id} SKU:{sku}")
    
    try:
        file_path = os.path.join(app.config['UPLOAD_FOLDER'], image.filename)
        if os.path.exists(file_path):
            os.remove(file_path)
    except Exception as e:
        rpa_error(f"[CRUD] Erro ao deletar arquivo da imagem {id}: {str(e)}", exc=e, regiao="catalog")
        
    db.session.delete(image)
    db.session.commit()
    rpa_info(f"[CRUD] Imagem deletada: ID:{id} SKU:{sku}")
    
    flash('Imagem deletada com sucesso')
    return redirect(url_for('catalog'))

@app.route('/image/<int:id>/status/<status>', methods=['POST'])
@login_required
def update_image_status(id, status):
    image = Image.query.get_or_404(id)
    valid_statuses = ['Pendente', 'Aprovado', 'Rejeitado']
    old_status = image.status
    if status in valid_statuses:
        image.status = status
        db.session.commit()
        rpa_info(f"[STATUS] Imagem ID:{id} alterada: {old_status} -> {status}")
        flash(f'Status atualizado para {status}')
    else:
        rpa_warn(f"[STATUS] Tentativa de status inv√°lido para imagem {id}: {status}")
        flash('Status inv√°lido')
    return redirect(url_for('image_detail', id=id))

def analyze_single_image(image, selected_fields=None):
    """Analyze a single image and update its AI fields. Returns (success, error_message)
    
    selected_fields: Lista de campos a atualizar. Op√ß√µes: descricao, tags, cor, tipo, material
    Se None ou vazio, atualiza todos os campos.
    """
    if selected_fields is None:
        selected_fields = ['descricao', 'tags', 'cor', 'tipo', 'material']
    temp_file_path = None
    file_path = None
    image_url = None
    
    try:
        if image.storage_path:
            from object_storage import object_storage
            import tempfile
            
            file_bytes = object_storage.download_file(image.storage_path)
            if file_bytes:
                ext = os.path.splitext(image.filename)[1] or '.jpg'
                fd, temp_file_path = tempfile.mkstemp(suffix=ext)
                os.write(fd, file_bytes)
                os.close(fd)
                file_path = temp_file_path
            else:
                domain = os.environ.get('REPLIT_DEV_DOMAIN', '')
                storage_key = image.storage_path.lstrip('/')
                if storage_key.startswith('storage/'):
                    storage_key = storage_key[8:]
                if domain:
                    image_url = f"https://{domain}/storage/{storage_key}"
                else:
                    image_url = url_for('serve_storage_image', object_path=storage_key, _external=True)
        
        if not file_path and not image_url:
            file_path = os.path.join(app.config['UPLOAD_FOLDER'], image.filename)
        
        if not file_path and not image_url:
            return False, 'Arquivo n√£o encontrado'
        
        if file_path and not os.path.exists(file_path) and not image_url:
            if image.storage_path:
                domain = os.environ.get('REPLIT_DEV_DOMAIN', '')
                storage_key = image.storage_path.lstrip('/')
                if storage_key.startswith('storage/'):
                    storage_key = storage_key[8:]
                if domain:
                    image_url = f"https://{domain}/storage/{storage_key}"
                else:
                    image_url = url_for('serve_storage_image', object_path=storage_key, _external=True)
        
        use_url = image_url is not None
        image_source = image_url if use_url else file_path
        
        if not image_source:
            return False, 'Arquivo n√£o encontrado'
        
        ai_result = analyze_image_with_context(
            image_source, 
            sku=image.sku,
            collection_id=image.collection_id,
            brand_id=image.brand_id,
            subcolecao_id=image.subcolecao_id,
            is_url=use_url
        )
        
        if isinstance(ai_result, str):
            return False, ai_result
        
        ai_items = ai_result
        first_item = ai_items[0] if ai_items else {}
        first_attrs = first_item.get('attributes', {}) if first_item else {}
        first_carteira = first_item.get('carteira', {}) if first_item else {}
        
        if 'descricao' in selected_fields:
            image.description = first_item.get('description', '')
        
        if 'tags' in selected_fields:
            new_tags = first_item.get('tags', []) if first_item else []
            if image.nome_peca and image.nome_peca not in new_tags:
                new_tags.insert(0, image.nome_peca)
            if image.subcolecao_rel and image.subcolecao_rel.nome and image.subcolecao_rel.nome not in new_tags:
                new_tags.append(image.subcolecao_rel.nome)
            if image.collection and image.collection.name and image.collection.name not in new_tags:
                new_tags.append(image.collection.name)
            image.tags = json.dumps(new_tags)
        
        if 'tipo' in selected_fields:
            image.ai_item_type = first_attrs.get('item_type')
        
        if 'cor' in selected_fields:
            image.ai_color = first_attrs.get('color')
        
        if 'material' in selected_fields:
            image.ai_material = first_attrs.get('material')
        
        image.ai_pattern = first_attrs.get('pattern')
        image.ai_style = first_attrs.get('style')
        
        if first_carteira:
            if first_carteira.get('categoria') and not image.categoria:
                image.categoria = first_carteira.get('categoria')
            if first_carteira.get('subcategoria') and not image.subcategoria:
                image.subcategoria = first_carteira.get('subcategoria')
            if first_carteira.get('tipo_peca') and not image.tipo_peca:
                image.tipo_peca = first_carteira.get('tipo_peca')
            if first_carteira.get('origem') and not image.origem:
                image.origem = first_carteira.get('origem')
        
        existing_items = ImageItem.query.filter_by(image_id=image.id).order_by(ImageItem.item_order).all()
        
        all_fields_selected = set(selected_fields) == {'descricao', 'tags', 'cor', 'tipo', 'material'}
        
        if all_fields_selected or not existing_items:
            ImageItem.query.filter_by(image_id=image.id).delete()
            
            for item_data in ai_items:
                attrs = item_data.get('attributes', {})
                item_tags = item_data.get('tags', [])
                if image.nome_peca and image.nome_peca not in item_tags:
                    item_tags.insert(0, image.nome_peca)
                if image.subcolecao_rel and image.subcolecao_rel.nome and image.subcolecao_rel.nome not in item_tags:
                    item_tags.append(image.subcolecao_rel.nome)
                if image.collection and image.collection.name and image.collection.name not in item_tags:
                    item_tags.append(image.collection.name)
                new_item = ImageItem(
                    image_id=image.id,
                    item_order=item_data.get('order', 1),
                    position_ref=item_data.get('position_ref', 'Pe√ßa √önica'),
                    description=item_data.get('description', ''),
                    tags=json.dumps(item_tags),
                    ai_item_type=attrs.get('item_type'),
                    ai_color=attrs.get('color'),
                    ai_material=attrs.get('material'),
                    ai_pattern=attrs.get('pattern'),
                    ai_style=attrs.get('style')
                )
                db.session.add(new_item)
        else:
            for existing_item in existing_items:
                if ai_items:
                    ai_data = ai_items[0]
                    attrs = ai_data.get('attributes', {})
                    
                    if 'descricao' in selected_fields:
                        existing_item.description = ai_data.get('description', '')
                    if 'tags' in selected_fields:
                        item_tags = ai_data.get('tags', [])
                        if image.nome_peca and image.nome_peca not in item_tags:
                            item_tags.insert(0, image.nome_peca)
                        if image.subcolecao_rel and image.subcolecao_rel.nome and image.subcolecao_rel.nome not in item_tags:
                            item_tags.append(image.subcolecao_rel.nome)
                        if image.collection and image.collection.name and image.collection.name not in item_tags:
                            item_tags.append(image.collection.name)
                        existing_item.tags = json.dumps(item_tags)
                    if 'tipo' in selected_fields:
                        existing_item.ai_item_type = attrs.get('item_type')
                    if 'cor' in selected_fields:
                        existing_item.ai_color = attrs.get('color')
                    if 'material' in selected_fields:
                        existing_item.ai_material = attrs.get('material')
                    
                    existing_item.ai_pattern = attrs.get('pattern')
                    existing_item.ai_style = attrs.get('style')
        
        db.session.commit()
        return True, None
        
    except Exception as e:
        print(f"[ERROR] Analysis failed for image {image.id}: {e}")
        return False, str(e)
    
    finally:
        if temp_file_path and os.path.exists(temp_file_path):
            try:
                os.remove(temp_file_path)
            except Exception:
                pass


@app.route('/image/<int:id>/reanalyze', methods=['POST'])
@login_required
def reanalyze_image(id):
    rpa_info(f"[AI] Reanalisando imagem ID:{id}")
    image = Image.query.get_or_404(id)
    
    selected_fields = request.form.getlist('fields')
    all_fields = request.form.get('all_fields') == 'on'
    
    if all_fields or not selected_fields:
        selected_fields = ['descricao', 'tags', 'cor', 'tipo', 'material']
    
    print(f"[AI] Selected fields for analysis: {selected_fields}")
    
    images_to_analyze = [image]
    if image.sku_base:
        group_images = Image.query.filter(
            Image.sku_base == image.sku_base,
            Image.id != image.id
        ).order_by(Image.sequencia).all()
        images_to_analyze.extend(group_images)
    
    total = len(images_to_analyze)
    success_count = 0
    error_count = 0
    first_error = None
    
    print(f"[AI] Starting group analysis for {total} images (sku_base: {image.sku_base})")
    
    for idx, img in enumerate(images_to_analyze, 1):
        print(f"[AI] Analyzing image {idx}/{total}: {img.filename}")
        success, error = analyze_single_image(img, selected_fields)
        if success:
            success_count += 1
        else:
            error_count += 1
            if not first_error:
                first_error = error
    
    if total == 1:
        if success_count == 1:
            flash('Imagem analisada com sucesso!')
        else:
            if first_error and first_error.startswith("AI Configuration missing"):
                flash('Chave OpenAI n√£o configurada. Acesse Configura√ß√µes para adicionar.')
            else:
                flash(f'Erro na an√°lise: {first_error}')
    else:
        if error_count == 0:
            flash(f'Grupo analisado com sucesso! {success_count} imagens processadas.')
        elif success_count == 0:
            if first_error and first_error.startswith("AI Configuration missing"):
                flash('Chave OpenAI n√£o configurada. Acesse Configura√ß√µes para adicionar.')
            else:
                flash(f'Erro ao analisar grupo: {first_error}')
        else:
            flash(f'An√°lise parcial: {success_count} sucesso, {error_count} erro(s).')
    
    return redirect(url_for('image_detail', id=id))


@app.route('/image/<int:image_id>/item/<int:item_id>/delete', methods=['POST'])
@login_required
def delete_image_item(image_id, item_id):
    rpa_info(f"[CRUD] Deletando item {item_id} da imagem {image_id}")
    """Deletar uma pe√ßa individual detectada pela IA"""
    item = ImageItem.query.filter_by(id=item_id, image_id=image_id).first_or_404()
    
    db.session.delete(item)
    db.session.commit()
    
    flash('Pe√ßa removida com sucesso!')
    return redirect(url_for('image_detail', id=image_id))


@app.route('/image/<int:id>/edit', methods=['GET', 'POST'])
@login_required
def edit_image(id):
    rpa_info(f"[NAV] Editar Imagem ID:{id} - Usu√°rio: {current_user.username}")
    image = Image.query.get_or_404(id)
    
    if request.method == 'POST':
        image.sku = request.form.get('sku')
        image.description = request.form.get('description')
        image.photographer = request.form.get('photographer')
        
        collection_id = request.form.get('collection_id')
        image.collection_id = int(collection_id) if collection_id else None
        
        brand_id = request.form.get('brand_id')
        image.brand_id = int(brand_id) if brand_id else None
        
        shooting_date = request.form.get('shooting_date')
        if shooting_date:
            try:
                image.shooting_date = datetime.strptime(shooting_date, '%Y-%m-%d')
            except ValueError:
                pass
        
        db.session.commit()
        flash('Imagem atualizada com sucesso!')
        return redirect(url_for('image_detail', id=id))
    
    collections = Collection.query.order_by(Collection.name).all()
    brands = Brand.query.order_by(Brand.name).all()
    return render_template('images/edit.html', image=image, collections=collections, brands=brands)

@app.route('/brands')
@login_required
def brands():
    nav_log.page_enter("Marcas", user=current_user.username)
    rpa_info(f"[NAV] Marcas - Usu√°rio: {current_user.username}")
    brands = Brand.query.order_by(Brand.name).all()
    return render_template('brands/list.html', brands=brands)

@app.route('/brands/new', methods=['GET', 'POST'])
@login_required
def new_brand():
    nav_log.page_enter("Nova Marca", user=current_user.username)
    rpa_info(f"[NAV] Nova Marca - Usu√°rio: {current_user.username}")
    if request.method == 'POST':
        name = request.form.get('name')
        description = request.form.get('description')
        
        if not name:
            flash('Nome da marca √© obrigat√≥rio')
            return redirect(url_for('new_brand'))
        
        if Brand.query.filter_by(name=name).first():
            flash('Marca j√° existe')
            return redirect(url_for('new_brand'))
            
        brand = Brand(name=name, description=description)
        db.session.add(brand)
        db.session.commit()
        crud_log.created("Marca", brand.id, name)
        rpa_info(f"[CRUD] Marca criada: {name} (ID: {brand.id})")
        
        flash('Marca criada com sucesso!')
        return redirect(url_for('brands'))
        
    return render_template('brands/new.html')

@app.route('/analytics')
@login_required
def analytics():
    nav_log.page_enter("Analytics", user=current_user.username)
    rpa_info(f"[NAV] Analytics - Usu√°rio: {current_user.username}")
    total_images = Image.query.count()
    pending_images = Image.query.filter_by(status='Pendente').count()
    approved_images = Image.query.filter_by(status='Aprovado').count()
    rejected_images = Image.query.filter_by(status='Rejeitado').count()
    total_collections = Collection.query.count()
    total_brands = Brand.query.count()
    
    return render_template('analytics/index.html', 
                          total_images=total_images,
                          pending_images=pending_images,
                          approved_images=approved_images,
                          rejected_images=rejected_images,
                          total_collections=total_collections,
                          total_brands=total_brands)

@app.route('/integrations')
@login_required
def integrations():
    rpa_info(f"[NAV] Integra√ß√µes - Usu√°rio: {current_user.username}")
    return render_template('integrations/index.html')

@app.route('/settings', methods=['GET', 'POST'])
@login_required
def settings():
    rpa_info(f"[NAV] Configura√ß√µes - Usu√°rio: {current_user.username}")
    if request.method == 'POST':
        api_key = request.form.get('api_key')
        
        config = SystemConfig.query.filter_by(key='OPENAI_API_KEY').first()
        if config:
            config.value = api_key
        else:
            config = SystemConfig(key='OPENAI_API_KEY', value=api_key)
            db.session.add(config)
            
        db.session.commit()
        rpa_info("[CONFIG] Configura√ß√µes atualizadas")
        flash('Settings updated successfully')
        return redirect(url_for('settings'))
        
    config = SystemConfig.query.filter_by(key='OPENAI_API_KEY').first()
    current_key = config.value if config else ''
    return render_template('admin/settings.html', current_key=current_key)

@app.route('/reports')
@login_required
def reports():
    rpa_info(f"[NAV] Relat√≥rios - Usu√°rio: {current_user.username}")
    total_images = Image.query.count()
    images_with_sku = Image.query.filter(Image.sku.isnot(None), Image.sku != '').count()
    images_without_sku = total_images - images_with_sku
    
    pending_images = Image.query.filter_by(status='Pendente').count()
    approved_images = Image.query.filter_by(status='Aprovado').count()
    rejected_images = Image.query.filter_by(status='Rejeitado').count()
    
    images_with_ai = Image.query.filter(Image.ai_item_type.isnot(None)).count()
    images_without_ai = total_images - images_with_ai
    
    brands = Brand.query.all()
    brands_stats = []
    for brand in brands:
        count = Image.query.filter_by(brand_id=brand.id).count()
        approved = Image.query.filter_by(brand_id=brand.id, status='Aprovado').count()
        pending = Image.query.filter_by(brand_id=brand.id, status='Pendente').count()
        brands_stats.append({
            'name': brand.name,
            'total': count,
            'approved': approved,
            'pending': pending
        })
    
    collections = Collection.query.all()
    collections_stats = []
    for collection in collections:
        count = Image.query.filter_by(collection_id=collection.id).count()
        collections_stats.append({
            'name': collection.name,
            'total': count
        })
    
    recent_uploads = Image.query.order_by(Image.upload_date.desc()).limit(10).all()
    
    return render_template('reports/index.html',
                          total_images=total_images,
                          images_with_sku=images_with_sku,
                          images_without_sku=images_without_sku,
                          pending_images=pending_images,
                          approved_images=approved_images,
                          rejected_images=rejected_images,
                          images_with_ai=images_with_ai,
                          images_without_ai=images_without_ai,
                          brands_stats=brands_stats,
                          collections_stats=collections_stats,
                          recent_uploads=recent_uploads)

@app.route('/skus-sem-foto')
@login_required
def skus_sem_foto():
    """Lista SKUs da Carteira que n√£o t√™m imagem cadastrada NA MESMA COLE√á√ÉO"""
    rpa_info(f"[NAV] SKUs Sem Foto - Usu√°rio: {current_user.username}")
    page = request.args.get('page', 1, type=int)
    colecao_filter = request.args.get('colecao', type=int)
    per_page = 50
    
    query = db.session.query(
        CarteiraCompras.sku,
        CarteiraCompras.colecao_id,
        Collection.name.label('colecao'),
        Brand.name.label('marca'),
        CarteiraCompras.categoria,
        CarteiraCompras.subcategoria
    ).outerjoin(Collection, CarteiraCompras.colecao_id == Collection.id
    ).outerjoin(Brand, CarteiraCompras.marca_id == Brand.id
    ).filter(
        ~db.exists().where(
            db.and_(
                Image.sku_base == CarteiraCompras.sku,
                Image.collection_id == CarteiraCompras.colecao_id
            )
        )
    )
    
    if colecao_filter:
        query = query.filter(CarteiraCompras.colecao_id == colecao_filter)
    
    query = query.distinct().order_by(CarteiraCompras.sku)
    
    pagination = query.paginate(page=page, per_page=per_page, error_out=False)
    
    skus_sem_foto = []
    for row in pagination.items:
        skus_sem_foto.append({
            'sku': row.sku,
            'colecao': row.colecao,
            'marca': row.marca,
            'categoria': row.categoria,
            'subcategoria': row.subcategoria
        })
    
    total_carteira = db.session.query(db.func.count(db.func.distinct(CarteiraCompras.sku))).scalar() or 0
    total_com_foto = db.session.query(db.func.count(db.func.distinct(CarteiraCompras.sku))).filter(
        db.exists().where(
            db.and_(
                Image.sku_base == CarteiraCompras.sku,
                Image.collection_id == CarteiraCompras.colecao_id
            )
        )
    ).scalar() or 0
    total_sem_foto = total_carteira - total_com_foto
    percentual = round((total_com_foto / total_carteira * 100) if total_carteira > 0 else 0, 1)
    
    colecoes = Collection.query.order_by(Collection.name).all()
    
    return render_template('reports/skus_sem_foto.html',
                          skus_sem_foto=skus_sem_foto,
                          pagination=pagination,
                          colecao_filter=colecao_filter,
                          colecoes=colecoes,
                          total_carteira=total_carteira,
                          total_com_foto=total_com_foto,
                          total_sem_foto=total_sem_foto,
                          percentual=percentual)

@app.route('/skus-sem-foto/exportar')
@login_required
def exportar_skus_sem_foto():
    rpa_info(f"[EXPORT] Exportando SKUs sem foto - Usu√°rio: {current_user.username}")
    """Exporta CSV com SKUs que n√£o t√™m foto NA MESMA COLE√á√ÉO"""
    output = io.StringIO()
    writer = csv.writer(output)
    
    writer.writerow(['SKU', 'Cole√ß√£o', 'Marca', 'Categoria', 'Subcategoria'])
    
    skus = db.session.query(
        CarteiraCompras.sku,
        Collection.name.label('colecao'),
        Brand.name.label('marca'),
        CarteiraCompras.categoria,
        CarteiraCompras.subcategoria
    ).outerjoin(Collection, CarteiraCompras.colecao_id == Collection.id
    ).outerjoin(Brand, CarteiraCompras.marca_id == Brand.id
    ).filter(
        ~db.exists().where(
            db.and_(
                Image.sku_base == CarteiraCompras.sku,
                Image.collection_id == CarteiraCompras.colecao_id
            )
        )
    ).distinct().order_by(CarteiraCompras.sku).all()
    
    for row in skus:
        writer.writerow([
            row.sku,
            row.colecao or '',
            row.marca or '',
            row.categoria or '',
            row.subcategoria or ''
        ])
    
    output.seek(0)
    response = make_response(output.getvalue())
    response.headers['Content-Disposition'] = 'attachment; filename=skus_sem_foto.csv'
    response.headers['Content-type'] = 'text/csv; charset=utf-8'
    return response

@app.route('/reports/export/<report_type>')
@login_required
def export_report(report_type):
    rpa_info(f"[EXPORT] Exportando relat√≥rio: {report_type} - Usu√°rio: {current_user.username}")
    output = io.StringIO()
    writer = csv.writer(output)
    
    if report_type == 'all':
        writer.writerow(['ID', 'C√≥digo √önico', 'SKU', 'Nome Original', 'Marca', 'Cole√ß√£o', 'Status', 'Tipo IA', 'Cor IA', 'Material IA', 'Fot√≥grafo', 'Data Upload'])
        images = Image.query.order_by(Image.upload_date.desc()).all()
        for img in images:
            writer.writerow([
                img.id,
                img.unique_code or '',
                img.sku or '',
                img.original_name,
                img.brand_ref.name if img.brand_ref else '',
                img.collection.name if img.collection else '',
                img.status,
                img.ai_item_type or '',
                img.ai_color or '',
                img.ai_material or '',
                img.photographer or '',
                img.upload_date.strftime('%Y-%m-%d %H:%M')
            ])
        filename = 'todas_imagens.csv'
        
    elif report_type == 'pending':
        writer.writerow(['ID', 'C√≥digo √önico', 'SKU', 'Nome Original', 'Marca', 'Cole√ß√£o', 'Data Upload'])
        images = Image.query.filter_by(status='Pendente').order_by(Image.upload_date.desc()).all()
        for img in images:
            writer.writerow([
                img.id,
                img.unique_code or '',
                img.sku or '',
                img.original_name,
                img.brand_ref.name if img.brand_ref else '',
                img.collection.name if img.collection else '',
                img.upload_date.strftime('%Y-%m-%d %H:%M')
            ])
        filename = 'imagens_pendentes.csv'
        
    elif report_type == 'without_sku':
        writer.writerow(['ID', 'C√≥digo √önico', 'Nome Original', 'Marca', 'Status', 'Data Upload'])
        images = Image.query.filter(db.or_(Image.sku.is_(None), Image.sku == '')).order_by(Image.upload_date.desc()).all()
        for img in images:
            writer.writerow([
                img.id,
                img.unique_code or '',
                img.original_name,
                img.brand_ref.name if img.brand_ref else '',
                img.status,
                img.upload_date.strftime('%Y-%m-%d %H:%M')
            ])
        filename = 'imagens_sem_sku.csv'
        
    elif report_type == 'approved':
        writer.writerow(['ID', 'C√≥digo √önico', 'SKU', 'Nome Original', 'Marca', 'Cole√ß√£o', 'Data Upload'])
        images = Image.query.filter_by(status='Aprovado').order_by(Image.upload_date.desc()).all()
        for img in images:
            writer.writerow([
                img.id,
                img.unique_code or '',
                img.sku or '',
                img.original_name,
                img.brand_ref.name if img.brand_ref else '',
                img.collection.name if img.collection else '',
                img.upload_date.strftime('%Y-%m-%d %H:%M')
            ])
        filename = 'imagens_aprovadas.csv'
    
    elif report_type == 'without_ai':
        writer.writerow(['ID', 'C√≥digo √önico', 'SKU', 'Nome Original', 'Marca', 'Status', 'Data Upload'])
        images = Image.query.filter(Image.ai_item_type.is_(None)).order_by(Image.upload_date.desc()).all()
        for img in images:
            writer.writerow([
                img.id,
                img.unique_code or '',
                img.sku or '',
                img.original_name,
                img.brand_ref.name if img.brand_ref else '',
                img.status,
                img.upload_date.strftime('%Y-%m-%d %H:%M')
            ])
        filename = 'imagens_sem_analise_ia.csv'
    
    else:
        return redirect(url_for('reports'))
    
    output.seek(0)
    response = make_response(output.getvalue())
    response.headers['Content-Disposition'] = f'attachment; filename={filename}'
    response.headers['Content-type'] = 'text/csv; charset=utf-8'
    return response

# ==================== PRODUTOS ====================

@app.route('/produtos')
@login_required
def produtos():
    nav_log.page_enter("Produtos", user=current_user.username)
    rpa_info(f"[NAV] Produtos - Usu√°rio: {current_user.username}")
    search = request.args.get('search', '')
    marca_id = request.args.get('marca_id', '')
    colecao_id = request.args.get('colecao_id', '')
    status_foto = request.args.get('status_foto', '')
    
    query = Produto.query.filter_by(ativo=True)
    
    if search:
        search_term = f'%{search}%'
        query = query.filter(db.or_(
            Produto.sku.ilike(search_term),
            Produto.descricao.ilike(search_term),
            Produto.cor.ilike(search_term)
        ))
    
    if marca_id:
        query = query.filter_by(marca_id=int(marca_id))
    
    if colecao_id:
        query = query.filter_by(colecao_id=int(colecao_id))
    
    if status_foto == 'com_foto':
        query = query.filter_by(tem_foto=True)
    elif status_foto == 'sem_foto':
        query = query.filter_by(tem_foto=False)
    
    produtos_list = query.order_by(Produto.created_at.desc()).all()
    marcas = Brand.query.order_by(Brand.name).all()
    colecoes = Collection.query.order_by(Collection.name).all()
    
    # Estat√≠sticas
    total_produtos = Produto.query.filter_by(ativo=True).count()
    com_foto = Produto.query.filter_by(ativo=True, tem_foto=True).count()
    sem_foto = Produto.query.filter_by(ativo=True, tem_foto=False).count()
    
    return render_template('produtos/list.html', 
                          produtos=produtos_list, 
                          marcas=marcas, 
                          colecoes=colecoes,
                          search_query=search,
                          total_produtos=total_produtos,
                          com_foto=com_foto,
                          sem_foto=sem_foto)

@app.route('/produtos/new', methods=['GET', 'POST'])
@login_required
def new_produto():
    rpa_info(f"[NAV] Novo Produto - Usu√°rio: {current_user.username}")
    if request.method == 'POST':
        sku = request.form.get('sku', '').strip()
        descricao = request.form.get('descricao', '').strip()
        cor = request.form.get('cor', '').strip()
        categoria = request.form.get('categoria', '').strip()
        atributos = request.form.get('atributos_tecnicos', '').strip()
        marca_id = request.form.get('marca_id')
        colecao_id = request.form.get('colecao_id')
        
        if not sku or not descricao:
            flash('SKU e Descri√ß√£o s√£o obrigat√≥rios')
            return redirect(url_for('new_produto'))
        
        if Produto.query.filter_by(sku=sku).first():
            flash('SKU j√° cadastrado')
            return redirect(url_for('new_produto'))
        
        produto = Produto(
            sku=sku,
            descricao=descricao,
            cor=cor,
            categoria=categoria,
            atributos_tecnicos=atributos,
            marca_id=int(marca_id) if marca_id else None,
            colecao_id=int(colecao_id) if colecao_id else None
        )
        db.session.add(produto)
        db.session.commit()
        
        flash('Produto cadastrado com sucesso!')
        return redirect(url_for('produtos'))
    
    marcas = Brand.query.order_by(Brand.name).all()
    colecoes = Collection.query.order_by(Collection.name).all()
    return render_template('produtos/new.html', marcas=marcas, colecoes=colecoes)

@app.route('/produtos/<int:id>/edit', methods=['GET', 'POST'])
@login_required
def edit_produto(id):
    rpa_info(f"[NAV] Editar Produto ID:{id} - Usu√°rio: {current_user.username}")
    produto = Produto.query.get_or_404(id)
    
    if request.method == 'POST':
        sku_novo = request.form.get('sku', '').strip()
        sku_antigo = produto.sku
        motivo = request.form.get('motivo_alteracao', '').strip()
        
        # Se SKU mudou, registrar no hist√≥rico
        if sku_novo != sku_antigo:
            if not motivo:
                flash('Informe o motivo da altera√ß√£o do SKU')
                return redirect(url_for('edit_produto', id=id))
            
            existing = Produto.query.filter_by(sku=sku_novo).first()
            if existing and existing.id != produto.id:
                flash('SKU j√° existe em outro produto')
                return redirect(url_for('edit_produto', id=id))
            
            # Registrar hist√≥rico
            historico = HistoricoSKU(
                produto_id=produto.id,
                sku_antigo=sku_antigo,
                sku_novo=sku_novo,
                motivo=motivo,
                usuario_id=current_user.id
            )
            db.session.add(historico)
            produto.sku = sku_novo
            
            # Atualizar SKU na carteira de compras se existir
            carteira_item = CarteiraCompras.query.filter_by(sku=sku_antigo).first()
            if carteira_item:
                carteira_item.sku = sku_novo
        
        produto.descricao = request.form.get('descricao', '').strip()
        produto.cor = request.form.get('cor', '').strip()
        produto.categoria = request.form.get('categoria', '').strip()
        produto.atributos_tecnicos = request.form.get('atributos_tecnicos', '').strip()
        
        marca_id = request.form.get('marca_id')
        produto.marca_id = int(marca_id) if marca_id else None
        
        colecao_id = request.form.get('colecao_id')
        produto.colecao_id = int(colecao_id) if colecao_id else None
        
        db.session.commit()
        flash('Produto atualizado com sucesso!')
        return redirect(url_for('produtos'))
    
    marcas = Brand.query.order_by(Brand.name).all()
    colecoes = Collection.query.order_by(Collection.name).all()
    
    # Imagens associadas ao produto
    imagens_associadas = Image.query.join(ImagemProduto).filter(ImagemProduto.produto_id == produto.id).all()
    
    # Imagens dispon√≠veis para associar (n√£o associadas ainda)
    imagens_associadas_ids = [img.id for img in imagens_associadas]
    imagens_disponiveis = Image.query.filter(~Image.id.in_(imagens_associadas_ids) if imagens_associadas_ids else True).order_by(Image.upload_date.desc()).limit(50).all()
    
    # Hist√≥rico de altera√ß√µes de SKU
    historico_sku = HistoricoSKU.query.filter_by(produto_id=produto.id).order_by(HistoricoSKU.data_alteracao.desc()).all()
    
    return render_template('produtos/edit.html', 
                          produto=produto, 
                          marcas=marcas, 
                          colecoes=colecoes,
                          imagens_associadas=imagens_associadas,
                          imagens_disponiveis=imagens_disponiveis,
                          historico_sku=historico_sku)

@app.route('/produtos/<int:id>/delete', methods=['POST'])
@login_required
def delete_produto(id):
    rpa_info(f"[CRUD] Deletando produto ID:{id}")
    produto = Produto.query.get_or_404(id)
    produto.ativo = False  # Soft delete
    db.session.commit()
    flash('Produto removido com sucesso')
    return redirect(url_for('produtos'))

@app.route('/produtos/delete-all', methods=['POST'])
@login_required
def delete_all_produtos():
    rpa_info("[CRUD] Iniciando dele√ß√£o de TODOS os produtos")
    """Deleta todos os produtos (soft delete)"""
    count = Produto.query.filter_by(ativo=True).count()
    Produto.query.filter_by(ativo=True).update({'ativo': False})
    db.session.commit()
    flash(f'{count} produtos removidos com sucesso!', 'success')
    return redirect(url_for('produtos'))

@app.route('/produtos/export')
@login_required
def export_produtos_csv():
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(['SKU', 'Descri√ß√£o', 'Cor', 'Categoria', 'Atributos T√©cnicos', 'Marca', 'Cole√ß√£o', 'Tem Foto', 'Data Cadastro'])
    
    produtos = Produto.query.filter_by(ativo=True).order_by(Produto.sku).all()
    for p in produtos:
        writer.writerow([
            p.sku,
            p.descricao,
            p.cor or '',
            p.categoria or '',
            p.atributos_tecnicos or '',
            p.marca.name if p.marca else '',
            p.colecao.name if p.colecao else '',
            'Sim' if p.tem_foto else 'N√£o',
            p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else ''
        ])
    
    output.seek(0)
    response = make_response(output.getvalue())
    response.headers['Content-Disposition'] = 'attachment; filename=produtos.csv'
    response.headers['Content-type'] = 'text/csv; charset=utf-8'
    return response

@app.route('/produtos/<int:id>/associar-imagem', methods=['POST'])
@login_required
def associar_imagem_produto(id):
    produto = Produto.query.get_or_404(id)
    imagem_id = request.form.get('imagem_id')
    
    if not imagem_id:
        flash('Selecione uma imagem')
        return redirect(url_for('edit_produto', id=id))
    
    # Verificar se j√° existe associa√ß√£o
    existing = ImagemProduto.query.filter_by(
        imagem_id=int(imagem_id), 
        produto_id=produto.id
    ).first()
    
    if existing:
        flash('Imagem j√° est√° associada a este produto')
        return redirect(url_for('edit_produto', id=id))
    
    associacao = ImagemProduto(
        imagem_id=int(imagem_id),
        produto_id=produto.id
    )
    db.session.add(associacao)
    produto.tem_foto = True
    
    # Atualizar status na carteira se existir
    carteira_item = CarteiraCompras.query.filter_by(sku=produto.sku).first()
    if carteira_item:
        carteira_item.status_foto = 'Com Foto'
        carteira_item.produto_id = produto.id
    
    db.session.commit()
    
    flash('Imagem associada com sucesso!')
    return redirect(url_for('edit_produto', id=id))

@app.route('/produtos/<int:id>/desassociar-imagem/<int:imagem_id>', methods=['POST'])
@login_required
def desassociar_imagem_produto(id, imagem_id):
    produto = Produto.query.get_or_404(id)
    
    # Remover associa√ß√£o
    associacao = ImagemProduto.query.filter_by(
        imagem_id=imagem_id, 
        produto_id=produto.id
    ).first()
    
    if associacao:
        db.session.delete(associacao)
        
        # Verificar se ainda tem fotos associadas
        remaining = ImagemProduto.query.filter_by(produto_id=produto.id).count()
        if remaining == 0:
            produto.tem_foto = False
            # Atualizar status na carteira
            carteira_item = CarteiraCompras.query.filter_by(sku=produto.sku).first()
            if carteira_item:
                carteira_item.status_foto = 'Sem Foto'
        
        db.session.commit()
        flash('Imagem desassociada com sucesso!')
    else:
        flash('Associa√ß√£o n√£o encontrada')
    
    return redirect(url_for('edit_produto', id=id))

# ==================== CARTEIRA DE COMPRAS ====================

@app.route('/carteira')
@login_required
def carteira():
    nav_log.page_enter("Carteira de Compras", user=current_user.username)
    rpa_info(f"[NAV] Carteira de Compras - Usu√°rio: {current_user.username}")
    status = request.args.get('status', '')
    search = request.args.get('search', '')
    lote = request.args.get('lote', '')
    
    query = CarteiraCompras.query
    
    if status:
        query = query.filter_by(status_foto=status)
    
    if lote:
        query = query.filter_by(lote_importacao=lote)
    
    if search:
        search_term = f'%{search}%'
        query = query.filter(db.or_(
            CarteiraCompras.sku.ilike(search_term),
            CarteiraCompras.descricao.ilike(search_term)
        ))
    
    itens = query.order_by(CarteiraCompras.data_importacao.desc()).all()
    
    # Estat√≠sticas
    total = CarteiraCompras.query.count()
    com_foto = CarteiraCompras.query.filter_by(status_foto='Com Foto').count()
    sem_foto = CarteiraCompras.query.filter_by(status_foto='Sem Foto').count()
    pendente = CarteiraCompras.query.filter_by(status_foto='Pendente').count()
    
    # Listar lotes √∫nicos
    lotes = db.session.query(
        CarteiraCompras.lote_importacao,
        db.func.count(CarteiraCompras.id).label('total_itens'),
        db.func.min(CarteiraCompras.data_importacao).label('data_importacao')
    ).filter(
        CarteiraCompras.lote_importacao.isnot(None)
    ).group_by(
        CarteiraCompras.lote_importacao
    ).order_by(
        db.desc('data_importacao')
    ).all()
    
    return render_template('carteira/list.html', 
                          itens_carteira=itens,
                          total_carteira=total,
                          com_foto=com_foto,
                          sem_foto=sem_foto,
                          pendente=pendente,
                          search_query=search,
                          lotes=lotes,
                          lote_selecionado=lote)

@app.route('/carteira/lote/<lote_id>/delete', methods=['POST'])
@login_required
def deletar_lote_carteira(lote_id):
    """Deleta todos os itens de um lote de importa√ß√£o"""
    log_start(M.CARTEIRA, f"Exclus√£o de lote: {lote_id}")
    rpa_info(f"[CARTEIRA] Iniciando exclus√£o do lote: {lote_id}")
    try:
        itens = CarteiraCompras.query.filter_by(lote_importacao=lote_id).all()
        count = len(itens)
        
        for item in itens:
            db.session.delete(item)
        
        db.session.commit()
        log_end(M.CARTEIRA, f"Lote {lote_id} exclu√≠do: {count} itens removidos")
        rpa_info(f"[CARTEIRA] Lote {lote_id} exclu√≠do: {count} itens removidos")
        flash(f'Lote "{lote_id}" deletado com sucesso! {count} itens removidos.', 'success')
    except Exception as e:
        db.session.rollback()
        log_error(M.CARTEIRA, f"Exclus√£o de lote {lote_id}", str(e))
        rpa_error(f"[CARTEIRA] Erro ao excluir lote {lote_id}: {str(e)}", exc=e, regiao="carteira")
        flash(f'Erro ao deletar lote: {str(e)}', 'error')
    
    return redirect(url_for('carteira'))

@app.route('/carteira/limpar-tudo', methods=['POST'])
@login_required
def limpar_toda_carteira():
    """Limpa toda a carteira de compras"""
    log_start(M.CARTEIRA, "Limpeza completa da carteira")
    rpa_info("[CARTEIRA] Iniciando limpeza completa da carteira")
    try:
        count = CarteiraCompras.query.count()
        CarteiraCompras.query.delete()
        db.session.commit()
        log_end(M.CARTEIRA, f"Carteira limpa: {count} itens removidos")
        rpa_info(f"[CARTEIRA] Limpeza completa: {count} itens removidos")
        flash(f'Carteira limpa com sucesso! {count} itens removidos.', 'success')
    except Exception as e:
        db.session.rollback()
        log_error(M.CARTEIRA, "Limpeza da carteira", str(e))
        rpa_error(f"[CARTEIRA] Erro na limpeza: {str(e)}", exc=e, regiao="carteira")
        flash(f'Erro ao limpar carteira: {str(e)}', 'error')
    
    return redirect(url_for('carteira'))

def normalizar_nome_coluna(nome):
    """Remove acentos, espa√ßos extras e converte para min√∫sculas para compara√ß√£o"""
    import unicodedata
    if not isinstance(nome, str):
        return str(nome).lower().strip()
    nome = unicodedata.normalize('NFD', nome)
    nome = ''.join(c for c in nome if unicodedata.category(c) != 'Mn')
    return nome.lower().strip()

def normalizar_carteira_dataframe(df):
    """
    Normaliza um DataFrame da carteira, mapeando colunas do Excel para o padr√£o do sistema.
    Regras: case-insensitive, ignora acentos e espa√ßos extras.
    
    Retorna: (df_normalizado, sku_encontrado: bool)
    """
    import pandas as pd
    
    mapeamento_sku = ['referencia e cor', 'refer√™ncia e cor', 'referencia ns + cor', 'refer√™ncia ns + cor', 'sku', 'codigo', 'c√≥digo', 'ref']
    mapeamento_descricao = ['nome', 'nome produto', 'descricao', 'descri√ß√£o', 'produto']
    mapeamento_cor = ['nome / cor', 'nome/cor', 'cor', 'cor produto']
    mapeamento_categoria = ['grupo', 'categoria', 'departamento', 'tipo']
    mapeamento_subcategoria = ['subgrupo', 'subcategoria', 'sub categoria', 'subtipo']
    mapeamento_subcolecao_campanha = ['entrada', 'campanha', 'subcole√ß√£o', 'subcolecao']  # Subcole√ß√£o/Campanha
    mapeamento_colecao = ['colecao', 'cole√ß√£o', 'temporada', 'season']  # Cole√ß√£o (normalmente vem da aba)
    mapeamento_marca = ['marca', 'brand', 'grife', 'fabricante']
    mapeamento_estilista = ['estilista', 'designer', 'criador']
    mapeamento_shooting = ['quando', 'shooting', 'data shooting', 'foto quando']
    mapeamento_observacoes = ['obs', 'observacoes', 'observa√ß√µes', 'notas', 'comentarios']
    mapeamento_origem = ['nacional / importado', 'nacional/importado', 'origem', 'procedencia']
    mapeamento_foto = ['foto', 'tem foto', 'status foto']
    mapeamento_okr = ['okr', 'status okr', 'aprovacao']
    mapeamento_quantidade = ['quantidade', 'qtd', 'qty', 'quant']
    mapeamento_posicao = ['top/bottom/inteiro', 'top / bottom / inteiro', 'posicao', 'posi√ß√£o', 'tipo peca']
    mapeamento_ref_estilo = ['referencia estilo', 'refer√™ncia estilo', 'ref estilo', 'codigo estilo', 'c√≥digo estilo']
    
    colunas_originais = {normalizar_nome_coluna(col): col for col in df.columns}
    
    novo_mapeamento = {}
    
    def encontrar_coluna(lista_nomes):
        for nome in lista_nomes:
            if nome in colunas_originais:
                return colunas_originais[nome]
        return None
    
    col_sku = encontrar_coluna(mapeamento_sku)
    col_descricao = encontrar_coluna(mapeamento_descricao)
    col_cor = encontrar_coluna(mapeamento_cor)
    col_categoria = encontrar_coluna(mapeamento_categoria)
    col_subcategoria = encontrar_coluna(mapeamento_subcategoria)
    col_subcolecao_campanha = encontrar_coluna(mapeamento_subcolecao_campanha)  # ENTRADA = Subcole√ß√£o
    col_colecao = encontrar_coluna(mapeamento_colecao)
    col_marca = encontrar_coluna(mapeamento_marca)
    col_estilista = encontrar_coluna(mapeamento_estilista)
    col_shooting = encontrar_coluna(mapeamento_shooting)
    col_observacoes = encontrar_coluna(mapeamento_observacoes)
    col_origem = encontrar_coluna(mapeamento_origem)
    col_foto = encontrar_coluna(mapeamento_foto)
    col_okr = encontrar_coluna(mapeamento_okr)
    col_quantidade = encontrar_coluna(mapeamento_quantidade)
    col_posicao = encontrar_coluna(mapeamento_posicao)
    col_ref_estilo = encontrar_coluna(mapeamento_ref_estilo)
    
    if col_sku:
        novo_mapeamento[col_sku] = 'sku'
    if col_descricao:
        novo_mapeamento[col_descricao] = 'descricao'
    if col_cor:
        novo_mapeamento[col_cor] = 'cor'
    if col_categoria:
        novo_mapeamento[col_categoria] = 'categoria'
    if col_subcategoria:
        novo_mapeamento[col_subcategoria] = 'subcategoria'
    if col_subcolecao_campanha:
        novo_mapeamento[col_subcolecao_campanha] = 'subcolecao_nome'  # ENTRADA = Subcole√ß√£o/Campanha
    if col_colecao:
        novo_mapeamento[col_colecao] = 'colecao_nome'
    if col_marca:
        novo_mapeamento[col_marca] = 'marca_nome'
    if col_estilista:
        novo_mapeamento[col_estilista] = 'estilista'
    if col_shooting:
        novo_mapeamento[col_shooting] = 'shooting'
    if col_observacoes:
        novo_mapeamento[col_observacoes] = 'observacoes'
    if col_origem:
        novo_mapeamento[col_origem] = 'origem'
    if col_foto:
        novo_mapeamento[col_foto] = 'status_foto_original'
    if col_okr:
        novo_mapeamento[col_okr] = 'okr'
    if col_quantidade:
        novo_mapeamento[col_quantidade] = 'quantidade'
    if col_posicao:
        novo_mapeamento[col_posicao] = 'posicao_peca'
    if col_ref_estilo:
        novo_mapeamento[col_ref_estilo] = 'referencia_estilo'
    
    df_normalizado = df.rename(columns=novo_mapeamento)
    
    sku_encontrado = 'sku' in df_normalizado.columns
    
    # DEBUG: Mostrar colunas detectadas
    print(f"[DEBUG] Colunas originais: {list(df.columns)}")
    print(f"[DEBUG] Mapeamento: {novo_mapeamento}")
    print(f"[DEBUG] Colunas normalizadas: {list(df_normalizado.columns)}")
    print(f"[DEBUG] col_marca={col_marca}, col_colecao={col_colecao}")
    
    return df_normalizado, sku_encontrado

def extrair_ano_estacao(nome_colecao):
    """Extrai ano e esta√ß√£o do nome da cole√ß√£o (ex: 'INVERNO 2026' ‚Üí ano=2026, estacao='Inverno')"""
    import re
    if not nome_colecao:
        return None, None
    
    nome_upper = nome_colecao.upper().strip()
    
    match_ano = re.search(r'\b(20\d{2})\b', nome_upper)
    ano = int(match_ano.group(1)) if match_ano else None
    
    estacao = None
    if 'INVERNO' in nome_upper:
        estacao = 'Inverno'
    elif 'VERAO' in nome_upper or 'VER√ÉO' in nome_upper:
        estacao = 'Ver√£o'
    elif 'PRIMAVERA' in nome_upper:
        estacao = 'Primavera'
    elif 'OUTONO' in nome_upper:
        estacao = 'Outono'
    elif 'ALTO VERAO' in nome_upper or 'ALTO VER√ÉO' in nome_upper:
        estacao = 'Alto Ver√£o'
    elif 'CRUISE' in nome_upper or 'RESORT' in nome_upper:
        estacao = 'Resort'
    
    return ano, estacao

def obter_ou_criar_colecao(nome_colecao, contadores):
    """Busca ou cria uma cole√ß√£o pelo nome. Retorna o ID da cole√ß√£o."""
    if not nome_colecao or not nome_colecao.strip():
        return None
    
    nome_normalizado = nome_colecao.strip().upper()
    
    colecao = Collection.query.filter(
        db.func.upper(Collection.name) == nome_normalizado
    ).first()
    
    if colecao:
        return colecao.id
    
    ano, estacao = extrair_ano_estacao(nome_colecao)
    
    nova_colecao = Collection(
        name=nome_colecao.strip().title(),
        description=f'Cole√ß√£o criada automaticamente via importa√ß√£o de carteira',
        year=ano,
        season=estacao
    )
    db.session.add(nova_colecao)
    db.session.flush()
    contadores['colecoes_criadas'] += 1
    return nova_colecao.id

def extrair_marca_do_nome_arquivo(nome_arquivo):
    """
    Extrai a marca do nome do arquivo usando padr√µes comuns.
    Prioriza a √öLTIMA palavra totalmente em mai√∫sculas (geralmente √© a marca).
    Ex: "Carteira diversas cole√ß√£o SOUQ.xlsx" -> "SOUQ"
    Ex: "Carteira MKT ANIMALE Inverno 26.xlsx" -> "ANIMALE"
    Ex: "SOUQ Inverno 2025.xlsx" -> "SOUQ"
    """
    import re
    
    if not nome_arquivo:
        return None
    
    nome = os.path.splitext(nome_arquivo)[0]
    
    palavras_ignorar = ['carteira', 'diversas', 'cole√ß√£o', 'colecao', 'inverno', 'verao', 'ver√£o', 
                        'primavera', 'outono', 'alto', 'preview', 'lancamento', 'lan√ßamento',
                        '2024', '2025', '2026', '24', '25', '26', '24-25', '25-26', '26-27',
                        'mkt', 'marketing', 'xlsx', 'csv', 'planilha', 'dados', 'lista']
    
    palavras = re.findall(r'[A-Za-z√Ä-√ø]+', nome)
    
    palavras_maiusculas = []
    for palavra in palavras:
        if len(palavra) >= 3 and palavra.isupper() and palavra.lower() not in palavras_ignorar:
            palavras_maiusculas.append(palavra)
    
    if palavras_maiusculas:
        return palavras_maiusculas[-1].upper()
    
    for palavra in reversed(palavras):
        if len(palavra) >= 4 and palavra.lower() not in palavras_ignorar:
            if palavra[0].isupper():
                return palavra.upper()
    
    return None

def obter_ou_criar_marca(nome_marca, contadores):
    """Busca ou cria uma marca pelo nome. Retorna o ID da marca."""
    if not nome_marca or not nome_marca.strip():
        return None
    
    nome_normalizado = nome_marca.strip().upper()
    
    marca = Brand.query.filter(
        db.func.upper(Brand.name) == nome_normalizado
    ).first()
    
    if marca:
        return marca.id
    
    nova_marca = Brand(
        name=nome_marca.strip().title(),
        description=f'Marca criada automaticamente via importa√ß√£o de carteira'
    )
    db.session.add(nova_marca)
    db.session.flush()
    contadores['marcas_criadas'] += 1
    return nova_marca.id

def obter_ou_criar_subcolecao(nome_subcolecao, colecao_id, contadores):
    """
    Busca ou cria uma subcole√ß√£o/campanha pelo nome dentro de uma cole√ß√£o.
    Retorna o ID da subcole√ß√£o.
    """
    if not nome_subcolecao or not str(nome_subcolecao).strip():
        return None
    if not colecao_id:
        return None
    
    nome_str = str(nome_subcolecao).strip()
    nome_normalizado = nome_str.upper()
    
    # Ignorar valores inv√°lidos
    if nome_normalizado in ['-', '0', 'NAN', 'NONE', '']:
        return None
    
    # Criar slug para busca
    import re
    slug = re.sub(r'[^a-zA-Z0-9]', '_', nome_normalizado.lower()).strip('_')
    
    # Buscar subcole√ß√£o existente na mesma cole√ß√£o
    subcolecao = Subcolecao.query.filter(
        db.func.upper(Subcolecao.nome) == nome_normalizado,
        Subcolecao.colecao_id == colecao_id
    ).first()
    
    if subcolecao:
        return subcolecao.id
    
    # Determinar tipo de campanha baseado no nome
    tipo_campanha = None
    if 'DDM' in nome_normalizado or 'DIA DAS M' in nome_normalizado:
        tipo_campanha = 'Dia das M√£es'
    elif 'NATAL' in nome_normalizado:
        tipo_campanha = 'Natal'
    elif 'REVEILLON' in nome_normalizado or 'ANO NOVO' in nome_normalizado:
        tipo_campanha = 'R√©veillon'
    elif 'LANCAMENTO' in nome_normalizado or 'LAN√áAMENTO' in nome_normalizado:
        tipo_campanha = 'Lan√ßamento'
    elif 'COLECAO' in nome_normalizado or 'COLE√á√ÉO' in nome_normalizado:
        tipo_campanha = 'Cole√ß√£o Principal'
    elif 'PREVIEW' in nome_normalizado:
        tipo_campanha = 'Preview'
    elif 'DROP' in nome_normalizado:
        tipo_campanha = 'Drop'
    elif 'PERENE' in nome_normalizado:
        tipo_campanha = 'Perene'
    elif 'ATACADO' in nome_normalizado:
        tipo_campanha = 'Atacado'
    elif 'ALTO VERAO' in nome_normalizado or 'ALTO VER√ÉO' in nome_normalizado:
        tipo_campanha = 'Alto Ver√£o'
    
    nova_subcolecao = Subcolecao(
        nome=nome_str.title(),
        slug=slug,
        tipo_campanha=tipo_campanha,
        colecao_id=colecao_id
    )
    db.session.add(nova_subcolecao)
    db.session.flush()
    contadores['subcolecoes_criadas'] = contadores.get('subcolecoes_criadas', 0) + 1
    return nova_subcolecao.id

def obter_ou_criar_produto(sku, dados_linha, contadores, marca_id=None, colecao_id=None, subcolecao_id=None, cache_produtos=None):
    """Busca ou cria um produto pelo SKU. Retorna o ID do produto."""
    import pandas as pd
    import json
    
    if not sku or not sku.strip():
        return None
    
    sku = sku.strip()
    
    # Verificar cache local primeiro (evita duplicatas na mesma importa√ß√£o)
    if cache_produtos is not None and sku in cache_produtos:
        return cache_produtos[sku]
    
    # Buscar QUALQUER produto com esse SKU (ativo ou inativo)
    produto = Produto.query.filter_by(sku=sku).first()
    
    if produto:
        # Se existe mas estava inativo, reativar
        if not produto.ativo:
            produto.ativo = True
            contadores['produtos_criados'] += 1
        
        # Atualizar marca, cole√ß√£o e subcole√ß√£o se ainda n√£o tiver
        if marca_id and not produto.marca_id:
            produto.marca_id = marca_id
        if colecao_id and not produto.colecao_id:
            produto.colecao_id = colecao_id
        if subcolecao_id and not produto.subcolecao_id:
            produto.subcolecao_id = subcolecao_id
        
        db.session.flush()
        
        # Adicionar ao cache
        if cache_produtos is not None:
            cache_produtos[sku] = produto.id
        
        return produto.id
    
    # Produto n√£o existe, criar novo
    descricao = str(dados_linha.get('descricao', ''))[:255] if pd.notna(dados_linha.get('descricao', '')) else sku
    cor = str(dados_linha.get('cor', ''))[:50] if pd.notna(dados_linha.get('cor', '')) else None
    categoria = str(dados_linha.get('categoria', ''))[:100] if pd.notna(dados_linha.get('categoria', '')) else None
    
    # Guardar informa√ß√µes extras em atributos_tecnicos como JSON
    atributos_extras = {}
    if pd.notna(dados_linha.get('subcategoria', '')):
        atributos_extras['subcategoria'] = str(dados_linha.get('subcategoria', ''))[:100]
    atributos_extras['origem'] = 'Importa√ß√£o Carteira'
    
    novo_produto = Produto(
        sku=sku,
        descricao=descricao if descricao else sku,
        cor=cor,
        categoria=categoria,
        marca_id=marca_id,
        colecao_id=colecao_id,
        subcolecao_id=subcolecao_id,
        atributos_tecnicos=json.dumps(atributos_extras) if atributos_extras else None,
        tem_foto=False
    )
    db.session.add(novo_produto)
    db.session.flush()
    contadores['produtos_criados'] += 1
    
    # Adicionar ao cache
    if cache_produtos is not None:
        cache_produtos[sku] = novo_produto.id
    
    return novo_produto.id

def processar_linhas_carteira(df, lote_id, aba_origem, contadores=None, cache_produtos=None, tipo_carteira='Moda', marca_fallback=None):
    """
    Processa linhas do DataFrame e insere/atualiza na CarteiraCompras.
    Auto-cria Cole√ß√µes (baseado no nome da ABA), Subcole√ß√µes (baseado em ENTRADA), Marcas e Produtos.
    
    IMPORTANTE:
    - aba_origem = Nome da ABA do Excel = COLE√á√ÉO (ex: "Ver√£o 24-25", "Inverno 26")
    - coluna ENTRADA = SUBCOLE√á√ÉO/CAMPANHA (ex: "Lan√ßamento", "DDM", "Natal")
    
    Args:
        df: DataFrame normalizado
        lote_id: ID do lote de importa√ß√£o
        aba_origem: Nome da aba de origem (ser√° usado como COLE√á√ÉO)
        contadores: Dicion√°rio para rastrear entidades criadas
        cache_produtos: Cache de produtos j√° criados nesta importa√ß√£o
        tipo_carteira: Tipo de carteira (Moda, Acess√≥rios, Home)
        marca_fallback: Marca extra√≠da do nome do arquivo (usado quando n√£o h√° coluna MARCA)
    
    Returns:
        (count, skus_invalidos): Quantidade de itens criados e linhas ignoradas
    """
    import pandas as pd
    
    log_start(M.CARTEIRA, f"Processando aba: {aba_origem}")
    rpa_info(f"[CARTEIRA] Processando aba: {aba_origem} ({len(df)} linhas)")
    total_linhas = len(df)
    
    if contadores is None:
        contadores = {
            'colecoes_criadas': 0,
            'subcolecoes_criadas': 0,
            'marcas_criadas': 0,
            'produtos_criados': 0
        }
    
    if cache_produtos is None:
        cache_produtos = {}
    
    cache_subcolecoes = {}
    
    count = 0
    skus_invalidos = 0
    
    colecao_id = obter_ou_criar_colecao(aba_origem, contadores) if aba_origem and aba_origem != 'CSV' else None
    
    marca_fallback_id = None
    if marca_fallback:
        marca_fallback_id = obter_ou_criar_marca(marca_fallback, contadores)
        print(f"[INFO] Marca extra√≠da do nome do arquivo: {marca_fallback}")
    
    for idx, row in df.iterrows():
        sku = str(row.get('sku', '')).strip() if pd.notna(row.get('sku', '')) else ''
        
        if not sku or sku.upper() in ['SKUS', 'SKU', 'NAN', 'NONE', '']:
            skus_invalidos += 1
            continue
        
        sku = sku.rstrip('.00').rstrip('.0').strip()
        
        nome_subcolecao = str(row.get('subcolecao_nome', '')).strip() if pd.notna(row.get('subcolecao_nome', '')) else None
        nome_marca = str(row.get('marca_nome', '')).strip() if pd.notna(row.get('marca_nome', '')) else None
        
        # Criar/obter subcole√ß√£o (requer colecao_id)
        subcolecao_id = None
        if nome_subcolecao and colecao_id:
            cache_key = f"{colecao_id}:{nome_subcolecao.upper()}"
            if cache_key in cache_subcolecoes:
                subcolecao_id = cache_subcolecoes[cache_key]
            else:
                subcolecao_id = obter_ou_criar_subcolecao(nome_subcolecao, colecao_id, contadores)
                cache_subcolecoes[cache_key] = subcolecao_id
        
        marca_id = obter_ou_criar_marca(nome_marca, contadores) if nome_marca else marca_fallback_id
        produto_id = obter_ou_criar_produto(sku, row, contadores, marca_id=marca_id, colecao_id=colecao_id, subcolecao_id=subcolecao_id, cache_produtos=cache_produtos)
        
        # IMPORTANTE: Verificar exist√™ncia por SKU + COLE√á√ÉO (um mesmo SKU pode existir em m√∫ltiplas cole√ß√µes)
        if colecao_id:
            existing = CarteiraCompras.query.filter_by(sku=sku, colecao_id=colecao_id).first()
        else:
            existing = CarteiraCompras.query.filter_by(sku=sku).first()
        
        if existing:
            # Atualizar registro existente na mesma cole√ß√£o
            existing.lote_importacao = lote_id
            existing.aba_origem = aba_origem
            if subcolecao_id:
                existing.subcolecao_id = subcolecao_id
            if marca_id:
                existing.marca_id = marca_id
            if produto_id:
                existing.produto_id = produto_id
            existing.colecao_nome = aba_origem
        else:
            status_foto_original = str(row.get('status_foto_original', '')).upper() if pd.notna(row.get('status_foto_original', '')) else ''
            if 'SIM' in status_foto_original or 'YES' in status_foto_original or 'S' == status_foto_original:
                status_foto = 'Com Foto'
            elif 'NAO' in status_foto_original or 'N√ÉO' in status_foto_original or 'NO' in status_foto_original or 'N' == status_foto_original:
                status_foto = 'Sem Foto'
            else:
                status_foto = 'Pendente'
            
            try:
                qtd = int(float(row.get('quantidade', 1))) if pd.notna(row.get('quantidade', 1)) else 1
            except (ValueError, TypeError):
                qtd = 1
            
            categoria_val = str(row.get('categoria', ''))[:100] if pd.notna(row.get('categoria', '')) else None
            subcategoria_val = str(row.get('subcategoria', ''))[:100] if pd.notna(row.get('subcategoria', '')) else None
            posicao_val = str(row.get('posicao_peca', ''))[:50] if pd.notna(row.get('posicao_peca', '')) else None
            ref_estilo_val = str(row.get('referencia_estilo', ''))[:50] if pd.notna(row.get('referencia_estilo', '')) else None
            
            item = CarteiraCompras(
                sku=sku,
                descricao=str(row.get('descricao', ''))[:255] if pd.notna(row.get('descricao', '')) else None,
                cor=str(row.get('cor', ''))[:100] if pd.notna(row.get('cor', '')) else None,
                categoria=categoria_val,
                subcategoria=subcategoria_val,
                colecao_nome=aba_origem[:100] if aba_origem else None,  # Cole√ß√£o = nome da aba
                colecao_id=colecao_id,
                subcolecao_id=subcolecao_id,  # Subcole√ß√£o = ENTRADA
                marca_id=marca_id,
                estilista=str(row.get('estilista', ''))[:255] if pd.notna(row.get('estilista', '')) else None,
                shooting=str(row.get('shooting', ''))[:100] if pd.notna(row.get('shooting', '')) else None,
                observacoes=str(row.get('observacoes', '')) if pd.notna(row.get('observacoes', '')) else None,
                origem=str(row.get('origem', ''))[:50] if pd.notna(row.get('origem', '')) else None,
                okr=str(row.get('okr', ''))[:20] if pd.notna(row.get('okr', '')) else None,
                quantidade=qtd,
                status_foto=status_foto,
                lote_importacao=lote_id,
                aba_origem=aba_origem,
                produto_id=produto_id,
                material=categoria_val,
                tipo_peca=subcategoria_val,
                posicao_peca=posicao_val,
                referencia_estilo=ref_estilo_val,
                tipo_carteira=tipo_carteira
            )
            
            if produto_id:
                produto = Produto.query.get(produto_id)
                if produto and produto.tem_foto:
                    item.status_foto = 'Com Foto'
            
            db.session.add(item)
            count += 1
            
            if count % 100 == 0:
                log_progress(M.CARTEIRA, "Importa√ß√£o", count, total_linhas)
    
    log_end(M.CARTEIRA, f"Aba {aba_origem}: {count} registros")
    return count, skus_invalidos

def reconciliar_imagens_com_carteira():
    """Busca match na Carteira para imagens que n√£o tiveram match anteriormente.
    Sobrescreve dados da IA pelos dados da Carteira quando encontra match.
    Retorna quantidade de imagens reconciliadas."""
    
    imagens_sem_match = Image.query.filter(
        db.or_(
            Image.nome_peca.is_(None),
            Image.nome_peca == ''
        )
    ).all()
    
    reconciliadas = 0
    
    for img in imagens_sem_match:
        if not img.sku_base:
            continue
        
        carteira = CarteiraCompras.query.filter_by(sku=img.sku_base).first()
        
        if carteira:
            img.nome_peca = carteira.descricao
            
            if carteira.categoria:
                img.categoria = carteira.categoria
            if carteira.subcategoria:
                img.subcategoria = carteira.subcategoria
            if carteira.tipo_peca:
                img.tipo_peca = carteira.tipo_peca
            if carteira.origem:
                img.origem = carteira.origem
            if carteira.material:
                img.ai_material = carteira.material
            if carteira.estilista:
                img.estilista = carteira.estilista
            if carteira.referencia_estilo:
                img.referencia_estilo = carteira.referencia_estilo
            
            if carteira.colecao_id:
                img.collection_id = carteira.colecao_id
            if carteira.subcolecao_id:
                img.subcolecao_id = carteira.subcolecao_id
            if carteira.marca_id:
                img.brand_id = carteira.marca_id
            
            if img.status == 'Pendente An√°lise IA':
                img.status = 'Pendente'
            
            carteira.status_foto = 'Com Foto'
            
            for item in img.items:
                if not item.description or item.description == '':
                    item.description = carteira.descricao
                if carteira.tipo_peca:
                    item.ai_item_type = carteira.tipo_peca
                if carteira.material:
                    item.ai_material = carteira.material
            
            reconciliadas += 1
            print(f"[RECONCILE] Image {img.id} ({img.sku_base}) matched with Carteira: {carteira.descricao[:50]}...")
    
    if reconciliadas > 0:
        db.session.commit()
    
    return reconciliadas


@app.route('/carteira/reconciliar', methods=['POST'])
@login_required
def reconciliar_carteira():
    """Endpoint para reconciliar imagens com a Carteira."""
    carteira_log.reconciliation_started()
    rpa_info("[CARTEIRA] Iniciando reconcilia√ß√£o de imagens")
    reconciliadas = reconciliar_imagens_com_carteira()
    carteira_log.reconciliation_completed(reconciliadas)
    rpa_info(f"[CARTEIRA] Reconcilia√ß√£o conclu√≠da: {reconciliadas} imagens atualizadas")
    
    if reconciliadas > 0:
        flash(f'{reconciliadas} imagem(ns) reconciliada(s) com a Carteira!')
    else:
        flash('Nenhuma imagem para reconciliar.')
    
    return redirect(url_for('listar_carteira'))


@app.route('/carteira/importar', methods=['GET', 'POST'])
@login_required
def importar_carteira():
    if request.method == 'GET':
        nav_log.page_enter("Importar Carteira", user=current_user.username)
        rpa_info(f"[NAV] Importar Carteira - Usu√°rio: {current_user.username}")
    if request.method == 'POST':
        if 'arquivo' not in request.files:
            flash('Nenhum arquivo enviado', 'error')
            rpa_warn("[CARTEIRA] Importa√ß√£o falhou - nenhum arquivo enviado")
            return redirect(request.url)
        
        file = request.files['arquivo']
        if file.filename == '':
            flash('Nenhum arquivo selecionado', 'error')
            return redirect(request.url)
        
        filename = file.filename.lower()
        if not (filename.endswith('.csv') or filename.endswith('.xlsx') or filename.endswith('.xls')):
            flash('Apenas arquivos CSV ou Excel (.xlsx, .xls) s√£o permitidos', 'error')
            return redirect(request.url)
        
        try:
            import uuid
            import pandas as pd
            
            lote_id = f"LOTE-{datetime.now().strftime('%Y%m%d%H%M%S')}-{uuid.uuid4().hex[:4].upper()}"
            aba_selecionada = request.form.get('aba', '')
            importar_todas = request.form.get('importar_todas', '') == 'true'
            tipo_carteira = request.form.get('tipo_carteira', 'Moda')
            
            carteira_log.import_started(file.filename, aba_selecionada if aba_selecionada else 'todas')
            
            marca_do_arquivo = extrair_marca_do_nome_arquivo(file.filename)
            
            total_count = 0
            total_invalidos = 0
            abas_processadas = []
            
            contadores = {
                'colecoes_criadas': 0,
                'marcas_criadas': 0,
                'produtos_criados': 0
            }
            
            cache_produtos = {}
            
            if filename.endswith('.csv'):
                try:
                    content = file.read().decode('utf-8')
                except UnicodeDecodeError:
                    file.seek(0)
                    content = file.read().decode('latin-1')
                
                df = pd.read_csv(io.StringIO(content))
                df_normalizado, sku_encontrado = normalizar_carteira_dataframe(df)
                
                if not sku_encontrado:
                    flash('Coluna de SKU n√£o encontrada no arquivo CSV. Verifique se existe uma coluna chamada "SKU", "REFER√äNCIA E COR" ou "CODIGO".', 'error')
                    return redirect(request.url)
                
                count, invalidos = processar_linhas_carteira(df_normalizado, lote_id, 'CSV', contadores, cache_produtos, tipo_carteira, marca_do_arquivo)
                total_count = count
                total_invalidos = invalidos
                abas_processadas.append('CSV')
                carteira_log.import_progress(count, count, 'CSV')
                
            else:
                xl = pd.ExcelFile(file)
                
                if importar_todas:
                    for sheet_name in xl.sheet_names:
                        df = pd.read_excel(xl, sheet_name=sheet_name)
                        
                        if df.empty or len(df) == 0:
                            continue
                        
                        df_normalizado, sku_encontrado = normalizar_carteira_dataframe(df)
                        
                        if not sku_encontrado:
                            continue
                        
                        count, invalidos = processar_linhas_carteira(df_normalizado, lote_id, sheet_name, contadores, cache_produtos, tipo_carteira, marca_do_arquivo)
                        total_count += count
                        total_invalidos += invalidos
                        if count > 0:
                            abas_processadas.append(f"{sheet_name} ({count})")
                            carteira_log.import_progress(total_count, len(xl.sheet_names), sheet_name)
                    
                    if total_count == 0:
                        flash('Nenhum item v√°lido encontrado nas abas do Excel. Verifique se existe uma coluna "REFER√äNCIA E COR" ou "SKU" em pelo menos uma aba.', 'error')
                        return redirect(request.url)
                else:
                    if aba_selecionada and aba_selecionada in xl.sheet_names:
                        df = pd.read_excel(xl, sheet_name=aba_selecionada)
                    else:
                        df = pd.read_excel(xl, sheet_name=0)
                        aba_selecionada = xl.sheet_names[0]
                    
                    df_normalizado, sku_encontrado = normalizar_carteira_dataframe(df)
                    
                    if not sku_encontrado:
                        flash(f'Coluna de SKU n√£o encontrada na aba "{aba_selecionada}". Verifique se existe uma coluna chamada "REFER√äNCIA E COR", "SKU" ou "CODIGO".', 'error')
                        return redirect(request.url)
                    
                    count, invalidos = processar_linhas_carteira(df_normalizado, lote_id, aba_selecionada, contadores, cache_produtos, tipo_carteira, marca_do_arquivo)
                    total_count = count
                    total_invalidos = invalidos
                    abas_processadas.append(aba_selecionada)
                    carteira_log.import_progress(count, count, aba_selecionada)
            
            db.session.commit()
            
            if len(abas_processadas) > 1:
                flash(f'Importa√ß√£o conclu√≠da! {total_count} novos itens de {len(abas_processadas)} abas adicionados. Abas: {", ".join(abas_processadas)}. Lote: {lote_id}', 'success')
            else:
                flash(f'Importa√ß√£o conclu√≠da! {total_count} novos itens da aba "{abas_processadas[0]}" adicionados. Lote: {lote_id}', 'success')
            
            entidades_criadas = []
            if contadores['colecoes_criadas'] > 0:
                entidades_criadas.append(f"{contadores['colecoes_criadas']} cole√ß√£o(√µes)")
            if contadores.get('subcolecoes_criadas', 0) > 0:
                entidades_criadas.append(f"{contadores['subcolecoes_criadas']} subcole√ß√£o(√µes)/campanha(s)")
            if contadores['marcas_criadas'] > 0:
                entidades_criadas.append(f"{contadores['marcas_criadas']} marca(s)")
            if contadores['produtos_criados'] > 0:
                entidades_criadas.append(f"{contadores['produtos_criados']} produto(s)")
            
            if entidades_criadas:
                flash(f'Criados automaticamente: {", ".join(entidades_criadas)}', 'info')
            
            if total_invalidos > 0:
                flash(f'{total_invalidos} linhas ignoradas (SKU vazio ou inv√°lido).', 'warning')
            
            atualizar_status_carteira()
            
            carteira_log.import_completed(total_count, len(abas_processadas), lote_id)
            rpa_info(f"[CARTEIRA] Importa√ß√£o conclu√≠da: {total_count} itens, {len(abas_processadas)} abas - Lote: {lote_id}")
            
            # Retornar sucesso para requisi√ß√£o AJAX
            return {'success': True, 'message': f'{total_count} itens importados'}, 200
            
        except Exception as e:
            db.session.rollback()
            carteira_log.import_error(str(e))
            rpa_error(f"[CARTEIRA] Erro na importa√ß√£o: {str(e)}", exc=e, regiao="carteira")
            flash(f'Erro ao importar: {str(e)}', 'error')
            return {'success': False, 'error': str(e)}, 500
    
    return render_template('carteira/importar.html')

@app.route('/carteira/abas', methods=['POST'])
@login_required
def listar_abas_excel():
    """Retorna lista de abas de um arquivo Excel para sele√ß√£o"""
    import pandas as pd
    if 'arquivo' not in request.files:
        return {'error': 'Nenhum arquivo enviado'}, 400
    
    file = request.files['arquivo']
    if not file.filename.lower().endswith(('.xlsx', '.xls')):
        return {'error': 'Apenas arquivos Excel'}, 400
    
    try:
        xl = pd.ExcelFile(file)
        abas = []
        total_linhas = 0
        for sheet_name in xl.sheet_names:
            df = pd.read_excel(xl, sheet_name=sheet_name)
            linhas = len(df)
            total_linhas += linhas
            
            df_norm, tem_sku = normalizar_carteira_dataframe(df)
            abas.append({
                'nome': sheet_name, 
                'linhas': linhas,
                'tem_sku': tem_sku
            })
        return {'abas': abas, 'total_linhas': total_linhas}
    except Exception as e:
        return {'error': str(e)}, 500

@app.route('/carteira/cruzar')
@login_required
def cruzar_carteira():
    rpa_info(f"[NAV] Cruzamento Carteira - Usu√°rio: {current_user.username}")
    """Executa cruzamento entre carteira e produtos/imagens"""
    count = atualizar_status_carteira()
    flash(f'Cruzamento conclu√≠do! {count} itens atualizados.')
    return redirect(url_for('carteira'))

def atualizar_status_carteira():
    """Atualiza status de fotos na carteira com base em produtos e imagens"""
    count = 0
    itens = CarteiraCompras.query.all()
    
    for item in itens:
        # Buscar produto pelo SKU
        produto = Produto.query.filter_by(sku=item.sku).first()
        
        if produto:
            item.produto_id = produto.id
            if produto.tem_foto:
                item.status_foto = 'Com Foto'
            else:
                item.status_foto = 'Sem Foto'
            count += 1
        else:
            # Buscar imagem diretamente pelo SKU
            imagem = Image.query.filter_by(sku=item.sku).first()
            if imagem:
                item.status_foto = 'Com Foto'
                count += 1
            else:
                item.status_foto = 'Sem Foto'
    
    db.session.commit()
    return count

@app.route('/carteira/export')
@login_required
def export_carteira():
    rpa_info(f"[EXPORT] Exportando carteira - Usu√°rio: {current_user.username}")
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(['SKU', 'Descri√ß√£o', 'Cor', 'Categoria', 'Quantidade', 'Status Foto', 'Data Importa√ß√£o', 'Lote'])
    
    itens = CarteiraCompras.query.order_by(CarteiraCompras.data_importacao.desc()).all()
    for item in itens:
        writer.writerow([
            item.sku,
            item.descricao or '',
            item.cor or '',
            item.categoria or '',
            item.quantidade,
            item.status_foto,
            item.data_importacao.strftime('%Y-%m-%d %H:%M') if item.data_importacao else '',
            item.lote_importacao or ''
        ])
    
    output.seek(0)
    response = make_response(output.getvalue())
    response.headers['Content-Disposition'] = 'attachment; filename=carteira_compras.csv'
    response.headers['Content-type'] = 'text/csv; charset=utf-8'
    return response

# ==================== RELAT√ìRIOS DE AUDITORIA ====================

@app.route('/auditoria')
@login_required
def auditoria():
    rpa_info(f"[NAV] Auditoria - Usu√°rio: {current_user.username}")
    # SKUs com foto vs sem foto
    produtos_com_foto = Produto.query.filter_by(tem_foto=True, ativo=True).count()
    produtos_sem_foto = Produto.query.filter_by(tem_foto=False, ativo=True).count()
    total_produtos = Produto.query.filter_by(ativo=True).count()
    
    # Carteira
    carteira_total = CarteiraCompras.query.count()
    carteira_com_foto = CarteiraCompras.query.filter_by(status_foto='Com Foto').count()
    carteira_sem_foto = CarteiraCompras.query.filter_by(status_foto='Sem Foto').count()
    carteira_pendente = CarteiraCompras.query.filter_by(status_foto='Pendente').count()
    
    # Hist√≥rico de altera√ß√µes de SKU
    alteracoes_sku = HistoricoSKU.query.order_by(HistoricoSKU.data_alteracao.desc()).limit(20).all()
    total_alteracoes = HistoricoSKU.query.count()
    
    # Diverg√™ncias: SKUs na carteira que mudaram
    divergencias = []
    for hist in HistoricoSKU.query.all():
        carteira_item = CarteiraCompras.query.filter_by(sku=hist.sku_antigo).first()
        if carteira_item:
            divergencias.append({
                'sku_antigo': hist.sku_antigo,
                'sku_novo': hist.sku_novo,
                'data': hist.data_alteracao,
                'produto_id': hist.produto_id,
                'carteira_id': carteira_item.id
            })
    
    # Lista de SKUs pendentes (sem foto)
    skus_pendentes = Produto.query.filter_by(tem_foto=False, ativo=True).order_by(Produto.sku).limit(50).all()
    
    return render_template('auditoria/index.html',
                          produtos_com_foto=produtos_com_foto,
                          produtos_sem_foto=produtos_sem_foto,
                          total_produtos=total_produtos,
                          carteira_total=carteira_total,
                          carteira_com_foto=carteira_com_foto,
                          carteira_sem_foto=carteira_sem_foto,
                          carteira_pendente=carteira_pendente,
                          alteracoes_sku=alteracoes_sku,
                          total_alteracoes=total_alteracoes,
                          divergencias=divergencias,
                          skus_pendentes=skus_pendentes)

@app.route('/auditoria/historico-sku')
@login_required
def historico_sku():
    rpa_info(f"[NAV] Hist√≥rico SKU - Usu√°rio: {current_user.username}")
    historico = HistoricoSKU.query.order_by(HistoricoSKU.data_alteracao.desc()).all()
    return render_template('auditoria/historico_sku.html', historico=historico)

@app.route('/auditoria/skus-pendentes')
@login_required
def skus_pendentes():
    rpa_info(f"[NAV] SKUs Pendentes - Usu√°rio: {current_user.username}")
    produtos = Produto.query.filter_by(tem_foto=False, ativo=True).order_by(Produto.sku).all()
    return render_template('auditoria/skus_pendentes.html', produtos=produtos)

@app.route('/auditoria/export/<tipo>')
@login_required
def export_auditoria(tipo):
    rpa_info(f"[EXPORT] Exportando auditoria: {tipo} - Usu√°rio: {current_user.username}")
    output = io.StringIO()
    writer = csv.writer(output)
    
    if tipo == 'skus_com_foto':
        writer.writerow(['SKU', 'Descri√ß√£o', 'Cor', 'Categoria', 'Marca', 'Cole√ß√£o'])
        produtos = Produto.query.filter_by(tem_foto=True, ativo=True).all()
        for p in produtos:
            writer.writerow([
                p.sku, p.descricao, p.cor or '', p.categoria or '',
                p.marca.name if p.marca else '',
                p.colecao.name if p.colecao else ''
            ])
        filename = 'skus_com_foto.csv'
    
    elif tipo == 'skus_sem_foto':
        writer.writerow(['SKU', 'Descri√ß√£o', 'Cor', 'Categoria', 'Marca', 'Cole√ß√£o'])
        produtos = Produto.query.filter_by(tem_foto=False, ativo=True).all()
        for p in produtos:
            writer.writerow([
                p.sku, p.descricao, p.cor or '', p.categoria or '',
                p.marca.name if p.marca else '',
                p.colecao.name if p.colecao else ''
            ])
        filename = 'skus_sem_foto.csv'
    
    elif tipo == 'historico_sku':
        writer.writerow(['SKU Antigo', 'SKU Novo', 'Data Altera√ß√£o', 'Motivo', 'Usu√°rio'])
        historico = HistoricoSKU.query.order_by(HistoricoSKU.data_alteracao.desc()).all()
        for h in historico:
            writer.writerow([
                h.sku_antigo, h.sku_novo,
                h.data_alteracao.strftime('%Y-%m-%d %H:%M'),
                h.motivo or '',
                h.usuario.username if h.usuario else ''
            ])
        filename = 'historico_alteracoes_sku.csv'
    
    elif tipo == 'divergencias':
        writer.writerow(['SKU Antigo (Carteira)', 'SKU Novo (Produto)', 'Data Altera√ß√£o', 'Status'])
        for hist in HistoricoSKU.query.all():
            carteira_item = CarteiraCompras.query.filter_by(sku=hist.sku_antigo).first()
            if carteira_item:
                writer.writerow([
                    hist.sku_antigo, hist.sku_novo,
                    hist.data_alteracao.strftime('%Y-%m-%d %H:%M'),
                    'Diverg√™ncia Detectada'
                ])
        filename = 'divergencias_sku.csv'
    
    else:
        return redirect(url_for('auditoria'))
    
    output.seek(0)
    response = make_response(output.getvalue())
    response.headers['Content-Disposition'] = f'attachment; filename={filename}'
    response.headers['Content-type'] = 'text/csv; charset=utf-8'
    return response

# ==================== BATCH UPLOAD (UPLOAD EM LOTE) ====================

import threading
import tempfile
from batch_processor import BatchProcessor, extract_zip_to_temp, extract_sku_from_filename

batch_processor_instance = None

def get_batch_processor():
    global batch_processor_instance
    if batch_processor_instance is None:
        from object_storage import object_storage
        batch_processor_instance = BatchProcessor(app, db, object_storage, analyze_func=None)
    return batch_processor_instance

@app.route('/batch')
@login_required
def batch_list():
    """Lista todos os lotes de upload"""
    nav_log.page_enter("Batches", user=current_user.username)
    rpa_info(f"[NAV] Batches - Usu√°rio: {current_user.username}")
    batches = BatchUpload.query.filter_by(usuario_id=current_user.id).order_by(BatchUpload.created_at.desc()).all()
    return render_template('batch/index.html', batches=batches)

@app.route('/batch/queue')
@login_required
def batch_queue():
    """P√°gina para criar m√∫ltiplos batches e processar em fila"""
    nav_log.page_enter("Fila de Batches", user=current_user.username)
    rpa_info(f"[NAV] Fila de Batches - Usu√°rio: {current_user.username}")
    collections = Collection.query.order_by(Collection.name).all()
    brands = Brand.query.order_by(Brand.name).all()
    return render_template('batch/queue.html', collections=collections, brands=brands)

@app.route('/batch/process-all', methods=['POST'])
@login_required
def batch_process_all():
    """Processa m√∫ltiplos batches de uma vez"""
    data = request.get_json()
    batch_ids = data.get('batch_ids', [])
    
    if not batch_ids:
        rpa_warn("[BATCH] Nenhum batch especificado para processamento")
        return jsonify({'error': 'Nenhum batch especificado'}), 400
    
    log_start(M.BATCH, f"Processando todos os batches: {len(batch_ids)} lotes")
    rpa_info(f"[BATCH] Iniciando processamento de {len(batch_ids)} lotes em sequ√™ncia")
    
    batches_to_process = []
    for batch_id in batch_ids:
        batch = BatchUpload.query.get(batch_id)
        if batch and batch.usuario_id == current_user.id:
            pending_items = BatchItem.query.filter_by(
                batch_id=batch_id, 
                processing_status='pending'
            ).count()
            if pending_items > 0:
                batch.status = 'Processando'
                batches_to_process.append(batch_id)
    
    db.session.commit()
    
    if batches_to_process:
        processor = get_batch_processor()
        thread = threading.Thread(
            target=processor.process_multiple_batches,
            args=(batches_to_process,)
        )
        thread.daemon = True
        thread.start()
    
    log_end(M.BATCH, "Processamento de m√∫ltiplos batches")
    rpa_info("[BATCH] Processamento de m√∫ltiplos lotes conclu√≠do")
    
    return jsonify({
        'success': True,
        'batches_started': len(batches_to_process),
        'batch_ids': batches_to_process
    })

@app.route('/batch/new', methods=['GET', 'POST'])
@login_required
def batch_new():
    """Criar novo lote de upload"""
    rpa_info(f"[NAV] Novo Batch - Usu√°rio: {current_user.username}")
    if request.method == 'POST':
        files = request.files.getlist('files')
        zip_file = request.files.get('zip_file')
        collection_id = request.form.get('collection_id')
        brand_id = request.form.get('brand_id')
        batch_name = request.form.get('batch_name', f"Lote {datetime.now().strftime('%Y-%m-%d %H:%M')}")
        
        log_start(M.BATCH, f"Criando novo batch: {batch_name}", arquivos=len(files) if files else 0, zip=bool(zip_file))
        rpa_info(f"[BATCH] Criando batch: {batch_name} - {len(files) if files else 0} arquivos")
        
        temp_dir = tempfile.mkdtemp(prefix='batch_upload_')
        temp_file_paths = []
        
        try:
            if zip_file and zip_file.filename:
                temp_zip_path = os.path.join(temp_dir, 'upload.zip')
                zip_file.save(temp_zip_path)
                temp_file_paths = extract_zip_to_temp(temp_zip_path, temp_dir)
                os.remove(temp_zip_path)
            
            elif files:
                for i, file in enumerate(files):
                    if file and file.filename:
                        ext = os.path.splitext(file.filename)[1].lower()
                        if ext in ['.jpg', '.jpeg', '.png', '.gif', '.webp']:
                            sku = extract_sku_from_filename(file.filename)
                            if sku:
                                temp_filename = f"upload_{i}_{sku}{ext}"
                                temp_path = os.path.join(temp_dir, temp_filename)
                                file.save(temp_path)
                                temp_file_paths.append({
                                    'sku': sku,
                                    'temp_path': temp_path,
                                    'filename': file.filename
                                })
            
            if not temp_file_paths:
                flash('Nenhum arquivo v√°lido encontrado. Envie imagens ou um arquivo ZIP.')
                return redirect(request.url)
            
            batch = BatchUpload(
                nome=batch_name,
                total_arquivos=len(temp_file_paths),
                usuario_id=current_user.id,
                colecao_id=int(collection_id) if collection_id else None,
                marca_id=int(brand_id) if brand_id else None,
                status='Pendente'
            )
            db.session.add(batch)
            db.session.flush()
            
            for i, file_info in enumerate(temp_file_paths):
                item = BatchItem(
                    batch_id=batch.id,
                    sku=file_info['sku'],
                    filename_original=file_info['filename'],
                    status='Pendente'
                )
                db.session.add(item)
                db.session.flush()
                file_info['item_id'] = item.id
            
            db.session.commit()
            
            processor = get_batch_processor()
            thread = threading.Thread(
                target=processor.process_batch,
                args=(batch.id, temp_file_paths)
            )
            thread.daemon = True
            thread.start()
            
            flash(f'Lote criado com {len(temp_file_paths)} arquivos. Processamento iniciado.')
            return redirect(url_for('batch_detail', batch_id=batch.id))
            
        except Exception as e:
            import shutil
            shutil.rmtree(temp_dir, ignore_errors=True)
            flash(f'Erro ao processar arquivos: {str(e)}')
            return redirect(request.url)
    
    collections = Collection.query.order_by(Collection.name).all()
    brands = Brand.query.order_by(Brand.name).all()
    return render_template('batch/new.html', collections=collections, brands=brands)

@app.route('/batch/create-async', methods=['POST'])
@login_required
def batch_create_async():
    """Cria um lote vazio para upload ass√≠ncrono de m√∫ltiplos arquivos"""
    data = request.get_json()
    
    batch_name = data.get('batch_name', f"Lote {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    collection_id = data.get('collection_id')
    brand_id = data.get('brand_id')
    total_files = data.get('total_files', 0)
    
    batch = BatchUpload(
        nome=batch_name,
        total_arquivos=total_files,
        usuario_id=current_user.id,
        colecao_id=int(collection_id) if collection_id else None,
        marca_id=int(brand_id) if brand_id else None,
        status='Recebendo'
    )
    db.session.add(batch)
    db.session.commit()
    
    batch_log.batch_created(batch.id, batch_name, total_files)
    rpa_info(f"[BATCH] Novo lote criado: #{batch.id} '{batch_name}' - {total_files} arquivos")
    
    return jsonify({
        'batch_id': batch.id,
        'status': 'created'
    })

@app.route('/batch/upload-file', methods=['POST'])
@login_required
def batch_upload_file():
    """Upload de um √∫nico arquivo direto para Object Storage (sem usar /tmp)"""
    from object_storage import object_storage as storage_service
    
    batch_id = request.form.get('batch_id')
    file = request.files.get('file')
    
    if not batch_id or not file:
        return jsonify({'error': 'Missing batch_id or file'}), 400
    
    batch = BatchUpload.query.get(batch_id)
    if not batch:
        return jsonify({'error': 'Batch not found'}), 404
    
    file_size = request.content_length or 0
    upload_log.upload_started(batch_id, file.filename, file_size)
    
    try:
        ext = os.path.splitext(file.filename)[1].lower()
        if ext not in ['.jpg', '.jpeg', '.png', '.gif', '.webp']:
            return jsonify({'error': 'Invalid file type'}), 400
        
        sku = extract_sku_from_filename(file.filename)
        if not sku:
            sku = os.path.splitext(file.filename)[0]
        
        file_bytes = file.read()
        file_size_actual = len(file_bytes)
        
        result = storage_service.upload_file(io.BytesIO(file_bytes), file.filename)
        storage_path = result['object_name']
        
        item = BatchItem(
            batch_id=batch_id,
            sku=sku,
            filename_original=file.filename,
            status='Pendente',
            reception_status='received',
            processing_status='pending',
            received_path=storage_path,
            file_size=file_size_actual
        )
        db.session.add(item)
        db.session.commit()
        
        debug(M.UPLOAD, 'SUCCESS', f"Arquivo enviado ao Object Storage", sku=sku, path=storage_path)
        rpa_info(f"[UPLOAD] OK: {sku} ({file_size_actual//1024}KB)")
        
        return jsonify({
            'success': True,
            'item_id': item.id,
            'sku': sku,
            'storage_path': storage_path
        })
        
    except Exception as e:
        db.session.rollback()
        upload_log.upload_error(batch_id, file.filename if file else 'unknown', str(e))
        rpa_error(f"[UPLOAD] Erro no upload: {file.filename if file else 'unknown'} - {str(e)}", exc=e, regiao="upload")
        return jsonify({'error': str(e)}), 500

@app.route('/batch/<int:batch_id>/sync-total', methods=['POST'])
@login_required
def batch_sync_total(batch_id):
    """Sincroniza total_arquivos com o n√∫mero real de BatchItems recebidos"""
    batch = BatchUpload.query.get_or_404(batch_id)
    
    actual_count = BatchItem.query.filter_by(batch_id=batch_id).count()
    batch.total_arquivos = actual_count
    db.session.commit()
    
    return jsonify({
        'success': True,
        'batch_id': batch_id,
        'total_arquivos': actual_count
    })

@app.route('/batch/<int:batch_id>/delete', methods=['DELETE'])
@login_required
def batch_delete(batch_id):
    """Exclui um lote e todos os seus itens"""
    log_start(M.BATCH, f"Excluindo batch #{batch_id}")
    rpa_info(f"[BATCH] Iniciando exclus√£o do batch #{batch_id}")
    
    batch = BatchUpload.query.get_or_404(batch_id)
    
    if batch.usuario_id != current_user.id and not current_user.is_admin:
        return jsonify({'error': 'Sem permiss√£o para excluir este lote'}), 403
    
    try:
        items = BatchItem.query.filter_by(batch_id=batch_id).all()
        for item in items:
            if item.received_path and os.path.exists(item.received_path):
                try:
                    os.remove(item.received_path)
                except:
                    pass
        
        BatchItem.query.filter_by(batch_id=batch_id).delete()
        db.session.delete(batch)
        db.session.commit()
        
        log_end(M.BATCH, f"Batch #{batch_id} exclu√≠do")
        rpa_info(f"[BATCH] Lote #{batch_id} exclu√≠do com sucesso")
        
        return jsonify({'success': True, 'message': 'Lote exclu√≠do com sucesso'})
        
    except Exception as e:
        db.session.rollback()
        batch_log.batch_error(batch_id, str(e))
        rpa_error(f"[BATCH] Erro ao excluir batch #{batch_id}: {str(e)}", exc=e, regiao="batch")
        return jsonify({'error': str(e)}), 500

@app.route('/batch/<int:batch_id>')
@login_required
def batch_detail(batch_id):
    """Detalhes de um lote de upload"""
    batch = BatchUpload.query.get_or_404(batch_id)
    rpa_info(f"[NAV] Detalhe Batch #{batch_id} - Usu√°rio: {current_user.username}")
    
    page = request.args.get('page', 1, type=int)
    status_filter = request.args.get('status', '')
    
    query = BatchItem.query.filter_by(batch_id=batch_id)
    if status_filter:
        query = query.filter_by(status=status_filter)
    
    items = query.order_by(BatchItem.id).paginate(page=page, per_page=50, error_out=False)
    
    return render_template('batch/detail.html', batch=batch, items=items, status_filter=status_filter)

@app.route('/batch/<int:batch_id>/status')
@login_required
def batch_status(batch_id):
    """API para obter status detalhado do lote (polling) - inclui fases de recep√ß√£o e processamento"""
    batch = BatchUpload.query.get_or_404(batch_id)
    
    reception_pending = BatchItem.query.filter_by(batch_id=batch_id, reception_status='pending').count()
    reception_receiving = BatchItem.query.filter_by(batch_id=batch_id, reception_status='receiving').count()
    reception_received = BatchItem.query.filter_by(batch_id=batch_id, reception_status='received').count()
    
    processing_pending = BatchItem.query.filter_by(batch_id=batch_id, processing_status='pending').count()
    processing_active = BatchItem.query.filter_by(batch_id=batch_id, processing_status='processing').count()
    processing_completed = BatchItem.query.filter_by(batch_id=batch_id, processing_status='completed').count()
    processing_failed = BatchItem.query.filter_by(batch_id=batch_id, processing_status='failed').count()
    processing_retry = BatchItem.query.filter_by(batch_id=batch_id, processing_status='retry').count()
    
    return {
        'id': batch.id,
        'status': batch.status,
        'total': batch.total_arquivos,
        'processados': batch.processados,
        'sucesso': batch.sucesso,
        'falhas': batch.falhas,
        'progresso': batch.progresso,
        'fase1_recepcao': {
            'pendente': reception_pending,
            'recebendo': reception_receiving,
            'recebido': reception_received
        },
        'fase2_processamento': {
            'pendente': processing_pending,
            'processando': processing_active,
            'concluido': processing_completed,
            'falha': processing_failed,
            'retry': processing_retry
        },
        'resiliente': True,
        'pode_retomar': processing_pending + processing_retry > 0
    }

@app.route('/batch/streaming-upload', methods=['POST'])
@login_required
def batch_streaming_upload():
    """
    Endpoint de recep√ß√£o com upload DIRETO para Object Storage (bucket).
    Garante que a imagem √© persistida IMEDIATAMENTE, antes de qualquer processamento.
    Se o processamento falhar depois, a imagem j√° est√° segura no bucket.
    
    DETEC√á√ÉO DE DUPLICATAS: Usa hash SHA256 para identificar imagens j√° upadas.
    SKUs iguais com hashes diferentes s√£o imagens diferentes (√¢ngulos) e ser√£o upadas.
    """
    import hashlib
    
    log_start(M.UPLOAD, "Streaming upload iniciado - UPLOAD DIRETO AO BUCKET")
    rpa_info("[UPLOAD] Streaming upload iniciado - DIRETO AO BUCKET")
    
    batch_id = request.form.get('batch_id')
    collection_id = request.form.get('collection_id')
    brand_id = request.form.get('brand_id')
    batch_name = request.form.get('batch_name', f"Lote {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    
    if not batch_id:
        batch = BatchUpload(
            nome=batch_name,
            total_arquivos=0,
            usuario_id=current_user.id,
            colecao_id=int(collection_id) if collection_id else None,
            marca_id=int(brand_id) if brand_id else None,
            status='Recebendo'
        )
        db.session.add(batch)
        db.session.commit()
        batch_id = batch.id
    else:
        batch = BatchUpload.query.get(int(batch_id))
        if not batch:
            return {'error': 'Batch n√£o encontrado'}, 404
    
    existing_hashes = set(
        row[0] for row in db.session.query(BatchItem.file_hash)
        .filter(BatchItem.file_hash.isnot(None))
        .filter(BatchItem.processing_status != 'orphaned')
        .all()
    )
    debug(M.UPLOAD, 'HASH_CACHE', f"Carregados {len(existing_hashes)} hashes existentes para verifica√ß√£o de duplicatas")
    
    received_files = []
    upload_errors = []
    skipped_files = []
    
    for key in request.files:
        file = request.files[key]
        if file and file.filename:
            original_filename = file.filename
            ext = os.path.splitext(original_filename)[1].lower()
            
            if ext not in ['.jpg', '.jpeg', '.png', '.gif', '.webp']:
                continue
            
            sku = extract_sku_from_filename(original_filename)
            if not sku:
                continue
            
            try:
                file_bytes = file.read()
                
                hasher = hashlib.sha256()
                hasher.update(file_bytes)
                file_hash = hasher.hexdigest()
                
                if file_hash in existing_hashes:
                    skipped_files.append({
                        'sku': sku,
                        'filename': original_filename,
                        'reason': 'duplicado',
                        'hash': file_hash[:16]
                    })
                    debug(M.UPLOAD, 'SKIP_DUPLICATE', f"Pulando {original_filename} - j√° existe (hash: {file_hash[:16]})")
                    del file_bytes
                    continue
                
                existing_hashes.add(file_hash)
                
                upload_result = object_storage.upload_bytes_immediate(
                    file_bytes=file_bytes,
                    original_filename=original_filename,
                    sku=sku,
                    batch_id=batch_id
                )
                
                item = BatchItem(
                    batch_id=batch_id,
                    sku=sku,
                    filename_original=original_filename,
                    file_size=upload_result['file_size'],
                    file_hash=file_hash,
                    storage_path=upload_result['storage_path'],
                    received_path=upload_result['object_name'],
                    reception_status='uploaded',
                    received_at=datetime.utcnow(),
                    processing_status='pending',
                    status='Pendente'
                )
                db.session.add(item)
                db.session.flush()
                
                received_files.append({
                    'item_id': item.id,
                    'sku': sku,
                    'filename': original_filename,
                    'size': upload_result['file_size'],
                    'hash': file_hash[:16],
                    'storage_path': upload_result['storage_path']
                })
                
                del file_bytes
                
            except Exception as e:
                error_msg = str(e)
                upload_errors.append({
                    'sku': sku,
                    'filename': original_filename,
                    'error': error_msg
                })
                error(M.UPLOAD, 'BUCKET_UPLOAD', f"Erro ao enviar {sku} para bucket: {error_msg}")
                rpa_err(f"[UPLOAD] Erro bucket: {sku} - {error_msg}", regiao="upload")
    
    batch.total_arquivos = BatchItem.query.filter_by(batch_id=batch_id).count()
    db.session.commit()
    
    log_end(M.UPLOAD, f"Upload conclu√≠do: {len(received_files)} novos, {len(skipped_files)} duplicados pulados, {len(upload_errors)} erros")
    
    return {
        'batch_id': batch_id,
        'received_count': len(received_files),
        'skipped_count': len(skipped_files),
        'skipped_files': skipped_files,
        'total_no_lote': batch.total_arquivos,
        'files': received_files,
        'errors': upload_errors,
        'bucket_upload': True
    }

@app.route('/batch/<int:batch_id>/start-processing', methods=['POST'])
@login_required
def batch_start_processing(batch_id):
    """Inicia o processamento de um lote - suporta imagens no bucket OU arquivos locais"""
    batch = BatchUpload.query.get_or_404(batch_id)
    
    if batch.status not in ['Recebendo', 'Pendente', 'Erro']:
        return {'error': f'Lote j√° est√° em status: {batch.status}'}, 400
    
    pending_items = BatchItem.query.filter_by(
        batch_id=batch_id,
        processing_status='pending'
    ).filter(
        db.or_(
            BatchItem.reception_status == 'uploaded',
            BatchItem.reception_status == 'received'
        )
    ).all()
    
    if not pending_items:
        return {'error': 'Nenhum item pendente para processar'}, 400
    
    batch_log.batch_started(batch_id, len(pending_items))
    rpa_info(f"[BATCH] Processamento do batch #{batch_id}: {len(pending_items)} itens pendentes")
    
    batch.status = 'Processando'
    batch.started_at = datetime.utcnow()
    db.session.commit()
    
    files_data = []
    for item in pending_items:
        if item.storage_path:
            object_name = item.storage_path.replace('/storage/', '') if item.storage_path.startswith('/storage/') else item.storage_path
            files_data.append({
                'item_id': item.id,
                'sku': item.sku,
                'storage_path': item.storage_path,
                'object_name': object_name,
                'filename': item.filename_original,
                'source': 'bucket'
            })
        elif item.received_path and os.path.exists(item.received_path):
            files_data.append({
                'item_id': item.id,
                'sku': item.sku,
                'temp_path': item.received_path,
                'filename': item.filename_original,
                'source': 'local'
            })
    
    if files_data:
        processor = get_batch_processor()
        thread = threading.Thread(
            target=processor.process_batch_from_bucket,
            args=(batch_id, files_data)
        )
        thread.daemon = True
        thread.start()
    
    return {
        'batch_id': batch_id,
        'status': 'Processando',
        'items_to_process': len(files_data),
        'from_bucket': sum(1 for f in files_data if f.get('source') == 'bucket'),
        'from_local': sum(1 for f in files_data if f.get('source') == 'local')
    }

@app.route('/batch/<int:batch_id>/resume', methods=['POST'])
@login_required
def batch_resume(batch_id):
    """Retoma processamento - suporta bucket OU arquivos locais"""
    rpa_info(f"[BATCH] Retomando processamento do batch #{batch_id}")
    batch = BatchUpload.query.get_or_404(batch_id)
    
    pending_items = BatchItem.query.filter(
        BatchItem.batch_id == batch_id,
        BatchItem.processing_status.in_(['pending', 'retry'])
    ).all()
    
    if not pending_items:
        return {'error': 'Nenhum item pendente para retomar', 'status': batch.status}, 400
    
    files_data = []
    orphaned_count = 0
    for item in pending_items:
        if item.storage_path:
            object_name = item.storage_path.replace('/storage/', '') if item.storage_path.startswith('/storage/') else item.storage_path
            files_data.append({
                'item_id': item.id,
                'sku': item.sku,
                'storage_path': item.storage_path,
                'object_name': object_name,
                'filename': item.filename_original,
                'source': 'bucket'
            })
        elif item.received_path and os.path.exists(item.received_path):
            files_data.append({
                'item_id': item.id,
                'sku': item.sku,
                'temp_path': item.received_path,
                'filename': item.filename_original,
                'source': 'local'
            })
        else:
            item.processing_status = 'orphaned'
            item.status = 'Erro'
            item.erro_mensagem = 'Arquivo n√£o encontrado (nem bucket nem local)'
            orphaned_count += 1
    
    if files_data:
        batch.status = 'Processando'
        db.session.commit()
        
        processor = get_batch_processor()
        thread = threading.Thread(
            target=processor.process_batch_from_bucket,
            args=(batch_id, files_data)
        )
        thread.daemon = True
        thread.start()
        
        return {
            'batch_id': batch_id,
            'status': 'Retomando',
            'items_to_process': len(files_data),
            'from_bucket': sum(1 for f in files_data if f.get('source') == 'bucket'),
            'from_local': sum(1 for f in files_data if f.get('source') == 'local'),
            'orphaned': orphaned_count
        }
    else:
        db.session.commit()
        return {'error': 'Nenhum arquivo encontrado para retomar', 'orphaned': orphaned_count, 'status': batch.status}, 400

@app.route('/batch/<int:batch_id>/reprocess', methods=['POST'])
@login_required
def batch_reprocess(batch_id):
    """Reprocessa itens que j√° est√£o no bucket mas falharam no processamento"""
    rpa_info(f"[BATCH] Reprocessando itens do batch #{batch_id} a partir do bucket")
    batch = BatchUpload.query.get_or_404(batch_id)
    
    failed_items = BatchItem.query.filter(
        BatchItem.batch_id == batch_id,
        BatchItem.storage_path.isnot(None),
        BatchItem.processing_status.in_(['failed', 'orphaned', 'pending'])
    ).all()
    
    if not failed_items:
        return {'error': 'Nenhum item com storage_path para reprocessar'}, 400
    
    files_data = []
    for item in failed_items:
        item.processing_status = 'pending'
        item.status = 'Pendente'
        item.tentativas = 0
        item.erro_mensagem = None
        
        object_name = item.storage_path.replace('/storage/', '') if item.storage_path.startswith('/storage/') else item.storage_path
        files_data.append({
            'item_id': item.id,
            'sku': item.sku,
            'storage_path': item.storage_path,
            'object_name': object_name,
            'filename': item.filename_original,
            'source': 'bucket'
        })
    
    batch.status = 'Processando'
    batch.started_at = datetime.utcnow()
    db.session.commit()
    
    processor = get_batch_processor()
    thread = threading.Thread(
        target=processor.process_batch_from_bucket,
        args=(batch_id, files_data)
    )
    thread.daemon = True
    thread.start()
    
    return {
        'batch_id': batch_id,
        'status': 'Reprocessando',
        'items_to_process': len(files_data)
    }

@app.route('/batch/<int:batch_id>/retry-failed', methods=['POST'])
@login_required
def batch_retry_failed(batch_id):
    rpa_info(f"[BATCH] Reprocessando itens falhos do batch #{batch_id}")
    """Reprocessar itens com falha"""
    batch = BatchUpload.query.get_or_404(batch_id)
    
    failed_items = BatchItem.query.filter_by(batch_id=batch_id, status='Erro').all()
    if not failed_items:
        flash('N√£o h√° itens com erro para reprocessar.')
        return redirect(url_for('batch_detail', batch_id=batch_id))
    
    batch.status = 'Processando'
    batch.processados -= len(failed_items)
    batch.falhas = 0
    db.session.commit()
    
    files_data = []
    for item in failed_items:
        item.status = 'Pendente'
        item.erro_mensagem = None
        item.tentativas = 0
        
        if item.storage_path:
            from object_storage import object_storage
            file_bytes = object_storage.download_file(item.storage_path.replace('/storage/', ''))
            if file_bytes:
                files_data.append({
                    'sku': item.sku,
                    'file_bytes': file_bytes,
                    'filename': item.filename_original,
                    'item_id': item.id
                })
    
    db.session.commit()
    
    if files_data:
        processor = get_batch_processor()
        thread = threading.Thread(
            target=processor.process_batch,
            args=(batch.id, files_data)
        )
        thread.daemon = True
        thread.start()
        flash(f'Reprocessando {len(files_data)} itens com falha.')
    
    return redirect(url_for('batch_detail', batch_id=batch_id))


@app.route('/analyze-pending-ai', methods=['GET', 'POST'])
@login_required
def analyze_pending_ai():
    """P√°gina para analisar imagens pendentes de an√°lise IA"""
    nav_log.page_enter("An√°lise IA Pendente", user=current_user.username)
    rpa_info(f"[NAV] An√°lise IA Pendente - Usu√°rio: {current_user.username}")
    pending_images = Image.query.filter_by(status='Pendente An√°lise IA').order_by(Image.upload_date.desc()).all()
    debug(M.CATALOG, 'DATA', f"Imagens pendentes de IA carregadas", total=len(pending_images))
    rpa_info(f"[CATALOG] {len(pending_images)} imagens pendentes de IA")
    
    if request.method == 'POST':
        image_ids = request.form.getlist('image_ids')
        
        if not image_ids:
            flash('Selecione pelo menos uma imagem para analisar.')
            return redirect(url_for('analyze_pending_ai'))
        
        processed = 0
        errors = 0
        
        for img_id in image_ids[:10]:
            image = Image.query.get(int(img_id))
            if not image:
                continue
            
            temp_file_path = None
            file_path = None
            
            try:
                if image.storage_path:
                    from object_storage import object_storage
                    import tempfile
                    
                    file_bytes = object_storage.download_file(image.storage_path)
                    if file_bytes:
                        ext = os.path.splitext(image.filename)[1] or '.jpg'
                        fd, temp_file_path = tempfile.mkstemp(suffix=ext)
                        os.write(fd, file_bytes)
                        os.close(fd)
                        file_path = temp_file_path
                
                if not file_path:
                    file_path = os.path.join(app.config['UPLOAD_FOLDER'], image.filename)
                
                if not os.path.exists(file_path):
                    errors += 1
                    continue
                
                ai_result = analyze_image_with_context(
                    file_path, 
                    sku=image.sku,
                    collection_id=image.collection_id,
                    brand_id=image.brand_id,
                    subcolecao_id=image.subcolecao_id
                )
                
                if isinstance(ai_result, str):
                    errors += 1
                    continue
                
                ai_items = ai_result
                first_item = ai_items[0] if ai_items else {}
                first_attrs = first_item.get('attributes', {}) if first_item else {}
                
                image.description = first_item.get('description', '')
                image.tags = json.dumps(first_item.get('tags', [])) if first_item else json.dumps([])
                image.ai_item_type = first_attrs.get('item_type')
                image.ai_color = first_attrs.get('color')
                image.ai_material = first_attrs.get('material')
                image.ai_pattern = first_attrs.get('pattern')
                image.ai_style = first_attrs.get('style')
                image.status = 'Pendente'
                
                ImageItem.query.filter_by(image_id=image.id).delete()
                
                for item_data in ai_items:
                    attrs = item_data.get('attributes', {})
                    new_item = ImageItem(
                        image_id=image.id,
                        item_order=item_data.get('order', 1),
                        position_ref=item_data.get('position_ref', 'Pe√ßa √önica'),
                        description=item_data.get('description', ''),
                        tags=json.dumps(item_data.get('tags', [])),
                        ai_item_type=attrs.get('item_type'),
                        ai_color=attrs.get('color'),
                        ai_material=attrs.get('material'),
                        ai_pattern=attrs.get('pattern'),
                        ai_style=attrs.get('style')
                    )
                    db.session.add(new_item)
                
                db.session.commit()
                processed += 1
                
            except Exception as e:
                print(f"[ERROR] Analysis failed for image {img_id}: {e}")
                errors += 1
            
            finally:
                if temp_file_path and os.path.exists(temp_file_path):
                    try:
                        os.remove(temp_file_path)
                    except Exception:
                        pass
        
        if processed > 0:
            flash(f'An√°lise conclu√≠da! {processed} imagens analisadas com sucesso.')
        if errors > 0:
            flash(f'{errors} imagens n√£o puderam ser analisadas.', 'warning')
        
        return redirect(url_for('analyze_pending_ai'))
    
    return render_template('batch/analyze_pending.html', pending_images=pending_images)


# ==================== CHUNKED UPLOAD (UPLOAD DE ARQUIVOS GRANDES) ====================
import uuid
import hashlib

# Diret√≥rio para chunks tempor√°rios
CHUNK_UPLOAD_DIR = os.path.join(tempfile.gettempdir(), 'oaz_chunks')
os.makedirs(CHUNK_UPLOAD_DIR, exist_ok=True)

# Armazenar informa√ß√µes de uploads em andamento
active_uploads = {}

@app.route('/upload/init', methods=['POST'])
@login_required
def upload_init():
    """Inicializa um upload chunked - retorna upload_id"""
    data = request.get_json()
    filename = data.get('filename', 'upload.zip')
    file_size = data.get('file_size', 0)
    chunk_size = data.get('chunk_size', 5 * 1024 * 1024)  # 5MB default
    
    upload_id = str(uuid.uuid4())
    upload_dir = os.path.join(CHUNK_UPLOAD_DIR, upload_id)
    os.makedirs(upload_dir, exist_ok=True)
    
    total_chunks = (file_size + chunk_size - 1) // chunk_size
    
    active_uploads[upload_id] = {
        'filename': filename,
        'file_size': file_size,
        'chunk_size': chunk_size,
        'total_chunks': total_chunks,
        'received_chunks': set(),
        'upload_dir': upload_dir,
        'user_id': current_user.id,
        'created_at': datetime.utcnow()
    }
    
    return {
        'upload_id': upload_id,
        'chunk_size': chunk_size,
        'total_chunks': total_chunks
    }

@app.route('/upload/chunk', methods=['POST'])
@login_required
def upload_chunk():
    """Recebe um chunk do arquivo"""
    upload_id = request.form.get('upload_id')
    chunk_index = int(request.form.get('chunk_index', 0))
    chunk_file = request.files.get('chunk')
    
    if not upload_id or upload_id not in active_uploads:
        return {'error': 'Upload inv√°lido'}, 400
    
    upload_info = active_uploads[upload_id]
    
    if upload_info['user_id'] != current_user.id:
        return {'error': 'N√£o autorizado'}, 403
    
    if not chunk_file:
        return {'error': 'Chunk n√£o recebido'}, 400
    
    # Salvar chunk
    chunk_path = os.path.join(upload_info['upload_dir'], f'chunk_{chunk_index:06d}')
    chunk_file.save(chunk_path)
    upload_info['received_chunks'].add(chunk_index)
    
    received = len(upload_info['received_chunks'])
    total = upload_info['total_chunks']
    
    return {
        'success': True,
        'chunk_index': chunk_index,
        'received': received,
        'total': total,
        'progress': round((received / total) * 100, 1)
    }

@app.route('/upload/complete', methods=['POST'])
@login_required
def upload_complete():
    """Finaliza o upload chunked e enfileira para processamento ass√≠ncrono"""
    data = request.get_json()
    upload_id = data.get('upload_id')
    collection_id = data.get('collection_id')
    brand_id = data.get('brand_id')
    batch_name = data.get('batch_name', f"Lote {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    
    if not upload_id or upload_id not in active_uploads:
        return {'error': 'Upload inv√°lido'}, 400
    
    upload_info = active_uploads[upload_id]
    
    if upload_info['user_id'] != current_user.id:
        return {'error': 'N√£o autorizado'}, 403
    
    if len(upload_info['received_chunks']) != upload_info['total_chunks']:
        missing = upload_info['total_chunks'] - len(upload_info['received_chunks'])
        return {'error': f'Faltam {missing} partes do arquivo'}, 400
    
    import shutil
    temp_dir = None
    chunk_dir = upload_info.get('upload_dir')
    
    try:
        temp_dir = tempfile.mkdtemp(prefix='batch_final_')
        final_path = os.path.join(temp_dir, upload_info['filename'])
        
        with open(final_path, 'wb') as outfile:
            for i in range(upload_info['total_chunks']):
                chunk_path = os.path.join(chunk_dir, f'chunk_{i:06d}')
                with open(chunk_path, 'rb') as chunk:
                    outfile.write(chunk.read())
        
        shutil.rmtree(chunk_dir, ignore_errors=True)
        if upload_id in active_uploads:
            del active_uploads[upload_id]
        
        batch = BatchUpload(
            nome=batch_name,
            total_arquivos=0,
            usuario_id=current_user.id,
            colecao_id=int(collection_id) if collection_id else None,
            marca_id=int(brand_id) if brand_id else None,
            status='Na Fila'
        )
        db.session.add(batch)
        db.session.commit()
        
        from upload_orchestrator import get_upload_orchestrator
        from object_storage import object_storage
        orchestrator = get_upload_orchestrator(app, db, object_storage)
        
        orchestrator.enqueue(
            batch_id=batch.id,
            archive_path=final_path,
            temp_dir=temp_dir,
            metadata={
                'collection_id': collection_id,
                'brand_id': brand_id,
                'batch_name': batch_name
            }
        )
        
        return {
            'success': True,
            'batch_id': batch.id,
            'status': 'queued',
            'message': 'Upload enfileirado para processamento',
            'redirect': url_for('batch_detail', batch_id=batch.id)
        }
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        
        if chunk_dir and os.path.exists(chunk_dir):
            shutil.rmtree(chunk_dir, ignore_errors=True)
        if temp_dir and os.path.exists(temp_dir):
            shutil.rmtree(temp_dir, ignore_errors=True)
        if upload_id in active_uploads:
            del active_uploads[upload_id]
        
        return {'error': f'Erro ao processar: {str(e)}'}, 500

@app.route('/upload/status/<upload_id>')
@login_required
def upload_status(upload_id):
    """Verifica status de um upload em andamento"""
    if upload_id not in active_uploads:
        return {'error': 'Upload n√£o encontrado'}, 404
    
    info = active_uploads[upload_id]
    if info['user_id'] != current_user.id:
        return {'error': 'N√£o autorizado'}, 403
    
    return {
        'upload_id': upload_id,
        'filename': info['filename'],
        'received': len(info['received_chunks']),
        'total': info['total_chunks'],
        'progress': round((len(info['received_chunks']) / info['total_chunks']) * 100, 1)
    }

@app.route('/upload/queue-status')
@login_required
def upload_queue_status():
    """Retorna status da fila de uploads"""
    from upload_orchestrator import get_upload_orchestrator
    from object_storage import object_storage
    orchestrator = get_upload_orchestrator(app, db, object_storage)
    return orchestrator.get_status()

@app.route('/batch/diagnose-zip', methods=['POST'])
@login_required
def diagnose_zip():
    """Diagn√≥stico de ZIP - mostra quais arquivos ser√£o processados e quais ser√£o ignorados"""
    import zipfile
    
    if 'file' not in request.files:
        return {'error': 'Nenhum arquivo enviado'}, 400
    
    zip_file = request.files['file']
    if not zip_file.filename.lower().endswith('.zip'):
        return {'error': 'Envie um arquivo ZIP'}, 400
    
    temp_path = os.path.join('/tmp', f'diag_{datetime.now().strftime("%H%M%S")}.zip')
    zip_file.save(temp_path)
    
    try:
        allowed_extensions = {'.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.tiff', '.tif'}
        result = {
            'total_arquivos': 0,
            'imagens_validas': 0,
            'ignorados': {
                'sistema': [],
                'extensao_invalida': [],
                'ocultos': [],
                'sem_sku': []
            }
        }
        
        with zipfile.ZipFile(temp_path, 'r') as zip_ref:
            for file_info in zip_ref.infolist():
                if file_info.is_dir():
                    continue
                
                result['total_arquivos'] += 1
                full_path = file_info.filename
                filename = os.path.basename(full_path)
                
                if '__MACOSX' in full_path or '.DS_Store' in full_path or 'Thumbs.db' in filename:
                    result['ignorados']['sistema'].append(full_path)
                    continue
                
                ext = os.path.splitext(filename)[1].lower()
                
                if ext not in allowed_extensions:
                    result['ignorados']['extensao_invalida'].append({'arquivo': full_path, 'extensao': ext})
                    continue
                
                if filename.startswith('.') or filename.startswith('__'):
                    result['ignorados']['ocultos'].append(full_path)
                    continue
                
                sku = extract_sku_from_filename(filename)
                if not sku:
                    result['ignorados']['sem_sku'].append(full_path)
                    continue
                
                result['imagens_validas'] += 1
        
        result['resumo'] = {
            'total_no_zip': result['total_arquivos'],
            'serao_processados': result['imagens_validas'],
            'serao_ignorados': sum(len(v) for v in result['ignorados'].values()),
            'sistema': len(result['ignorados']['sistema']),
            'extensao_invalida': len(result['ignorados']['extensao_invalida']),
            'ocultos': len(result['ignorados']['ocultos']),
            'sem_sku': len(result['ignorados']['sem_sku'])
        }
        
        return result
        
    finally:
        if os.path.exists(temp_path):
            os.remove(temp_path)


# Initialize DB
with app.app_context():
    db.create_all()
    # Create a test user if not exists
    if not User.query.filter_by(username='admin').first():
        admin = User(username='admin', email='admin@oaz.com')
        admin.set_password('admin')
        db.session.add(admin)
        db.session.commit()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)

================================================================================
FILE: attached_assets/Pasted--2025-12-15-11-43-14-90-2fc88dfb-User-2025-12-15-14-43-_1765809821848.txt
================================================================================

2025-12-15 11:43:14.90
2fc88dfb
User
[2025-12-15 14:43:13.903] [INFO ] [BATCH ] [PROCESS ] [04.23.02.601.012_4] Tentativa #1
2025-12-15 11:43:14.90
2fc88dfb
User
File "/home/runner/workspace/batch_processor.py", line 292, in _process_single_item_isolated
2025-12-15 11:43:14.90
2fc88dfb
User
FileNotFoundError: Temp file not found: images/20251215135405_fc2a00b5.jpg
2025-12-15 11:43:14.90
2fc88dfb
User
Traceback (most recent call last):
2025-12-15 11:43:14.90
2fc88dfb
User
raise FileNotFoundError(f"Temp file not found: {temp_path}")
2025-12-15 11:43:14.90
2fc88dfb
User
[2025-12-15 14:43:14.704] [ERROR ] [BATCH ] [PROCESS ] [04.23.02.601.012_4] Arquivo tempor√°rio n√£o encontrado: images/20251215135405_fc2a00b5.jpg
2025-12-15 11:43:15.20
2fc88dfb
User
Traceback (most recent call last):
2025-12-15 11:43:15.80
2fc88dfb
User
> PING fd e2 ae c2 [binary, 4 bytes]
2025-12-15 11:43:16.60
2fc88dfb
User
[2025-12-15 14:43:16.603] [INFO ] [BATCH ] [PROCESS ] [04.23.02.601.012_3] Iniciando processamento...
2025-12-15 11:43:17.31
2fc88dfb
User
raise FileNotFoundError(f"Temp file not found: {temp_path}")
2025-12-15 11:43:17.31
2fc88dfb
User
File "/home/runner/workspace/batch_processor.py", line 292, in _process_single_item_isolated
2025-12-15 11:43:17.31
2fc88dfb
User
FileNotFoundError: Temp file not found: images/20251215135403_a917a8a7.jpg
2025-12-15 11:43:17.90
2fc88dfb
User
% sent keepalive ping
2025-12-15 11:43:18.50
2fc88dfb
User
< PING ac 14 57 8d [binary, 4 bytes]
2025-12-15 11:43:18.63
2fc88dfb
User
[2025-12-15 14:43:18.636] [INFO ] [BATCH ] [PROCESS ] [04.23.02.602.052_2] Iniciando processamento...
2025-12-15 11:43:19.06
2fc88dfb
User
[2025-12-15 14:43:19.069] [ERROR ] [BATCH ] [PROCESS ] [04.23.02.601.012_2] ‚úó ERRO: Temp file not found: images/20251215135406_39bcec28.jpg
2025-12-15 11:43:19.06
2fc88dfb
User
[2025-12-15 14:43:19.069] [INFO ] [BATCH ] [PROCESS ] [04.23.02.601.012_2] Tentativa #1
2025-12-15 11:43:19.06
2fc88dfb
User
[2025-12-15 14:43:19.069] [ERROR ] [BATCH ] [PROCESS ] [04.23.02.601.012_2] Arquivo tempor√°rio n√£o encontrado: images/20251215135406_39bcec28.jpg
2025-12-15 11:43:19.20
2fc88dfb
User
File "/home/runner/workspace/batch_processor.py", line 292, in _process_single_item_isolated
2025-12-15 11:43:19.20
2fc88dfb
User
Traceback (most recent call last):
2025-12-15 11:43:19.20
2fc88dfb
User
raise FileNotFoundError(f"Temp file not found: {temp_path}")
2025-12-15 11:43:19.20
2fc88dfb
User
FileNotFoundError: Temp file not found: images/20251215135406_39bcec28.jpg
2025-12-15 11:43:19.70
2fc88dfb
User
> PONG ac 14 57 8d [binary, 4 bytes]
2025-12-15 11:43:20.20
2fc88dfb
User
> TEXT 'V1|01|APP-BANCO-IMAGEM-OAZ|2025-12-15T14:43:19Z|Sudeste|INFO|alive||\n' [69 bytes]
2025-12-15 11:43:21.80
2fc88dfb
User
[2025-12-15 14:43:21.203] [INFO ] [BATCH ] [PROCESS ] [04.23.02.601.012_3] Tentativa #1
2025-12-15 11:43:21.80
2fc88dfb
User
[2025-12-15 14:43:20.503] [INFO ] [BATCH ] [PROCESS ] [04.23.02.602.052_3] Iniciando processamento...
2025-12-15 11:43:21.80
2fc88dfb
User
> TEXT 'V1|01|APP-BANCO-IMAGEM-OAZ|2025-12-15T14:43:15Z|Sudeste|INFO|alive||\n' [69 bytes]
2025-12-15 11:43:21.80
2fc88dfb
User
< PONG fd e2 ae c2 [binary, 4 bytes]
2025-12-15 11:43:21.80
2fc88dfb
User
% received keepalive pong
2025-12-15 11:43:23.40
2fc88dfb
User
[2025-12-15 14:43:21.402] [ERROR ] [BATCH ] [PROCESS ] [04.23.02.601.012_3] Arquivo tempor√°rio n√£o encontrado: images/20251215135407_f8abe2c9.jpg
2025-12-15 11:43:23.60
2fc88dfb
User
[2025-12-15 14:43:23.203] [ERROR ] [BATCH ] [PROCESS ] [04.23.02.601.012_3] ‚úó ERRO: Temp file not found: images/20251215135407_f8abe2c9.jpg
2025-12-15 11:43:23.60
2fc88dfb
User
[2025-12-15 14:43:22.103] [INFO ] [BATCH ] [PROCESS ] [04.23.02.602.052_1] Iniciando processamento...
2025-12-15 11:43:23.60
2fc88dfb
User
[2025-12-15 14:43:22.203] [INFO ] [BATCH ] [PROCESS ] [04.23.02.604.021_1] Iniciando processamento...

2025-12-15 11:43:25.10
2fc88dfb
User
> TEXT 'V1|01|APP-BANCO-IMAGEM-OAZ|2025-12-15T14:43:24Z|Sudeste|INFO|alive||\n' [69 bytes]
2025-12-15 11:43:25.50
2fc88dfb
User
> TEXT 'V1|01|APP-BANCO-IMAGEM-OAZ|2025-12-15T14:43:21Z|Sudeste|INFO|alive||\n' [69 bytes]
2025-12-15 11:43:26.10
2fc88dfb
User
> PONG bb 30 90 c3 [binary, 4 bytes]
2025-12-15 11:43:26.10
2fc88dfb
User
% sent keepalive ping
2025-12-15 11:43:26.10
2fc88dfb
User
> PING c7 7b 42 5e [binary, 4 bytes]
2025-12-15 11:43:26.10
2fc88dfb
User
< PING bb 30 90 c3 [binary, 4 bytes]

================================================================================
FILE: attached_assets/Pasted--fd-os-open-file-flags-0o600-OSError-Errno-122--1765494_1765494027393.txt
================================================================================

    fd = _os.open(file, flags, 0o600)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
OSError: [Errno 122] Disk quota exceeded: '/tmp/tmp_9ru70ul'
[2025-12-11 23:00:12.407] [WARN   ] [SYSTEM         ] [UPLOAD_RETRY] [JS] Retry 3/8 para 04.26.12.496.061_2.jpg (HTTP 500) | batch_id=12
172.31.88.162 - - [11/Dec/2025 23:00:12] "POST /api/log HTTP/1.1" 200 -
[2025-12-11 23:00:12.424] [WARN   ] [SYSTEM         ] [UPLOAD_RETRY] [JS] Retry 3/8 para 04.26.12.496.061_1.jpg (HTTP 500) | batch_id=12
172.31.88.162 - - [11/Dec/2025 23:00:12] "POST /api/log HTTP/1.1" 200 -
[2025-12-11 23:00:12.542] [WARN   ] [SYSTEM         ] [UPLOAD_RETRY] [JS] Retry 3/8 para 04.26.12.496.002_4.jpg (HTTP 500) | batch_id=12
172.31.88.162 - - [11/Dec/2025 23:00:12] "POST /api/log HTTP/1.1" 200 -
172.31.88.162 - - [11/Dec/2025 23:00:19] "POST /batch/upload-file HTTP/1.1" 500 -
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1536, in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1514, in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1511, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 919, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/app.py", line 4204, in batch_upload_file
    batch_id = request.form.get('batch_id')
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/utils.py", line 100, in __get__
    value = self.fget(obj)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 445, in form
    self._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/wrappers.py", line 198, in _load_form_data
    super()._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 271, in _load_form_data
    data = parser.parse(
           ^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 242, in parse
    return parse_func(stream, mimetype, content_length, options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 267, in _parse_multipart
    form, files = parser.parse(stream, boundary, content_length)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 391, in parse
    _write(event.data)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 844, in write
    self._check(file)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 712, in _check
    self.rollover()
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 717, in rollover
    newfile = self._file = TemporaryFile(**self._TemporaryFileArgs)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 674, in TemporaryFile
    file = _io.open(dir, mode, buffering=buffering,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 667, in opener
    fd, name = _mkstemp_inner(dir, prefix, suffix, flags, output_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 257, in _mkstemp_inner
    fd = _os.open(file, flags, 0o600)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
OSError: [Errno 122] Disk quota exceeded: '/tmp/tmpab1kg7de'
172.31.88.162 - - [11/Dec/2025 23:00:19] "POST /batch/upload-file HTTP/1.1" 500 -
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1536, in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1514, in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1511, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 919, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/app.py", line 4204, in batch_upload_file
    batch_id = request.form.get('batch_id')
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/utils.py", line 100, in __get__
    value = self.fget(obj)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 445, in form
    self._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/wrappers.py", line 198, in _load_form_data
    super()._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 271, in _load_form_data
    data = parser.parse(
           ^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 242, in parse
    return parse_func(stream, mimetype, content_length, options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 267, in _parse_multipart
    form, files = parser.parse(stream, boundary, content_length)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 391, in parse
    _write(event.data)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 844, in write
    self._check(file)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 712, in _check
    self.rollover()
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 717, in rollover
    newfile = self._file = TemporaryFile(**self._TemporaryFileArgs)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 674, in TemporaryFile
    file = _io.open(dir, mode, buffering=buffering,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 667, in opener
    fd, name = _mkstemp_inner(dir, prefix, suffix, flags, output_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 257, in _mkstemp_inner
    fd = _os.open(file, flags, 0o600)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
OSError: [Errno 122] Disk quota exceeded: '/tmp/tmp7zq6hjqv'
172.31.88.162 - - [11/Dec/2025 23:00:21] "POST /batch/upload-file HTTP/1.1" 500 -
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1536, in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1514, in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1511, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 919, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/app.py", line 4204, in batch_upload_file
    batch_id = request.form.get('batch_id')
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/utils.py", line 100, in __get__
    value = self.fget(obj)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 445, in form
    self._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/wrappers.py", line 198, in _load_form_data
    super()._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 271, in _load_form_data
    data = parser.parse(
           ^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 242, in parse
    return parse_func(stream, mimetype, content_length, options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 267, in _parse_multipart
    form, files = parser.parse(stream, boundary, content_length)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 391, in parse
    _write(event.data)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 844, in write
    self._check(file)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 712, in _check
    self.rollover()
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 717, in rollover
    newfile = self._file = TemporaryFile(**self._TemporaryFileArgs)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 674, in TemporaryFile
    file = _io.open(dir, mode, buffering=buffering,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 667, in opener
    fd, name = _mkstemp_inner(dir, prefix, suffix, flags, output_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 257, in _mkstemp_inner
    fd = _os.open(file, flags, 0o600)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
OSError: [Errno 122] Disk quota exceeded: '/tmp/tmpne785va_'
172.31.88.162 - - [11/Dec/2025 23:00:21] "POST /batch/upload-file HTTP/1.1" 500 -
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1536, in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1514, in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1511, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 919, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/app.py", line 4204, in batch_upload_file
    batch_id = request.form.get('batch_id')
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/utils.py", line 100, in __get__
    value = self.fget(obj)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 445, in form
    self._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/wrappers.py", line 198, in _load_form_data
    super()._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 271, in _load_form_data
    data = parser.parse(
           ^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 242, in parse
    return parse_func(stream, mimetype, content_length, options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 267, in _parse_multipart
    form, files = parser.parse(stream, boundary, content_length)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 391, in parse
    _write(event.data)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 844, in write
    self._check(file)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 712, in _check
    self.rollover()
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 717, in rollover
    newfile = self._file = TemporaryFile(**self._TemporaryFileArgs)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 674, in TemporaryFile
    file = _io.open(dir, mode, buffering=buffering,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 667, in opener
    fd, name = _mkstemp_inner(dir, prefix, suffix, flags, output_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 257, in _mkstemp_inner
    fd = _os.open(file, flags, 0o600)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
OSError: [Errno 122] Disk quota exceeded: '/tmp/tmplkdx_mvh'
172.31.88.162 - - [11/Dec/2025 23:00:21] "POST /batch/upload-file HTTP/1.1" 500 -
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1536, in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1514, in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 1511, in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 919, in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask_login/utils.py", line 290, in decorated_view
    return current_app.ensure_sync(func)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/app.py", line 4204, in batch_upload_file
    batch_id = request.form.get('batch_id')
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/utils.py", line 100, in __get__
    value = self.fget(obj)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 445, in form
    self._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/wrappers.py", line 198, in _load_form_data
    super()._load_form_data()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/wrappers/request.py", line 271, in _load_form_data
    data = parser.parse(
           ^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 242, in parse
    return parse_func(stream, mimetype, content_length, options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 267, in _parse_multipart
    form, files = parser.parse(stream, boundary, content_length)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/werkzeug/formparser.py", line 391, in parse
    _write(event.data)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 844, in write
    self._check(file)
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 712, in _check
    self.rollover()
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 717, in rollover
    newfile = self._file = TemporaryFile(**self._TemporaryFileArgs)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 674, in TemporaryFile
    file = _io.open(dir, mode, buffering=buffering,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 667, in opener
    fd, name = _mkstemp_inner(dir, prefix, suffix, flags, output_type)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/nix/store/7d088dip86hlzri9sk0h78b63yfmx0a0-python3-3.11.13/lib/python3.11/tempfile.py", line 257, in _mkstemp_inner
    fd = _os.open(file, flags, 0o600)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
OSError: [Errno 122] Disk quota exceeded: '/tmp/tmpodtc_bw6'
[2025-12-11 23:00:22.407] [WARN   ] [SYSTEM         ] [UPLOAD_RETRY] [JS] Retry 4/8 para 04.26.12.496.002_4.jpg (HTTP 500) | batch_id=12
172.31.88.162 - - [11/Dec/2025 23:00:22] "POST /api/log HTTP/1.1" 200 -
[2025-12-11 23:00:22.504] [WARN   ] [SYSTEM         ] [UPLOAD_RETRY] [JS] Retry 4/8 para 04.26.12.496.061_1.jpg (HTTP 500) | batch_id=12
172.31.88.162 - - [11/Dec/2025 23:00:22] "POST /api/log HTTP/1.1" 200 -
[2025-12-11 23:00:22.545] [WARN   ] [SYSTEM         ] [UPLOAD_RETRY] [JS] Retry 4/8 para 04.26.12.496.061_2.jpg (HTTP 500) | batch_id=12
172.31.88.162 - - [11/Dec/2025 23:00:22] "POST /api/log HTTP/1.1" 200 -

================================================================================
FILE: attached_assets/Pasted-Comportamento-esperado-Recebe-um-DataFrame-lido-do-Exce_1764700901446.txt
================================================================================
Comportamento esperado:

Recebe um DataFrame lido do Excel (pode ser de uma aba espec√≠fica).

Faz o mapeamento de colunas usando regra de "melhor esfor√ßo".

Regras de mapeamento (case-insensitive, ignorando acentos e espa√ßos extras):

SKU:

Se existir coluna chamada algo como:

"REFER√äNCIA E COR"

"REFERENCIA E COR"

"SKU"

"CODIGO"

Mapear essa coluna para sku.

DESCRICAO:

Se existir:

"NOME"

"NOME "

"NOME PRODUTO"

Mapear para descricao.

COR:

Se existir:

"NOME / COR"

"COR"

"COR PRODUTO"

Mapear para cor.

CATEGORIA:

Se existir:

"GRUPO"

"DEPARTAMENTO"

eventualmente combinar "GRUPO" com "TOP/BOTTOM/INTEIRO" (por exemplo f"{grupo} - {tipo}"), mas isso n√£o √© obrigat√≥rio.

Mapear o resultado para categoria.

QUANTIDADE:

Se existir coluna com:

"QUANTIDADE"

"QTD"

Usar como quantidade.

Sen√£o, definir quantidade = 1 para todas as linhas.

Qualquer coluna que n√£o encaixar nessas regras pode ser ignorada para o import.

No final, a fun√ß√£o deve devolver um DataFrame com pelo menos a coluna sku preenchida e, se poss√≠vel, descricao, cor, categoria, quantidade.

Lidar com m√∫ltiplas abas no Excel

A carteira pode vir com m√∫ltiplas abas, por exemplo: "ROUPAS", "HOME", "ACESS√ìRIOS".

Implementar uma l√≥gica assim:

Se houver m√∫ltiplas sheets:

Ler todas as sheets.

Para cada sheet, chamar a fun√ß√£o normalizar_carteira_dataframe(df_sheet).

Concatenar os DataFrames normalizados em um √∫nico DataFrame antes de alimentar a l√≥gica de import.

Se for necess√°rio, ignore sheets completamente vazias.

Reaproveitar a l√≥gica existente de import

Depois de normalizar as colunas (Excel ‚Üí padr√£o), N√ÉO reescreva toda a l√≥gica de cria√ß√£o da Carteira.

O ideal √©:

Transformar o DataFrame normalizado (de Excel) em uma estrutura compat√≠vel com o que j√° √© usado pelo import de CSV (um iterador de linhas com chaves sku, descricao, etc.).

Reutilizar a mesma fun√ß√£o ou bloco que:

verifica se o SKU j√° existe na CarteiraCompras,

atualiza ou cria o registro,

atribui status_foto inicial correto,

marca data_importacao e lote_importacao.

Mensagens e feedback ao usu√°rio

Se um arquivo Excel for importado com sucesso, mostrar uma mensagem clara (via flash) do tipo:

"Carteira importada com sucesso a partir de arquivo Excel. X itens processados."

Se nenhum campo de SKU for encontrado ap√≥s o mapeamento:

Exibir uma mensagem explicando que n√£o foi poss√≠vel encontrar a coluna de SKU e sugerir que a planilha tenha uma coluna como "REFER√äNCIA E COR" ou "SKU".

Explicar (dentro do sistema) como montar a carteira Excel

Na template da tela de import da carteira (provavelmente um HTML como carteira_import.html ou similar), adicione um pequeno bloco de texto explicando:

Que o sistema aceita agora:

CSV com as colunas: SKU, DESCRICAO, COR, CATEGORIA, QUANTIDADE.

EXCEL (xlsx/xls) com colunas como:

"REFER√äNCIA E COR" ‚Üí ser√° mapeado automaticamente para SKU

"NOME" ‚Üí descri√ß√£o

"NOME / COR" ‚Üí cor

"GRUPO" ‚Üí categoria

Que as outras colunas ser√£o ignoradas.

Que, se n√£o houver quantidade na planilha, ser√° assumido 1.

Garantir que n√£o quebre nada existente

Depois de implementar, verifique:

Import de CSV antigo continua funcionando do mesmo jeito.

Import de Excel funciona e preenche CarteiraCompras corretamente.

Auditoria, relat√≥rios e cruzamentos (produtos com foto/sem foto, diverg√™ncias de SKU etc.) continuam funcionando com a carteira vinda de Excel.

========================
ENTREGA ESPERADA

C√≥digo modificado com:

Rota de import aceitando xlsx/xls al√©m de csv.

Fun√ß√£o clara de normaliza√ß√£o/mapeamento de colunas de Excel para o padr√£o (sku, descricao, cor, categoria, quantidade).

Uso dessa fun√ß√£o para importar todas as sheets de um arquivo Excel.

Mensagens de erro/sucesso adequadas.

Pequena explica√ß√£o na UI (template) de como deve ser a carteira em Excel.

Sem quebrar o fluxo atual de CSV.

================================================================================
FILE: attached_assets/Pasted-Quero-que-voc-leia-o-c-digo-TODO-do-projeto-e-fa-a-as-s_1764700832050.txt
================================================================================
Quero que voc√™ leia o c√≥digo TODO do projeto e fa√ßa as seguintes altera√ß√µes de forma consistente.

========================
CONTEXTUALIZA√á√ÉO DO SISTEMA
========================
Este projeto √© um sistema de banco de imagens + carteira de compras, em Flask + SQLAlchemy.

Hoje j√° existe:
- Modelo de carteira de compras (CarteiraCompras), com campos como:
  - sku
  - descricao
  - cor
  - categoria
  - quantidade
  - status_foto
  - data_importacao
  - lote_importacao
- Uma rota de importa√ß√£o de carteira (provavelmente algo como /carteira/importar) que:
  - Aceita upload de arquivo .csv
  - Usa csv.DictReader
  - Procura colunas com os nomes (case-insensitive):
    - "sku" ou "SKU"             (OBRIGAT√ìRIO)
    - "descricao" ou "DESCRICAO" (opcional)
    - "cor" ou "COR"             (opcional)
    - "categoria" ou "CATEGORIA" (opcional)
    - "quantidade" ou "QUANTIDADE" (opcional, default = 1 se n√£o existir)
  - Para cada linha v√°lida, cria ou atualiza registros em CarteiraCompras.

O sistema j√° funciona bem com CSV nesse formato.

Por√©m, na pr√°tica, a carteira vem em arquivos EXCEL (xlsx) com colunas como:
- "REFER√äNCIA E COR"
- "NOME "
- "NOME / COR "
- "GRUPO"
- "TOP/BOTTOM/INTEIRO"
- e outras colunas que devem ser ignoradas para o import.

Exemplos de mapeamento desejado:
- Coluna "REFER√äNCIA E COR"  ‚Üí deve virar "SKU"
- Coluna "NOME "             ‚Üí deve virar "DESCRICAO"
- Coluna "NOME / COR "       ‚Üí deve virar "COR"
- Coluna "GRUPO"             ‚Üí pode virar "CATEGORIA"
- Coluna "TOP/BOTTOM/INTEIRO" pode entrar em CATEGORIA junto com GRUPO, ou ser ignorada por enquanto.

================================
OBJETIVO DA ALTERA√á√ÉO (IMPORTAR EXCEL)
================================
Quero adicionar uma funcionalidade para que o sistema aceite tamb√©m arquivos EXCEL (xlsx/xls) como "carteira" e fa√ßa o mapeamento autom√°tico para o formato que o sistema j√° espera, SEM quebrar a importa√ß√£o CSV atual.

Resumindo:
- Manter o comportamento atual para CSV funcionando.
- Adicionar suporte a XLS/XLSX.
- Fazer o mapeamento de colunas de Excel ‚Üí colunas padr√£o (`sku`, `descricao`, `cor`, `categoria`, `quantidade`).
- No final, alimentar a mesma l√≥gica de import j√° existente (ou algo equivalente) para popular CarteiraCompras.

====================
O QUE VOC√ä DEVE FAZER
====================

1) Localizar a rota de importa√ß√£o da carteira
--------------------------------------------
- Encontre a rota Flask respons√°vel por importar a carteira (algo como `/carteira/importar` ou similar).
- Entenda como ela:
  - Faz o upload do arquivo
  - Identifica se √© CSV
  - Usa csv.DictReader para iterar pelas linhas
  - Cria/atualiza CarteiraCompras.

2) Adicionar suporte a arquivos .xlsx e .xls
--------------------------------------------
- Permitir upload de arquivos `.xlsx` e `.xls` nessa mesma rota.
- Voc√™ pode usar `pandas` ou `openpyxl` ou a lib que j√° estiver no projeto (se alguma existir) para ler o Excel.
- Se precisar, adicione a depend√™ncia no `requirements.txt`.

Regras:
- Se o arquivo for `.csv`, manter o fluxo atual (n√£o quebrar nada).
- Se o arquivo for `.xlsx` ou `.xls`, seguir os passos abaixo.

3) Implementar uma fun√ß√£o de normaliza√ß√£o de coluna (Excel ‚Üí padr√£o esperado)
-------------------------------------------------------------------------------
Crie uma fun√ß√£o utilit√°ria, por exemplo:

```python
def normalizar_carteira_dataframe(df):
    ...
    return df_normalizado

================================================================================
FILE: attached_assets/Pasted-Sistema-de-Tutorial-Din-mico-Encapsulado-Objetivo-Criar_1765820177536.txt
================================================================================
Sistema de Tutorial Din√¢mico Encapsulado
Objetivo
Criar um sistema de tutorial interativo que intercepta TODAS as intera√ß√µes do usu√°rio (cliques, digita√ß√£o, submiss√µes) quando ativado, exibindo descri√ß√µes contextuais em vez de executar as a√ß√µes. Funciona com conte√∫do est√°tico e din√¢mico (AJAX, polling, SPA).

Arquitetura
1. TutorialManager (Classe JavaScript)
Adicione no template base ou layout principal:

class TutorialManager {
    constructor() {
        this.isActive = localStorage.getItem('tutorialMode') === 'true';
        this.modal = null;
        this.init();
    }
    
    init() {
        this.createModal();
        this.setupEventListeners();
        this.updateToggleButton();
    }
    
    createModal() {
        const modalHTML = `
        <div id="tutorialModal" class="tutorial-modal" style="display:none;">
            <div class="tutorial-modal-content">
                <span class="tutorial-modal-close">&times;</span>
                <h4 id="tutorialModalTitle"></h4>
                <p id="tutorialModalDesc"></p>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        this.modal = document.getElementById('tutorialModal');
        this.modal.querySelector('.tutorial-modal-close').onclick = () => this.hideModal();
    }
    
    setupEventListeners() {
        // DELEGA√á√ÉO GLOBAL - captura tudo, inclusive conte√∫do din√¢mico
        document.addEventListener('click', (e) => this.handleInteraction(e), true);
        document.addEventListener('submit', (e) => this.handleInteraction(e), true);
        document.addEventListener('change', (e) => this.handleInteraction(e), true);
        document.addEventListener('focus', (e) => this.handleFocus(e), true);
    }
    
    handleInteraction(e) {
        if (!this.isActive) return;
        
        const target = e.target.closest('button, a, input, select, textarea, [onclick], label, form');
        if (!target) return;
        
        // Excluir elementos do pr√≥prio tutorial
        if (target.closest('#tutorialModal, #tutorialToggle, .tutorial-excluded')) return;
        
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const info = this.getElementInfo(target);
        this.showModal(info.title, info.desc);
    }
    
    handleFocus(e) {
        if (!this.isActive) return;
        const target = e.target;
        if (target.matches('input, select, textarea, [contenteditable]')) {
            if (!target.closest('#tutorialModal, .tutorial-excluded')) {
                e.preventDefault();
                target.blur();
            }
        }
    }
    
    getElementInfo(el) {
        // 1. Atributos expl√≠citos t√™m prioridade
        let title = el.getAttribute('data-tutorial-title');
        let desc = el.getAttribute('data-tutorial-desc');
        
        if (title && desc) return { title, desc };
        
        // 2. Auto-gera√ß√£o baseada no contexto
        title = title || this.generateTitle(el);
        desc = desc || this.generateDescription(el);
        
        return { title, desc };
    }
    
    generateTitle(el) {
        // Texto do elemento
        const text = el.textContent?.trim()?.substring(0, 50);
        if (text && text.length > 2) return text;
        
        // T√≠tulo do tooltip
        const tooltip = el.getAttribute('title') || el.getAttribute('data-bs-original-title');
        if (tooltip) return tooltip;
        
        // √çcone Font Awesome
        const icon = el.querySelector('i[class*="fa-"]');
        if (icon) {
            const iconClass = [...icon.classList].find(c => c.startsWith('fa-') && c !== 'fa-fw');
            if (iconClass) return this.iconToTitle(iconClass);
        }
        
        // Tipo do input
        if (el.tagName === 'INPUT') return `Campo ${el.type || 'texto'}`;
        if (el.tagName === 'SELECT') return 'Sele√ß√£o';
        if (el.tagName === 'BUTTON') return 'Bot√£o';
        
        return 'Elemento interativo';
    }
    
    generateDescription(el) {
        // Placeholder
        if (el.placeholder) return `Digite: ${el.placeholder}`;
        
        // Aria-label
        if (el.getAttribute('aria-label')) return el.getAttribute('aria-label');
        
        // Label associado
        const label = document.querySelector(`label[for="${el.id}"]`);
        if (label) return `Campo: ${label.textContent.trim()}`;
        
        // Link - analisar href
        if (el.tagName === 'A' && el.href) {
            if (el.href.includes('/edit')) return 'Abre formul√°rio de edi√ß√£o';
            if (el.href.includes('/delete')) return 'Remove este item';
            if (el.href.includes('/view') || el.href.includes('/show')) return 'Visualiza detalhes';
            return 'Navega para outra p√°gina';
        }
        
        // Bot√£o submit
        if (el.type === 'submit') return 'Envia o formul√°rio';
        
        return 'Clique para interagir com este elemento';
    }
    
    iconToTitle(iconClass) {
        const map = {
            'fa-eye': 'Visualizar',
            'fa-edit': 'Editar',
            'fa-trash': 'Excluir',
            'fa-plus': 'Adicionar',
            'fa-save': 'Salvar',
            'fa-download': 'Download',
            'fa-upload': 'Upload',
            'fa-search': 'Pesquisar',
            'fa-filter': 'Filtrar',
            'fa-refresh': 'Atualizar',
            'fa-redo': 'Reprocessar',
            'fa-file-pdf': 'Documento PDF',
            'fa-camera': 'Captura de tela'
        };
        return map[iconClass] || iconClass.replace('fa-', '').replace(/-/g, ' ');
    }
    
    toggle() {
        this.isActive = !this.isActive;
        localStorage.setItem('tutorialMode', this.isActive);
        this.updateToggleButton();
        
        if (this.isActive) {
            document.querySelectorAll('input, textarea, select').forEach(el => el.blur());
        }
    }
    
    updateToggleButton() {
        const btn = document.getElementById('tutorialToggle');
        if (btn) {
            btn.classList.toggle('active', this.isActive);
            btn.innerHTML = this.isActive 
                ? '<i class="fas fa-question-circle"></i> Tutorial ATIVO'
                : '<i class="fas fa-question-circle"></i> Tutorial';
        }
    }
    
    showModal(title, desc) {
        document.getElementById('tutorialModalTitle').textContent = title;
        document.getElementById('tutorialModalDesc').textContent = desc;
        this.modal.style.display = 'flex';
    }
    
    hideModal() {
        this.modal.style.display = 'none';
    }
}
// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    window.tutorialManager = new TutorialManager();
});

2. CSS do Modal
.tutorial-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}
.tutorial-modal-content {
    background: white;
    padding: 25px;
    border-radius: 10px;
    max-width: 450px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
.tutorial-modal-close {
    float: right;
    font-size: 24px;
    cursor: pointer;
}
#tutorialToggle.active {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
}

3. Bot√£o Toggle (no header/navbar)
<button id="tutorialToggle" class="btn tutorial-excluded" onclick="tutorialManager.toggle()">
    <i class="fas fa-question-circle"></i> Tutorial
</button>

4. Elementos com Descri√ß√µes Espec√≠ficas
Para descri√ß√µes personalizadas, adicione atributos:

<button data-tutorial-title="Salvar Altera√ß√µes" 
        data-tutorial-desc="Salva todas as modifica√ß√µes feitas no formul√°rio.">
    <i class="fas fa-save"></i> Salvar
</button>

5. Conte√∫do Din√¢mico (JavaScript)
Quando gerar HTML via JavaScript, inclua os atributos:

buttonsHTML += `
    <a href="/item/${id}/edit" 
       data-tutorial-title="Editar Item"
       data-tutorial-desc="Abre o formul√°rio de edi√ß√£o deste item.">
        <i class="fas fa-edit"></i>
    </a>
`;

Caracter√≠sticas
Encapsulado: Uma √∫nica classe JavaScript
Port√°vel: Funciona em qualquer framework (Flask, Django, Node, PHP, etc.)
Din√¢mico: Event delegation no document captura elementos criados ap√≥s carregamento
Persistente: Estado salvo em localStorage
Auto-descritivo: Gera descri√ß√µes automaticamente quando n√£o especificadas
Exclus√µes: Use classe .tutorial-excluded para elementos que n√£o devem ser interceptados

================================================================================
FILE: attached_assets/image_1764688431490.png
================================================================================

================================================================================
FILE: attached_assets/image_1765222618160.png
================================================================================

================================================================================
FILE: attached_assets/image_1765223269842.png
================================================================================

================================================================================
FILE: attached_assets/image_1765388486682.png
================================================================================

================================================================================
FILE: attached_assets/image_1765393861939.png
================================================================================

================================================================================
FILE: attached_assets/image_1765393862388.png
================================================================================

================================================================================
FILE: attached_assets/image_1765404585125.png
================================================================================

================================================================================
FILE: attached_assets/image_1765404586694.png
================================================================================

================================================================================
FILE: batch_processor.py
================================================================================
"""
Batch Processor - Sistema de processamento em lote de imagens
Processa imagens em paralelo usando ThreadPoolExecutor com sess√µes de banco isoladas
Match prim√°rio com CarteiraCompras, API como fallback futuro
"""

import os
import io
import json
import zipfile
import tempfile
import traceback
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor, as_completed
from threading import Lock
import time
from PIL import Image as PILImage

from oaz_logger import (
    info, debug, warn, error, success,
    log_start, log_end, log_progress, log_error,
    batch_log, M
)

try:
    from rpa_monitor_client import rpa_info, rpa_warn, rpa_error as rpa_err
except ImportError:
    def rpa_info(msg): pass
    def rpa_warn(msg): pass
    def rpa_err(msg, **kwargs): pass

MAX_WORKERS = 5
MAX_RETRIES = 3
RETRY_DELAY = 2

progress_lock = Lock()

def log_batch(message, level="INFO"):
    """Logger centralizado para batch processing - usando sistema OAZ + RPA Monitor"""
    if level == "ERROR":
        error(M.BATCH, 'PROCESS', message)
        rpa_err(f"[BATCH] {message}", regiao="batch")
    elif level == "WARN":
        warn(M.BATCH, 'PROCESS', message)
        rpa_warn(f"[BATCH] {message}")
    elif level == "DEBUG":
        debug(M.BATCH, 'PROCESS', message)
    else:
        info(M.BATCH, 'PROCESS', message)
        rpa_info(f"[BATCH] {message}")

def generate_thumbnail_bytes(image_data, max_width=300, quality=75):
    """Gera thumbnail a partir de dados de imagem
    
    Args:
        image_data: bytes da imagem original
        max_width: largura m√°xima do thumbnail (default 300px)
        quality: qualidade JPEG (default 75%)
    
    Returns:
        tuple: (thumbnail_bytes, width, height, file_size) ou (None, None, None, None) em caso de erro
    """
    try:
        img = PILImage.open(io.BytesIO(image_data))
        
        if img.mode in ('RGBA', 'LA', 'P'):
            img = img.convert('RGB')
        
        original_width, original_height = img.size
        if original_width > max_width:
            ratio = max_width / original_width
            new_height = int(original_height * ratio)
            img = img.resize((max_width, new_height), PILImage.Resampling.LANCZOS)
        
        output = io.BytesIO()
        img.save(output, format='JPEG', quality=quality, optimize=True)
        thumbnail_bytes = output.getvalue()
        
        width, height = img.size
        file_size = len(thumbnail_bytes)
        
        log_batch(f"Thumbnail gerado: {width}x{height}, {file_size/1024:.1f}KB (original: {original_width}x{original_height})")
        
        return thumbnail_bytes, width, height, file_size
        
    except Exception as e:
        log_batch(f"Falha ao gerar thumbnail: {e}", "ERROR")
        return None, None, None, None

class BatchProcessor:
    """Processador de lotes de imagens com threading e sess√µes isoladas"""
    
    def __init__(self, app, db, object_storage, analyze_func=None):
        self.app = app
        self.db = db
        self.object_storage = object_storage
        self.analyze_func = analyze_func
        self.max_workers = app.config.get('MAX_BATCH_WORKERS', MAX_WORKERS)
    
    def process_batch(self, batch_id, temp_file_paths, skip_cleanup=False):
        """
        Processa um lote de imagens em paralelo usando arquivos tempor√°rios
        
        Args:
            batch_id: ID do BatchUpload
            temp_file_paths: Lista de dicts com {item_id, sku, temp_path, filename}
            skip_cleanup: Se True, n√£o remove arquivos tempor√°rios ap√≥s processamento
        """
        log_batch(f"========== INICIANDO PROCESSAMENTO LOTE #{batch_id} ==========")
        log_batch(f"Total de arquivos para processar: {len(temp_file_paths)}")
        log_batch(f"Workers paralelos: {self.max_workers}")
        
        with self.app.app_context():
            from app import BatchUpload
            batch = self.db.session.get(BatchUpload, batch_id)
            if not batch:
                log_batch(f"ERRO: Lote #{batch_id} n√£o encontrado no banco!", "ERROR")
                return
            
            batch.status = 'Processando'
            batch.started_at = datetime.utcnow()
            self.db.session.commit()
            log_batch(f"Status do lote atualizado para 'Processando'")
        
        processed_count = 0
        success_count = 0
        error_count = 0
        start_time = time.time()
        
        with ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            futures = {}
            
            log_batch(f"Submetendo {len(temp_file_paths)} tarefas ao executor...")
            for file_info in temp_file_paths:
                future = executor.submit(
                    self._process_single_item_isolated,
                    batch_id,
                    file_info['item_id'],
                    file_info['sku'],
                    file_info['temp_path'],
                    file_info['filename']
                )
                futures[future] = file_info['item_id']
            
            log_batch(f"Todas as tarefas submetidas. Aguardando conclus√£o...")
            
            for future in as_completed(futures):
                item_id = futures[future]
                try:
                    result = future.result()
                    processed_count += 1
                    if result['success']:
                        success_count += 1
                    else:
                        error_count += 1
                    self._update_batch_progress_atomic(batch_id, result['success'])
                    
                    if processed_count % 10 == 0 or processed_count == len(temp_file_paths):
                        elapsed = time.time() - start_time
                        rate = processed_count / elapsed if elapsed > 0 else 0
                        remaining = len(temp_file_paths) - processed_count
                        eta = remaining / rate if rate > 0 else 0
                        log_batch(f"Progresso: {processed_count}/{len(temp_file_paths)} ({success_count} OK, {error_count} erros) - {rate:.1f} img/s - ETA: {eta:.0f}s")
                        
                except Exception as e:
                    error_count += 1
                    processed_count += 1
                    log_batch(f"EXCE√á√ÉO processando item {item_id}: {e}", "ERROR")
                    self._update_batch_progress_atomic(batch_id, False)
        
        elapsed_total = time.time() - start_time
        log_batch(f"========== PROCESSAMENTO CONCLU√çDO ==========")
        log_batch(f"Lote #{batch_id}: {processed_count} processados em {elapsed_total:.1f}s")
        log_batch(f"Sucesso: {success_count} | Erros: {error_count}")
        log_batch(f"Taxa m√©dia: {processed_count/elapsed_total:.1f} imagens/segundo")
        
        with self.app.app_context():
            batch = self.db.session.get(BatchUpload, batch_id)
            if batch:
                batch.status = 'Conclu√≠do'
                batch.finished_at = datetime.utcnow()
                self.db.session.commit()
                log_batch(f"Status do lote atualizado para 'Conclu√≠do'")
        
        if not skip_cleanup:
            self._cleanup_temp_files(temp_file_paths)
            log_batch(f"Arquivos tempor√°rios limpos")
        else:
            log_batch(f"Cleanup ignorado (skip_cleanup=True)")
    
    def process_batch_from_bucket(self, batch_id, files_data):
        """
        Processa um lote de imagens que j√° est√£o no bucket (Object Storage).
        Suporta tanto imagens do bucket quanto arquivos locais legados.
        
        Args:
            batch_id: ID do BatchUpload
            files_data: Lista de dicts com:
                - {item_id, sku, storage_path, object_name, filename, source='bucket'} para bucket
                - {item_id, sku, temp_path, filename, source='local'} para legado
        """
        log_batch(f"========== INICIANDO PROCESSAMENTO LOTE #{batch_id} (BUCKET) ==========")
        log_batch(f"Total de arquivos para processar: {len(files_data)}")
        bucket_count = sum(1 for f in files_data if f.get('source') == 'bucket')
        local_count = sum(1 for f in files_data if f.get('source') == 'local')
        log_batch(f"Origem: {bucket_count} do bucket, {local_count} locais")
        log_batch(f"Workers paralelos: {self.max_workers}")
        
        with self.app.app_context():
            from app import BatchUpload
            batch = self.db.session.get(BatchUpload, batch_id)
            if not batch:
                log_batch(f"ERRO: Lote #{batch_id} n√£o encontrado no banco!", "ERROR")
                return
            
            batch.status = 'Processando'
            batch.started_at = datetime.utcnow()
            self.db.session.commit()
            log_batch(f"Status do lote atualizado para 'Processando'")
        
        processed_count = 0
        success_count = 0
        error_count = 0
        start_time = time.time()
        
        with ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            futures = {}
            
            log_batch(f"Submetendo {len(files_data)} tarefas ao executor...")
            for file_info in files_data:
                if file_info.get('source') == 'bucket':
                    future = executor.submit(
                        self._process_single_item_from_bucket,
                        batch_id,
                        file_info['item_id'],
                        file_info['sku'],
                        file_info['storage_path'],
                        file_info['object_name'],
                        file_info['filename']
                    )
                else:
                    future = executor.submit(
                        self._process_single_item_isolated,
                        batch_id,
                        file_info['item_id'],
                        file_info['sku'],
                        file_info['temp_path'],
                        file_info['filename']
                    )
                futures[future] = file_info['item_id']
            
            log_batch(f"Todas as tarefas submetidas. Aguardando conclus√£o...")
            
            for future in as_completed(futures):
                item_id = futures[future]
                try:
                    result = future.result()
                    processed_count += 1
                    if result['success']:
                        success_count += 1
                    else:
                        error_count += 1
                    self._update_batch_progress_atomic(batch_id, result['success'])
                    
                    if processed_count % 10 == 0 or processed_count == len(files_data):
                        elapsed = time.time() - start_time
                        rate = processed_count / elapsed if elapsed > 0 else 0
                        remaining = len(files_data) - processed_count
                        eta = remaining / rate if rate > 0 else 0
                        log_batch(f"Progresso: {processed_count}/{len(files_data)} ({success_count} OK, {error_count} erros) - {rate:.1f} img/s - ETA: {eta:.0f}s")
                        
                except Exception as e:
                    error_count += 1
                    processed_count += 1
                    log_batch(f"EXCE√á√ÉO processando item {item_id}: {e}", "ERROR")
                    self._update_batch_progress_atomic(batch_id, False)
        
        elapsed_total = time.time() - start_time
        log_batch(f"========== PROCESSAMENTO CONCLU√çDO ==========")
        log_batch(f"Lote #{batch_id}: {processed_count} processados em {elapsed_total:.1f}s")
        log_batch(f"Sucesso: {success_count} | Erros: {error_count}")
        if elapsed_total > 0:
            log_batch(f"Taxa m√©dia: {processed_count/elapsed_total:.1f} imagens/segundo")
        
        with self.app.app_context():
            batch = self.db.session.get(BatchUpload, batch_id)
            if batch:
                batch.status = 'Conclu√≠do'
                batch.finished_at = datetime.utcnow()
                self.db.session.commit()
                log_batch(f"Status do lote atualizado para 'Conclu√≠do'")
    
    def _process_single_item_from_bucket(self, batch_id, item_id, sku, storage_path, object_name, original_filename):
        """Processa um √∫nico item baixando a imagem do bucket"""
        from app import BatchUpload, BatchItem, Image, ImageItem, CarteiraCompras, ImageThumbnail
        
        log_batch(f"[{sku}] Iniciando processamento (bucket)...")
        
        with self.app.app_context():
            self.db.session.remove()
            
            item = self.db.session.get(BatchItem, item_id)
            if not item:
                log_batch(f"[{sku}] Item #{item_id} n√£o encontrado!", "ERROR")
                return {'success': False, 'error': 'Item not found'}
            
            item.status = 'Processando'
            item.processing_status = 'processing'
            item.tentativas += 1
            self.db.session.commit()
            log_batch(f"[{sku}] Tentativa #{item.tentativas}")
            
            try:
                log_batch(f"[{sku}] Baixando imagem do bucket: {object_name}...")
                image_data = self.object_storage.download_file(object_name)
                
                if not image_data:
                    log_batch(f"[{sku}] Imagem n√£o encontrada no bucket: {object_name}", "ERROR")
                    raise FileNotFoundError(f"Image not found in bucket: {object_name}")
                
                file_size_mb = len(image_data) / (1024 * 1024)
                log_batch(f"[{sku}] Arquivo: {original_filename} ({file_size_mb:.2f}MB)")
                
                batch = self.db.session.get(BatchUpload, batch_id)
                batch_colecao_id = batch.colecao_id if batch else None
                
                log_batch(f"[{sku}] Buscando na Carteira de Compras (cole√ß√£o: {batch_colecao_id})...")
                carteira_data = self._match_carteira_compras_in_session(sku, colecao_id=batch_colecao_id)
                
                if carteira_data and carteira_data.get('found'):
                    log_batch(f"[{sku}] ‚úì MATCH encontrado na Carteira! Desc: {carteira_data.get('descricao', '')[:50]}...")
                else:
                    log_batch(f"[{sku}] ‚úó Sem match na Carteira - ser√° marcado para an√°lise IA")
                
                import uuid
                unique_code = f"IMG-{uuid.uuid4().hex[:8].upper()}"
                
                if carteira_data and carteira_data.get('found'):
                    nome_peca = carteira_data.get('descricao', '')
                    cor = carteira_data.get('cor', '')
                    categoria = carteira_data.get('categoria', '')
                    subcategoria = carteira_data.get('subcategoria', '')
                    material = carteira_data.get('material', '')
                    tipo_peca = carteira_data.get('tipo_peca', '')
                    posicao_peca = carteira_data.get('posicao_peca', '')
                    
                    tags_list = []
                    if categoria:
                        tags_list.append(categoria)
                    if subcategoria:
                        tags_list.append(subcategoria)
                    if cor:
                        tags_list.append(cor)
                    if carteira_data.get('colecao_nome'):
                        tags_list.append(carteira_data['colecao_nome'])
                    if material and material not in tags_list:
                        tags_list.append(material)
                    if tipo_peca and tipo_peca not in tags_list:
                        tags_list.append(tipo_peca)
                    
                    image_status = 'Pendente'
                    
                    collection_id = carteira_data.get('colecao_id') if carteira_data.get('colecao_id') else (batch.colecao_id if batch else None)
                    subcolecao_id = carteira_data.get('subcolecao_id') if carteira_data.get('subcolecao_id') else (batch.subcolecao_id if batch and hasattr(batch, 'subcolecao_id') else None)
                    brand_id = carteira_data.get('marca_id') if carteira_data.get('marca_id') else (batch.marca_id if batch else None)
                    estilista = carteira_data.get('estilista', '')
                    origem = carteira_data.get('origem', '')
                    referencia_estilo = carteira_data.get('referencia_estilo', '')
                    
                    carteira = self.db.session.get(CarteiraCompras, carteira_data['carteira_id'])
                    if carteira:
                        carteira.status_foto = 'Com Foto'
                        self.db.session.add(carteira)
                    
                    from app import Produto
                    produto = self.db.session.query(Produto).filter_by(sku=carteira_data.get('sku_base', sku)).first()
                    if not produto:
                        produto = self.db.session.query(Produto).filter_by(sku=sku).first()
                    if produto:
                        produto.tem_foto = True
                        self.db.session.add(produto)
                        log_batch(f"[{sku}] ‚úì Produto atualizado: tem_foto=True")
                    
                    match_source = 'carteira'
                else:
                    nome_peca = ''
                    cor = ''
                    categoria = ''
                    material = ''
                    tipo_peca = ''
                    posicao_peca = ''
                    tags_list = []
                    image_status = 'Pendente An√°lise IA'
                    collection_id = batch.colecao_id if batch else None
                    subcolecao_id = batch.subcolecao_id if batch and hasattr(batch, 'subcolecao_id') else None
                    brand_id = batch.marca_id if batch else None
                    estilista = ''
                    origem = ''
                    referencia_estilo = ''
                    match_source = 'sem_match'
                
                sku_base = carteira_data.get('sku_base', sku) if carteira_data else sku
                sequencia = carteira_data.get('sequencia') if carteira_data else None
                
                ext = os.path.splitext(original_filename)[1] or '.jpg'
                new_image = Image(
                    filename=f"{sku}{ext}",
                    original_name=original_filename,
                    storage_path=storage_path,
                    sku=sku,
                    sku_base=sku_base,
                    sequencia=sequencia,
                    nome_peca=nome_peca,
                    description=None,
                    tags=json.dumps(tags_list),
                    ai_item_type=tipo_peca if tipo_peca else (categoria if carteira_data else None),
                    ai_color=cor if carteira_data else None,
                    ai_material=material if material else None,
                    ai_pattern=posicao_peca if posicao_peca else None,
                    ai_style=None,
                    uploader_id=batch.usuario_id if batch else None,
                    collection_id=collection_id,
                    subcolecao_id=subcolecao_id,
                    brand_id=brand_id,
                    unique_code=unique_code,
                    status=image_status,
                    estilista=estilista if estilista else None,
                    origem=origem if origem else None,
                    referencia_estilo=referencia_estilo if referencia_estilo else None
                )
                self.db.session.add(new_image)
                self.db.session.flush()
                
                if carteira_data and carteira_data.get('found'):
                    position_ref = 'Pe√ßa √önica'
                    if posicao_peca:
                        if 'TOP' in posicao_peca.upper():
                            position_ref = 'Pe√ßa Superior'
                        elif 'BOTTOM' in posicao_peca.upper():
                            position_ref = 'Pe√ßa Inferior'
                        elif 'INTEIRO' in posicao_peca.upper():
                            position_ref = 'Pe√ßa √önica'
                    
                    new_item_obj = ImageItem(
                        image_id=new_image.id,
                        item_order=1,
                        position_ref=position_ref,
                        description=nome_peca,
                        tags=json.dumps(tags_list),
                        ai_item_type=tipo_peca if tipo_peca else categoria,
                        ai_color=cor,
                        ai_material=material if material else None,
                        ai_pattern=None,
                        ai_style=None
                    )
                    self.db.session.add(new_item_obj)
                
                item = self.db.session.get(BatchItem, item_id)
                item.status = 'Sucesso'
                item.processing_status = 'completed'
                item.image_id = new_image.id
                item.ai_description = nome_peca
                item.ai_tags = json.dumps(tags_list)
                item.ai_attributes = json.dumps({
                    'match_source': match_source,
                    'categoria': categoria,
                    'cor': cor,
                    'carteira_id': carteira_data.get('carteira_id') if carteira_data else None,
                    'subcolecao_id': subcolecao_id,
                    'estilista': estilista if estilista else None,
                    'origem': origem if origem else None,
                    'referencia_estilo': referencia_estilo if referencia_estilo else None
                })
                item.processed_at = datetime.utcnow()
                item.erro_mensagem = None
                
                log_batch(f"[{sku}] Gerando thumbnail...")
                try:
                    thumbnail_bytes, thumb_width, thumb_height, thumb_size = generate_thumbnail_bytes(image_data)
                    
                    if thumbnail_bytes:
                        thumbnail = ImageThumbnail(
                            image_id=new_image.id,
                            thumbnail_data=thumbnail_bytes,
                            width=thumb_width,
                            height=thumb_height,
                            file_size=thumb_size,
                            mime_type='image/jpeg'
                        )
                        self.db.session.add(thumbnail)
                        log_batch(f"[{sku}] ‚úì Thumbnail salvo: {thumb_size/1024:.1f}KB")
                    else:
                        log_batch(f"[{sku}] ‚ö† Thumbnail n√£o gerado", "WARN")
                except Exception as thumb_err:
                    log_batch(f"[{sku}] ‚ö† Erro ao gerar thumbnail: {thumb_err}", "WARN")
                
                self.db.session.commit()
                
                del image_data
                
                log_batch(f"[{sku}] ‚úì SUCESSO - Imagem #{new_image.id} criada (match: {match_source})")
                return {'success': True, 'image_id': new_image.id, 'match_source': match_source}
                
            except Exception as e:
                error_msg = str(e)
                log_batch(f"[{sku}] ‚úó ERRO: {error_msg}", "ERROR")
                traceback.print_exc()
                
                self.db.session.rollback()
                
                item = self.db.session.get(BatchItem, item_id)
                if item:
                    item.status = 'Erro'
                    item.processing_status = 'failed'
                    item.erro_mensagem = error_msg[:500]
                    item.processed_at = datetime.utcnow()
                    self.db.session.commit()
                
                return {'success': False, 'error': error_msg}
    
    def _match_carteira_compras_in_session(self, sku_completo, colecao_id=None):
        """
        Busca dados da CarteiraCompras pelo SKU usando a sess√£o atual.
        Tenta primeiro com SKU completo, depois com SKU base (sem sufixos).
        IMPORTANTE: S√≥ faz match com a cole√ß√£o especificada (do batch).
        
        Args:
            sku_completo: C√≥digo SKU completo do arquivo (ex: ABC123_01)
            colecao_id: ID da cole√ß√£o do batch (filtra o match apenas para esta cole√ß√£o)
            
        Returns:
            Dict com dados da carteira ou None se n√£o encontrar
        """
        from app import CarteiraCompras
        from sqlalchemy import func
        
        sku_base, sequencia = extract_sku_base_and_sequence(sku_completo)
        
        query = self.db.session.query(CarteiraCompras).filter_by(sku=sku_completo)
        if colecao_id:
            query = query.filter(CarteiraCompras.colecao_id == colecao_id)
        carteira = query.first()
        
        if not carteira:
            sku_upper = sku_completo.upper().strip()
            query = self.db.session.query(CarteiraCompras).filter(
                func.upper(func.trim(CarteiraCompras.sku)) == sku_upper
            )
            if colecao_id:
                query = query.filter(CarteiraCompras.colecao_id == colecao_id)
            carteira = query.first()
        
        if not carteira and sku_base and sku_base != sku_completo:
            query = self.db.session.query(CarteiraCompras).filter_by(sku=sku_base)
            if colecao_id:
                query = query.filter(CarteiraCompras.colecao_id == colecao_id)
            carteira = query.first()
            
            if not carteira:
                sku_base_upper = sku_base.upper().strip()
                query = self.db.session.query(CarteiraCompras).filter(
                    func.upper(func.trim(CarteiraCompras.sku)) == sku_base_upper
                )
                if colecao_id:
                    query = query.filter(CarteiraCompras.colecao_id == colecao_id)
                carteira = query.first()
        
        if carteira:
            return {
                'found': True,
                'sku_base': sku_base,
                'sequencia': sequencia,
                'descricao': carteira.descricao or '',
                'cor': carteira.cor or '',
                'categoria': carteira.categoria or '',
                'subcategoria': carteira.subcategoria or '',
                'colecao_nome': carteira.colecao_nome or '',
                'colecao_id': carteira.colecao_id,
                'subcolecao_id': carteira.subcolecao_id,
                'marca_id': carteira.marca_id,
                'estilista': carteira.estilista or '',
                'shooting': carteira.shooting or '',
                'observacoes': carteira.observacoes or '',
                'origem': carteira.origem or '',
                'carteira_id': carteira.id,
                'material': carteira.material or carteira.categoria or '',
                'tipo_peca': carteira.tipo_peca or carteira.subcategoria or '',
                'posicao_peca': carteira.posicao_peca or '',
                'referencia_estilo': carteira.referencia_estilo or '',
                'tipo_carteira': carteira.tipo_carteira or 'Moda'
            }
        
        return {
            'found': False,
            'sku_base': sku_base,
            'sequencia': sequencia
        }
    
    def _process_single_item_isolated(self, batch_id, item_id, sku, temp_path, original_filename):
        """Processa um √∫nico item com sess√£o de banco isolada"""
        from app import BatchUpload, BatchItem, Image, ImageItem, CarteiraCompras, ImageThumbnail
        
        log_batch(f"[{sku}] Iniciando processamento...")
        
        with self.app.app_context():
            self.db.session.remove()
            
            item = self.db.session.get(BatchItem, item_id)
            if not item:
                log_batch(f"[{sku}] Item #{item_id} n√£o encontrado!", "ERROR")
                return {'success': False, 'error': 'Item not found'}
            
            item.status = 'Processando'
            item.processing_status = 'processing'
            item.tentativas += 1
            self.db.session.commit()
            log_batch(f"[{sku}] Tentativa #{item.tentativas}")
            
            try:
                if not os.path.exists(temp_path):
                    log_batch(f"[{sku}] Arquivo tempor√°rio n√£o encontrado: {temp_path}", "ERROR")
                    raise FileNotFoundError(f"Temp file not found: {temp_path}")
                
                file_size_mb = os.path.getsize(temp_path) / (1024 * 1024)
                log_batch(f"[{sku}] Arquivo: {original_filename} ({file_size_mb:.2f}MB)")
                
                batch = self.db.session.get(BatchUpload, batch_id)
                batch_colecao_id = batch.colecao_id if batch else None
                
                log_batch(f"[{sku}] Buscando na Carteira de Compras (cole√ß√£o: {batch_colecao_id})...")
                carteira_data = self._match_carteira_compras_in_session(sku, colecao_id=batch_colecao_id)
                
                if carteira_data and carteira_data.get('found'):
                    log_batch(f"[{sku}] ‚úì MATCH encontrado na Carteira! Desc: {carteira_data.get('descricao', '')[:50]}...")
                else:
                    log_batch(f"[{sku}] ‚úó Sem match na Carteira - ser√° marcado para an√°lise IA")
                
                log_batch(f"[{sku}] Fazendo upload para Object Storage...")
                storage_result = None
                for attempt in range(MAX_RETRIES):
                    try:
                        with open(temp_path, 'rb') as f:
                            ext = os.path.splitext(original_filename)[1] or '.jpg'
                            storage_result = self.object_storage.upload_file(f, f"{sku}{ext}")
                        log_batch(f"[{sku}] ‚úì Upload conclu√≠do")
                        break
                    except Exception as e:
                        log_batch(f"[{sku}] Upload falhou (tentativa {attempt+1}/{MAX_RETRIES}): {e}", "WARN")
                        if attempt < MAX_RETRIES - 1:
                            time.sleep(RETRY_DELAY * (attempt + 1))
                        else:
                            raise e
                
                storage_path = storage_result.get('storage_path') if storage_result else None
                
                import uuid
                unique_code = f"IMG-{uuid.uuid4().hex[:8].upper()}"
                
                if carteira_data and carteira_data.get('found'):
                    nome_peca = carteira_data.get('descricao', '')  # Nome da pe√ßa vai para campo separado
                    cor = carteira_data.get('cor', '')
                    categoria = carteira_data.get('categoria', '')
                    subcategoria = carteira_data.get('subcategoria', '')
                    material = carteira_data.get('material', '')
                    tipo_peca = carteira_data.get('tipo_peca', '')
                    posicao_peca = carteira_data.get('posicao_peca', '')
                    
                    tags_list = []
                    if categoria:
                        tags_list.append(categoria)
                    if subcategoria:
                        tags_list.append(subcategoria)
                    if cor:
                        tags_list.append(cor)
                    if carteira_data.get('colecao_nome'):
                        tags_list.append(carteira_data['colecao_nome'])
                    if material and material not in tags_list:
                        tags_list.append(material)
                    if tipo_peca and tipo_peca not in tags_list:
                        tags_list.append(tipo_peca)
                    
                    image_status = 'Pendente'
                    
                    collection_id = carteira_data.get('colecao_id') if carteira_data.get('colecao_id') else (batch.colecao_id if batch else None)
                    subcolecao_id = carteira_data.get('subcolecao_id') if carteira_data.get('subcolecao_id') else (batch.subcolecao_id if batch and hasattr(batch, 'subcolecao_id') else None)
                    brand_id = carteira_data.get('marca_id') if carteira_data.get('marca_id') else (batch.marca_id if batch else None)
                    estilista = carteira_data.get('estilista', '')
                    origem = carteira_data.get('origem', '')
                    referencia_estilo = carteira_data.get('referencia_estilo', '')
                    
                    carteira = self.db.session.get(CarteiraCompras, carteira_data['carteira_id'])
                    if carteira:
                        carteira.status_foto = 'Com Foto'
                        self.db.session.add(carteira)
                    
                    from app import Produto
                    produto = self.db.session.query(Produto).filter_by(sku=carteira_data.get('sku_base', sku)).first()
                    if not produto:
                        produto = self.db.session.query(Produto).filter_by(sku=sku).first()
                    if produto:
                        produto.tem_foto = True
                        self.db.session.add(produto)
                        log_batch(f"[{sku}] ‚úì Produto atualizado: tem_foto=True")
                    
                    match_source = 'carteira'
                else:
                    nome_peca = ''  # Sem match, nome_peca vazio
                    cor = ''
                    categoria = ''
                    material = ''
                    tipo_peca = ''
                    posicao_peca = ''
                    tags_list = []
                    image_status = 'Pendente An√°lise IA'
                    collection_id = batch.colecao_id if batch else None
                    subcolecao_id = batch.subcolecao_id if batch and hasattr(batch, 'subcolecao_id') else None
                    brand_id = batch.marca_id if batch else None
                    estilista = ''
                    origem = ''
                    referencia_estilo = ''
                    match_source = 'sem_match'
                
                sku_base = carteira_data.get('sku_base', sku) if carteira_data else sku
                sequencia = carteira_data.get('sequencia') if carteira_data else None
                
                ext = os.path.splitext(original_filename)[1] or '.jpg'
                new_image = Image(
                    filename=f"{sku}{ext}",
                    original_name=original_filename,
                    storage_path=storage_path,
                    sku=sku,
                    sku_base=sku_base,
                    sequencia=sequencia,
                    nome_peca=nome_peca,  # Nome da pe√ßa da Carteira
                    description=None,  # Descri√ß√£o ser√° preenchida pela IA
                    tags=json.dumps(tags_list),
                    ai_item_type=tipo_peca if tipo_peca else (categoria if carteira_data else None),
                    ai_color=cor if carteira_data else None,
                    ai_material=material if material else None,
                    ai_pattern=posicao_peca if posicao_peca else None,
                    ai_style=None,
                    uploader_id=batch.usuario_id if batch else None,
                    collection_id=collection_id,
                    subcolecao_id=subcolecao_id,
                    brand_id=brand_id,
                    unique_code=unique_code,
                    status=image_status,
                    estilista=estilista if estilista else None,
                    origem=origem if origem else None,
                    referencia_estilo=referencia_estilo if referencia_estilo else None
                )
                self.db.session.add(new_image)
                self.db.session.flush()
                
                if carteira_data and carteira_data.get('found'):
                    position_ref = 'Pe√ßa √önica'
                    if posicao_peca:
                        if 'TOP' in posicao_peca.upper():
                            position_ref = 'Pe√ßa Superior'
                        elif 'BOTTOM' in posicao_peca.upper():
                            position_ref = 'Pe√ßa Inferior'
                        elif 'INTEIRO' in posicao_peca.upper():
                            position_ref = 'Pe√ßa √önica'
                    
                    new_item_obj = ImageItem(
                        image_id=new_image.id,
                        item_order=1,
                        position_ref=position_ref,
                        description=nome_peca,  # ImageItem recebe o nome da pe√ßa
                        tags=json.dumps(tags_list),
                        ai_item_type=tipo_peca if tipo_peca else categoria,
                        ai_color=cor,
                        ai_material=material if material else None,
                        ai_pattern=None,
                        ai_style=None
                    )
                    self.db.session.add(new_item_obj)
                
                item = self.db.session.get(BatchItem, item_id)
                item.status = 'Sucesso'
                item.processing_status = 'completed'
                item.storage_path = storage_path
                item.image_id = new_image.id
                item.ai_description = nome_peca
                item.ai_tags = json.dumps(tags_list)
                item.ai_attributes = json.dumps({
                    'match_source': match_source,
                    'categoria': categoria,
                    'cor': cor,
                    'carteira_id': carteira_data.get('carteira_id') if carteira_data else None,
                    'subcolecao_id': subcolecao_id,
                    'estilista': estilista if estilista else None,
                    'origem': origem if origem else None,
                    'referencia_estilo': referencia_estilo if referencia_estilo else None
                })
                item.processed_at = datetime.utcnow()
                item.erro_mensagem = None
                
                log_batch(f"[{sku}] Gerando thumbnail...")
                try:
                    with open(temp_path, 'rb') as f:
                        image_data = f.read()
                    thumbnail_bytes, thumb_width, thumb_height, thumb_size = generate_thumbnail_bytes(image_data)
                    
                    if thumbnail_bytes:
                        thumbnail = ImageThumbnail(
                            image_id=new_image.id,
                            thumbnail_data=thumbnail_bytes,
                            width=thumb_width,
                            height=thumb_height,
                            file_size=thumb_size,
                            mime_type='image/jpeg'
                        )
                        self.db.session.add(thumbnail)
                        log_batch(f"[{sku}] ‚úì Thumbnail salvo: {thumb_size/1024:.1f}KB")
                    else:
                        log_batch(f"[{sku}] ‚ö† Thumbnail n√£o gerado", "WARN")
                except Exception as thumb_err:
                    log_batch(f"[{sku}] ‚ö† Erro ao gerar thumbnail: {thumb_err}", "WARN")
                
                self.db.session.commit()
                
                log_batch(f"[{sku}] ‚úì SUCESSO - Imagem #{new_image.id} criada (match: {match_source})")
                return {'success': True, 'image_id': new_image.id, 'match_source': match_source}
                
            except Exception as e:
                error_msg = str(e)
                log_batch(f"[{sku}] ‚úó ERRO: {error_msg}", "ERROR")
                traceback.print_exc()
                
                self.db.session.rollback()
                
                item = self.db.session.get(BatchItem, item_id)
                if item:
                    item.status = 'Erro'
                    item.processing_status = 'failed'
                    item.erro_mensagem = error_msg[:500]
                    item.processed_at = datetime.utcnow()
                    self.db.session.commit()
                
                return {'success': False, 'error': error_msg}
    
    def _update_batch_progress_atomic(self, batch_id, success):
        """Atualiza o progresso do batch de forma at√¥mica usando lock"""
        with progress_lock:
            with self.app.app_context():
                self.db.session.remove()
                from app import BatchUpload
                batch = self.db.session.get(BatchUpload, batch_id)
                if batch:
                    batch.processados = (batch.processados or 0) + 1
                    if success:
                        batch.sucesso = (batch.sucesso or 0) + 1
                    else:
                        batch.falhas = (batch.falhas or 0) + 1
                    self.db.session.commit()
    
    def _cleanup_temp_files(self, temp_file_paths):
        """Remove arquivos tempor√°rios e diret√≥rio ap√≥s processamento"""
        import shutil
        temp_dirs = set()
        
        for file_info in temp_file_paths:
            temp_path = file_info.get('temp_path')
            if temp_path:
                temp_dirs.add(os.path.dirname(temp_path))
                if os.path.exists(temp_path):
                    try:
                        os.remove(temp_path)
                    except Exception as e:
                        print(f"[WARN] Could not delete temp file {temp_path}: {e}")
        
        for temp_dir in temp_dirs:
            if temp_dir and os.path.exists(temp_dir) and temp_dir.startswith('/tmp'):
                try:
                    shutil.rmtree(temp_dir, ignore_errors=True)
                except Exception as e:
                    print(f"[WARN] Could not delete temp dir {temp_dir}: {e}")
    
    def process_multiple_batches(self, batch_ids):
        """
        Processa m√∫ltiplos batches em sequ√™ncia.
        Usado para processar todos os batches de uma fila de upload.
        
        Args:
            batch_ids: Lista de IDs de BatchUpload para processar
        """
        log_batch(f"========== PROCESSANDO M√öLTIPLOS BATCHES ==========")
        log_batch(f"Total de batches para processar: {len(batch_ids)}")
        
        all_temp_files = []
        
        for idx, batch_id in enumerate(batch_ids):
            log_batch(f"--- Batch {idx + 1}/{len(batch_ids)} (ID: {batch_id}) ---")
            
            temp_file_paths = []
            
            with self.app.app_context():
                from app import BatchUpload, BatchItem
                
                batch = self.db.session.get(BatchUpload, batch_id)
                if not batch:
                    log_batch(f"Batch {batch_id} n√£o encontrado, pulando...", "WARN")
                    continue
                
                pending_items = self.db.session.query(BatchItem).filter_by(
                    batch_id=batch_id,
                    processing_status='pending'
                ).all()
                
                if not pending_items:
                    log_batch(f"Batch {batch_id} n√£o tem itens pendentes, pulando...")
                    batch.status = 'Conclu√≠do'
                    self.db.session.commit()
                    continue
                
                for item in pending_items:
                    if item.received_path:
                        is_object_storage = item.received_path.startswith('images/')
                        is_local_file = os.path.exists(item.received_path) if not is_object_storage else False
                        
                        if is_object_storage or is_local_file:
                            temp_file_paths.append({
                                'item_id': item.id,
                                'sku': item.sku,
                                'temp_path': item.received_path,
                                'filename': item.filename_original,
                                'is_object_storage': is_object_storage
                            })
                        else:
                            log_batch(f"Arquivo n√£o encontrado para item {item.id}: {item.received_path}", "WARN")
                            item.processing_status = 'failed'
                            item.erro_mensagem = 'Arquivo n√£o encontrado'
                    else:
                        log_batch(f"Item {item.id} sem caminho de arquivo", "WARN")
                        item.processing_status = 'failed'
                        item.erro_mensagem = 'Caminho de arquivo vazio'
                
                self.db.session.commit()
            
            if temp_file_paths:
                log_batch(f"Iniciando processamento de {len(temp_file_paths)} itens do batch {batch_id}")
                all_temp_files.extend(temp_file_paths)
                self.process_batch(batch_id, temp_file_paths, skip_cleanup=True)
            else:
                with self.app.app_context():
                    batch = self.db.session.get(BatchUpload, batch_id)
                    if batch:
                        log_batch(f"Nenhum arquivo v√°lido para processar no batch {batch_id}", "WARN")
                        batch.status = 'Erro'
                        batch.finished_at = datetime.utcnow()
                        self.db.session.commit()
        
        if all_temp_files:
            log_batch(f"Limpando {len(all_temp_files)} arquivos tempor√°rios de todos os batches...")
            self._cleanup_temp_files(all_temp_files)
        
        log_batch(f"========== TODOS OS BATCHES PROCESSADOS ==========")


def extract_sku_from_filename(filename):
    """Extrai o SKU completo do nome do arquivo (remove extens√£o)"""
    name = os.path.basename(filename)
    sku = os.path.splitext(name)[0]
    return sku.strip()


def extract_sku_base_and_sequence(sku_completo):
    """
    Extrai o SKU base e a sequ√™ncia/√¢ngulo de um SKU completo.
    
    Exemplos:
        "ABC123_01" -> ("ABC123", "01")
        "ABC123_02" -> ("ABC123", "02")
        "ABC123-A" -> ("ABC123", "A")
        "ABC123-B" -> ("ABC123", "B")
        "ABC123_FRENTE" -> ("ABC123", "FRENTE")
        "ABC123" -> ("ABC123", None)  # Sem sufixo = imagem principal
    
    Padr√µes reconhecidos:
        - _01, _02, _03... (n√∫meros com underscore)
        - -01, -02, -03... (n√∫meros com h√≠fen)
        - _A, _B, _C... (letras com underscore)
        - -A, -B, -C... (letras com h√≠fen)
        - _FRENTE, _COSTAS, _LATERAL... (descritivos)
    """
    import re
    
    if not sku_completo:
        return (None, None)
    
    sku = sku_completo.strip()
    
    patterns = [
        r'^(.+?)[-_](\d{1,3})$',
        r'^(.+?)[-_]([A-Za-z])$',
        r'^(.+?)[-_](FRENTE|COSTAS|LATERAL|DETALHE|ZOOM|VERSO|CIMA|BAIXO|TOP|BOTTOM)$',
    ]
    
    for pattern in patterns:
        match = re.match(pattern, sku, re.IGNORECASE)
        if match:
            sku_base = match.group(1).strip()
            sequencia = match.group(2).strip().upper()
            return (sku_base, sequencia)
    
    return (sku, None)


def extract_zip_to_temp(zip_path, temp_dir):
    """
    Extrai arquivos de imagem de um ZIP para diret√≥rio tempor√°rio usando streaming
    
    Args:
        zip_path: Caminho do arquivo ZIP
        temp_dir: Diret√≥rio tempor√°rio para extrair
    
    Returns:
        Lista de dicts com {sku, temp_path, filename}
    """
    import shutil
    files_data = []
    skipped_files = {'system': 0, 'extension': 0, 'hidden': 0, 'no_sku': 0}
    allowed_extensions = {'.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.tiff', '.tif'}
    
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        total_files = len([f for f in zip_ref.infolist() if not f.is_dir()])
        log_batch(f"[ZIP] Total de arquivos no ZIP: {total_files}", "INFO")
        
        for file_info in zip_ref.infolist():
            if file_info.is_dir():
                continue
            
            full_path = file_info.filename
            filename = os.path.basename(full_path)
            
            if '__MACOSX' in full_path or '.DS_Store' in full_path or 'Thumbs.db' in filename:
                skipped_files['system'] += 1
                continue
            
            ext = os.path.splitext(filename)[1].lower()
            
            if ext not in allowed_extensions:
                skipped_files['extension'] += 1
                continue
            
            if filename.startswith('.') or filename.startswith('__'):
                skipped_files['hidden'] += 1
                continue
            
            sku = extract_sku_from_filename(filename)
            if not sku:
                skipped_files['no_sku'] += 1
                log_batch(f"[ZIP] Arquivo sem SKU ignorado: {filename}", "WARN")
                continue
            
            temp_filename = f"zip_{sku}_{len(files_data)}{ext}"
            temp_path = os.path.join(temp_dir, temp_filename)
            
            try:
                with zip_ref.open(file_info.filename) as src, open(temp_path, 'wb') as dst:
                    shutil.copyfileobj(src, dst, length=1024*1024)
                
                files_data.append({
                    'sku': sku,
                    'temp_path': temp_path,
                    'filename': filename
                })
            except Exception as e:
                log_batch(f"[ZIP] Erro ao extrair {filename}: {e}", "ERROR")
    
    total_skipped = sum(skipped_files.values())
    if total_skipped > 0:
        log_batch(f"[ZIP] Arquivos ignorados: {total_skipped} (sistema: {skipped_files['system']}, extens√£o inv√°lida: {skipped_files['extension']}, ocultos: {skipped_files['hidden']}, sem SKU: {skipped_files['no_sku']})", "INFO")
    
    log_batch(f"[ZIP] Extra√ß√£o completa: {len(files_data)} imagens v√°lidas de {total_files} arquivos", "INFO")
    
    return files_data


def get_batch_processor(app, db, object_storage, analyze_func=None):
    """Factory function para criar um BatchProcessor"""
    return BatchProcessor(app, db, object_storage, analyze_func)

================================================================================
FILE: libs/rpa_monitor_client/.vs/ProjectSettings.json
================================================================================
{
  "CurrentProjectSetting": null
}

================================================================================
FILE: libs/rpa_monitor_client/.vs/VSWorkspaceState.json
================================================================================
{
  "ExpandedNodes": [
    "",
    "\\rpa_monitor_client",
    "\\rpa_monitor_client.egg-info"
  ],
  "SelectedNode": "\\rpa_monitor_client\\_client.py",
  "PreviewInSolutionExplorer": false
}

================================================================================
FILE: libs/rpa_monitor_client/.vs/rpa_monitor_client/v17/DocumentLayout.backup.json
================================================================================
{
  "Version": 1,
  "WorkspaceRootPath": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\",
  "Documents": [
    {
      "AbsoluteMoniker": "D:0:0:{A2FE74E1-B743-11D0-AE1A-00A0C90FFFC3}|\u003CMiscFiles\u003E|C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_commands.py||{8B382828-6202-11D1-8870-0000F87579D2}",
      "RelativeMoniker": "D:0:0:{A2FE74E1-B743-11D0-AE1A-00A0C90FFFC3}|\u003CMiscFiles\u003E|solutionrelative:rpa_monitor_client\\_commands.py||{8B382828-6202-11D1-8870-0000F87579D2}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{A2FE74E1-B743-11D0-AE1A-00A0C90FFFC3}|\u003CMiscFiles\u003E|C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_client.py||{8B382828-6202-11D1-8870-0000F87579D2}",
      "RelativeMoniker": "D:0:0:{A2FE74E1-B743-11D0-AE1A-00A0C90FFFC3}|\u003CMiscFiles\u003E|solutionrelative:rpa_monitor_client\\_client.py||{8B382828-6202-11D1-8870-0000F87579D2}"
    }
  ],
  "DocumentGroupContainers": [
    {
      "Orientation": 0,
      "VerticalTabListWidth": 256,
      "DocumentGroups": [
        {
          "DockedWidth": 200,
          "SelectedChildIndex": 11,
          "Children": [
            {
              "$type": "Bookmark",
              "Name": "ST:130:0:{1fc202d4-d401-403c-9834-5b218574bb67}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:128:0:{116d2292-e37d-41cd-a077-ebacac4c8cc4}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:129:0:{75188d03-9892-4ae2-abf1-207126247ce5}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:130:0:{75188d03-9892-4ae2-abf1-207126247ce5}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:131:0:{75188d03-9892-4ae2-abf1-207126247ce5}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:128:0:{75188d03-9892-4ae2-abf1-207126247ce5}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:128:0:{1fc202d4-d401-403c-9834-5b218574bb67}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:129:0:{1fc202d4-d401-403c-9834-5b218574bb67}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:132:0:{1fc202d4-d401-403c-9834-5b218574bb67}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:131:0:{116d2292-e37d-41cd-a077-ebacac4c8cc4}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:0:0:{1c4feeaa-4718-4aa9-859d-94ce25d182ba}"
            },
            {
              "$type": "Document",
              "DocumentIndex": 0,
              "Title": "_commands.py",
              "DocumentMoniker": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_commands.py",
              "RelativeDocumentMoniker": "rpa_monitor_client\\_commands.py",
              "ToolTip": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_commands.py",
              "RelativeToolTip": "rpa_monitor_client\\_commands.py",
              "ViewState": "AgIAAJkBAAAAAAAAAAAhwLsBAAAoAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.002457|",
              "WhenOpened": "2025-11-26T15:17:57.648Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 1,
              "Title": "_client.py",
              "DocumentMoniker": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_client.py",
              "RelativeDocumentMoniker": "rpa_monitor_client\\_client.py",
              "ToolTip": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_client.py",
              "RelativeToolTip": "rpa_monitor_client\\_client.py",
              "ViewState": "AgIAANkBAAAAAAAAAAAIwOoBAAAwAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.002457|",
              "WhenOpened": "2025-11-19T11:22:39.597Z",
              "EditorCaption": ""
            }
          ]
        }
      ]
    }
  ]
}

================================================================================
FILE: libs/rpa_monitor_client/.vs/rpa_monitor_client/v17/DocumentLayout.json
================================================================================
{
  "Version": 1,
  "WorkspaceRootPath": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\",
  "Documents": [
    {
      "AbsoluteMoniker": "D:0:0:{A2FE74E1-B743-11D0-AE1A-00A0C90FFFC3}|\u003CMiscFiles\u003E|C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_commands.py||{8B382828-6202-11D1-8870-0000F87579D2}",
      "RelativeMoniker": "D:0:0:{A2FE74E1-B743-11D0-AE1A-00A0C90FFFC3}|\u003CMiscFiles\u003E|solutionrelative:rpa_monitor_client\\_commands.py||{8B382828-6202-11D1-8870-0000F87579D2}"
    },
    {
      "AbsoluteMoniker": "D:0:0:{A2FE74E1-B743-11D0-AE1A-00A0C90FFFC3}|\u003CMiscFiles\u003E|C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_client.py||{8B382828-6202-11D1-8870-0000F87579D2}",
      "RelativeMoniker": "D:0:0:{A2FE74E1-B743-11D0-AE1A-00A0C90FFFC3}|\u003CMiscFiles\u003E|solutionrelative:rpa_monitor_client\\_client.py||{8B382828-6202-11D1-8870-0000F87579D2}"
    }
  ],
  "DocumentGroupContainers": [
    {
      "Orientation": 0,
      "VerticalTabListWidth": 256,
      "DocumentGroups": [
        {
          "DockedWidth": 200,
          "SelectedChildIndex": 11,
          "Children": [
            {
              "$type": "Bookmark",
              "Name": "ST:130:0:{1fc202d4-d401-403c-9834-5b218574bb67}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:128:0:{116d2292-e37d-41cd-a077-ebacac4c8cc4}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:129:0:{75188d03-9892-4ae2-abf1-207126247ce5}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:130:0:{75188d03-9892-4ae2-abf1-207126247ce5}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:131:0:{75188d03-9892-4ae2-abf1-207126247ce5}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:128:0:{75188d03-9892-4ae2-abf1-207126247ce5}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:128:0:{1fc202d4-d401-403c-9834-5b218574bb67}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:129:0:{1fc202d4-d401-403c-9834-5b218574bb67}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:132:0:{1fc202d4-d401-403c-9834-5b218574bb67}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:131:0:{116d2292-e37d-41cd-a077-ebacac4c8cc4}"
            },
            {
              "$type": "Bookmark",
              "Name": "ST:0:0:{1c4feeaa-4718-4aa9-859d-94ce25d182ba}"
            },
            {
              "$type": "Document",
              "DocumentIndex": 0,
              "Title": "_commands.py",
              "DocumentMoniker": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_commands.py",
              "RelativeDocumentMoniker": "rpa_monitor_client\\_commands.py",
              "ToolTip": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_commands.py",
              "RelativeToolTip": "rpa_monitor_client\\_commands.py",
              "ViewState": "AgIAAJkBAAAAAAAAAAAhwLsBAAAoAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.002457|",
              "WhenOpened": "2025-11-26T15:17:57.648Z",
              "EditorCaption": ""
            },
            {
              "$type": "Document",
              "DocumentIndex": 1,
              "Title": "_client.py",
              "DocumentMoniker": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_client.py",
              "RelativeDocumentMoniker": "rpa_monitor_client\\_client.py",
              "ToolTip": "C:\\Users\\andre\\OneDrive\\Desktop\\Projetos Andrey - Parcial\\BizArt\\rpa_monitor_client\\rpa_monitor_client\\_client.py",
              "RelativeToolTip": "rpa_monitor_client\\_client.py",
              "ViewState": "AgIAANkBAAAAAAAAAAAIwOoBAAAwAAAAAAAAAA==",
              "Icon": "ae27a6b0-e345-4288-96df-5eaf394ee369.002457|",
              "WhenOpened": "2025-11-19T11:22:39.597Z"
            }
          ]
        }
      ]
    }
  ]
}

================================================================================
FILE: libs/rpa_monitor_client/README.md
================================================================================
# rpa-monitor-client

Cliente Python plug-and-play para enviar heartbeats (OP=01) e logs (OP=02)
para o servidor de monitoramento RPA.

## Instala√ß√£o (local)

```bash
pip install -e ./rpa_monitor_client
```

## Uso b√°sico (config expl√≠cita)

```python
from rpa_monitor_client import setup_rpa_monitor, rpa_log

setup_rpa_monitor(
    rpa_id="RPA-CLIENTE-001",
    host="seu-servidor.com",
    port=5051,
    region="SISTEMA_X",
)

rpa_log.info("RPA iniciado")
```

## Uso com vari√°veis de ambiente

```env
RPA_MONITOR_ID=RPA-CLIENTE-XYZ
RPA_MONITOR_HOST=seu-servidor.com
RPA_MONITOR_PORT=5051
RPA_MONITOR_REGION=MINHA_REGIAO
RPA_MONITOR_HEARTBEAT=5
```

```python
from rpa_monitor_client import auto_setup_rpa_monitor, rpa_log

auto_setup_rpa_monitor()
rpa_log.info("Subiu com auto_setup")
```

================================================================================
FILE: libs/rpa_monitor_client/pyproject.toml
================================================================================
[project]
name = "rpa-monitor-client"
version = "0.1.0"
description = "Cliente RPA para enviar heartbeats e logs para o servidor de monitoramento (suporte TCP e WebSocket)"
readme = "README.md"
requires-python = ">=3.8"

authors = [
  { name = "Andrey Barreto" }
]

dependencies = [
  "websockets>=12.0",
  "croniter>=1.4.0",
]


[project.urls]
Homepage = "https://example.com"

[build-system]
requires = ["setuptools>=64", "wheel"]
build-backend = "setuptools.build_meta"

[tool.setuptools]
packages = ["rpa_monitor_client"]

================================================================================
FILE: libs/rpa_monitor_client/rpa_monitor_client/__init__.py
================================================================================
# rpa_monitor_client/__init__.py
from typing import Optional

from ._client import _RPAMonitorClient
from ._config import RPAConfig, load_from_env
from ._logging_api import rpa_log, set_client
from ._commands import rpa

__all__ = [
    "setup_rpa_monitor",
    "auto_setup_rpa_monitor",
    "shutdown_rpa_monitor",
    "rpa_log",
    "rpa",
]

_client: Optional[_RPAMonitorClient] = None


def _create_client_from_config(cfg: RPAConfig) -> _RPAMonitorClient:
    return _RPAMonitorClient(
        rpa_id=cfg.rpa_id,
        host=cfg.host,
        port=cfg.port,
        region=cfg.region,
        heartbeat_interval=cfg.heartbeat_interval,
        transport=cfg.transport,
    )


def setup_rpa_monitor(
    rpa_id: str,
    host: str,
    port: Optional[int] = None,
    region: str = "default",
    heartbeat_interval: int = 5,
    transport: str = "tcp",
) -> None:
    """
    Configura√ß√£o manual do cliente de monitoramento.
    """
    global _client
    if _client is not None:
        return

    cfg = RPAConfig(
        rpa_id=rpa_id,
        host=host,
        port=port,
        region=region,
        heartbeat_interval=heartbeat_interval,
        transport=transport,
    )
    client = _create_client_from_config(cfg)
    ok = client.start()
    if not ok:
        raise RuntimeError("N√£o foi poss√≠vel inicializar o cliente de monitoramento")

    _client = client
    set_client(client)
    rpa._attach_client(client)


def auto_setup_rpa_monitor() -> None:
    """
    Configura√ß√£o autom√°tica a partir de vari√°veis de ambiente.
    """
    global _client
    if _client is not None:
        return

    cfg = load_from_env()
    client = _create_client_from_config(cfg)
    ok = client.start()
    if not ok:
        raise RuntimeError("N√£o foi poss√≠vel inicializar o cliente de monitoramento")

    _client = client
    set_client(client)
    rpa._attach_client(client)


def shutdown_rpa_monitor() -> None:
    """
    Finaliza o cliente de monitoramento.
    """
    global _client
    if _client is not None:
        _client.stop()
        _client = None
        set_client(None)  # remove do rpa_log
        rpa._detach_client()

================================================================================
FILE: libs/rpa_monitor_client/rpa_monitor_client/_client.py
================================================================================
import asyncio
import base64
import queue
import socket
import threading
import time
from datetime import datetime, timezone
from typing import Optional

try:
    import websockets  # type: ignore
except ImportError:
    websockets = None  # S√≥ ser√° usado se transport="ws"


class _RPAMonitorClient:
    """
    Cliente interno para enviar heartbeats, logs, imagens e receber comandos.

    Suporta dois transports:
      - TCP (padr√£o): host/port -> socket TCP puro
      - WebSocket: host = URL completa (ws:// ou wss://), port opcional

    Protocolo de linha:
      V1|OP|RPA_ID|TS|REGIAO|NIVEL|PAYLOAD|NONCE|SIG

    OP codes j√° usados pela lib:
      01 = HEARTBEAT
      02 = LOG
      04 = IMAGE

    OP codes de comandos:
      05 = COMMAND        (servidor -> RPA, JSON legacy)
      10 = REGISTER_COMMANDS (RPA -> servidor)
      11 = SCHEDULE_SYNC  (servidor -> RPA, JSON de agendamentos)
      12 = SCHEDULE_ACK   (RPA -> servidor)
      13 = EXEC_RESULT    (RPA -> servidor)
      90 = COMMAND_PUSH   (servidor -> RPA, "cmd:args_b64:execucao_id")
    """

    # ------------------------------------------------------------------
    # Processamento de mensagens recebidas do servidor
    # ------------------------------------------------------------------
    def _handle_incoming_line(self, line: str) -> None:
        """
        Trata mensagens recebidas do servidor (via WebSocket ou TCP).

        Espera formato:
            V1|OP|RPA_ID|TS|REGIAO|NIVEL|PAYLOAD|NONCE|SIG
        """
        try:
            line = line.strip()
            if not line:
                return

            parts = line.split("|", 8)
            if len(parts) < 7:
                return

            version, op, rpa_id, ts, region, level, payload, *_rest = parts

            # Ignora mensagens destinadas a outro RPA
            if rpa_id and rpa_id != self.rpa_id:
                return

            # Import local para evitar ciclo
            from ._commands import rpa

            if op == "11":  # SCHEDULE_SYNC
                rpa._handle_schedule_sync(payload)
            elif op == "05":  # COMMAND (execu√ß√£o imediata - JSON)
                rpa._handle_immediate_command(payload)
            elif op == "90":  # COMMAND_PUSH (manual/agendado - cmd:args_b64:exec_id)
                rpa._handle_push_command(payload)
            else:
                # Outros opcodes de entrada (ACK etc.) podem ser ignorados aqui
                return
        except Exception as exc:
            try:
                self.log_error(f"Falha ao processar mensagem recebida: {exc}")
            except Exception:
                print(f"[rpa-monitor-client] Erro em _handle_incoming_line: {exc}")

    # ------------------------------------------------------------------
    # Construtor
    # ------------------------------------------------------------------
    def __init__(
        self,
        rpa_id: str,
        host: str,
        port: Optional[int],
        region: str = "default",
        heartbeat_interval: int = 5,
        transport: str = "tcp",
    ):
        self.rpa_id = rpa_id
        self.host = host
        self.port = port
        self.region = region
        self.heartbeat_interval = heartbeat_interval
        self.transport = (transport or "tcp").lower()

        # --- TCP state ---
        self._sock: Optional[socket.socket] = None
        self._lock = threading.Lock()
        self._tcp_recv_thread: Optional[threading.Thread] = None
        self._tcp_running = False

        # --- WS state ---
        self._ws_url: Optional[str] = None
        self._ws_queue: "queue.Queue[str]" = queue.Queue()
        self._ws_thread: Optional[threading.Thread] = None
        self._ws_running = False

        # --- common state ---
        self._running = False
        self._heartbeat_thread: Optional[threading.Thread] = None

        if self.transport == "ws":
            if not websockets:
                raise RuntimeError(
                    "Transporte 'ws' requer o pacote 'websockets'. "
                    "Instale com: pip install websockets"
                )
            # host √© a URL completa ws://.../ws ou wss://.../ws
            self._ws_url = self.host

    # ==========================================================
    # Public lifecycle
    # ==========================================================
    def start(self) -> bool:
        """
        Inicia o cliente:
          - TCP: conecta, inicia heartbeat e receiver
          - WS: inicia loop WS (envio+recebimento) + heartbeat
        """
        if self._running:
            print("[rpa-monitor-client] Cliente j√° est√° rodando")
            return True

        print(f"[rpa-monitor-client] Iniciando RPA: {self.rpa_id}")
        print(f"[rpa-monitor-client] Transport: {self.transport}")
        print(
            f"[rpa-monitor-client] Destino: {self.host}"
            + (f":{self.port}" if self.port and self.transport == "tcp" else "")
        )

        if self.transport == "tcp":
            if not self._connect_tcp():
                print("[rpa-monitor-client] Falha na conex√£o TCP inicial")
            else:
                self._start_tcp_receiver()
        elif self.transport == "ws":
            self._start_ws_loop()
        else:
            raise ValueError(f"Transport desconhecido: {self.transport}")

        self._running = True

        # Thread de heartbeat (comum aos dois)
        self._heartbeat_thread = threading.Thread(
            target=self._heartbeat_loop,
            daemon=True,
        )
        self._heartbeat_thread.start()

        # Log de inicializa√ß√£o
        self.log_info(f"RPA {self.rpa_id} iniciado")

        return True

    def stop(self) -> None:
        """Encerra heartbeat e transport correspondente."""
        if not self._running:
            return

        print("[rpa-monitor-client] Parando cliente...")
        self._running = False

        # Log de finaliza√ß√£o
        try:
            self.log_info(f"RPA {self.rpa_id} finalizado")
        except Exception:
            pass

        if self._heartbeat_thread and self._heartbeat_thread.is_alive():
            self._heartbeat_thread.join(timeout=5)

        if self.transport == "tcp":
            self._tcp_running = False
            if self._tcp_recv_thread and self._tcp_recv_thread.is_alive():
                self._tcp_recv_thread.join(timeout=5)
            with self._lock:
                if self._sock:
                    try:
                        self._sock.close()
                    except Exception:
                        pass
                    self._sock = None
        elif self.transport == "ws":
            self._ws_running = False
            if self._ws_thread and self._ws_thread.is_alive():
                # coloca algo na fila pra destravar o get()
                self._ws_queue.put("")
                self._ws_thread.join(timeout=5)

        print("[rpa-monitor-client] Cliente parado")

    # ==========================================================
    # TCP transport
    # ==========================================================
    def _connect_tcp(self) -> bool:
        """Abre (ou reabre) a conex√£o TCP."""
        if not self.port:
            print("[rpa-monitor-client] Porta TCP n√£o configurada.")
            return False

        try:
            # fecha anterior
            if self._sock:
                try:
                    self._sock.close()
                except Exception:
                    pass

            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.settimeout(10.0)
            s.connect((self.host, self.port))
            with self._lock:
                self._sock = s
            print(
                f"[rpa-monitor-client] TCP conectado em "
                f"{self.host}:{self.port} ({self.rpa_id})"
            )
            return True
        except Exception as e:
            print(f"[rpa-monitor-client] Erro ao conectar TCP: {e}")
            with self._lock:
                self._sock = None
            return False

    def _ensure_tcp_connected(self) -> bool:
        with self._lock:
            ok = self._sock is not None
        if ok:
            return True
        if self._connect_tcp():
            # se reconectou, garante que receiver est√° rodando
            self._start_tcp_receiver()
            return True
        return False

    def _start_tcp_receiver(self) -> None:
        if self._tcp_recv_thread and self._tcp_recv_thread.is_alive():
            return
        self._tcp_running = True
        self._tcp_recv_thread = threading.Thread(
            target=self._tcp_recv_loop,
            name="rpa-tcp-recv",
            daemon=True,
        )
        self._tcp_recv_thread.start()

    def _tcp_recv_loop(self) -> None:
        """
        Loop simples de recep√ß√£o para TCP.
        L√™ linhas terminadas em '\n' e entrega para _handle_incoming_line().
        """
        print("[rpa-monitor-client] TCP receiver iniciado")
        buf = b""
        while self._tcp_running:
            try:
                with self._lock:
                    sock = self._sock
                if not sock:
                    time.sleep(1.0)
                    continue
                chunk = sock.recv(4096)
                if not chunk:
                    # conex√£o fechada
                    time.sleep(1.0)
                    continue
                buf += chunk
                while b"\n" in buf:
                    line, buf = buf.split(b"\n", 1)
                    try:
                        text = line.decode("utf-8", errors="ignore")
                        self._handle_incoming_line(text)
                    except Exception as exc:
                        print(f"[rpa-monitor-client] Erro no parse TCP: {exc}")
            except Exception as exc:
                print(f"[rpa-monitor-client] Erro no TCP receiver: {exc}")
                time.sleep(1.0)
        print("[rpa-monitor-client] TCP receiver encerrado")

    # ==========================================================
    # WebSocket transport
    # ==========================================================
    def _start_ws_loop(self) -> None:
        """Inicia thread com loop asyncio para WebSocket."""
        if not self._ws_url:
            raise RuntimeError("URL WebSocket n√£o configurada.")

        self._ws_running = True
        self._ws_thread = threading.Thread(
            target=self._ws_loop_thread,
            daemon=True,
        )
        self._ws_thread.start()
        print(f"[rpa-monitor-client] WS loop iniciado em {self._ws_url}")

    def _ws_loop_thread(self) -> None:
        asyncio.run(self._ws_loop())

    async def _ws_loop(self) -> None:
        """
        Loop principal do WebSocket:
          - reconecta automaticamente
          - envia linhas da fila
          - recebe mensagens do servidor e chama _handle_incoming_line
        """
        assert self._ws_url is not None
        url = self._ws_url

        while self._ws_running:
            try:
                print(f"[rpa-monitor-client] Conectando WebSocket em {url} ...")
                async with websockets.connect(url) as ws:  # type: ignore[attr-defined]
                    print("[rpa-monitor-client] WebSocket conectado.")

                    async def sender() -> None:
                        loop = asyncio.get_running_loop()
                        while self._ws_running:
                            line = await loop.run_in_executor(None, self._ws_queue.get)
                            if not self._ws_running:
                                break
                            if not line:
                                continue
                            await ws.send(line)

                    async def receiver() -> None:
                        async for msg in ws:
                            try:
                                self._handle_incoming_line(msg)
                            except Exception as exc:
                                print(
                                    f"[rpa-monitor-client] Erro ao processar mensagem WS: {exc}"
                                )

                    sender_task = asyncio.create_task(sender())
                    receiver_task = asyncio.create_task(receiver())

                    done, pending = await asyncio.wait(
                        {sender_task, receiver_task},
                        return_when=asyncio.FIRST_EXCEPTION,
                    )

                    for task in pending:
                        task.cancel()

            except Exception as e:
                print(
                    "[rpa-monitor-client] WS desconectado "
                    f"({e}), tentando reconectar em 3s..."
                )
                await asyncio.sleep(3.0)

    # ==========================================================
    # Heartbeat + logs (comum)
    # ==========================================================
    def _heartbeat_loop(self) -> None:
        """Envia heartbeat (OP=01) periodicamente."""
        print(
            "[rpa-monitor-client] Heartbeat iniciado "
            f"(intervalo: {self.heartbeat_interval}s)"
        )
        while self._running:
            try:
                self._send_message(
                    op="01",
                    nivel="INFO",
                    payload="alive",
                    regiao=self.region,
                )
            except Exception as e:
                print(f"[rpa-monitor-client] Falha no heartbeat: {e}")
            time.sleep(self.heartbeat_interval)

    def log(
        self,
        mensagem: str,
        nivel: str = "INFO",
        regiao: Optional[str] = None,
    ) -> None:
        try:
            self._send_message(
                op="02",
                nivel=nivel,
                payload=mensagem,
                regiao=regiao or self.region,
            )
        except Exception as e:
            print(f"[rpa-monitor-client] Falha ao enviar log: {e}")

    def log_error(
        self,
        mensagem: str,
        exc: Optional[BaseException] = None,
        regiao: Optional[str] = None,
    ) -> None:
        txt = mensagem
        if exc is not None:
            txt = f"{mensagem} | {type(exc).__name__}: {exc}"
        self.log(txt, nivel="ERROR", regiao=regiao)

    def log_warn(self, mensagem: str, regiao: Optional[str] = None) -> None:
        self.log(mensagem, nivel="WARN", regiao=regiao)

    def log_info(self, mensagem: str, regiao: Optional[str] = None) -> None:
        self.log(mensagem, nivel="INFO", regiao=regiao)

    # ---------- IMAGEM (OP=04) ----------
    def send_image(
        self,
        image_bytes: bytes,
        content_type: str = "image/png",
        filename: str = "screenshot.png",
        regiao: Optional[str] = None,
        nivel: str = "INFO",
    ) -> None:
        """
        Envia uma imagem para o servidor no formato:

        V1|04|RPA_ID|TS|REGIAO|NIVEL|content_type=...;filename=...;base64=<BASE64_DATA>||

        - image_bytes: bytes da imagem (PNG/JPEG/etc)
        - content_type: ex. 'image/png'
        - filename: nome sugerido
        """
        b64 = base64.b64encode(image_bytes).decode("ascii")
        payload = (
            f"content_type={content_type};"
            f"filename={filename};"
            f"base64={b64}"
        )

        self._send_message(
            op="04",
            nivel=nivel,
            payload=payload,
            regiao=regiao or self.region,
        )

    # ==========================================================
    # Envio de mensagem (decide TCP x WS)
    # ==========================================================
    def _send_message(
        self,
        op: str,
        nivel: str,
        payload: str,
        regiao: Optional[str] = None,
        nonce: str = "",
        sig: str = "",
    ) -> None:
        ts = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
        reg = regiao or self.region
        line = f"V1|{op}|{self.rpa_id}|{ts}|{reg}|{nivel}|{payload}|{nonce}|{sig}\n"

        if self.transport == "ws":
            # S√≥ enfileira: o loop WS envia e reconecta se precisar
            self._ws_queue.put(line)
            return

        # --- caminho TCP ---
        def _do_send() -> None:
            with self._lock:
                if not self._sock:
                    raise RuntimeError("Socket TCP n√£o conectado")
                self._sock.sendall(line.encode("utf-8"))

        # garante conex√£o
        if not self._ensure_tcp_connected():
            raise RuntimeError("N√£o foi poss√≠vel conectar ao servidor TCP")

        try:
            _do_send()
        except (BrokenPipeError, ConnectionResetError, OSError) as e:
            print(
                "[rpa-monitor-client] Conex√£o TCP perdida "
                f"({e}), tentando reconectar..."
            )
            if not self._connect_tcp():
                print(
                    "[rpa-monitor-client] Reconex√£o TCP falhou, mensagem perdida."
                )
                return
            try:
                _do_send()
                print(
                    "[rpa-monitor-client] Mensagem reenviada ap√≥s reconex√£o TCP."
                )
            except Exception as e2:
                print(
                    "[rpa-monitor-client] Falha ao reenviar ap√≥s reconex√£o TCP: "
                    f"{e2}"
                )

================================================================================
FILE: libs/rpa_monitor_client/rpa_monitor_client/_config.py
================================================================================
import os
from dataclasses import dataclass
from typing import Optional


@dataclass
class RPAConfig:
    rpa_id: str
    host: str
    port: Optional[int]
    region: str = "default"
    heartbeat_interval: int = 5
    transport: str = "tcp"


def load_from_env() -> RPAConfig:
    """
    Le configuracoes de ambiente.

    Com TCP (padrao):
      RPA_MONITOR_TRANSPORT=tcp
      RPA_MONITOR_HOST=meu-servidor.local
      RPA_MONITOR_PORT=5051

    Com WebSocket:
      RPA_MONITOR_TRANSPORT=ws
      RPA_MONITOR_HOST=wss://meu-repl.replit.dev/ws
      (RPA_MONITOR_PORT opcional)

    Comum:
      RPA_MONITOR_ID
      RPA_MONITOR_REGION (opcional)
      RPA_MONITOR_HEARTBEAT (opcional)
    """
    rpa_id = os.getenv("RPA_MONITOR_ID", "").strip()
    host = os.getenv("RPA_MONITOR_HOST", "").strip()
    transport = os.getenv("RPA_MONITOR_TRANSPORT", "tcp").strip().lower()

    if not rpa_id or not host:
        raise RuntimeError(
            "Variaveis obrigatorias: RPA_MONITOR_ID, RPA_MONITOR_HOST "
            "(e RPA_MONITOR_PORT se transport=tcp)."
        )

    port: Optional[int] = None
    port_str = os.getenv("RPA_MONITOR_PORT", "").strip()
    if port_str and port_str.lower() not in ("none", "null", ""):
        try:
            port = int(port_str)
        except ValueError:
            port = None

    if transport == "tcp" and port is None:
        raise RuntimeError("RPA_MONITOR_PORT e obrigatorio quando transport=tcp")

    region = os.getenv("RPA_MONITOR_REGION", "default").strip()
    heartbeat = int(os.getenv("RPA_MONITOR_HEARTBEAT", "5"))

    return RPAConfig(
        rpa_id=rpa_id,
        host=host,
        port=port,
        region=region,
        heartbeat_interval=heartbeat,
        transport=transport,
    )

================================================================================
FILE: libs/rpa_monitor_client/rpa_monitor_client/_logging_api.py
================================================================================
from io import BytesIO
from typing import Optional

from ._client import _RPAMonitorClient

_client_instance: Optional[_RPAMonitorClient] = None


def set_client(client: Optional[_RPAMonitorClient]) -> None:
    global _client_instance
    _client_instance = client


class _RPALogProxy:
    """Proxy simples para expor m√©todos de log e envio de imagem."""

    def info(self, msg: str, regiao: Optional[str] = None) -> None:
        if _client_instance:
            _client_instance.log_info(msg, regiao=regiao)

    def warn(self, msg: str, regiao: Optional[str] = None) -> None:
        if _client_instance:
            _client_instance.log_warn(msg, regiao=regiao)

    def error(
        self,
        msg: str,
        exc: Optional[BaseException] = None,
        regiao: Optional[str] = None,
    ) -> None:
        if _client_instance:
            _client_instance.log_error(msg, exc=exc, regiao=regiao)

    def image(
        self,
        image_bytes: bytes,
        content_type: str = "image/png",
        filename: str = "screenshot.png",
        regiao: Optional[str] = None,
        nivel: str = "INFO",
    ) -> None:
        """
        Envia uma imagem (OP=04) usando bytes j√° capturados pelo c√≥digo do RPA.

        Exemplo:
            with open("tela.png", "rb") as f:
                rpa_log.image(f.read(), filename="tela.png")
        """
        if _client_instance:
            _client_instance.send_image(
                image_bytes=image_bytes,
                content_type=content_type,
                filename=filename,
                regiao=regiao,
                nivel=nivel,
            )

    def screenshot(
        self,
        content_type: str = "image/png",
        filename: str = "screenshot.png",
        regiao: Optional[str] = "screenshot",
        nivel: str = "INFO",
    ) -> None:
        """
        Captura a tela inteira e envia como imagem (OP=04).

        Requer 'pyautogui' instalado no projeto do RPA:
            pip install pyautogui

        Exemplo de uso:
            try:
                ...
            except Exception as e:
                rpa_log.error("Erro X", exc=e)
                rpa_log.screenshot(filename="erro_x.png")
        """
        if not _client_instance:
            print(
                "[rpa-monitor-client] Nenhum cliente configurado para enviar screenshot."
            )
            return

        try:
            import pyautogui  # depend√™ncia opcional, s√≥ usada aqui
        except ImportError:
            print(
                "[rpa-monitor-client] pyautogui n√£o est√° instalado. "
                "Instale com: pip install pyautogui"
            )
            return

        try:
            img = pyautogui.screenshot()
            buffer = BytesIO()
            img.save(buffer, format="PNG")
            image_bytes = buffer.getvalue()

            _client_instance.send_image(
                image_bytes=image_bytes,
                content_type=content_type,
                filename=filename,
                regiao=regiao,
                nivel=nivel,
            )
        except Exception as e:
            print(f"[rpa-monitor-client] Falha ao capturar/enviar screenshot: {e}")


rpa_log = _RPALogProxy()

================================================================================
FILE: oaz_logger.py
================================================================================
"""
OAZ Smart Image Bank - Sistema de Logging Centralizado
========================================================
Este m√≥dulo fornece logging padronizado para integra√ß√£o com RPA Monitor.

Formato de log:
[YYYY-MM-DD HH:MM:SS.mmm] [LEVEL] [MODULE] [EVENT] message

N√≠veis:
- INFO: Eventos normais do sistema
- DEBUG: Informa√ß√µes detalhadas para debugging
- WARN: Avisos que n√£o impedem execu√ß√£o
- ERROR: Erros que precisam de aten√ß√£o
- SUCCESS: Eventos conclu√≠dos com sucesso

Eventos:
- START: In√≠cio de uma opera√ß√£o
- END: Fim de uma opera√ß√£o
- PROGRESS: Progresso durante opera√ß√£o
- ACTION: A√ß√£o do usu√°rio (clique, navega√ß√£o)
- DATA: Opera√ß√£o de dados (CRUD)
- AUTH: Autentica√ß√£o
- UPLOAD: Upload de arquivos
- BATCH: Processamento em lote
- IMPORT: Importa√ß√£o de dados
- API: Chamada de API
"""

import sys
import logging
from datetime import datetime
from functools import wraps
from flask import request, g
import traceback

# Configurar logging b√°sico do Python
logging.basicConfig(
    level=logging.DEBUG,
    format='%(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout)
    ]
)

# Logger principal
logger = logging.getLogger('OAZ')
logger.setLevel(logging.DEBUG)

# Cores ANSI para console (opcional)
COLORS = {
    'INFO': '\033[94m',      # Azul
    'DEBUG': '\033[90m',     # Cinza
    'WARN': '\033[93m',      # Amarelo
    'ERROR': '\033[91m',     # Vermelho
    'SUCCESS': '\033[92m',   # Verde
    'RESET': '\033[0m'       # Reset
}

# Desabilitar cores se n√£o for terminal
USE_COLORS = sys.stdout.isatty()

def _format_timestamp():
    """Retorna timestamp no formato padr√£o."""
    return datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]

def _colorize(level, text):
    """Adiciona cor ao texto se dispon√≠vel."""
    if USE_COLORS and level in COLORS:
        return f"{COLORS[level]}{text}{COLORS['RESET']}"
    return text

def _log(level, module, event, message, extra=None):
    """Fun√ß√£o interna de logging."""
    timestamp = _format_timestamp()
    
    # Formatar linha principal
    log_line = f"[{timestamp}] [{level:7}] [{module:15}] [{event:10}] {message}"
    
    # Adicionar detalhes extras se existirem
    if extra:
        if isinstance(extra, dict):
            details = ' | '.join([f"{k}={v}" for k, v in extra.items()])
            log_line += f" | {details}"
        else:
            log_line += f" | {extra}"
    
    # Colorir e imprimir
    colored_line = _colorize(level, log_line)
    print(colored_line, flush=True)
    
    return log_line

# ============================================
# FUN√á√ïES DE LOGGING POR N√çVEL
# ============================================

def info(module, event, message, **extra):
    """Log de informa√ß√£o geral."""
    return _log('INFO', module, event, message, extra if extra else None)

def debug(module, event, message, **extra):
    """Log de debug detalhado."""
    return _log('DEBUG', module, event, message, extra if extra else None)

def warn(module, event, message, **extra):
    """Log de aviso."""
    return _log('WARN', module, event, message, extra if extra else None)

def error(module, event, message, **extra):
    """Log de erro."""
    return _log('ERROR', module, event, message, extra if extra else None)

def success(module, event, message, **extra):
    """Log de sucesso."""
    return _log('SUCCESS', module, event, message, extra if extra else None)

# ============================================
# FUN√á√ïES DE LOGGING POR CONTEXTO
# ============================================

def log_start(module, operation, **extra):
    """Log de in√≠cio de opera√ß√£o."""
    return info(module, 'START', f"Iniciando: {operation}", **extra)

def log_end(module, operation, **extra):
    """Log de fim de opera√ß√£o."""
    return success(module, 'END', f"Finalizado: {operation}", **extra)

def log_progress(module, operation, current, total, **extra):
    """Log de progresso."""
    percent = round((current / total) * 100, 1) if total > 0 else 0
    return info(module, 'PROGRESS', f"{operation}: {current}/{total} ({percent}%)", **extra)

def log_action(module, action, **extra):
    """Log de a√ß√£o do usu√°rio."""
    return info(module, 'ACTION', action, **extra)

def log_error(module, operation, error_msg, **extra):
    """Log de erro com detalhes."""
    return error(module, 'ERROR', f"{operation}: {error_msg}", **extra)

def log_data(module, operation, entity, **extra):
    """Log de opera√ß√£o de dados."""
    return info(module, 'DATA', f"{operation}: {entity}", **extra)

# ============================================
# DECORADORES PARA ROTAS FLASK
# ============================================

def log_route(module):
    """
    Decorator para logging autom√°tico de rotas Flask.
    Registra entrada e sa√≠da de cada rota.
    
    Uso:
        @app.route('/dashboard')
        @log_route('DASHBOARD')
        def dashboard():
            ...
    """
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            # Obter informa√ß√µes da requisi√ß√£o
            method = request.method
            path = request.path
            user = getattr(g, 'user', None)
            user_info = f"user={user.username}" if user else "user=an√¥nimo"
            
            # Log de entrada
            info(module, 'ACTION', f"Acessando rota", method=method, path=path, user=user_info)
            
            try:
                # Executar fun√ß√£o
                result = f(*args, **kwargs)
                
                # Log de sucesso
                debug(module, 'END', f"Rota conclu√≠da", path=path)
                
                return result
            except Exception as e:
                # Log de erro
                error(module, 'ERROR', f"Erro na rota: {str(e)}", path=path, traceback=traceback.format_exc()[-500:])
                raise
        
        return decorated_function
    return decorator

def log_operation(module, operation_name):
    """
    Decorator para logging de opera√ß√µes longas.
    Registra in√≠cio, fim e tempo de execu√ß√£o.
    
    Uso:
        @log_operation('BATCH', 'Processamento de lote')
        def process_batch(batch_id):
            ...
    """
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            start_time = datetime.now()
            
            # Log de in√≠cio
            log_start(module, operation_name)
            
            try:
                # Executar fun√ß√£o
                result = f(*args, **kwargs)
                
                # Calcular dura√ß√£o
                duration = (datetime.now() - start_time).total_seconds()
                
                # Log de sucesso
                log_end(module, operation_name, duration=f"{duration:.2f}s")
                
                return result
            except Exception as e:
                # Calcular dura√ß√£o at√© erro
                duration = (datetime.now() - start_time).total_seconds()
                
                # Log de erro
                log_error(module, operation_name, str(e), duration=f"{duration:.2f}s")
                raise
        
        return decorated_function
    return decorator

# ============================================
# M√ìDULOS PR√â-DEFINIDOS
# ============================================

class OAZModules:
    """Constantes para nomes de m√≥dulos."""
    AUTH = 'AUTH'
    DASHBOARD = 'DASHBOARD'
    CARTEIRA = 'CARTEIRA'
    BATCH = 'BATCH'
    UPLOAD = 'UPLOAD'
    CATALOG = 'CATALOG'
    BRANDS = 'BRANDS'
    COLLECTIONS = 'COLLECTIONS'
    PRODUCTS = 'PRODUCTS'
    IMAGES = 'IMAGES'
    REPORTS = 'REPORTS'
    API = 'API'
    DATABASE = 'DATABASE'
    STORAGE = 'STORAGE'
    AI = 'AI'
    SYSTEM = 'SYSTEM'

# Alias para m√≥dulos
M = OAZModules

# ============================================
# LOGGING ESPEC√çFICO POR √ÅREA
# ============================================

class AuthLogger:
    """Logger espec√≠fico para autentica√ß√£o."""
    
    @staticmethod
    def login_attempt(username):
        return info(M.AUTH, 'ACTION', f"Tentativa de login", username=username)
    
    @staticmethod
    def login_success(username, user_id):
        return success(M.AUTH, 'SUCCESS', f"Login realizado com sucesso", username=username, user_id=user_id)
    
    @staticmethod
    def login_failed(username, reason):
        return warn(M.AUTH, 'WARN', f"Falha no login", username=username, reason=reason)
    
    @staticmethod
    def logout(username):
        return info(M.AUTH, 'ACTION', f"Logout realizado", username=username)
    
    @staticmethod
    def access_denied(username, path):
        return warn(M.AUTH, 'WARN', f"Acesso negado", username=username, path=path)

class BatchLogger:
    """Logger espec√≠fico para processamento em lote."""
    
    @staticmethod
    def batch_created(batch_id, name, total_files):
        return info(M.BATCH, 'START', f"Batch criado", batch_id=batch_id, nome=name, arquivos=total_files)
    
    @staticmethod
    def batch_started(batch_id, total_files):
        return info(M.BATCH, 'START', f"Processamento iniciado", batch_id=batch_id, total=total_files)
    
    @staticmethod
    def batch_progress(batch_id, processed, total, success_count, error_count):
        percent = round((processed / total) * 100, 1) if total > 0 else 0
        return info(M.BATCH, 'PROGRESS', f"Batch #{batch_id}: {processed}/{total} ({percent}%)", sucesso=success_count, erros=error_count)
    
    @staticmethod
    def batch_completed(batch_id, success_count, error_count, duration):
        return success(M.BATCH, 'END', f"Batch #{batch_id} conclu√≠do", sucesso=success_count, erros=error_count, duracao=f"{duration:.1f}s")
    
    @staticmethod
    def batch_error(batch_id, error_msg):
        return error(M.BATCH, 'ERROR', f"Erro no batch #{batch_id}", erro=error_msg)
    
    @staticmethod
    def file_processing(batch_id, filename, sku):
        return debug(M.BATCH, 'PROGRESS', f"Processando arquivo", batch_id=batch_id, arquivo=filename, sku=sku)
    
    @staticmethod
    def file_success(batch_id, filename, sku, matched=False):
        match_status = "COM match" if matched else "SEM match"
        return debug(M.BATCH, 'SUCCESS', f"Arquivo processado ({match_status})", batch_id=batch_id, sku=sku)
    
    @staticmethod
    def file_error(batch_id, filename, error_msg):
        return error(M.BATCH, 'ERROR', f"Erro ao processar arquivo", batch_id=batch_id, arquivo=filename, erro=error_msg)

class UploadLogger:
    """Logger espec√≠fico para uploads."""
    
    @staticmethod
    def upload_started(batch_id, filename, size):
        size_mb = round(size / (1024 * 1024), 2) if size else 0
        return info(M.UPLOAD, 'START', f"Upload iniciado", batch_id=batch_id, arquivo=filename, tamanho=f"{size_mb}MB")
    
    @staticmethod
    def upload_progress(batch_id, received, total):
        percent = round((received / total) * 100, 1) if total > 0 else 0
        return debug(M.UPLOAD, 'PROGRESS', f"Upload: {received}/{total} arquivos ({percent}%)", batch_id=batch_id)
    
    @staticmethod
    def upload_completed(batch_id, total_files):
        return success(M.UPLOAD, 'END', f"Upload conclu√≠do", batch_id=batch_id, arquivos=total_files)
    
    @staticmethod
    def upload_error(batch_id, filename, error_msg):
        return error(M.UPLOAD, 'ERROR', f"Erro no upload", batch_id=batch_id, arquivo=filename, erro=error_msg)

class CarteiraLogger:
    """Logger espec√≠fico para Carteira de Compras."""
    
    @staticmethod
    def import_started(filename, sheet_name=None):
        return info(M.CARTEIRA, 'START', f"Importa√ß√£o iniciada", arquivo=filename, aba=sheet_name or "todas")
    
    @staticmethod
    def import_progress(processed, total, sheet_name=None):
        percent = round((processed / total) * 100, 1) if total > 0 else 0
        return info(M.CARTEIRA, 'PROGRESS', f"Importa√ß√£o: {processed}/{total} ({percent}%)", aba=sheet_name)
    
    @staticmethod
    def import_completed(total_items, sheets_count, lote_id):
        return success(M.CARTEIRA, 'END', f"Importa√ß√£o conclu√≠da", itens=total_items, abas=sheets_count, lote=lote_id)
    
    @staticmethod
    def import_error(error_msg, line=None):
        return error(M.CARTEIRA, 'ERROR', f"Erro na importa√ß√£o", erro=error_msg, linha=line)
    
    @staticmethod
    def sku_created(sku, colecao):
        return debug(M.CARTEIRA, 'DATA', f"SKU criado", sku=sku, colecao=colecao)
    
    @staticmethod
    def sku_updated(sku, colecao):
        return debug(M.CARTEIRA, 'DATA', f"SKU atualizado", sku=sku, colecao=colecao)
    
    @staticmethod
    def reconciliation_started():
        return info(M.CARTEIRA, 'START', f"Reconcilia√ß√£o iniciada")
    
    @staticmethod
    def reconciliation_completed(count):
        return success(M.CARTEIRA, 'END', f"Reconcilia√ß√£o conclu√≠da", imagens_reconciliadas=count)

class CatalogLogger:
    """Logger espec√≠fico para cat√°logo de imagens."""
    
    @staticmethod
    def page_accessed(page, filters=None):
        return info(M.CATALOG, 'ACTION', f"Cat√°logo acessado", pagina=page, filtros=filters)
    
    @staticmethod
    def image_viewed(image_id, sku):
        return debug(M.CATALOG, 'ACTION', f"Imagem visualizada", image_id=image_id, sku=sku)
    
    @staticmethod
    def image_approved(image_id, sku, user):
        return info(M.CATALOG, 'DATA', f"Imagem aprovada", image_id=image_id, sku=sku, usuario=user)
    
    @staticmethod
    def image_rejected(image_id, sku, user, reason=None):
        return info(M.CATALOG, 'DATA', f"Imagem rejeitada", image_id=image_id, sku=sku, usuario=user, motivo=reason)

class CRUDLogger:
    """Logger gen√©rico para opera√ß√µes CRUD."""
    
    @staticmethod
    def created(entity_type, entity_id, name=None):
        return info(M.DATABASE, 'DATA', f"{entity_type} criado", id=entity_id, nome=name)
    
    @staticmethod
    def updated(entity_type, entity_id, fields=None):
        return info(M.DATABASE, 'DATA', f"{entity_type} atualizado", id=entity_id, campos=fields)
    
    @staticmethod
    def deleted(entity_type, entity_id, name=None):
        return warn(M.DATABASE, 'DATA', f"{entity_type} exclu√≠do", id=entity_id, nome=name)
    
    @staticmethod
    def listed(entity_type, count, filters=None):
        return debug(M.DATABASE, 'DATA', f"{entity_type} listados", quantidade=count, filtros=filters)

class NavigationLogger:
    """Logger para navega√ß√£o no sistema."""
    
    @staticmethod
    def page_enter(page_name, user=None):
        return info(M.SYSTEM, 'ACTION', f"Entrando na p√°gina: {page_name}", usuario=user)
    
    @staticmethod
    def tab_switch(tab_name, user=None):
        return debug(M.SYSTEM, 'ACTION', f"Mudando para aba: {tab_name}", usuario=user)
    
    @staticmethod
    def button_click(button_name, page=None, user=None):
        return debug(M.SYSTEM, 'ACTION', f"Clique no bot√£o: {button_name}", pagina=page, usuario=user)
    
    @staticmethod
    def modal_open(modal_name, page=None):
        return debug(M.SYSTEM, 'ACTION', f"Modal aberto: {modal_name}", pagina=page)
    
    @staticmethod
    def modal_close(modal_name, page=None):
        return debug(M.SYSTEM, 'ACTION', f"Modal fechado: {modal_name}", pagina=page)

# ============================================
# INST√ÇNCIAS GLOBAIS
# ============================================

auth_log = AuthLogger()
batch_log = BatchLogger()
upload_log = UploadLogger()
carteira_log = CarteiraLogger()
catalog_log = CatalogLogger()
crud_log = CRUDLogger()
nav_log = NavigationLogger()

# ============================================
# FUN√á√ïES DE CONVENI√äNCIA
# ============================================

def log_separator(title=None):
    """Imprime linha separadora no log."""
    sep = "=" * 60
    if title:
        print(f"\n{sep}\n{title.center(60)}\n{sep}", flush=True)
    else:
        print(sep, flush=True)

def log_section(title):
    """Imprime cabe√ßalho de se√ß√£o no log."""
    timestamp = _format_timestamp()
    print(f"\n[{timestamp}] {'=' * 20} {title} {'=' * 20}", flush=True)

# ============================================
# INICIALIZA√á√ÉO
# ============================================

def init_logging():
    """Inicializa o sistema de logging."""
    log_separator("OAZ SMART IMAGE BANK - SISTEMA DE LOGGING")
    info(M.SYSTEM, 'START', "Sistema de logging inicializado")
    info(M.SYSTEM, 'INFO', f"Cores: {'habilitadas' if USE_COLORS else 'desabilitadas'}")
    return True

# Auto-inicializa√ß√£o ao importar
init_logging()

================================================================================
FILE: object_storage.py
================================================================================
"""
Object Storage Service for Replit App Storage
Uses the official replit-object-storage SDK
Suporta streaming de arquivos grandes (at√© 3GB) com chunks de 20MB
"""

import os
import io
import hashlib
from datetime import datetime
import uuid
from replit.object_storage import Client
from replit.object_storage.errors import ObjectNotFoundError

CHUNK_SIZE_BYTES = 20 * 1024 * 1024  # 20MB chunks para arquivos grandes


class ObjectStorageService:
    """Service for interacting with Replit Object Storage using default bucket"""
    
    def __init__(self):
        self._client = None
    
    @property
    def client(self):
        """Lazy initialization of the storage client with default bucket"""
        if self._client is None:
            self._client = Client()
        return self._client
    
    def get_object_prefix(self):
        """Get the object prefix for images"""
        return os.environ.get('OBJECT_STORAGE_PREFIX', 'images')
    
    def generate_object_name(self, original_filename):
        """Generate a unique object name with timestamp"""
        timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
        unique_id = uuid.uuid4().hex[:8]
        ext = os.path.splitext(original_filename)[1].lower()
        return f"{self.get_object_prefix()}/{timestamp}_{unique_id}{ext}"
    
    def upload_file(self, file_data, original_filename, content_type=None):
        """
        Upload a file to object storage
        
        Args:
            file_data: File bytes or file-like object
            original_filename: Original name of the file
            content_type: MIME type of the file (not used with SDK, but kept for compatibility)
            
        Returns:
            dict with object_name
        """
        object_name = self.generate_object_name(original_filename)
        
        if hasattr(file_data, 'read'):
            data = file_data.read()
        else:
            data = file_data
        
        self.client.upload_from_bytes(object_name, data)
        
        return {
            'object_name': object_name,
            'storage_path': f"/storage/{object_name}"
        }
    
    def upload_file_streaming(self, file_path, original_filename=None, chunk_size=None):
        """
        Upload de arquivo otimizado para imagens individuais.
        
        NOTA: O SDK do Replit Object Storage requer upload de bytes completos.
        Para arquivos de imagem (tipicamente < 50MB), isso √© aceit√°vel.
        Arquivos ZIP grandes (at√© 3GB) devem ser extra√≠dos e processados individualmente.
        
        Otimiza√ß√µes implementadas:
        - Calcula hash SHA256 durante leitura (streaming)
        - Libera mem√≥ria imediatamente ap√≥s upload
        - Sem limite artificial - deixa o SDK decidir
        
        Args:
            file_path: Caminho do arquivo no servidor
            original_filename: Nome original (usa basename se n√£o fornecido)
            chunk_size: Tamanho do chunk para hash (default: 20MB)
            
        Returns:
            dict com object_name, storage_path, file_size, file_hash
        """
        if chunk_size is None:
            chunk_size = CHUNK_SIZE_BYTES
        
        if original_filename is None:
            original_filename = os.path.basename(file_path)
        
        object_name = self.generate_object_name(original_filename)
        file_size = os.path.getsize(file_path)
        
        hasher = hashlib.sha256()
        
        with open(file_path, 'rb') as f:
            while True:
                chunk = f.read(chunk_size)
                if not chunk:
                    break
                hasher.update(chunk)
        
        with open(file_path, 'rb') as f:
            data = f.read()
        
        self.client.upload_from_bytes(object_name, data)
        file_hash = hasher.hexdigest()
        
        del data
        
        return {
            'object_name': object_name,
            'storage_path': f"/storage/{object_name}",
            'file_size': file_size,
            'file_hash': file_hash
        }
    
    def upload_file_direct(self, file_path, original_filename=None):
        """
        Upload direto de arquivo pequeno (< 50MB) - sem streaming
        Mais eficiente para imagens individuais
        """
        if original_filename is None:
            original_filename = os.path.basename(file_path)
        
        object_name = self.generate_object_name(original_filename)
        file_size = os.path.getsize(file_path)
        
        hasher = hashlib.sha256()
        
        with open(file_path, 'rb') as f:
            data = f.read()
            hasher.update(data)
        
        self.client.upload_from_bytes(object_name, data)
        file_hash = hasher.hexdigest()
        
        del data
        
        return {
            'object_name': object_name,
            'storage_path': f"/storage/{object_name}",
            'file_size': file_size,
            'file_hash': file_hash
        }
    
    def upload_bytes_immediate(self, file_bytes, original_filename, sku=None, batch_id=None):
        """
        Upload IMEDIATO de bytes para o bucket - usado na recep√ß√£o do upload.
        Garante que a imagem √© persistida no bucket ANTES de qualquer processamento.
        
        Args:
            file_bytes: bytes da imagem
            original_filename: nome original do arquivo
            sku: c√≥digo SKU para organizar no bucket
            batch_id: ID do batch para organiza√ß√£o
            
        Returns:
            dict com object_name, storage_path, file_size, file_hash
        """
        timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
        unique_id = uuid.uuid4().hex[:8]
        ext = os.path.splitext(original_filename)[1].lower()
        
        if batch_id and sku:
            object_name = f"{self.get_object_prefix()}/batch_{batch_id}/{sku}_{timestamp}_{unique_id}{ext}"
        elif sku:
            object_name = f"{self.get_object_prefix()}/{sku}_{timestamp}_{unique_id}{ext}"
        else:
            object_name = f"{self.get_object_prefix()}/{timestamp}_{unique_id}{ext}"
        
        hasher = hashlib.sha256()
        hasher.update(file_bytes)
        file_hash = hasher.hexdigest()
        file_size = len(file_bytes)
        
        self.client.upload_from_bytes(object_name, file_bytes)
        
        return {
            'object_name': object_name,
            'storage_path': f"/storage/{object_name}",
            'file_size': file_size,
            'file_hash': file_hash
        }
    
    def download_file(self, object_name):
        """
        Download a file from object storage
        
        Args:
            object_name: The object name/path in the bucket
            
        Returns:
            File bytes
        """
        try:
            return self.client.download_as_bytes(object_name)
        except ObjectNotFoundError:
            return None
    
    def delete_file(self, object_name):
        """
        Delete a file from object storage
        
        Args:
            object_name: The object name/path in the bucket
            
        Returns:
            True if deleted, False otherwise
        """
        try:
            self.client.delete(object_name, ignore_not_found=True)
            return True
        except Exception as e:
            print(f"Error deleting file: {e}")
            return False
    
    def file_exists(self, object_name):
        """Check if a file exists in object storage"""
        try:
            return self.client.exists(object_name)
        except Exception:
            return False
    
    def list_files(self, prefix=None):
        """List files in the bucket with optional prefix filter"""
        try:
            return self.client.list(prefix=prefix or self.get_object_prefix())
        except Exception as e:
            print(f"Error listing files: {e}")
            return []


def get_storage_client():
    """Get a configured storage client instance"""
    return ObjectStorageService()


object_storage = ObjectStorageService()

================================================================================
FILE: replit.md
================================================================================
# OAZ Smart Image Bank

## Overview
OAZ Smart Image Bank is a Flask-based intelligent image management system tailored for fashion retail. Its primary purpose is to provide a professional image cataloging platform with AI-powered analysis, robust user authentication, and a modern, intuitive dark-mode interface. The system aims to streamline image workflows, enhance metadata management, and provide valuable insights for fashion businesses.

## User Preferences
- Interface em portugu√™s brasileiro

## System Architecture

### UI/UX Decisions
The application features a premium dark-mode UI with glassmorphism effects, designed for a modern and professional aesthetic. All UI text is in Brazilian Portuguese.

### Technical Implementations
-   **Backend**: Flask (Python 3.11)
-   **Database**: PostgreSQL with SQLAlchemy ORM, utilizing connection pooling for efficiency.
-   **Authentication**: Flask-Login for secure user management and password hashing.
-   **AI Integration**: Utilizes OpenAI GPT-4o Vision API for intelligent image analysis, with a fallback mechanism.
-   **Frontend**: Built with Vanilla HTML, CSS, and JavaScript, employing a custom design system.
-   **Storage**: Replit Object Storage is used for scalable cloud-based image storage.
-   **Image Upload**: Supports drag-and-drop, and batch uploads of 1M+ images with parallel processing (5 workers). Images are automatically matched with SKU data from purchase orders (Carteira de Compras).
-   **SKU Grouping**: Intelligent extraction of SKU base from filenames with suffixes (_01, _02, -A, -B, _FRENTE, _COSTAS, etc.). Multiple images of the same product are grouped by `sku_base` while maintaining individual `sequencia` identifiers for each angle/variation.
-   **AI Fallback**: Images without an automatic match are marked for future AI analysis, with contextualized analysis leveraging similar products.
-   **Field Separation**: Clear separation between Carteira data (nome_peca, categoria, subcategoria, tipo_peca, origem) and AI-generated data (description, tags, cor, material). Carteira fields are never overwritten by AI analysis.
-   **Reconciliation System**: Button to re-match images with Carteira when new products are imported. Updates Carteira-derived fields while preserving AI-generated observations.
-   **Resilient Upload System**: Upload direto para Object Storage com reprocessamento:
    - **Upload Imediato ao Bucket**: Arquivos v√£o DIRETO para o Object Storage durante recep√ß√£o (sem arquivos tempor√°rios locais)
    - **Persist√™ncia Garantida**: `storage_path` √© salvo imediatamente ap√≥s upload ao bucket
    - **Processamento Desacoplado**: Match com Carteira, thumbnails e an√°lise IA usam imagem j√° salva no bucket
    - **Reprocessamento**: Endpoint `/batch/{id}/reprocess` permite reprocessar itens que falharam (imagem j√° est√° no bucket)
    - **Recupera√ß√£o de Falhas**: Se o processamento falhar, n√£o perde a imagem - basta reprocessar
    - Suporte legado para arquivos locais durante transi√ß√£o
-   **Multi-Batch Queue System**: Upload multiple collections at once with centralized processing:
    - Create multiple batches in a single interface (/batch/queue)
    - Each batch can have different collection and brand assignments
    - Upload files for each batch in sequence (one batch at a time)
    - "Processar Todos" button to start processing all uploaded batches together
    - Sequential processing with cleanup only after all batches complete
-   **Thumbnail System**: Automatic thumbnail generation using Pillow:
    - Thumbnails stored in PostgreSQL (BYTEA) for fast retrieval
    - 300px max width, JPEG quality 75% (~5-50KB each)
    - Endpoint `/thumbnail/<image_id>` serves thumbnails with fallback generation
    - Catalog listing uses thumbnails for fast page loads
-   **Logging System**: Sistema de logging centralizado com duas camadas:
    - **Local (`oaz_logger.py`)**: Logging no console do servidor
        - Formato estruturado: `[TIMESTAMP] [LEVEL] [MODULE] [ACTION] mensagem | key=value`
        - M√≥dulos: AUTH, BATCH, UPLOAD, CARTEIRA, CATALOG, CRUD, DASHBOARD, SYSTEM
        - Logs especializados: auth_log, batch_log, upload_log, carteira_log, catalog_log, crud_log, nav_log
        - Timestamps com milissegundos para debugging
        - Cores no console para f√°cil identifica√ß√£o visual
    - **Externo (`rpa_monitor_client`)**: Monitoramento remoto via WebSocket
        - Conex√£o ao servidor RPA Monitor (wss://app-in-sight.replit.app/ws)
        - Fun√ß√µes helper: `rpa_info()`, `rpa_warn()`, `rpa_error()`, `rpa_screenshot()`
        - Screenshot autom√°tico em erros para debugging visual
        - Configura√ß√£o via secrets: RPA_MONITOR_ID, RPA_MONITOR_HOST, RPA_MONITOR_PORT, RPA_MONITOR_REGION, RPA_MONITOR_TRANSPORT
        - Integrado em todas as rotas principais: Login, Dashboard, Cat√°logo, Carteira, Batch
-   **Data Models**: Includes models for Users, Brands, Collections, Images, ImageItems (for multi-piece detection), Products, SKU History, and Shopping Cart (CarteiraCompras) imports.
-   **Workflow**: Implements a status workflow for images: Pendente ‚Üí Aprovado/Rejeitado ‚Üí Pendente An√°lise IA.
-   **Product Management**: Comprehensive CRUD operations for products, linking images to products, and tracking SKU changes with an audit trail.
-   **Import System**: Robust Excel/CSV import for purchase orders, including automatic creation of brands, collections, and products, with flexible column normalization and multi-sheet import capabilities.
-   **Reporting**: Provides metrics by status, brand, and collection, with CSV export functionality.
-   **SKUs Sem Foto Report**: Dashboard card showing photography coverage by collection, with progress bars and detailed page listing pending SKUs with CSV export. Reports correctly consider collection scope - a SKU is only marked as "with photo" if there's an image in the SAME collection.
-   **Collection-Scoped Matching**: Batch processing now filters SKU matches by the collection selected in the batch dropdown, preventing cross-collection matches.
-   **Multi-Piece Detection**: AI can detect and analyze up to four individual pieces within a single image, each with its own metadata.
-   **Batch AI Analysis from Catalog**: Select multiple SKUs in the catalog view and generate AI descriptions for all at once:
    - Checkboxes on each thumbnail card for multi-selection
    - Floating action bar appears when items are selected
    - Quick AI button on each thumbnail for single-click analysis
    - Modal with field selection (description, tags, color, type, material)
    - Real-time progress bar with per-image status log
    - Sequential processing with error resilience (partial success handling)
    - Endpoint `/api/analyze-single` for individual image analysis via AJAX
-   **Duplicate Detection**: Upload uses SHA256 hash to detect and skip duplicate images:
    - Hash calculated before upload to Object Storage
    - Existing hashes queried in batch from database
    - Duplicate files are skipped with feedback to user
    - Multiple images of same SKU (different angles) are allowed since hash differs
-   **Interactive Tutorial System**: Sistema de tutorial din√¢mico com toggle on/off:
    - Classe TutorialManager encapsulada (`static/js/tutorial.js`)
    - Intercepta TODOS os cliques quando ativado, exibindo descri√ß√µes contextuais
    - Modal com tema dark mode integrado ao design do sistema
    - Toggle via bot√£o no header ou link "Ajuda" no sidebar
    - Auto-gera√ß√£o de descri√ß√µes baseada em contexto (√≠cones, hrefs, tipos de input)
    - Atributos `data-tutorial-title` e `data-tutorial-desc` para descri√ß√µes personalizadas
    - Estado persistido em localStorage
    - Notifica√ß√£o toast ao ativar/desativar

### System Design Choices
The application is designed for scalability and performance, particularly for handling large volumes of images and data. It leverages a PostgreSQL database with optimized indexes for efficient querying of millions of records. The use of Replit Object Storage ensures persistent, scalable cloud storage for images, accessible via a dedicated `/storage/<path>` route. The batch processing system employs `ThreadPoolExecutor` for parallel execution, and the application is configured for Autoscale deployment on Replit.

## External Dependencies

-   **PostgreSQL**: Primary database for all application data.
-   **OpenAI GPT-4o Vision API**: Used for AI-powered image analysis and metadata extraction.
-   **Replit Object Storage**: Cloud-based storage solution for all uploaded images.
-   **Flask-Login**: For user authentication and session management.
-   **SQLAlchemy**: Python SQL toolkit and Object-Relational Mapper (ORM).

================================================================================
FILE: requirements.txt
================================================================================
Flask
Flask-SQLAlchemy
Flask-Login
werkzeug
openai
python-dotenv
openpyxl
pandas
google-cloud-storage
google-auth
replit-object-storage
requests
sift-stack-py
psycopg2-binary
openai
Pillow

================================================================================
FILE: reset_admin.py
================================================================================
from app import app, db, User

with app.app_context():
    # Delete existing admin user
    admin = User.query.filter_by(username='admin').first()
    if admin:
        db.session.delete(admin)
        db.session.commit()
        print("Deleted existing admin user")
    
    # Create new admin user
    new_admin = User(username='admin', email='admin@oaz.com')
    new_admin.set_password('admin')
    db.session.add(new_admin)
    db.session.commit()
    print("Created new admin user")
    
    # Verify
    test_admin = User.query.filter_by(username='admin').first()
    if test_admin:
        print(f"Verification - User: {test_admin.username}")
        print(f"Password check: {test_admin.check_password('admin')}")

================================================================================
FILE: static/css/style.css
================================================================================
:root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --text-primary: #f0f6fc;
    --text-secondary: #8b949e;
    --accent-primary: #238636; /* Greenish from screenshot or Blue */
    --accent-blue: #1f6feb;
    --border-color: #30363d;
    --card-bg: #161b22;
    --hover-bg: #21262d;
    --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: var(--font-main);
    background-color: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    height: 100vh;
    display: flex;
    overflow: hidden;
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
    color: var(--text-primary);
    font-weight: 600;
}

a {
    text-decoration: none;
    color: var(--accent-blue);
}

/* Layout */
.app-container {
    display: flex;
    width: 100%;
    height: 100%;
}

/* Sidebar */
.sidebar {
    width: 260px;
    background-color: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    flex-shrink: 0;
}

.logo-area {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 2.5rem;
}

.logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #1f6feb, #8b5cf6);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
}

.nav-menu {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex: 1;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: 6px;
    color: var(--text-secondary);
    transition: all 0.2s ease;
    font-size: 0.95rem;
}

.nav-item:hover, .nav-item.active {
    background-color: rgba(31, 111, 235, 0.1);
    color: var(--accent-blue);
}

.nav-item i {
    width: 20px;
    text-align: center;
}

.bottom-menu {
    margin-top: auto;
    border-top: 1px solid var(--border-color);
    padding-top: 1rem;
}

/* Main Content */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background-color: var(--bg-primary);
}

/* Header */
.top-header {
    height: 70px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 2rem;
    background-color: var(--bg-primary);
}

.search-bar {
    position: relative;
    width: 400px;
}

.search-bar input {
    width: 100%;
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    padding: 10px 16px 10px 40px;
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.search-bar i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.icon-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.1rem;
}

.user-profile {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.user-profile img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Content Area */
.content-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
}

/* Dashboard Grid */
.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1.5rem;
}

.stat-title {
    color: var(--text-secondary);
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stat-change {
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

.stat-change.positive { color: #3fb950; }
.stat-change.negative { color: #f85149; }

/* Charts Area */
.charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.chart-card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1.5rem;
    min-height: 300px;
}

/* Buttons */
.btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background-color: var(--accent-blue);
    color: white;
}

.btn-primary:hover {
    background-color: #1158c7;
}

/* Auth Pages */
.auth-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100vh;
    background-color: var(--bg-primary);
}

.auth-box {
    width: 400px;
    padding: 2rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
}

.auth-title {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    text-align: center;
}

.form-group {
    margin-bottom: 1.2rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.form-control {
    width: 100%;
    padding: 10px;
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-blue);
}

/* Image Grid */
.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
}

.image-card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s;
}

.image-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent-blue);
}

.image-preview {
    height: 200px;
    width: 100%;
    object-fit: cover;
    background-color: var(--bg-tertiary);
}

.image-info {
    padding: 1rem;
}

.image-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.image-meta {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-top: 0.5rem;
}

.status-pendente { background-color: rgba(210, 153, 34, 0.2); color: #d29922; }
.status-aprovado { background-color: rgba(63, 185, 80, 0.2); color: #3fb950; }
.status-rejeitado { background-color: rgba(248, 81, 73, 0.2); color: #f85149; }

/* Upload Area */
.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: rgba(22, 27, 34, 0.5);
    transition: all 0.3s;
}

.upload-area:hover {
    border-color: var(--accent-blue);
    background-color: rgba(31, 111, 235, 0.05);
}

.upload-icon {
    font-size: 3rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

/* ========================================
   TUTORIAL SYSTEM STYLES
   ======================================== */

/* Tutorial Modal - Dark Theme */
.tutorial-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
    animation: tutorialFadeIn 0.2s ease;
}

@keyframes tutorialFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.tutorial-modal-content {
    background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
    padding: 0;
    border-radius: 16px;
    max-width: 480px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
    border: 1px solid var(--border-color);
    animation: tutorialSlideIn 0.3s ease;
    overflow: hidden;
}

@keyframes tutorialSlideIn {
    from { 
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to { 
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.tutorial-modal-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px 24px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
    border-bottom: 1px solid var(--border-color);
}

.tutorial-modal-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    flex-shrink: 0;
}

.tutorial-modal-header h4 {
    flex: 1;
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.tutorial-modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    border-radius: 8px;
    transition: all 0.2s;
}

.tutorial-modal-close:hover {
    background: rgba(248, 81, 73, 0.2);
    color: #f85149;
}

.tutorial-modal-content > p {
    padding: 24px;
    margin: 0;
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--text-secondary);
}

.tutorial-modal-footer {
    padding: 16px 24px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid var(--border-color);
}

.tutorial-hint {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--text-secondary);
    opacity: 0.7;
}

.tutorial-hint i {
    color: #d29922;
}

/* Tutorial Toggle Button */
#tutorialToggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-secondary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s;
}

#tutorialToggle:hover {
    border-color: var(--accent-blue);
    color: var(--text-primary);
}

#tutorialToggle.active {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-color: transparent;
    color: white;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
}

#tutorialToggle.active:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
}

/* Tutorial Notification Toast */
.tutorial-notification {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    padding: 14px 28px;
    border-radius: 12px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 10001;
    box-shadow: 0 10px 40px rgba(99, 102, 241, 0.5);
    animation: notificationSlideUp 0.4s ease;
}

@keyframes notificationSlideUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.tutorial-notification.fade-out {
    animation: notificationSlideDown 0.3s ease forwards;
}

@keyframes notificationSlideDown {
    from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
}

.tutorial-notification i {
    font-size: 1.1rem;
}

================================================================================
FILE: static/js/tutorial.js
================================================================================
class TutorialManager {
    constructor() {
        this.isActive = localStorage.getItem('tutorialMode') === 'true';
        this.modal = null;
        this.init();
    }
    
    init() {
        this.createModal();
        this.setupEventListeners();
        this.updateToggleButton();
    }
    
    createModal() {
        const modalHTML = `
        <div id="tutorialModal" class="tutorial-modal" style="display:none;">
            <div class="tutorial-modal-content">
                <div class="tutorial-modal-header">
                    <span class="tutorial-modal-icon"><i class="fas fa-info-circle"></i></span>
                    <h4 id="tutorialModalTitle"></h4>
                    <span class="tutorial-modal-close">&times;</span>
                </div>
                <p id="tutorialModalDesc"></p>
                <div class="tutorial-modal-footer">
                    <span class="tutorial-hint"><i class="fas fa-lightbulb"></i> Clique fora ou no X para fechar</span>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        this.modal = document.getElementById('tutorialModal');
        this.modal.querySelector('.tutorial-modal-close').onclick = () => this.hideModal();
        this.modal.onclick = (e) => {
            if (e.target === this.modal) this.hideModal();
        };
    }
    
    setupEventListeners() {
        document.addEventListener('click', (e) => this.handleInteraction(e), true);
        document.addEventListener('submit', (e) => this.handleInteraction(e), true);
        document.addEventListener('change', (e) => this.handleInteraction(e), true);
        document.addEventListener('focus', (e) => this.handleFocus(e), true);
    }
    
    handleInteraction(e) {
        if (!this.isActive) return;
        
        const target = e.target.closest('button, a, input, select, textarea, [onclick], label, form, .card, .stat-card, .nav-item');
        if (!target) return;
        
        if (target.closest('#tutorialModal, #tutorialToggle, .tutorial-excluded')) return;
        
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        const info = this.getElementInfo(target);
        this.showModal(info.title, info.desc);
    }
    
    handleFocus(e) {
        if (!this.isActive) return;
        const target = e.target;
        if (target.matches('input, select, textarea, [contenteditable]')) {
            if (!target.closest('#tutorialModal, .tutorial-excluded')) {
                e.preventDefault();
                target.blur();
            }
        }
    }
    
    getElementInfo(el) {
        let title = el.getAttribute('data-tutorial-title');
        let desc = el.getAttribute('data-tutorial-desc');
        
        if (title && desc) return { title, desc };
        
        title = title || this.generateTitle(el);
        desc = desc || this.generateDescription(el);
        
        return { title, desc };
    }
    
    generateTitle(el) {
        const text = el.textContent?.trim()?.substring(0, 50);
        if (text && text.length > 2 && text.length < 40) return text;
        
        const tooltip = el.getAttribute('title') || el.getAttribute('data-bs-original-title');
        if (tooltip) return tooltip;
        
        const icon = el.querySelector('i[class*="fa-"]');
        if (icon) {
            const iconClass = [...icon.classList].find(c => c.startsWith('fa-') && c !== 'fa-fw');
            if (iconClass) return this.iconToTitle(iconClass);
        }
        
        if (el.tagName === 'INPUT') {
            const types = {
                'text': 'Campo de Texto',
                'email': 'Campo de E-mail',
                'password': 'Campo de Senha',
                'number': 'Campo Num√©rico',
                'file': 'Sele√ß√£o de Arquivo',
                'date': 'Sele√ß√£o de Data',
                'checkbox': 'Caixa de Sele√ß√£o',
                'radio': 'Op√ß√£o de Sele√ß√£o',
                'search': 'Campo de Busca'
            };
            return types[el.type] || 'Campo de Entrada';
        }
        if (el.tagName === 'SELECT') return 'Lista de Sele√ß√£o';
        if (el.tagName === 'BUTTON') return 'Bot√£o';
        if (el.tagName === 'FORM') return 'Formul√°rio';
        if (el.classList.contains('card') || el.classList.contains('stat-card')) return 'Card de Informa√ß√£o';
        
        return 'Elemento Interativo';
    }
    
    generateDescription(el) {
        if (el.placeholder) return `Digite aqui: ${el.placeholder}`;
        
        if (el.getAttribute('aria-label')) return el.getAttribute('aria-label');
        
        const label = document.querySelector(`label[for="${el.id}"]`);
        if (label) return `Preencha o campo: ${label.textContent.trim()}`;
        
        if (el.tagName === 'A' && el.href) {
            if (el.href.includes('/edit')) return 'Abre o formul√°rio de edi√ß√£o deste item';
            if (el.href.includes('/delete')) return 'Remove este item do sistema';
            if (el.href.includes('/view') || el.href.includes('/show') || el.href.includes('/detail')) return 'Visualiza os detalhes completos';
            if (el.href.includes('/new') || el.href.includes('/create')) return 'Abre o formul√°rio para criar um novo item';
            if (el.href.includes('/upload')) return 'Abre a tela de upload de arquivos';
            if (el.href.includes('/catalog')) return 'Acessa a biblioteca de imagens';
            if (el.href.includes('/dashboard')) return 'Volta para o painel principal';
            if (el.href.includes('/batch')) return 'Gerencia uploads em lote';
            if (el.href.includes('/carteira')) return 'Acessa a carteira de compras';
            if (el.href.includes('/collection')) return 'Gerencia cole√ß√µes';
            if (el.href.includes('/brand')) return 'Gerencia marcas';
            if (el.href.includes('/report')) return 'Acessa relat√≥rios do sistema';
            if (el.href.includes('/logout')) return 'Encerra sua sess√£o no sistema';
            return 'Navega para outra p√°gina do sistema';
        }
        
        if (el.type === 'submit') return 'Confirma e envia as informa√ß√µes do formul√°rio';
        if (el.type === 'file') return 'Clique para selecionar arquivos do seu computador';
        if (el.type === 'checkbox') return 'Marque ou desmarque esta op√ß√£o';
        if (el.type === 'search') return 'Digite para buscar no sistema';
        
        if (el.classList.contains('stat-card') || el.classList.contains('card')) {
            return 'Card com informa√ß√µes e m√©tricas do sistema';
        }
        
        if (el.classList.contains('nav-item')) {
            return 'Menu de navega√ß√£o - acessa diferentes √°reas do sistema';
        }
        
        return 'Clique para interagir com este elemento';
    }
    
    iconToTitle(iconClass) {
        const map = {
            'fa-eye': 'Visualizar',
            'fa-edit': 'Editar',
            'fa-pen': 'Editar',
            'fa-pencil': 'Editar',
            'fa-trash': 'Excluir',
            'fa-trash-alt': 'Excluir',
            'fa-plus': 'Adicionar Novo',
            'fa-plus-circle': 'Adicionar Novo',
            'fa-save': 'Salvar',
            'fa-download': 'Download',
            'fa-upload': 'Upload',
            'fa-cloud-upload-alt': 'Upload em Lote',
            'fa-search': 'Pesquisar',
            'fa-filter': 'Filtrar',
            'fa-refresh': 'Atualizar',
            'fa-sync': 'Sincronizar',
            'fa-redo': 'Reprocessar',
            'fa-file-pdf': 'Documento PDF',
            'fa-file-excel': 'Planilha Excel',
            'fa-file-csv': 'Arquivo CSV',
            'fa-camera': 'Captura de Tela',
            'fa-image': 'Imagem',
            'fa-images': 'Galeria de Imagens',
            'fa-th-large': 'Painel Principal',
            'fa-robot': 'An√°lise por IA',
            'fa-box': 'Produtos',
            'fa-shopping-cart': 'Carteira de Compras',
            'fa-folder': 'Cole√ß√µes',
            'fa-tag': 'Marcas',
            'fa-clipboard-check': 'Auditoria',
            'fa-file-alt': 'Relat√≥rios',
            'fa-network-wired': 'Integra√ß√µes',
            'fa-question-circle': 'Ajuda / Tutorial',
            'fa-sign-out-alt': 'Sair do Sistema',
            'fa-cog': 'Configura√ß√µes',
            'fa-bell': 'Notifica√ß√µes',
            'fa-check': 'Confirmar',
            'fa-times': 'Cancelar / Fechar',
            'fa-play': 'Iniciar',
            'fa-pause': 'Pausar',
            'fa-stop': 'Parar',
            'fa-gem': 'OAZ Banco de Imagens'
        };
        const result = map[iconClass];
        if (result) return result;
        return iconClass.replace('fa-', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
    
    toggle() {
        this.isActive = !this.isActive;
        localStorage.setItem('tutorialMode', this.isActive);
        this.updateToggleButton();
        this.showToggleNotification();
        
        if (this.isActive) {
            document.querySelectorAll('input, textarea, select').forEach(el => el.blur());
        }
    }
    
    updateToggleButton() {
        const btn = document.getElementById('tutorialToggle');
        if (btn) {
            btn.classList.toggle('active', this.isActive);
            btn.innerHTML = this.isActive 
                ? '<i class="fas fa-graduation-cap"></i> Tutorial ATIVO'
                : '<i class="far fa-question-circle"></i> Tutorial';
        }
    }
    
    showToggleNotification() {
        const existing = document.querySelector('.tutorial-notification');
        if (existing) existing.remove();
        
        const notification = document.createElement('div');
        notification.className = 'tutorial-notification';
        notification.innerHTML = this.isActive 
            ? '<i class="fas fa-graduation-cap"></i> Modo Tutorial ATIVADO - Clique em qualquer elemento para ver sua descri√ß√£o'
            : '<i class="fas fa-check"></i> Modo Tutorial desativado - Navega√ß√£o normal restaurada';
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    showModal(title, desc) {
        document.getElementById('tutorialModalTitle').textContent = title;
        document.getElementById('tutorialModalDesc').textContent = desc;
        this.modal.style.display = 'flex';
    }
    
    hideModal() {
        this.modal.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    window.tutorialManager = new TutorialManager();
});

================================================================================
FILE: templates/admin/settings.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Configura√ß√µes</h1>
    <p style="color: var(--text-secondary);">Configure as defini√ß√µes do sistema e integra√ß√µes.</p>
</div>

<div class="stat-card" style="max-width: 600px;">
    <h3 style="margin-bottom: 1.5rem;">Configura√ß√£o de IA</h3>

    <form method="POST">
        <div class="form-group">
            <label class="form-label">Chave API OpenAI</label>
            <div style="position: relative;">
                <input type="password" name="api_key" class="form-control" value="{{ current_key }}"
                    placeholder="sk-..." required>
                <i class="fas fa-key"
                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                Esta chave ser√° usada para an√°lise de imagens e marca√ß√£o autom√°tica.
                <a href="https://platform.openai.com/api-keys" target="_blank"
                    style="color: var(--accent-blue);">Obtenha uma chave aqui</a>.
            </p>
        </div>

        <div
            style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
            <button type="submit" class="btn btn-primary">
                Salvar Configura√ß√£o
            </button>
        </div>
    </form>
</div>
{% endblock %}

================================================================================
FILE: templates/analytics/index.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>An√°lises e M√©tricas</h1>
    <p style="color: var(--text-secondary);">Visualize estat√≠sticas detalhadas e insights do seu banco de imagens.</p>
</div>

<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-title">Taxa de Crescimento</div>
        <div class="stat-value">+12.5%</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i> vs. m√™s anterior
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Tempo M√©dio de Aprova√ß√£o</div>
        <div class="stat-value">2.3h</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-down"></i> -15% mais r√°pido
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Uso de Armazenamento</div>
        <div class="stat-value">68%</div>
        <div class="stat-change negative">
            <i class="fas fa-arrow-up"></i> +5% este m√™s
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Precis√£o da IA</div>
        <div class="stat-value">94%</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i> +3.2%
        </div>
    </div>
</div>

<div class="charts-grid" style="margin-top: 2rem;">
    <div style="grid-column: 1 / -1;">
        <div class="chart-card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                <div>
                    <h3>Uploads por Per√≠odo</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">√öltimos 30 dias</p>
                </div>
                <select class="form-control" style="width: 150px;">
                    <option>√öltimos 7 dias</option>
                    <option selected>√öltimos 30 dias</option>
                    <option>√öltimos 90 dias</option>
                    <option>Este ano</option>
                </select>
            </div>
            <canvas id="uploadsChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <div>
        <div class="chart-card">
            <h3 style="margin-bottom: 1.5rem;">Distribui√ß√£o por Status</h3>
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <div>
        <div class="chart-card">
            <h3 style="margin-bottom: 1.5rem;">Top 10 Tags Mais Usadas</h3>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.9rem;">Casual</span>
                    <div style="flex: 1; margin: 0 1rem; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <div style="width: 85%; height: 100%; background: var(--accent-blue);"></div>
                    </div>
                    <span style="font-size: 0.9rem; color: var(--text-secondary);">850</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.9rem;">Denim</span>
                    <div style="flex: 1; margin: 0 1rem; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <div style="width: 72%; height: 100%; background: var(--accent-purple);"></div>
                    </div>
                    <span style="font-size: 0.9rem; color: var(--text-secondary);">720</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.9rem;">Cotton</span>
                    <div style="flex: 1; margin: 0 1rem; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <div style="width: 65%; height: 100%; background: var(--accent-pink);"></div>
                    </div>
                    <span style="font-size: 0.9rem; color: var(--text-secondary);">650</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.9rem;">Blue</span>
                    <div style="flex: 1; margin: 0 1rem; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <div style="width: 58%; height: 100%; background: var(--accent-blue);"></div>
                    </div>
                    <span style="font-size: 0.9rem; color: var(--text-secondary);">580</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.9rem;">Formal</span>
                    <div style="flex: 1; margin: 0 1rem; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <div style="width: 45%; height: 100%; background: var(--accent-purple);"></div>
                    </div>
                    <span style="font-size: 0.9rem; color: var(--text-secondary);">450</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Uploads Chart
    const ctxUploads = document.getElementById('uploadsChart').getContext('2d');
    new Chart(ctxUploads, {
        type: 'line',
        data: {
            labels: ['1', '3', '5', '7', '9', '11', '13', '15', '17', '19', '21', '23', '25', '27', '29', '30'],
            datasets: [{
                label: 'Uploads',
                data: [45, 52, 38, 65, 59, 80, 81, 56, 55, 40, 68, 72, 85, 90, 78, 95],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#9ca3af' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#9ca3af' }
                }
            }
        }
    });

    // Status Chart
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['Aprovado', 'Pendente', 'Rejeitado'],
            datasets: [{
                data: [65, 25, 10],
                backgroundColor: ['#3fb950', '#d29922', '#f85149'],
                borderWidth: 0
            }]
        },
        options: {
            plugins: {
                legend: { position: 'bottom', labels: { color: '#9ca3af' } }
            }
        }
    });
</script>
{% endblock %}

================================================================================
FILE: templates/auditoria/historico_sku.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <a href="{{ url_for('auditoria') }}" style="color: var(--text-secondary); font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-arrow-left"></i> Voltar para Auditoria
        </a>
        <h1 style="margin-top: 1rem;">Hist√≥rico de Altera√ß√µes de SKU</h1>
        <p style="color: var(--text-secondary);">Registro completo de todas as altera√ß√µes de SKU no sistema.</p>
    </div>
    <a href="{{ url_for('exportar_auditoria', tipo='historico_sku') }}" class="btn" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);">
        <i class="fas fa-file-export"></i> Exportar CSV
    </a>
</div>

{% if historico %}
<div class="stat-card" style="padding: 0; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">SKU Antigo</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">SKU Novo</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Data da Altera√ß√£o</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Motivo</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Usu√°rio</th>
            </tr>
        </thead>
        <tbody>
            {% for item in historico %}
            <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 1rem;">
                    <span style="font-family: monospace; background: rgba(248, 81, 73, 0.1); color: #f85149; padding: 4px 8px; border-radius: 4px;">
                        {{ item.sku_antigo }}
                    </span>
                </td>
                <td style="padding: 1rem;">
                    <span style="font-family: monospace; background: rgba(63, 185, 80, 0.1); color: #3fb950; padding: 4px 8px; border-radius: 4px;">
                        {{ item.sku_novo }}
                    </span>
                </td>
                <td style="padding: 1rem; color: var(--text-secondary);">
                    <i class="far fa-calendar-alt" style="margin-right: 0.5rem;"></i>
                    {{ item.data_alteracao.strftime('%d/%m/%Y √†s %H:%M') }}
                </td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ item.motivo or '-' }}</td>
                <td style="padding: 1rem;">
                    {% if item.usuario %}
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 28px; height: 28px; border-radius: 50%; background: var(--accent-blue); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 600;">
                            {{ item.usuario.username[0].upper() }}
                        </div>
                        <span>{{ item.usuario.username }}</span>
                    </div>
                    {% else %}
                    <span style="color: var(--text-secondary);">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="stat-card" style="text-align: center; padding: 4rem;">
    <div style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;">
        <i class="fas fa-history"></i>
    </div>
    <h3>Nenhum Hist√≥rico Encontrado</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">N√£o h√° registro de altera√ß√µes de SKU no sistema.</p>
</div>
{% endif %}
{% endblock %}

================================================================================
FILE: templates/auditoria/index.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Auditoria</h1>
    <p style="color: var(--text-secondary);">Dashboard de auditoria e controle de qualidade.</p>
</div>

<h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
    <i class="fas fa-box" style="color: var(--accent-blue);"></i> Status dos Produtos
</h3>
<div class="dashboard-stats" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 2rem;">
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Total de Produtos</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ total_produtos }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(31, 111, 235, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-boxes" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Produtos com Foto</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #3fb950;">{{ produtos_com_foto }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(63, 185, 80, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-image" style="color: #3fb950; font-size: 1.25rem;"></i>
            </div>
        </div>
        <a href="{{ url_for('export_auditoria', tipo='produtos_com_foto') }}" style="color: var(--accent-blue); font-size: 0.85rem; margin-top: 0.5rem; display: inline-block;">
            <i class="fas fa-download"></i> Exportar lista
        </a>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Produtos sem Foto</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #f85149;">{{ produtos_sem_foto }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(248, 81, 73, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-image" style="color: #f85149; font-size: 1.25rem;"></i>
            </div>
        </div>
        <a href="{{ url_for('skus_pendentes') }}" style="color: var(--accent-blue); font-size: 0.85rem; margin-top: 0.5rem; display: inline-block;">
            <i class="fas fa-list"></i> Ver lista completa
        </a>
    </div>
</div>

<h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
    <i class="fas fa-wallet" style="color: var(--accent-blue);"></i> Status da Carteira
</h3>
<div class="dashboard-stats" style="margin-bottom: 2rem;">
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Total na Carteira</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ carteira_total }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(31, 111, 235, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-wallet" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Com Foto</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #3fb950;">{{ carteira_com_foto }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(63, 185, 80, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-check-circle" style="color: #3fb950; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Sem Foto</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #f85149;">{{ carteira_sem_foto }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(248, 81, 73, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times-circle" style="color: #f85149; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Pendente</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #d29922;">{{ carteira_pendente }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(210, 153, 34, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-clock" style="color: #d29922; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-history" style="color: #d29922;"></i> Altera√ß√µes Recentes de SKU
            </h3>
            <a href="{{ url_for('historico_sku') }}" style="color: var(--accent-blue); font-size: 0.85rem;">
                Ver hist√≥rico completo <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        
        {% if alteracoes_sku %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <th style="padding: 0.5rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary);">SKU Antigo</th>
                    <th style="padding: 0.5rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary);">SKU Novo</th>
                    <th style="padding: 0.5rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary);">Data</th>
                </tr>
            </thead>
            <tbody>
                {% for item in alteracoes_sku[:10] %}
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 0.5rem; font-family: monospace; font-size: 0.85rem; color: #f85149;">{{ item.sku_antigo }}</td>
                    <td style="padding: 0.5rem; font-family: monospace; font-size: 0.85rem; color: #3fb950;">{{ item.sku_novo }}</td>
                    <td style="padding: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">{{ item.data_alteracao.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem; color: #3fb950;"></i>
            <p>Nenhuma altera√ß√£o de SKU registrada</p>
        </div>
        {% endif %}
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-exclamation-triangle" style="color: #f85149;"></i> Diverg√™ncias
            </h3>
        </div>
        
        {% if divergencias %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <th style="padding: 0.5rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary);">SKU Carteira</th>
                    <th style="padding: 0.5rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary);">SKU Novo</th>
                    <th style="padding: 0.5rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary);">Data</th>
                </tr>
            </thead>
            <tbody>
                {% for div in divergencias[:10] %}
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 0.5rem; font-family: monospace; font-size: 0.85rem; color: #f85149;">{{ div.sku_antigo }}</td>
                    <td style="padding: 0.5rem; font-family: monospace; font-size: 0.85rem; color: #3fb950;">{{ div.sku_novo }}</td>
                    <td style="padding: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">{{ div.data.strftime('%d/%m/%Y') if div.data else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
            <i class="fas fa-info-circle"></i> SKUs na carteira que foram atualizados no cadastro de produtos
        </p>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem; color: #3fb950;"></i>
            <p>Nenhuma diverg√™ncia encontrada</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="stat-card" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-image" style="color: #f85149;"></i> SKUs Pendentes (Sem Foto)
        </h3>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('skus_pendentes') }}" class="btn" style="padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.85rem;">
                <i class="fas fa-list"></i> Ver Todos
            </a>
            <a href="{{ url_for('export_auditoria', tipo='produtos_sem_foto') }}" class="btn" style="padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.85rem;">
                <i class="fas fa-download"></i> Exportar CSV
            </a>
        </div>
    </div>
    
    {% if skus_pendentes %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 1px solid var(--border-color);">
                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">SKU</th>
                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Descri√ß√£o</th>
                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Cor</th>
                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Marca</th>
                <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Cole√ß√£o</th>
            </tr>
        </thead>
        <tbody>
            {% for produto in skus_pendentes[:20] %}
            <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 0.75rem; font-weight: 500; font-family: monospace;">{{ produto.sku }}</td>
                <td style="padding: 0.75rem; color: var(--text-secondary);">{{ produto.descricao or '-' }}</td>
                <td style="padding: 0.75rem; color: var(--text-secondary);">{{ produto.cor or '-' }}</td>
                <td style="padding: 0.75rem; color: var(--text-secondary);">{{ produto.marca.name if produto.marca else '-' }}</td>
                <td style="padding: 0.75rem; color: var(--text-secondary);">{{ produto.colecao.name if produto.colecao else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if skus_pendentes|length > 20 %}
    <div style="text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
        Mostrando 20 de {{ skus_pendentes|length }} produtos pendentes. <a href="{{ url_for('skus_pendentes') }}" style="color: var(--accent-blue);">Ver todos</a>
    </div>
    {% endif %}
    {% else %}
    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem; color: #3fb950;"></i>
        <p>Todos os produtos possuem foto!</p>
    </div>
    {% endif %}
</div>
{% endblock %}

================================================================================
FILE: templates/auditoria/skus_pendentes.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <a href="{{ url_for('auditoria') }}" style="color: var(--text-secondary); font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-arrow-left"></i> Voltar para Auditoria
        </a>
        <h1 style="margin-top: 1rem;">Produtos sem Foto</h1>
        <p style="color: var(--text-secondary);">Lista completa de produtos que ainda n√£o possuem foto associada.</p>
    </div>
    <a href="{{ url_for('exportar_auditoria', tipo='skus_pendentes') }}" class="btn" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);">
        <i class="fas fa-file-export"></i> Exportar CSV
    </a>
</div>

<div class="stat-card" style="margin-bottom: 2rem; display: inline-flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem;">
    <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(248, 81, 73, 0.1); display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-exclamation-circle" style="color: #f85149; font-size: 1.25rem;"></i>
    </div>
    <div>
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Total de SKUs Pendentes</p>
        <h2 style="font-size: 1.75rem; font-weight: 600; color: #f85149;">{{ produtos|length }}</h2>
    </div>
</div>

{% if produtos %}
<div class="stat-card" style="padding: 0; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">SKU</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Descri√ß√£o</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Cor</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Marca</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Cole√ß√£o</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for produto in produtos %}
            <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 1rem;">
                    <span style="font-family: monospace; font-weight: 500;">{{ produto.sku }}</span>
                </td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ produto.descricao or '-' }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ produto.cor or '-' }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ produto.marca.name if produto.marca else '-' }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ produto.colecao.name if produto.colecao else '-' }}</td>
                <td style="padding: 1rem; text-align: center;">
                    <a href="{{ url_for('edit_produto', id=produto.id) }}" class="btn" style="padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--accent-blue); font-size: 0.85rem;" title="Associar Foto">
                        <i class="fas fa-link"></i> Associar Foto
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="stat-card" style="text-align: center; padding: 4rem;">
    <div style="font-size: 3rem; color: #3fb950; margin-bottom: 1rem;">
        <i class="fas fa-check-circle"></i>
    </div>
    <h3>Parab√©ns!</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Todos os produtos possuem foto associada.</p>
    <a href="{{ url_for('produtos') }}" class="btn btn-primary">
        <i class="fas fa-box"></i> Ver Produtos
    </a>
</div>
{% endif %}
{% endblock %}

================================================================================
FILE: templates/auth/login.html
================================================================================
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Banco de Imagens OAZ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="auth-container">
        <div class="auth-box">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div class="logo-icon" style="margin: 0 auto 1rem; width: 48px; height: 48px; font-size: 1.5rem;">
                    <i class="fas fa-gem"></i>
                </div>
                <h1 class="auth-title">Banco de Imagens OAZ</h1>
                <p style="color: var(--text-secondary);">Entre para acessar seu espa√ßo de trabalho</p>
            </div>

            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div style="margin-bottom: 1rem; color: #f85149; text-align: center;">
                {{ messages[0] }}
            </div>
            {% endif %}
            {% endwith %}

            <form method="POST" action="{{ url_for('login') }}">
                <div class="form-group">
                    <label class="form-label">Usu√°rio</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" name="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary"
                    style="width: 100%; justify-content: center; margin-top: 1rem;">
                    Entrar
                </button>
            </form>

            <div style="margin-top: 1.5rem; text-align: center; font-size: 0.9rem;">
                <a href="{{ url_for('register') }}" style="color: var(--text-secondary);">N√£o tem uma conta?
                    Cadastre-se</a>
            </div>
        </div>
    </div>
</body>

</html>

================================================================================
FILE: templates/auth/register.html
================================================================================
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Banco de Imagens OAZ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="auth-container">
        <div class="auth-box">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div class="logo-icon" style="margin: 0 auto 1rem; width: 48px; height: 48px; font-size: 1.5rem;">
                    <i class="fas fa-gem"></i>
                </div>
                <h1 class="auth-title">Criar Conta</h1>
                <p style="color: var(--text-secondary);">Junte-se ao Banco de Imagens OAZ</p>
            </div>

            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div style="margin-bottom: 1rem; color: #f85149; text-align: center;">
                {{ messages[0] }}
            </div>
            {% endif %}
            {% endwith %}

            <form method="POST" action="{{ url_for('register') }}">
                <div class="form-group">
                    <label class="form-label">Usu√°rio</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">E-mail</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" name="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary"
                    style="width: 100%; justify-content: center; margin-top: 1rem;">
                    Criar Conta
                </button>
            </form>

            <div style="margin-top: 1.5rem; text-align: center; font-size: 0.9rem;">
                <a href="{{ url_for('login') }}" style="color: var(--text-secondary);">J√° tem uma conta? Entre</a>
            </div>
        </div>
    </div>
</body>

</html>

================================================================================
FILE: templates/base.html
================================================================================
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Imagens OAZ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/tutorial.js') }}" defer></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-area">
                <div class="logo-icon">
                    <i class="fas fa-gem"></i>
                </div>
                <div>
                    <div style="font-weight: 700; font-size: 1.1rem;">OAZ</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Banco de Imagens</div>
                </div>
            </div>

            <nav class="nav-menu">
                <a href="{{ url_for('dashboard') }}"
                    class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}"
                    data-tutorial-title="Painel Principal"
                    data-tutorial-desc="Vis√£o geral do sistema com m√©tricas, estat√≠sticas de imagens, uploads recentes e atalhos r√°pidos.">
                    <i class="fas fa-th-large"></i>
                    <span>Painel</span>
                </a>
                <a href="{{ url_for('catalog') }}"
                    class="nav-item {% if request.endpoint == 'catalog' %}active{% endif %}"
                    data-tutorial-title="Biblioteca de Imagens"
                    data-tutorial-desc="Visualize, pesquise e gerencie todas as imagens do banco. Aplique filtros por cole√ß√£o, marca, status e execute an√°lise IA em lote.">
                    <i class="far fa-images"></i>
                    <span>Biblioteca de Imagens</span>
                </a>
                <a href="{{ url_for('batch_list') }}"
                    class="nav-item {% if request.endpoint in ['batch_list', 'batch_new', 'batch_detail'] %}active{% endif %}"
                    data-tutorial-title="Upload em Lote"
                    data-tutorial-desc="Fa√ßa upload de m√∫ltiplas imagens de uma vez. Suporta drag-and-drop, detec√ß√£o de duplicatas e match autom√°tico com SKUs da Carteira.">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Upload em Lote</span>
                </a>
                <a href="{{ url_for('analyze_pending_ai') }}"
                    class="nav-item {% if request.endpoint == 'analyze_pending_ai' %}active{% endif %}"
                    data-tutorial-title="An√°lise por IA"
                    data-tutorial-desc="Processe imagens pendentes com intelig√™ncia artificial para gerar descri√ß√µes, identificar cores, materiais e caracter√≠sticas.">
                    <i class="fas fa-robot"></i>
                    <span>An√°lise IA</span>
                </a>
                <a href="{{ url_for('produtos') }}"
                    class="nav-item {% if request.endpoint in ['produtos', 'new_produto', 'edit_produto'] %}active{% endif %}"
                    data-tutorial-title="Gest√£o de Produtos"
                    data-tutorial-desc="Cadastre e gerencie produtos do cat√°logo. Vincule imagens, defina atributos e mantenha o hist√≥rico de SKUs.">
                    <i class="fas fa-box"></i>
                    <span>Produtos</span>
                </a>
                <a href="{{ url_for('carteira') }}"
                    class="nav-item {% if request.endpoint in ['carteira', 'importar_carteira'] %}active{% endif %}"
                    data-tutorial-title="Carteira de Compras"
                    data-tutorial-desc="Importe planilhas de pedidos de compra. Os SKUs importados s√£o usados para match autom√°tico com imagens durante o upload.">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Carteira de Compras</span>
                </a>
                <a href="{{ url_for('collections') }}"
                    class="nav-item {% if request.endpoint in ['collections', 'collection_detail', 'new_collection', 'edit_collection'] %}active{% endif %}"
                    data-tutorial-title="Cole√ß√µes"
                    data-tutorial-desc="Organize suas imagens por cole√ß√£o (ex: Ver√£o 2025, Inverno 2024). Cada cole√ß√£o agrupa imagens e produtos relacionados.">
                    <i class="far fa-folder"></i>
                    <span>Cole√ß√µes</span>
                </a>
                <a href="{{ url_for('brands') }}"
                    class="nav-item {% if request.endpoint == 'brands' %}active{% endif %}"
                    data-tutorial-title="Marcas"
                    data-tutorial-desc="Gerencie as marcas do seu cat√°logo. Associe produtos e imagens a marcas espec√≠ficas para melhor organiza√ß√£o.">
                    <i class="fas fa-tag"></i>
                    <span>Marcas</span>
                </a>
                <a href="{{ url_for('auditoria') }}"
                    class="nav-item {% if request.endpoint in ['auditoria', 'historico_sku', 'skus_pendentes'] %}active{% endif %}"
                    data-tutorial-title="Auditoria"
                    data-tutorial-desc="Acompanhe altera√ß√µes em SKUs, identifique pend√™ncias e verifique o hist√≥rico de modifica√ß√µes no sistema.">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Auditoria</span>
                </a>
                <a href="{{ url_for('reports') }}"
                    class="nav-item {% if request.endpoint == 'reports' %}active{% endif %}"
                    data-tutorial-title="Relat√≥rios"
                    data-tutorial-desc="Gere relat√≥rios de cobertura fotogr√°fica, SKUs sem foto, m√©tricas por cole√ß√£o e exporte dados em CSV.">
                    <i class="fas fa-file-alt"></i>
                    <span>Relat√≥rios</span>
                </a>
                <a href="{{ url_for('integrations') }}"
                    class="nav-item {% if request.endpoint == 'integrations' %}active{% endif %}"
                    data-tutorial-title="Integra√ß√µes"
                    data-tutorial-desc="Configure integra√ß√µes com sistemas externos, APIs e servi√ßos de terceiros.">
                    <i class="fas fa-network-wired"></i>
                    <span>Integra√ß√µes</span>
                </a>
            </nav>

            <div class="bottom-menu">
                <a href="#" class="nav-item tutorial-excluded" onclick="tutorialManager.toggle(); return false;"
                    data-tutorial-title="Ativar Tutorial"
                    data-tutorial-desc="Ativa o modo tutorial interativo para aprender sobre cada funcionalidade do sistema.">
                    <i class="far fa-question-circle"></i>
                    <span>Ajuda</span>
                </a>
                <a href="{{ url_for('logout') }}" class="nav-item"
                    data-tutorial-title="Sair do Sistema"
                    data-tutorial-desc="Encerra sua sess√£o atual e volta para a tela de login.">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="top-header">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Buscar por SKU, tag, cole√ß√£o...">
                </div>

                <div class="header-actions">
                    <button id="tutorialToggle" class="tutorial-excluded" onclick="tutorialManager.toggle()"
                        data-tutorial-title="Modo Tutorial"
                        data-tutorial-desc="Liga/desliga o modo tutorial. Quando ativo, clicar em qualquer elemento mostra sua descri√ß√£o ao inv√©s de executar a a√ß√£o.">
                        <i class="far fa-question-circle"></i> Tutorial
                    </button>
                    <button class="icon-btn" data-tutorial-title="Notifica√ß√µes" data-tutorial-desc="Exibe alertas e notifica√ß√µes do sistema."><i class="far fa-bell"></i></button>
                    <a href="{{ url_for('settings') }}" class="icon-btn" data-tutorial-title="Configura√ß√µes" data-tutorial-desc="Acessa as configura√ß√µes do sistema."><i class="fas fa-cog"></i></a>
                    <div class="user-profile">
                        <!-- Placeholder for user avatar -->
                        <div
                            style="width:100%; height:100%; background:#3b82f6; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">
                            {{ current_user.username[0].upper() }}
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Scroll Area -->
            <div class="content-scroll">
                {% with messages = get_flashed_messages() %}
                {% if messages %}
                <div
                    style="margin-bottom: 1rem; padding: 1rem; background: rgba(31, 111, 235, 0.1); border: 1px solid var(--accent-blue); border-radius: 6px; color: var(--accent-blue);">
                    {{ messages[0] }}
                </div>
                {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
</body>

</html>

================================================================================
FILE: templates/batch/analyze_pending.html
================================================================================
{% extends "base.html" %}

{% block title %}An√°lise IA Pendente - OAZ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>An√°lise IA Pendente</h1>
    <p>Imagens sem match na Carteira de Compras - analisar com intelig√™ncia artificial</p>
</div>

<div class="content-card">
    <div class="card-header">
        <h2><i class="fas fa-robot"></i> Imagens Aguardando An√°lise IA</h2>
        <span class="badge badge-warning">{{ pending_images|length }} pendente(s)</span>
    </div>
    
    <div class="card-body">
        {% if pending_images %}
        <form method="POST">
            <div class="mb-3" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <button type="button" onclick="toggleAll(true)" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-check-square"></i> Selecionar Todos
                    </button>
                    <button type="button" onclick="toggleAll(false)" class="btn btn-outline-secondary btn-sm">
                        <i class="far fa-square"></i> Desmarcar Todos
                    </button>
                </div>
                <div style="background: rgba(255,193,7,0.1); padding: 0.75rem 1rem; border-radius: 8px; border-left: 3px solid #ffc107;">
                    <i class="fas fa-info-circle" style="color: #ffc107;"></i>
                    <span style="font-size: 0.9rem;">M√°ximo de 10 imagens por vez para evitar timeout</span>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;"><input type="checkbox" id="selectAll" onchange="toggleAll(this.checked)"></th>
                            <th style="width: 80px;">Preview</th>
                            <th>SKU</th>
                            <th>Cole√ß√£o</th>
                            <th>Marca</th>
                            <th>Subcole√ß√£o</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for image in pending_images %}
                        <tr>
                            <td>
                                <input type="checkbox" name="image_ids" value="{{ image.id }}" class="image-checkbox">
                            </td>
                            <td>
                                {% if image.image_url %}
                                <img src="{{ image.image_url }}" alt="{{ image.sku }}" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                {% else %}
                                <div style="width: 60px; height: 60px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-image" style="color: var(--text-secondary);"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('image_detail', id=image.id) }}" style="color: var(--accent-primary); text-decoration: none;">
                                    {{ image.sku or 'Sem SKU' }}
                                </a>
                            </td>
                            <td>{{ image.collection.name if image.collection else '-' }}</td>
                            <td>{{ image.brand.name if image.brand else '-' }}</td>
                            <td>{{ image.subcolecao_rel.nome if image.subcolecao_rel else '-' }}</td>
                            <td>{{ image.created_at.strftime('%d/%m/%Y') if image.created_at else '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4" style="display: flex; justify-content: flex-end; gap: 1rem;">
                <a href="{{ url_for('catalog') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-robot"></i> Analisar Selecionadas com IA
                </button>
            </div>
        </form>
        {% else %}
        <div class="empty-state" style="text-align: center; padding: 3rem;">
            <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success-color); margin-bottom: 1rem;"></i>
            <h3>Nenhuma imagem pendente!</h3>
            <p style="color: var(--text-secondary);">Todas as imagens foram processadas ou encontraram match na Carteira de Compras.</p>
            <a href="{{ url_for('batch_list') }}" class="btn btn-primary mt-3">
                <i class="fas fa-cloud-upload-alt"></i> Fazer Novo Upload
            </a>
        </div>
        {% endif %}
    </div>
</div>

<style>
.content-card {
    background: var(--bg-secondary);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.card-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h2 {
    margin: 0;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-body {
    padding: 1.5rem;
}

.badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.badge-warning {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.data-table tr:hover {
    background: rgba(var(--accent-primary-rgb), 0.05);
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.btn-primary {
    background: var(--accent-primary);
    color: #000;
}

.btn-primary:hover {
    background: var(--accent-secondary);
    transform: translateY(-1px);
}

.btn-outline-primary {
    background: transparent;
    border: 1px solid var(--accent-primary);
    color: var(--accent-primary);
}

.btn-outline-secondary {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
}

.mb-3 { margin-bottom: 1rem; }
.mt-3 { margin-top: 1rem; }
.mt-4 { margin-top: 1.5rem; }
</style>

<script>
function toggleAll(checked) {
    document.querySelectorAll('.image-checkbox').forEach(cb => {
        cb.checked = checked;
    });
    document.getElementById('selectAll').checked = checked;
}

document.querySelectorAll('.image-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
        const all = document.querySelectorAll('.image-checkbox');
        const checked = document.querySelectorAll('.image-checkbox:checked');
        document.getElementById('selectAll').checked = all.length === checked.length;
    });
});
</script>
{% endblock %}

================================================================================
FILE: templates/batch/detail.html
================================================================================
{% extends "base.html" %}

{% block title %}Lote #{{ batch.id }} - OAZ Smart Image Bank{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Lote: {{ batch.nome or 'Sem nome' }}</h1>
    <a href="{{ url_for('batch_list') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>
</div>

<div class="batch-status-card" id="batch-status">
    <div class="status-header">
        <div class="status-indicator">
            <span class="status-badge status-{{ batch.status|lower|replace(' ', '-') }}">
                {% if batch.status == 'Processando' %}
                <span class="pulse-dot"></span>
                {% endif %}
                {{ batch.status }}
            </span>
            {% if batch.status == 'Processando' %}
            <span class="processing-label">Processamento em andamento...</span>
            {% elif batch.status == 'Conclu√≠do' %}
            <span class="completed-label"><i class="fas fa-check-circle"></i> Conclu√≠do</span>
            {% elif batch.status == 'Recebendo' %}
            <span class="receiving-label"><i class="fas fa-download"></i> Recebendo arquivos...</span>
            {% endif %}
        </div>
        <span class="batch-id">#{{ batch.id }}</span>
    </div>
    
    <div class="progress-section">
        <div class="progress-bar-large">
            <div class="progress-fill" style="width: {{ batch.progresso }}%"></div>
        </div>
        <div class="progress-info">
            <span id="progress-percent">{{ batch.progresso }}%</span>
            <span id="progress-count">{{ batch.processados }} / {{ batch.total_arquivos }}</span>
        </div>
    </div>
    
    <div class="stats-row">
        <div class="stat-box">
            <span class="stat-value" id="stat-total">{{ batch.total_arquivos }}</span>
            <span class="stat-label">Total</span>
        </div>
        <div class="stat-box success">
            <span class="stat-value" id="stat-success">{{ batch.sucesso }}</span>
            <span class="stat-label">Sucesso</span>
        </div>
        <div class="stat-box danger">
            <span class="stat-value" id="stat-failed">{{ batch.falhas }}</span>
            <span class="stat-label">Falhas</span>
        </div>
        <div class="stat-box info">
            <span class="stat-value">{{ batch.processados }}</span>
            <span class="stat-label">Processados</span>
        </div>
    </div>
    
    {% if batch.falhas > 0 %}
    <div class="error-alert" id="error-alert">
        <div class="error-alert-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="error-alert-content">
            <strong>{{ batch.falhas }} imagem(ns) com erro</strong>
            <p>Alguns arquivos n√£o foram processados corretamente. Voc√™ pode tentar reprocessar.</p>
        </div>
        {% if batch.status == 'Conclu√≠do' %}
        <form method="POST" action="{{ url_for('batch_retry_failed', batch_id=batch.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-warning">
                <i class="fas fa-redo"></i> Reprocessar Falhas
            </button>
        </form>
        {% endif %}
    </div>
    {% endif %}
    
    {% if batch.status == 'Conclu√≠do' and batch.sucesso > 0 %}
    <div class="success-alert">
        <div class="success-alert-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="success-alert-content">
            <strong>{{ batch.sucesso }} imagem(ns) processada(s) com sucesso!</strong>
            <p>As imagens est√£o dispon√≠veis no cat√°logo.</p>
        </div>
        <a href="{{ url_for('catalog') }}" class="btn btn-success">
            <i class="fas fa-images"></i> Ver Cat√°logo
        </a>
    </div>
    {% endif %}
    
    {% if batch.status == 'Processando' %}
    <div class="resume-section" style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <strong>Processamento parado?</strong>
            <p style="margin: 0; color: #888; font-size: 0.9rem;">Se o processamento parou inesperadamente, clique para retomar.</p>
        </div>
        <button id="btn-resume" class="btn btn-primary" onclick="resumeProcessing()">
            <i class="fas fa-play"></i> Retomar Processamento
        </button>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">
        <h3>Itens do Lote</h3>
        <div class="filter-tabs">
            <a href="{{ url_for('batch_detail', batch_id=batch.id) }}" 
               class="filter-tab {% if not status_filter %}active{% endif %}">Todos</a>
            <a href="{{ url_for('batch_detail', batch_id=batch.id, status='Pendente') }}" 
               class="filter-tab {% if status_filter == 'Pendente' %}active{% endif %}">Pendentes</a>
            <a href="{{ url_for('batch_detail', batch_id=batch.id, status='Processando') }}" 
               class="filter-tab {% if status_filter == 'Processando' %}active{% endif %}">Processando</a>
            <a href="{{ url_for('batch_detail', batch_id=batch.id, status='Sucesso') }}" 
               class="filter-tab {% if status_filter == 'Sucesso' %}active{% endif %}">Sucesso</a>
            <a href="{{ url_for('batch_detail', batch_id=batch.id, status='Erro') }}" 
               class="filter-tab {% if status_filter == 'Erro' %}active{% endif %}">Erros</a>
        </div>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>Arquivo Original</th>
                    <th>Status</th>
                    <th>Tentativas</th>
                    <th>Processado</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items.items %}
                <tr>
                    <td><strong>{{ item.sku }}</strong></td>
                    <td>{{ item.filename_original or '-' }}</td>
                    <td>
                        <span class="status-badge status-{{ item.status|lower }}">
                            {{ item.status }}
                        </span>
                        {% if item.erro_mensagem %}
                        <div class="error-msg" title="{{ item.erro_mensagem }}">
                            <i class="fas fa-exclamation-circle"></i>
                            {{ item.erro_mensagem[:50] }}{% if item.erro_mensagem|length > 50 %}...{% endif %}
                        </div>
                        {% endif %}
                    </td>
                    <td>{{ item.tentativas }}</td>
                    <td>{{ item.processed_at.strftime('%d/%m %H:%M') if item.processed_at else '-' }}</td>
                    <td>
                        {% if item.image_id %}
                        <a href="{{ url_for('image_detail', id=item.image_id) }}" class="btn btn-sm btn-primary">
                            Ver Imagem
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if items.pages > 1 %}
        <div class="pagination">
            {% if items.has_prev %}
            <a href="{{ url_for('batch_detail', batch_id=batch.id, page=items.prev_num, status=status_filter) }}" class="btn btn-sm btn-secondary">
                Anterior
            </a>
            {% endif %}
            
            <span class="page-info">P√°gina {{ items.page }} de {{ items.pages }}</span>
            
            {% if items.has_next %}
            <a href="{{ url_for('batch_detail', batch_id=batch.id, page=items.next_num, status=status_filter) }}" class="btn btn-sm btn-secondary">
                Pr√≥xima
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<style>
.batch-status-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid rgba(255,255,255,0.1);
}
.status-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}
.batch-id {
    color: var(--text-secondary);
    font-size: 1.2rem;
}
.progress-section {
    margin: 20px 0;
}
.progress-bar-large {
    height: 24px;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    border-radius: 12px;
    transition: width 0.5s ease;
}
.progress-info {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 1.1rem;
}
#progress-percent {
    font-weight: 700;
    color: var(--primary-color);
}
.stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-top: 30px;
}
.stat-box {
    background: rgba(255,255,255,0.05);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}
.stat-box.success { border-left: 4px solid #28a745; }
.stat-box.danger { border-left: 4px solid #dc3545; }
.stat-box.info { border-left: 4px solid #007bff; }
.stat-value {
    display: block;
    font-size: 2rem;
    font-weight: 700;
}
.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}
.filter-tabs {
    display: flex;
    gap: 10px;
}
.filter-tab {
    padding: 8px 16px;
    border-radius: 20px;
    background: rgba(255,255,255,0.05);
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.3s;
}
.filter-tab:hover, .filter-tab.active {
    background: var(--primary-color);
    color: white;
}
.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}
.status-pendente {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}
.status-processando {
    background: rgba(0, 123, 255, 0.2);
    color: #007bff;
}
.status-sucesso {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}
.status-erro {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}
.status-conclu√≠do {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}
.error-msg {
    font-size: 0.75rem;
    color: #dc3545;
    margin-top: 5px;
}
.pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}
.page-info {
    color: var(--text-secondary);
}
.actions {
    margin-top: 20px;
    text-align: center;
}
.status-indicator {
    display: flex;
    align-items: center;
    gap: 15px;
}
.pulse-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: currentColor;
    border-radius: 50%;
    margin-right: 6px;
    animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}
.processing-label {
    font-size: 0.9rem;
    color: #007bff;
    animation: blink 2s linear infinite;
}
@keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.5; }
}
.completed-label {
    font-size: 0.9rem;
    color: #28a745;
}
.receiving-label {
    font-size: 0.9rem;
    color: #17a2b8;
    animation: blink 2s linear infinite;
}
.status-recebendo {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
}
.last-update {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 10px;
    text-align: right;
}
.error-alert {
    display: flex;
    align-items: center;
    gap: 20px;
    background: rgba(220, 53, 69, 0.15);
    border: 1px solid rgba(220, 53, 69, 0.4);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}
.error-alert-icon {
    font-size: 2rem;
    color: #dc3545;
}
.error-alert-content {
    flex: 1;
}
.error-alert-content strong {
    color: #dc3545;
    font-size: 1.1rem;
}
.error-alert-content p {
    color: var(--text-secondary);
    margin: 5px 0 0;
    font-size: 0.9rem;
}
.success-alert {
    display: flex;
    align-items: center;
    gap: 20px;
    background: rgba(40, 167, 69, 0.15);
    border: 1px solid rgba(40, 167, 69, 0.4);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}
.success-alert-icon {
    font-size: 2rem;
    color: #28a745;
}
.success-alert-content {
    flex: 1;
}
.success-alert-content strong {
    color: #28a745;
    font-size: 1.1rem;
}
.success-alert-content p {
    color: var(--text-secondary);
    margin: 5px 0 0;
    font-size: 0.9rem;
}
</style>

<script>
function resumeProcessing() {
    const btn = document.getElementById('btn-resume');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Retomando...';
    
    fetch('{{ url_for("batch_resume", batch_id=batch.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erro: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play"></i> Retomar Processamento';
        } else {
            btn.innerHTML = '<i class="fas fa-check"></i> Retomado! (' + data.items_to_process + ' itens)';
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(err => {
        alert('Erro ao retomar: ' + err);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Retomar Processamento';
    });
}

(function() {
    let pollInterval = null;
    let lastStatus = '{{ batch.status }}';
    
    function updateStatus() {
        fetch('{{ url_for("batch_status", batch_id=batch.id) }}')
            .then(response => response.json())
            .then(data => {
                console.log('[POLL] Status:', data.status, 'Processados:', data.processados, '/', data.total);
                
                document.getElementById('progress-percent').textContent = data.progresso + '%';
                document.getElementById('progress-count').textContent = data.processados + ' / ' + data.total;
                document.querySelector('.progress-fill').style.width = data.progresso + '%';
                document.getElementById('stat-success').textContent = data.sucesso;
                document.getElementById('stat-failed').textContent = data.falhas;
                
                const statusBadge = document.querySelector('.status-badge');
                const processingLabel = document.querySelector('.processing-label');
                
                if (data.status !== lastStatus) {
                    lastStatus = data.status;
                    statusBadge.innerHTML = data.status;
                    statusBadge.className = 'status-badge status-' + data.status.toLowerCase().replace(' ', '-');
                    
                    if (data.status === 'Conclu√≠do') {
                        if (processingLabel) processingLabel.remove();
                        stopPolling();
                        location.reload();
                    } else if (data.status === 'Processando' && !processingLabel) {
                        statusBadge.innerHTML = '<span class="pulse-dot"></span>' + data.status;
                    }
                }
                
                let updateDiv = document.querySelector('.last-update');
                if (!updateDiv) {
                    updateDiv = document.createElement('div');
                    updateDiv.className = 'last-update';
                    document.querySelector('.progress-section').appendChild(updateDiv);
                }
                updateDiv.textContent = '√öltima atualiza√ß√£o: ' + new Date().toLocaleTimeString('pt-BR');
            })
            .catch(err => {
                console.error('[POLL] Erro:', err);
            });
    }
    
    function startPolling() {
        if (!pollInterval) {
            console.log('[POLL] Iniciando polling...');
            updateStatus();
            pollInterval = setInterval(updateStatus, 2000);
        }
    }
    
    function stopPolling() {
        if (pollInterval) {
            console.log('[POLL] Parando polling');
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }
    
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            console.log('[POLL] Tab oculta - pausando');
        } else {
            console.log('[POLL] Tab vis√≠vel - verificando status');
            if (lastStatus === 'Processando' || lastStatus === 'Recebendo') {
                updateStatus();
            }
        }
    });
    
    if (lastStatus === 'Processando' || lastStatus === 'Recebendo') {
        startPolling();
    } else {
        updateStatus();
    }
})();
</script>
{% endblock %}

================================================================================
FILE: templates/batch/index.html
================================================================================
{% extends "base.html" %}

{% block title %}Upload em Lote - OAZ Smart Image Bank{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Upload em Lote</h1>
    <div class="header-actions">
        <a href="{{ url_for('batch_queue') }}" class="btn btn-success"
            data-tutorial-title="Fila de M√∫ltiplos Batches"
            data-tutorial-desc="Crie e gerencie m√∫ltiplos lotes de upload de uma vez. Ideal para organizar uploads por cole√ß√£o ou sess√£o de fotos.">
            <i class="fas fa-layer-group"></i> Fila de M√∫ltiplos Batches
        </a>
        <a href="{{ url_for('batch_new') }}" class="btn btn-primary"
            data-tutorial-title="Criar Novo Lote"
            data-tutorial-desc="Inicia um novo lote de upload. Selecione cole√ß√£o, marca e arraste as imagens para fazer upload em massa.">
            <i class="fas fa-plus"></i> Novo Lote
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Lotes de Upload</h3>
    </div>
    <div class="card-body">
        {% if batches %}
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Status</th>
                    <th>Progresso</th>
                    <th>Total</th>
                    <th>Sucesso</th>
                    <th>Falhas</th>
                    <th>Data</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for batch in batches %}
                <tr>
                    <td>{{ batch.id }}</td>
                    <td>{{ batch.nome or 'Sem nome' }}</td>
                    <td>
                        <span class="status-badge status-{{ batch.status|lower|replace(' ', '-') }}">
                            {{ batch.status }}
                        </span>
                    </td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: {{ batch.progresso }}%"></div>
                            <span class="progress-text">{{ batch.progresso }}%</span>
                        </div>
                    </td>
                    <td>{{ batch.total_arquivos }}</td>
                    <td class="text-success">{{ batch.sucesso }}</td>
                    <td class="text-danger">{{ batch.falhas }}</td>
                    <td>{{ batch.created_at.strftime('%d/%m/%Y %H:%M') if batch.created_at else '-' }}</td>
                    <td class="actions-cell">
                        <a href="{{ url_for('batch_detail', batch_id=batch.id) }}" class="btn btn-sm btn-secondary" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% if batch.status in ['Recebendo', 'Pendente'] and batch.total_arquivos > 0 %}
                        <button class="btn btn-sm btn-success" onclick="startProcessing({{ batch.id }})" title="Iniciar processamento">
                            <i class="fas fa-play"></i>
                        </button>
                        {% elif batch.falhas > 0 %}
                        <button class="btn btn-sm btn-warning" onclick="reprocessBatch({{ batch.id }})" title="Reprocessar falhas">
                            <i class="fas fa-redo"></i>
                        </button>
                        {% endif %}
                        <button class="btn btn-sm btn-danger" onclick="deleteBatch({{ batch.id }}, '{{ batch.nome or 'Lote ' ~ batch.id }}')" title="Excluir lote">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>Nenhum lote de upload</h3>
            <p>Crie seu primeiro lote para fazer upload de m√∫ltiplas imagens de uma vez.</p>
            <a href="{{ url_for('batch_new') }}" class="btn btn-primary">Criar Lote</a>
        </div>
        {% endif %}
    </div>
</div>

<style>
.header-actions {
    display: flex;
    gap: 10px;
}
.btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}
.btn-success:hover {
    background: linear-gradient(135deg, #218838, #1eb389);
}
.progress-bar-container {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    height: 20px;
    position: relative;
    overflow: hidden;
    min-width: 100px;
}
.progress-bar {
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}
.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    font-weight: 600;
}
.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}
.status-pendente {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}
.status-processando {
    background: rgba(0, 123, 255, 0.2);
    color: #007bff;
}
.status-conclu√≠do {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}
.status-erro {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}
.text-success { color: #28a745; }
.text-danger { color: #dc3545; }
.actions-cell {
    display: flex;
    gap: 8px;
}
.btn-danger {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
}
.btn-danger:hover {
    background: rgba(220, 53, 69, 0.4);
}
.btn-warning {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
    border: 1px solid rgba(255, 193, 7, 0.3);
}
.btn-warning:hover {
    background: rgba(255, 193, 7, 0.4);
}
.btn-sm.btn-success {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
}
.btn-sm.btn-success:hover {
    background: rgba(40, 167, 69, 0.4);
}
.status-recebendo {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
}
</style>

<script>
async function deleteBatch(batchId, batchName) {
    if (!confirm(`Tem certeza que deseja excluir "${batchName}"?\n\nTodos os itens do lote ser√£o removidos permanentemente.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/batch/${batchId}/delete`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Erro ao excluir lote: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro ao excluir lote: ' + error.message);
    }
}

async function startProcessing(batchId) {
    if (!confirm('Iniciar processamento deste lote?\n\nAs imagens ser√£o analisadas e vinculadas aos SKUs da Carteira.')) {
        return;
    }
    
    try {
        const response = await fetch(`/batch/${batchId}/start-processing`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Processamento iniciado com sucesso!');
            window.location.href = `/batch/${batchId}`;
        } else {
            alert('Erro ao iniciar processamento: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro ao iniciar processamento: ' + error.message);
    }
}

async function reprocessBatch(batchId) {
    if (!confirm('Reprocessar itens com falha?\n\nNota: Arquivos que foram perdidos (caminho legado) precisam ser re-enviados.')) {
        return;
    }
    
    try {
        const response = await fetch(`/batch/${batchId}/reprocess`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`Reprocessamento iniciado!\n\n${data.message || 'Verifique os detalhes do lote.'}`);
            window.location.href = `/batch/${batchId}`;
        } else {
            alert('Erro ao reprocessar: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro ao reprocessar: ' + error.message);
    }
}
</script>
{% endblock %}

================================================================================
FILE: templates/batch/new.html
================================================================================
{% extends "base.html" %}

{% block title %}Novo Upload em Lote - OAZ Smart Image Bank{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Novo Upload em Lote</h1>
    <a href="{{ url_for('batch_list') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>
</div>

<div class="card">
    <div class="card-header">
        <h3>Configurar Lote</h3>
    </div>
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data" id="batch-form">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="batch_name">Nome do Lote</label>
                    <input type="text" class="form-control" id="batch_name" name="batch_name" 
                           placeholder="Ex: Cole√ß√£o Ver√£o 2025">
                </div>
                <div class="form-group col-md-3">
                    <label for="collection_id">Cole√ß√£o</label>
                    <select class="form-control" id="collection_id" name="collection_id">
                        <option value="">Selecione...</option>
                        {% for c in collections %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <label for="brand_id">Marca</label>
                    <select class="form-control" id="brand_id" name="brand_id">
                        <option value="">Selecione...</option>
                        {% for b in brands %}
                        <option value="{{ b.id }}">{{ b.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="upload-tabs">
                <button type="button" class="tab-btn active" data-tab="files">
                    <i class="fas fa-images"></i> M√∫ltiplos Arquivos
                </button>
                <button type="button" class="tab-btn" data-tab="zip">
                    <i class="fas fa-file-archive"></i> Arquivo ZIP (at√© 3GB)
                </button>
            </div>
            
            <div class="tab-content" id="files-tab">
                <div class="upload-zone" id="drop-zone">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Arraste as imagens aqui</h3>
                    <p>ou clique para selecionar</p>
                    <input type="file" id="files" name="files" multiple 
                           accept=".jpg,.jpeg,.png,.gif,.webp" class="file-input">
                    <small>Formatos: JPG, PNG, GIF, WebP | O nome do arquivo ser√° usado como SKU</small>
                </div>
                <div id="file-list" class="file-list"></div>
            </div>
            
            <div class="tab-content hidden" id="zip-tab">
                <div class="upload-zone" id="drop-zone-zip">
                    <i class="fas fa-file-archive"></i>
                    <h3>Arraste o arquivo ZIP aqui</h3>
                    <p>ou clique para selecionar</p>
                    <input type="file" id="zip_file" name="zip_file" 
                           accept=".zip" class="file-input">
                    <small>Suporta arquivos de at√© 3GB - Upload em partes autom√°tico</small>
                </div>
                <div id="zip-info" class="zip-info"></div>
            </div>
            
            <!-- Progress Container (hidden by default) -->
            <div id="upload-progress" class="upload-progress hidden">
                <div class="progress-header">
                    <span id="progress-status">Preparando upload...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="progress-details">
                    <span id="progress-details-text">Iniciando...</span>
                </div>
                <div class="progress-actions" style="margin-top: 15px; text-align: center;">
                    <button type="button" class="btn btn-danger" id="cancel-btn">
                        <i class="fas fa-times"></i> Cancelar Upload
                    </button>
                </div>
            </div>
            
            <div class="info-box">
                <h4><i class="fas fa-info-circle"></i> Como funciona</h4>
                <ul>
                    <li><strong>SKU = Nome do Arquivo:</strong> O nome de cada arquivo (sem extens√£o) ser√° usado como c√≥digo SKU do produto</li>
                    <li><strong>Upload Robusto:</strong> Arquivos grandes s√£o enviados em partes (at√© 3GB suportados)</li>
                    <li><strong>Processamento Paralelo:</strong> 5 imagens s√£o processadas simultaneamente</li>
                    <li><strong>An√°lise de IA:</strong> Cada imagem recebe descri√ß√£o detalhada autom√°tica via OpenAI</li>
                </ul>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                    <i class="fas fa-rocket"></i> Iniciar Upload
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.upload-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
.tab-btn {
    padding: 12px 24px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s;
}
.tab-btn:hover, .tab-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}
.tab-content.hidden {
    display: none;
}
.upload-zone {
    border: 2px dashed rgba(255,255,255,0.2);
    border-radius: 12px;
    padding: 60px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}
.upload-zone:hover, .upload-zone.dragover {
    border-color: var(--primary-color);
    background: rgba(255,107,53,0.1);
}
.upload-zone i {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 15px;
}
.upload-zone h3 {
    margin-bottom: 10px;
}
.file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}
.file-list {
    margin-top: 20px;
    max-height: 300px;
    overflow-y: auto;
}
.file-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    margin-bottom: 8px;
}
.file-item .file-name {
    flex: 1;
    margin-left: 10px;
}
.file-item .file-sku {
    color: var(--primary-color);
    font-weight: 600;
}
.file-item .file-size {
    color: var(--text-secondary);
    font-size: 0.85rem;
}
.info-box {
    background: rgba(0, 123, 255, 0.1);
    border: 1px solid rgba(0, 123, 255, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin: 30px 0;
}
.info-box h4 {
    color: #007bff;
    margin-bottom: 15px;
}
.info-box ul {
    margin: 0;
    padding-left: 20px;
}
.info-box li {
    margin-bottom: 8px;
}
.form-actions {
    text-align: center;
    margin-top: 30px;
}
.btn-lg {
    padding: 15px 40px;
    font-size: 1.1rem;
}
.zip-info {
    margin-top: 20px;
    padding: 15px;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 8px;
    display: none;
}
.zip-info.visible {
    display: block;
}
.upload-progress {
    margin: 30px 0;
    padding: 25px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
}
.upload-progress.hidden {
    display: none;
}
.progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    font-size: 1.1rem;
}
.progress-bar-container {
    height: 24px;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), #ff9f43);
    border-radius: 12px;
    width: 0%;
    transition: width 0.3s ease;
}
.progress-details {
    margin-top: 10px;
    color: var(--text-secondary);
    font-size: 0.9rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const filesInput = document.getElementById('files');
    const zipInput = document.getElementById('zip_file');
    const fileList = document.getElementById('file-list');
    const zipInfo = document.getElementById('zip-info');
    const dropZone = document.getElementById('drop-zone');
    const dropZoneZip = document.getElementById('drop-zone-zip');
    const batchForm = document.getElementById('batch-form');
    const submitBtn = document.getElementById('submit-btn');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressStatus = document.getElementById('progress-status');
    const progressPercent = document.getElementById('progress-percent');
    const progressDetails = document.getElementById('progress-details-text');
    
    const CHUNK_SIZE = 5 * 1024 * 1024;  // 5MB por chunk
    const cancelBtn = document.getElementById('cancel-btn');
    let uploadCancelled = false;
    let currentBatchId = null;
    
    // Cancel button handler
    if (cancelBtn) {
        cancelBtn.addEventListener('click', async function() {
            uploadCancelled = true;
            progressStatus.textContent = 'Cancelando...';
            progressBar.style.background = '#dc3545';
            
            if (currentBatchId) {
                try {
                    await fetch(`/batch/${currentBatchId}/delete`, { method: 'DELETE' });
                } catch (e) {
                    console.error('Erro ao deletar batch:', e);
                }
            }
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        });
    }
    
    // Tab switching
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const tab = this.dataset.tab;
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tab + '-tab').classList.remove('hidden');
            
            if (tab === 'zip') {
                filesInput.value = '';
                fileList.innerHTML = '';
            } else {
                zipInput.value = '';
                zipInfo.classList.remove('visible');
                zipInfo.innerHTML = '';
            }
        });
    });
    
    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }
    
    function updateFileList(files) {
        fileList.innerHTML = '';
        if (!files || files.length === 0) return;
        
        let html = `<div class="file-count">${files.length} arquivo(s) selecionado(s)</div>`;
        
        Array.from(files).slice(0, 50).forEach(file => {
            const sku = file.name.replace(/\.[^/.]+$/, '');
            html += `
                <div class="file-item">
                    <i class="fas fa-image"></i>
                    <div class="file-name">
                        <div class="file-sku">SKU: ${sku}</div>
                        <div class="file-size">${file.name} (${formatSize(file.size)})</div>
                    </div>
                </div>
            `;
        });
        
        if (files.length > 50) {
            html += `<div class="file-item" style="justify-content: center; color: var(--text-secondary);">
                ... e mais ${files.length - 50} arquivos
            </div>`;
        }
        
        fileList.innerHTML = html;
    }
    
    function updateZipInfo(files) {
        if (!files || files.length === 0) {
            zipInfo.classList.remove('visible');
            zipInfo.innerHTML = '';
            return;
        }
        
        const file = files[0];
        zipInfo.innerHTML = `
            <i class="fas fa-check-circle" style="color: #28a745; margin-right: 10px;"></i>
            <strong>${file.name}</strong> (${formatSize(file.size)})
            <br><small style="margin-top: 5px; display: block;">Upload em partes - suporta arquivos grandes</small>
        `;
        zipInfo.style.display = 'block';
        zipInfo.classList.add('visible');
    }
    
    // File input change events
    if (filesInput) {
        filesInput.addEventListener('change', function(e) {
            console.log('Files selected:', this.files.length);
            updateFileList(this.files);
        });
    }
    
    if (zipInput) {
        zipInput.addEventListener('change', function(e) {
            console.log('ZIP file selected:', this.files.length, this.files[0]?.name);
            updateZipInfo(this.files);
        });
    }
    
    // Click handlers for drop zones
    if (dropZoneZip) {
        dropZoneZip.addEventListener('click', function(e) {
            if (e.target !== zipInput) {
                zipInput.click();
            }
        });
    }
    
    if (dropZone) {
        dropZone.addEventListener('click', function(e) {
            if (e.target !== filesInput) {
                filesInput.click();
            }
        });
    }
    
    // Drag and drop handlers
    [dropZone, dropZoneZip].forEach(zone => {
        if (!zone) return;
        
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('dragover');
        });
        
        zone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');
        });
        
        zone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (zone === dropZoneZip && files.length > 0) {
                const dt = new DataTransfer();
                dt.items.add(files[0]);
                zipInput.files = dt.files;
                updateZipInfo(zipInput.files);
            } else if (zone === dropZone && files.length > 0) {
                const dt = new DataTransfer();
                Array.from(files).forEach(f => dt.items.add(f));
                filesInput.files = dt.files;
                updateFileList(filesInput.files);
            }
        });
    });
    
    // Upload single file with retry and exponential backoff
    async function uploadSingleFile(file, batchId, maxRetries = 5) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                if (uploadCancelled) {
                    return { success: false, filename: file.name, cancelled: true };
                }
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('batch_id', batchId);
                
                const response = await fetch('/batch/upload-file', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    return { success: true, filename: file.name };
                }
                
                // Server error, retry with backoff
                if (attempt < maxRetries) {
                    const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000); // Max 10s
                    console.log(`Retry ${attempt}/${maxRetries} for ${file.name} after ${delay}ms`);
                    await new Promise(r => setTimeout(r, delay));
                }
            } catch (err) {
                console.log(`Error uploading ${file.name}: ${err.message}`);
                if (attempt < maxRetries) {
                    const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }
        console.error(`Failed to upload ${file.name} after ${maxRetries} attempts`);
        return { success: false, filename: file.name };
    }
    
    // Upload multiple files function with retry
    async function uploadMultipleFiles(files, collectionId, brandId, batchName) {
        const totalFiles = files.length;
        const BATCH_SIZE = 5; // Keep at 5 to avoid server overload
        const MAX_RETRIES = 5; // More retries for large batches
        
        progressStatus.textContent = 'Criando lote...';
        progressDetails.textContent = `Preparando ${totalFiles} arquivos...`;
        
        // 1. Create batch first (total will be updated after all uploads)
        const createBatchResponse = await fetch('/batch/create-async', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                batch_name: batchName,
                collection_id: collectionId,
                brand_id: brandId,
                total_files: 0  // Will be updated based on actual uploads
            })
        });
        
        if (!createBatchResponse.ok) {
            const errorData = await createBatchResponse.json();
            throw new Error(errorData.error || 'Falha ao criar lote');
        }
        
        const batchData = await createBatchResponse.json();
        const batchId = batchData.batch_id;
        currentBatchId = batchId;
        
        if (uploadCancelled) {
            throw new Error('Upload cancelado pelo usu√°rio');
        }
        
        // 2. Upload files in smaller batches with retry
        progressStatus.textContent = 'Enviando arquivos...';
        let uploaded = 0;
        let processed = 0;
        let failedFiles = [];
        
        const fileArray = Array.from(files);
        
        for (let i = 0; i < totalFiles; i += BATCH_SIZE) {
            if (uploadCancelled) {
                throw new Error('Upload cancelado pelo usu√°rio');
            }
            
            const batchFiles = fileArray.slice(i, Math.min(i + BATCH_SIZE, totalFiles));
            
            const uploadPromises = batchFiles.map(file => uploadSingleFile(file, batchId, MAX_RETRIES));
            const results = await Promise.all(uploadPromises);
            
            for (const result of results) {
                processed++;
                if (result.success) {
                    uploaded++;
                } else {
                    failedFiles.push(result.filename);
                }
            }
            
            const percent = (processed / totalFiles * 100).toFixed(1);
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            progressDetails.textContent = `${uploaded} de ${totalFiles} enviados com sucesso (${failedFiles.length} falhas)`;
        }
        
        // 3. Update batch total to reflect actual uploads
        await fetch(`/batch/${batchId}/sync-total`, { method: 'POST' });
        
        // 4. Start processing
        progressStatus.textContent = 'Iniciando processamento...';
        
        const processResponse = await fetch(`/batch/${batchId}/start-processing`, {
            method: 'POST'
        });
        
        if (failedFiles.length > 0) {
            console.warn('Arquivos que falharam:', failedFiles);
        }
        
        return {
            batch_id: batchId,
            total_files: uploaded,
            errors: failedFiles.length,
            failed_files: failedFiles.slice(0, 10),
            redirect: `/batch/${batchId}`
        };
    }
    
    // Chunked upload function
    async function uploadFileChunked(file, collectionId, brandId, batchName) {
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        
        // 1. Initialize upload
        progressStatus.textContent = 'Iniciando upload...';
        progressDetails.textContent = `Arquivo: ${file.name} (${formatSize(file.size)})`;
        
        const initResponse = await fetch('/upload/init', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                filename: file.name,
                file_size: file.size,
                chunk_size: CHUNK_SIZE
            })
        });
        
        if (!initResponse.ok) {
            throw new Error('Falha ao iniciar upload');
        }
        
        const initData = await initResponse.json();
        const uploadId = initData.upload_id;
        
        // 2. Upload chunks
        progressStatus.textContent = 'Enviando arquivo...';
        
        for (let i = 0; i < totalChunks; i++) {
            const start = i * CHUNK_SIZE;
            const end = Math.min(start + CHUNK_SIZE, file.size);
            const chunk = file.slice(start, end);
            
            const formData = new FormData();
            formData.append('upload_id', uploadId);
            formData.append('chunk_index', i);
            formData.append('chunk', chunk);
            
            const chunkResponse = await fetch('/upload/chunk', {
                method: 'POST',
                body: formData
            });
            
            if (!chunkResponse.ok) {
                throw new Error(`Falha ao enviar parte ${i + 1}`);
            }
            
            const chunkData = await chunkResponse.json();
            const percent = chunkData.progress;
            
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent.toFixed(1) + '%';
            progressDetails.textContent = `Parte ${i + 1} de ${totalChunks} - ${formatSize(end)} de ${formatSize(file.size)}`;
        }
        
        // 3. Complete upload and process
        progressStatus.textContent = 'Processando arquivo ZIP...';
        progressDetails.textContent = 'Extraindo imagens e criando lote...';
        
        const completeResponse = await fetch('/upload/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                upload_id: uploadId,
                collection_id: collectionId,
                brand_id: brandId,
                batch_name: batchName
            })
        });
        
        const completeData = await completeResponse.json();
        
        if (!completeResponse.ok) {
            throw new Error(completeData.error || 'Falha ao processar arquivo');
        }
        
        return completeData;
    }
    
    // Form submission
    if (batchForm) {
        batchForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const collectionId = document.getElementById('collection_id').value;
            const brandId = document.getElementById('brand_id').value;
            const batchName = document.getElementById('batch_name').value || 
                              `Lote ${new Date().toLocaleString('pt-BR')}`;
            
            // Check if ZIP file is selected (use chunked upload)
            if (zipInput && zipInput.files.length > 0) {
                const zipFile = zipInput.files[0];
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                uploadProgress.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';
                
                try {
                    const result = await uploadFileChunked(zipFile, collectionId, brandId, batchName);
                    
                    progressBar.style.width = '100%';
                    progressPercent.textContent = '100%';
                    progressStatus.textContent = 'Upload conclu√≠do!';
                    progressDetails.textContent = `${result.total_files} imagens encontradas. Redirecionando...`;
                    
                    setTimeout(() => {
                        window.location.href = result.redirect;
                    }, 1500);
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    progressStatus.textContent = 'Erro no upload!';
                    progressDetails.textContent = error.message;
                    progressBar.style.background = '#dc3545';
                    
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-rocket"></i> Tentar Novamente';
                }
                
                return;
            }
            
            // Async upload for multiple files
            if (filesInput && filesInput.files.length > 0) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                uploadProgress.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';
                
                try {
                    const result = await uploadMultipleFiles(filesInput.files, collectionId, brandId, batchName);
                    
                    progressBar.style.width = '100%';
                    progressPercent.textContent = '100%';
                    progressStatus.textContent = 'Upload conclu√≠do!';
                    progressDetails.textContent = `${result.total_files} imagens enviadas. Redirecionando...`;
                    
                    setTimeout(() => {
                        window.location.href = result.redirect;
                    }, 1500);
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    progressStatus.textContent = 'Erro no upload!';
                    progressDetails.textContent = error.message;
                    progressBar.style.background = '#dc3545';
                    
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-rocket"></i> Tentar Novamente';
                }
                
                return;
            }
            
            alert('Selecione arquivos ou um arquivo ZIP para fazer upload.');
        });
    }
});
</script>
{% endblock %}

================================================================================
FILE: templates/batch/queue.html
================================================================================
{% extends "base.html" %}

{% block title %}Fila de Uploads - OAZ Smart Image Bank{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Fila de Uploads</h1>
    <div class="header-actions">
        <a href="{{ url_for('batch_list') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<div class="queue-container">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-plus-circle"></i> Adicionar Batches √† Fila</h3>
        </div>
        <div class="card-body">
            <div id="batch-forms">
                <div class="batch-form-item" data-index="0">
                    <div class="batch-form-header">
                        <span class="batch-number">Batch #1</span>
                        <button type="button" class="btn btn-sm btn-danger remove-batch" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>Nome do Batch</label>
                            <input type="text" class="form-control batch-name" placeholder="Ex: Cole√ß√£o Ver√£o 25-26">
                        </div>
                        <div class="form-group col-md-3">
                            <label>Cole√ß√£o</label>
                            <select class="form-control batch-collection">
                                <option value="">Selecione...</option>
                                {% for c in collections %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <label>Marca</label>
                            <select class="form-control batch-brand">
                                <option value="">Selecione...</option>
                                {% for b in brands %}
                                <option value="{{ b.id }}">{{ b.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-2">
                            <label>Arquivos</label>
                            <div class="file-select-btn">
                                <input type="file" class="batch-files" multiple accept=".jpg,.jpeg,.png,.gif,.webp">
                                <span class="file-count">0 arquivos</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="add-batch-section">
                <button type="button" class="btn btn-outline-primary" id="add-batch-btn">
                    <i class="fas fa-plus"></i> Adicionar Outro Batch
                </button>
            </div>
            
            <div class="queue-summary" id="queue-summary" style="display: none;">
                <div class="summary-stats">
                    <div class="stat">
                        <span class="stat-value" id="total-batches">0</span>
                        <span class="stat-label">Batches</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="total-files">0</span>
                        <span class="stat-label">Arquivos</span>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-primary btn-lg" id="start-queue-btn" disabled>
                    <i class="fas fa-cloud-upload-alt"></i> Iniciar Upload da Fila
                </button>
            </div>
        </div>
    </div>
    
    <div id="upload-progress-section" class="card" style="display: none;">
        <div class="card-header">
            <h3><i class="fas fa-tasks"></i> Progresso da Fila</h3>
        </div>
        <div class="card-body">
            <div id="queue-progress-list"></div>
            
            <div class="overall-progress">
                <div class="progress-header">
                    <span>Progresso Geral</span>
                    <span id="overall-percent">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="overall-progress-bar"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="processing-section" class="card" style="display: none;">
        <div class="card-header">
            <h3><i class="fas fa-cogs"></i> Processamento</h3>
        </div>
        <div class="card-body">
            <div class="processing-info">
                <p>Todos os uploads foram conclu√≠dos! Agora voc√™ pode processar todos os batches de uma vez.</p>
                <p>O processamento far√° o match das imagens com a Carteira de Compras.</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-success btn-lg" id="process-all-btn">
                    <i class="fas fa-play"></i> Processar Todos os Batches
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.queue-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.batch-form-item {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
}
.batch-form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.batch-number {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 1.1rem;
}
.form-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}
.form-group {
    flex: 1;
    min-width: 150px;
}
.form-group label {
    display: block;
    margin-bottom: 5px;
    font-size: 0.9rem;
    color: var(--text-secondary);
}
.file-select-btn {
    position: relative;
    overflow: hidden;
}
.file-select-btn input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}
.file-count {
    display: block;
    padding: 10px 15px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
}
.file-count:hover {
    background: rgba(255,255,255,0.1);
}
.add-batch-section {
    text-align: center;
    margin: 20px 0;
}
.btn-outline-primary {
    background: transparent;
    border: 2px dashed var(--primary-color);
    color: var(--primary-color);
}
.btn-outline-primary:hover {
    background: rgba(255,107,53,0.1);
}
.queue-summary {
    background: rgba(255,107,53,0.1);
    border: 1px solid rgba(255,107,53,0.3);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
}
.summary-stats {
    display: flex;
    justify-content: center;
    gap: 60px;
}
.stat {
    text-align: center;
}
.stat-value {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}
.stat-label {
    color: var(--text-secondary);
}
.form-actions {
    text-align: center;
    margin-top: 30px;
}
.btn-lg {
    padding: 15px 40px;
    font-size: 1.1rem;
}
#queue-progress-list {
    margin-bottom: 30px;
}
.queue-item-progress {
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}
.queue-item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}
.queue-item-name {
    font-weight: 600;
}
.queue-item-status {
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
}
.status-waiting {
    background: rgba(108,117,125,0.2);
    color: #6c757d;
}
.status-uploading {
    background: rgba(0,123,255,0.2);
    color: #007bff;
}
.status-uploaded {
    background: rgba(40,167,69,0.2);
    color: #28a745;
}
.status-processing {
    background: rgba(255,193,7,0.2);
    color: #ffc107;
}
.queue-item-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}
.btn-process {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s ease;
}
.btn-process:hover {
    background: linear-gradient(135deg, #218838, #1eb389);
    transform: scale(1.05);
}
.btn-process:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.btn-process.processing {
    background: linear-gradient(135deg, #ffc107, #ff9800);
}
.overall-progress {
    margin-top: 20px;
}
.progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}
.progress-bar-container {
    height: 24px;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), #ff9f43);
    border-radius: 12px;
    width: 0%;
    transition: width 0.3s ease;
}
.processing-info {
    text-align: center;
    padding: 20px;
    color: var(--text-secondary);
}
.processing-info p {
    margin: 10px 0;
}
.col-md-2 { flex: 0 0 16.66%; max-width: 16.66%; }
.col-md-3 { flex: 0 0 25%; max-width: 25%; }
.col-md-4 { flex: 0 0 33.33%; max-width: 33.33%; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const batchForms = document.getElementById('batch-forms');
    const addBatchBtn = document.getElementById('add-batch-btn');
    const startQueueBtn = document.getElementById('start-queue-btn');
    const queueSummary = document.getElementById('queue-summary');
    const uploadProgressSection = document.getElementById('upload-progress-section');
    const processingSection = document.getElementById('processing-section');
    const processAllBtn = document.getElementById('process-all-btn');
    
    let batchIndex = 1;
    let uploadedBatchIds = [];
    
    // Fun√ß√£o global para processar batch individual
    window.processSingleBatch = async function(index) {
        const btn = document.getElementById(`process-btn-${index}`);
        const batchId = btn.dataset.batchId;
        
        if (!batchId) {
            alert('Erro: ID do batch n√£o encontrado');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
        btn.classList.add('processing');
        
        document.getElementById(`status-${index}`).textContent = 'Processando...';
        document.getElementById(`status-${index}`).className = 'queue-item-status status-processing';
        
        try {
            const response = await fetch(`/batch/${batchId}/start-processing`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                btn.innerHTML = '<i class="fas fa-check"></i> Iniciado';
                btn.style.background = 'linear-gradient(135deg, #28a745, #28a745)';
                document.getElementById(`status-${index}`).textContent = 'Em Processamento';
            } else {
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro';
                btn.disabled = false;
                alert('Erro: ' + (data.error || 'Falha ao iniciar processamento'));
            }
        } catch (err) {
            btn.innerHTML = '<i class="fas fa-redo"></i> Tentar Novamente';
            btn.disabled = false;
            btn.classList.remove('processing');
            alert('Erro: ' + err.message);
        }
    };
    
    // Sistema de Logging para Frontend (envia para console do servidor)
    const OAZLog = {
        async send(level, action, message, extras = {}) {
            try {
                await fetch('/api/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ module: 'FRONTEND', level, action, message, extras })
                });
            } catch (e) { console.error('Log error:', e); }
        },
        info: (action, message, extras) => OAZLog.send('INFO', action, message, extras),
        debug: (action, message, extras) => OAZLog.send('DEBUG', action, message, extras),
        warn: (action, message, extras) => OAZLog.send('WARN', action, message, extras),
        error: (action, message, extras) => OAZLog.send('ERROR', action, message, extras),
        success: (action, message, extras) => OAZLog.send('SUCCESS', action, message, extras)
    };
    
    OAZLog.info('PAGE_LOAD', 'P√°gina Fila de Batches carregada');
    
    const collectionsData = [
        {% for c in collections %}
        { id: {{ c.id }}, name: "{{ c.name }}" },
        {% endfor %}
    ];
    
    const brandsData = [
        {% for b in brands %}
        { id: {{ b.id }}, name: "{{ b.name }}" },
        {% endfor %}
    ];
    
    function updateSummary() {
        const forms = batchForms.querySelectorAll('.batch-form-item');
        let totalBatches = 0;
        let totalFiles = 0;
        
        forms.forEach(form => {
            const filesInput = form.querySelector('.batch-files');
            if (filesInput.files.length > 0) {
                totalBatches++;
                totalFiles += filesInput.files.length;
            }
        });
        
        document.getElementById('total-batches').textContent = totalBatches;
        document.getElementById('total-files').textContent = totalFiles;
        
        if (totalBatches > 0) {
            queueSummary.style.display = 'block';
            startQueueBtn.disabled = false;
        } else {
            queueSummary.style.display = 'none';
            startQueueBtn.disabled = true;
        }
        
        forms.forEach((form, idx) => {
            const removeBtn = form.querySelector('.remove-batch');
            if (forms.length > 1) {
                removeBtn.style.display = 'block';
            } else {
                removeBtn.style.display = 'none';
            }
        });
    }
    
    function createBatchForm(index) {
        const template = batchForms.querySelector('.batch-form-item').cloneNode(true);
        template.dataset.index = index;
        template.querySelector('.batch-number').textContent = `Batch #${index + 1}`;
        template.querySelector('.batch-name').value = '';
        template.querySelector('.batch-collection').selectedIndex = 0;
        template.querySelector('.batch-brand').selectedIndex = 0;
        template.querySelector('.file-count').textContent = '0 arquivos';
        
        const newFileInput = document.createElement('input');
        newFileInput.type = 'file';
        newFileInput.className = 'batch-files';
        newFileInput.multiple = true;
        newFileInput.accept = '.jpg,.jpeg,.png,.gif,.webp';
        
        const oldFileInput = template.querySelector('.batch-files');
        oldFileInput.parentNode.replaceChild(newFileInput, oldFileInput);
        
        newFileInput.addEventListener('change', function() {
            const count = this.files.length;
            this.parentNode.querySelector('.file-count').textContent = count + ' arquivos';
            
            // Calcular tamanho total
            let totalSize = 0;
            for (let i = 0; i < this.files.length; i++) {
                totalSize += this.files[i].size;
            }
            OAZLog.info('FILES_SELECTED', `Arquivos selecionados no Batch #${parseInt(template.dataset.index) + 1}`, { arquivos: count, tamanho_total_mb: (totalSize / 1024 / 1024).toFixed(2) });
            updateSummary();
        });
        
        template.querySelector('.remove-batch').addEventListener('click', function() {
            template.remove();
            renumberBatches();
            updateSummary();
        });
        
        return template;
    }
    
    function renumberBatches() {
        const forms = batchForms.querySelectorAll('.batch-form-item');
        forms.forEach((form, idx) => {
            form.dataset.index = idx;
            form.querySelector('.batch-number').textContent = `Batch #${idx + 1}`;
        });
        batchIndex = forms.length;
    }
    
    batchForms.querySelector('.batch-files').addEventListener('change', function() {
        const count = this.files.length;
        this.parentNode.querySelector('.file-count').textContent = count + ' arquivos';
        
        // Calcular tamanho total dos arquivos
        let totalSize = 0;
        for (let i = 0; i < this.files.length; i++) {
            totalSize += this.files[i].size;
        }
        OAZLog.info('FILES_SELECTED', `Arquivos selecionados no Batch #1`, { arquivos: count, tamanho_total_mb: (totalSize / 1024 / 1024).toFixed(2) });
        updateSummary();
    });
    
    batchForms.querySelector('.remove-batch').addEventListener('click', function() {
        const form = this.closest('.batch-form-item');
        if (batchForms.querySelectorAll('.batch-form-item').length > 1) {
            const batchNum = form.querySelector('.batch-number').textContent;
            OAZLog.info('BATCH_REMOVED', `${batchNum} removido da fila`);
            form.remove();
            renumberBatches();
            updateSummary();
        }
    });
    
    addBatchBtn.addEventListener('click', function() {
        const newForm = createBatchForm(batchIndex);
        batchForms.appendChild(newForm);
        batchIndex++;
        OAZLog.info('BATCH_ADDED', `Batch #${batchIndex} adicionado √† fila`);
        updateSummary();
    });
    
    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }
    
    async function uploadSingleFile(file, batchId, fileIndex, totalFiles, maxRetries = 8) {
        const TIMEOUT_MS = 120000; // 2 minutos por arquivo
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('batch_id', batchId);
                
                const response = await fetch('/batch/upload-file', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    return { success: true, filename: file.name };
                }
                
                const errorText = await response.text().catch(() => 'Unknown');
                console.warn(`[UPLOAD] HTTP ${response.status} para ${file.name}: ${errorText}`);
                
                if (attempt < maxRetries) {
                    OAZLog.warn('UPLOAD_RETRY', `Retry ${attempt}/${maxRetries} para ${file.name} (HTTP ${response.status})`, { batch_id: batchId });
                    const delay = Math.min(2000 * attempt, 15000);
                    await new Promise(r => setTimeout(r, delay));
                }
            } catch (err) {
                clearTimeout(timeoutId);
                
                const isTimeout = err.name === 'AbortError';
                const errMsg = isTimeout ? 'TIMEOUT' : err.message;
                
                console.warn(`[UPLOAD] Erro tentativa ${attempt}/${maxRetries} para ${file.name}: ${errMsg}`);
                
                if (attempt < maxRetries) {
                    OAZLog.warn('UPLOAD_RETRY', `Retry ${attempt}/${maxRetries} para ${file.name} (${errMsg})`, { batch_id: batchId, timeout: isTimeout });
                    const delay = isTimeout ? 5000 : Math.min(2000 * attempt, 15000);
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }
        OAZLog.error('UPLOAD_FAILED', `Falha definitiva ap√≥s ${maxRetries} tentativas: ${file.name}`, { batch_id: batchId });
        return { success: false, filename: file.name };
    }
    
    async function uploadBatchFiles(batchData, progressCallback, batchIndex) {
        OAZLog.info('BATCH_CREATE_START', `Criando batch: ${batchData.name}`, { colecao_id: batchData.collectionId, marca_id: batchData.brandId });
        
        const createResponse = await fetch('/batch/create-async', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                batch_name: batchData.name,
                collection_id: batchData.collectionId,
                brand_id: batchData.brandId,
                total_files: 0,
                auto_process: false
            })
        });
        
        if (!createResponse.ok) {
            OAZLog.error('BATCH_CREATE_ERROR', `Falha ao criar batch: ${batchData.name}`);
            throw new Error('Falha ao criar batch');
        }
        
        const createData = await createResponse.json();
        const batchId = createData.batch_id;
        
        const files = Array.from(batchData.files);
        const totalFiles = files.length;
        const BATCH_SIZE = 5; // Upload de 5 imagens por vez
        let uploaded = 0;
        let failed = 0;
        
        OAZLog.info('UPLOAD_BATCH_START', `========== INICIANDO UPLOAD BATCH #${batchId} ==========`, { nome: batchData.name, total_arquivos: totalFiles, workers_paralelos: BATCH_SIZE });
        const uploadStartTime = Date.now();
        
        for (let i = 0; i < totalFiles; i += BATCH_SIZE) {
            const batchFiles = files.slice(i, Math.min(i + BATCH_SIZE, totalFiles));
            const startIndex = i;
            const uploadPromises = batchFiles.map((file, idx) => uploadSingleFile(file, batchId, startIndex + idx + 1, totalFiles));
            const results = await Promise.all(uploadPromises);
            
            for (const result of results) {
                if (result.success) {
                    uploaded++;
                } else {
                    failed++;
                }
            }
            
            // Log de progresso a cada 20 arquivos ou no final
            if (uploaded % 20 === 0 || uploaded + failed === totalFiles) {
                const elapsed = (Date.now() - uploadStartTime) / 1000;
                const rate = uploaded / elapsed;
                const remaining = totalFiles - uploaded - failed;
                const eta = rate > 0 ? remaining / rate : 0;
                OAZLog.info('UPLOAD_PROGRESS', `Progresso: ${uploaded}/${totalFiles} (${failed} falhas) - ${rate.toFixed(1)} arq/s - ETA: ${eta.toFixed(0)}s`, { batch_id: batchId });
            }
            
            progressCallback(uploaded, totalFiles);
        }
        
        const totalElapsed = (Date.now() - uploadStartTime) / 1000;
        OAZLog.success('UPLOAD_BATCH_END', `========== UPLOAD BATCH #${batchId} CONCLU√çDO ==========`, { sucessos: uploaded, falhas: failed, tempo_segundos: totalElapsed.toFixed(1), taxa_media: (uploaded / totalElapsed).toFixed(1) });
        
        await fetch(`/batch/${batchId}/sync-total`, { method: 'POST' });
        
        return { batchId, uploaded, total: totalFiles, failed };
    }
    
    startQueueBtn.addEventListener('click', async function() {
        const forms = batchForms.querySelectorAll('.batch-form-item');
        const batches = [];
        
        forms.forEach(form => {
            const filesInput = form.querySelector('.batch-files');
            if (filesInput.files.length > 0) {
                batches.push({
                    name: form.querySelector('.batch-name').value || `Batch ${batches.length + 1}`,
                    collectionId: form.querySelector('.batch-collection').value,
                    brandId: form.querySelector('.batch-brand').value,
                    files: filesInput.files
                });
            }
        });
        
        if (batches.length === 0) return;
        
        // Calcular total de arquivos
        const totalFilesAll = batches.reduce((sum, b) => sum + b.files.length, 0);
        OAZLog.info('QUEUE_START', `========== INICIANDO FILA DE UPLOADS ==========`, { total_batches: batches.length, total_arquivos: totalFilesAll });
        
        document.querySelector('.card-body').style.display = 'none';
        uploadProgressSection.style.display = 'block';
        
        const progressList = document.getElementById('queue-progress-list');
        progressList.innerHTML = batches.map((b, i) => `
            <div class="queue-item-progress" id="queue-item-${i}">
                <div class="queue-item-header">
                    <span class="queue-item-name">${b.name}</span>
                    <div class="queue-item-actions">
                        <button class="btn btn-sm btn-process" id="process-btn-${i}" style="display: none;" onclick="processSingleBatch(${i})">
                            <i class="fas fa-play"></i> Processar
                        </button>
                        <span class="queue-item-status status-waiting" id="status-${i}">Aguardando</span>
                    </div>
                </div>
                <div class="progress-bar-container" style="height: 12px;">
                    <div class="progress-bar" id="progress-${i}" style="width: 0%"></div>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                    <span id="details-${i}">${b.files.length} arquivos</span>
                </div>
            </div>
        `).join('');
        
        let uploadedFilesAll = 0;
        uploadedBatchIds = [];
        const queueStartTime = Date.now();
        
        for (let i = 0; i < batches.length; i++) {
            document.getElementById(`status-${i}`).textContent = 'Subindo...';
            document.getElementById(`status-${i}`).className = 'queue-item-status status-uploading';
            
            OAZLog.info('BATCH_UPLOAD_START', `Iniciando upload do Batch ${i + 1}/${batches.length}: ${batches[i].name}`, { arquivos: batches[i].files.length });
            
            const result = await uploadBatchFiles(batches[i], (uploaded, total) => {
                const percent = (uploaded / total * 100).toFixed(0);
                document.getElementById(`progress-${i}`).style.width = percent + '%';
                document.getElementById(`details-${i}`).textContent = `${uploaded}/${total} arquivos`;
                
                const overallPercent = ((uploadedFilesAll + uploaded) / totalFilesAll * 100).toFixed(0);
                document.getElementById('overall-progress-bar').style.width = overallPercent + '%';
                document.getElementById('overall-percent').textContent = overallPercent + '%';
            }, i);
            
            uploadedFilesAll += result.uploaded;
            uploadedBatchIds.push(result.batchId);
            
            document.getElementById(`status-${i}`).textContent = 'Upload Conclu√≠do';
            document.getElementById(`status-${i}`).className = 'queue-item-status status-uploaded';
            document.getElementById(`progress-${i}`).style.width = '100%';
            
            // Mostrar bot√£o de processar individual
            document.getElementById(`process-btn-${i}`).style.display = 'inline-flex';
            document.getElementById(`process-btn-${i}`).dataset.batchId = result.batchId;
        }
        
        const totalQueueTime = (Date.now() - queueStartTime) / 1000;
        OAZLog.success('QUEUE_END', `========== FILA DE UPLOADS CONCLU√çDA ==========`, { batches_concluidos: batches.length, arquivos_enviados: uploadedFilesAll, tempo_total_segundos: totalQueueTime.toFixed(1) });
        
        document.getElementById('overall-progress-bar').style.width = '100%';
        document.getElementById('overall-percent').textContent = '100%';
        
        processingSection.style.display = 'block';
    });
    
    processAllBtn.addEventListener('click', async function() {
        OAZLog.info('PROCESS_ALL_CLICK', `Bot√£o "Processar Todos" clicado`, { batch_ids: uploadedBatchIds });
        
        processAllBtn.disabled = true;
        processAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando processamento...';
        
        try {
            OAZLog.info('PROCESS_ALL_START', `Iniciando processamento de ${uploadedBatchIds.length} batches`, { batch_ids: uploadedBatchIds });
            
            const response = await fetch('/batch/process-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ batch_ids: uploadedBatchIds })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                OAZLog.success('PROCESS_ALL_TRIGGERED', `Processamento iniciado com sucesso`, { batches_started: data.batches_started });
                window.location.href = '/batch';
            } else {
                OAZLog.error('PROCESS_ALL_ERROR', `Erro ao iniciar processamento: ${data.error || 'Falha desconhecida'}`);
                alert('Erro: ' + (data.error || 'Falha ao iniciar processamento'));
                processAllBtn.disabled = false;
                processAllBtn.innerHTML = '<i class="fas fa-play"></i> Processar Todos os Batches';
            }
        } catch (err) {
            OAZLog.error('PROCESS_ALL_EXCEPTION', `Exce√ß√£o: ${err.message}`);
            alert('Erro: ' + err.message);
            processAllBtn.disabled = false;
            processAllBtn.innerHTML = '<i class="fas fa-play"></i> Processar Todos os Batches';
        }
    });
});
</script>
{% endblock %}

================================================================================
FILE: templates/brands/list.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1>Marcas</h1>
        <p style="color: var(--text-secondary);">Gerencie as marcas cadastradas no sistema.</p>
    </div>
    <a href="{{ url_for('new_brand') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nova Marca
    </a>
</div>

{% if brands %}
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
    {% for brand in brands %}
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
                <h3 style="margin-bottom: 0.25rem;">{{ brand.name }}</h3>
                <span style="color: var(--accent-blue); font-size: 0.8rem;">
                    {{ brand.images | length }} imagens
                </span>
            </div>
        </div>

        {% if brand.description %}
        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
            {{ brand.description }}
        </p>
        {% endif %}

        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--text-secondary); border-top: 1px solid var(--border-color); padding-top: 1rem;">
            <span>Criado em {{ brand.created_at.strftime('%d/%m/%Y') }}</span>
            <a href="{{ url_for('catalog') }}?brand_id={{ brand.id }}" style="color: var(--accent-blue);">
                Ver imagens <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="stat-card" style="text-align: center; padding: 4rem;">
    <div style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;">
        <i class="fas fa-tag"></i>
    </div>
    <h3>Nenhuma Marca Cadastrada</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Crie sua primeira marca para organizar as imagens.</p>
    <a href="{{ url_for('new_brand') }}" class="btn btn-primary">Criar Nova Marca</a>
</div>
{% endif %}
{% endblock %}

================================================================================
FILE: templates/brands/new.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Nova Marca</h1>
    <p style="color: var(--text-secondary);">Cadastre uma nova marca no sistema.</p>
</div>

<div class="stat-card" style="max-width: 600px; padding: 2rem;">
    <form method="POST" action="{{ url_for('new_brand') }}">
        <div class="form-group">
            <label class="form-label">Nome da Marca *</label>
            <input type="text" name="name" class="form-control" placeholder="Ex: OAZ, Nike, Adidas..." required>
        </div>
        
        <div class="form-group">
            <label class="form-label">Descri√ß√£o (Opcional)</label>
            <textarea name="description" class="form-control" rows="3" placeholder="Descri√ß√£o da marca..."></textarea>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Salvar Marca
            </button>
            <a href="{{ url_for('brands') }}" class="btn" style="background: var(--bg-tertiary); color: var(--text-primary);">
                Cancelar
            </a>
        </div>
    </form>
</div>
{% endblock %}

================================================================================
FILE: templates/carteira/importar.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="{{ url_for('carteira') }}" style="color: var(--text-secondary); font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-arrow-left"></i> Voltar para Carteira
    </a>
    <h1 style="margin-top: 1rem;">Importar Carteira de Compras</h1>
    <p style="color: var(--text-secondary);">Importe um arquivo Excel (.xlsx) ou CSV com os produtos da carteira.</p>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <div class="stat-card">
        <form action="{{ url_for('importar_carteira') }}" method="POST" enctype="multipart/form-data" id="importForm" target="_self">
            <div class="upload-area" id="dropZone" style="height: 280px; cursor: pointer;" onclick="document.getElementById('fileInput').click();">
                <div style="text-align: center;">
                    <div class="upload-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h3 style="margin-bottom: 0.5rem;">Arraste e solte seu arquivo aqui</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Aceita arquivos Excel (.xlsx, .xls) ou CSV</p>
                    <span class="btn btn-primary">
                        <i class="fas fa-upload"></i> Selecionar Arquivo
                    </span>
                </div>
            </div>
            <input type="file" name="arquivo" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileSelect(this)">
            <input type="hidden" name="importar_todas" id="importarTodasInput" value="false">
            
            <div style="margin-top: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                    <i class="fas fa-tags" style="color: var(--accent-blue);"></i> Tipo de Carteira:
                </label>
                <select name="tipo_carteira" id="tipoCarteira" class="form-input" style="width: 100%;">
                    <option value="Moda" selected>Moda (Roupas)</option>
                    <option value="Acess√≥rios">Acess√≥rios</option>
                    <option value="Home">Home (Produtos de Casa)</option>
                </select>
                <p style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                    <i class="fas fa-info-circle" style="color: var(--accent-blue);"></i> 
                    Define o tipo de produtos desta carteira para organiza√ß√£o.
                </p>
            </div>
            
            <div id="filePreview" style="display: none; margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-file-excel" id="fileIcon" style="font-size: 2rem; color: #3fb950;"></i>
                    <div style="flex: 1;">
                        <div id="fileName" style="font-weight: 500;"></div>
                        <div id="fileSize" style="font-size: 0.85rem; color: var(--text-secondary);"></div>
                    </div>
                    <button type="button" onclick="clearFile()" style="background: none; border: none; color: #f85149; cursor: pointer; font-size: 1.2rem;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div id="abaSelector" style="display: none; margin-top: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="importarTodasCheck" onchange="toggleImportarTodas()" style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">Importar TODAS as abas de uma vez</span>
                    </label>
                </div>
                
                <div id="abaSelectContainer">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                        <i class="fas fa-layer-group" style="color: var(--accent-blue);"></i> Ou selecione uma aba:
                    </label>
                    <select name="aba" id="abaSelect" class="form-input" style="width: 100%;">
                        <option value="">Carregando abas...</option>
                    </select>
                </div>
                
                <p id="abaInfo" style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-secondary);"></p>
            </div>

            <div id="errorMessage" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(248, 81, 73, 0.1); border: 1px solid #f85149; border-radius: 8px; color: #f85149;">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
            </div>

            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <button type="submit" class="btn btn-primary" id="submitBtn" style="width: 100%; justify-content: center; padding: 12px;">
                    <i class="fas fa-file-import"></i> Importar Carteira
                </button>
            </div>
        </form>
    </div>

    <div>
        <div class="stat-card">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-file-excel" style="color: #3fb950;"></i> Arquivos Excel
            </h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                O sistema reconhece automaticamente as seguintes colunas (ignora maiusculas/minusculas e acentos):
            </p>
            <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <ul style="font-size: 0.8rem; color: var(--text-secondary); margin: 0; padding-left: 1rem; line-height: 1.6;">
                    <li><strong style="color: #3fb950;">REFERENCIA E COR</strong> ou <strong style="color: #3fb950;">REFERENCIA NS + COR</strong> ou <strong style="color: #3fb950;">SKU</strong> <span style="color: #f85149;">(obrigatorio)</span></li>
                    <li><strong style="color: #79c0ff;">NOME</strong> ou <strong style="color: #79c0ff;">NOME PRODUTO</strong> ‚Üí Descricao</li>
                    <li><strong style="color: #79c0ff;">GRUPO</strong> ‚Üí Material (MALHA, TECIDO PLANO)</li>
                    <li><strong style="color: #79c0ff;">SUBGRUPO</strong> ‚Üí Tipo de Peca (Blusa, Calca)</li>
                    <li><strong style="color: #79c0ff;">TOP/BOTTOM/INTEIRO</strong> ‚Üí Posicao da Peca</li>
                    <li><strong style="color: #79c0ff;">REFERENCIA ESTILO</strong> ‚Üí Codigo Estilo</li>
                    <li><strong style="color: #79c0ff;">ENTRADA</strong> ‚Üí Colecao (ex: INVERNO 2026)</li>
                    <li><strong style="color: #79c0ff;">ESTILISTA</strong> ‚Üí Estilista</li>
                    <li><strong style="color: #79c0ff;">NACIONAL / IMPORTADO</strong> ‚Üí Origem</li>
                </ul>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-secondary);">
                <i class="fas fa-info-circle" style="color: var(--accent-blue);"></i> 
                Colunas nao reconhecidas serao ignoradas.
            </p>
        </div>

        <div class="stat-card" style="margin-top: 1.5rem;">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-file-csv" style="color: #d29922;"></i> Arquivos CSV
            </h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                Para arquivos CSV, use as mesmas colunas:
            </p>
            <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 1rem;">
                <code style="color: #3fb950; font-size: 0.85rem;">
                    SKU, DESCRICAO, COR, CATEGORIA, QUANTIDADE
                </code>
            </div>
        </div>

        <div class="stat-card" style="margin-top: 1.5rem;">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-lightbulb" style="color: #d29922;"></i> Dicas
            </h3>
            <ul style="font-size: 0.85rem; color: var(--text-secondary); padding-left: 1.25rem; list-style: disc; line-height: 1.8;">
                <li>Excel com multiplas abas: escolha uma ou importe todas</li>
                <li>SKUs duplicados serao ignorados (nao duplica)</li>
                <li>Coluna FOTO com "SIM" marca como "Com Foto"</li>
                <li>Cruzamento automatico com produtos cadastrados</li>
                <li>Quantidade padrao = 1 se nao informada</li>
            </ul>
        </div>
    </div>
</div>

<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const abaSelector = document.getElementById('abaSelector');
const abaSelect = document.getElementById('abaSelect');
const abaSelectContainer = document.getElementById('abaSelectContainer');
const abaInfo = document.getElementById('abaInfo');
const importarTodasCheck = document.getElementById('importarTodasCheck');
const importarTodasInput = document.getElementById('importarTodasInput');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    dropZone.style.borderColor = 'var(--accent-blue)';
    dropZone.style.backgroundColor = 'rgba(31, 111, 235, 0.1)';
}

function unhighlight(e) {
    dropZone.style.borderColor = '';
    dropZone.style.backgroundColor = '';
}

dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(fileInput);
    }
}

function toggleImportarTodas() {
    if (importarTodasCheck.checked) {
        importarTodasInput.value = 'true';
        abaSelectContainer.style.display = 'none';
        abaInfo.innerHTML = '<i class="fas fa-check-circle" style="color: #3fb950;"></i> Todas as abas com coluna de SKU valida serao importadas.';
    } else {
        importarTodasInput.value = 'false';
        abaSelectContainer.style.display = 'block';
    }
}

async function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        filePreview.style.display = 'block';
        dropZone.style.display = 'none';
        
        const isExcel = file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');
        const fileIcon = document.getElementById('fileIcon');
        
        if (isExcel) {
            fileIcon.className = 'fas fa-file-excel';
            fileIcon.style.color = '#3fb950';
            
            abaSelector.style.display = 'block';
            abaSelect.innerHTML = '<option value="">Carregando abas...</option>';
            abaInfo.textContent = '';
            importarTodasCheck.checked = false;
            importarTodasInput.value = 'false';
            abaSelectContainer.style.display = 'block';
            
            const formData = new FormData();
            formData.append('arquivo', file);
            
            try {
                const response = await fetch('/carteira/abas', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    abaSelect.innerHTML = '';
                    
                    let abasComSku = 0;
                    data.abas.forEach((aba, index) => {
                        const option = document.createElement('option');
                        option.value = aba.nome;
                        const skuStatus = aba.tem_sku ? '‚úì SKU' : '‚úó Sem SKU';
                        const skuColor = aba.tem_sku ? '#3fb950' : '#f85149';
                        option.innerHTML = `${aba.nome} (${aba.linhas} linhas) - ${skuStatus}`;
                        option.style.color = aba.tem_sku ? '' : '#888';
                        if (index === 0 || (aba.tem_sku && abasComSku === 0)) {
                            option.selected = true;
                        }
                        if (aba.tem_sku) abasComSku++;
                        abaSelect.appendChild(option);
                    });
                    
                    if (data.abas.length > 1) {
                        abaInfo.innerHTML = `<i class="fas fa-info-circle" style="color: var(--accent-blue);"></i> ${data.abas.length} abas encontradas, ${abasComSku} com coluna de SKU. Total: ${data.total_linhas} linhas.`;
                    } else {
                        abaInfo.innerHTML = `<i class="fas fa-info-circle" style="color: var(--accent-blue);"></i> 1 aba encontrada com ${data.total_linhas} linhas.`;
                    }
                } else {
                    abaSelect.innerHTML = '<option value="">Erro ao carregar abas</option>';
                }
            } catch (error) {
                console.error('Erro:', error);
                abaSelect.innerHTML = '<option value="">Erro ao carregar abas</option>';
            }
        } else {
            fileIcon.className = 'fas fa-file-csv';
            fileIcon.style.color = '#d29922';
            abaSelector.style.display = 'none';
        }
    }
}

function clearFile() {
    fileInput.value = '';
    filePreview.style.display = 'none';
    abaSelector.style.display = 'none';
    dropZone.style.display = 'flex';
    importarTodasCheck.checked = false;
    importarTodasInput.value = 'false';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    errorText.textContent = message;
    errorDiv.style.display = 'block';
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}

document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    hideError();
    
    const fileInput = document.getElementById('fileInput');
    if (!fileInput.files || fileInput.files.length === 0) {
        showError('Por favor, selecione um arquivo Excel (.xlsx) ou CSV para importar.');
        return false;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando... Aguarde';
    
    try {
        const formData = new FormData(this);
        
        const response = await fetch('{{ url_for("importar_carteira") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // Redirecionar para carteira ap√≥s sucesso
            window.location.href = '{{ url_for("carteira") }}';
        } else {
            const text = await response.text();
            showError('Erro ao importar: ' + (text || 'Erro desconhecido'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-file-import"></i> Importar Carteira';
        }
    } catch (error) {
        console.error('Erro:', error);
        showError('Erro de conex√£o ao importar. Tente novamente.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-file-import"></i> Importar Carteira';
    }
});
</script>
{% endblock %}

================================================================================
FILE: templates/carteira/list.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1>Carteira de Produtos</h1>
        <p style="color: var(--text-secondary);">Gerencie a carteira de produtos importada.</p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('importar_carteira') }}" class="btn btn-primary">
            <i class="fas fa-file-import"></i> Importar Excel/CSV
        </a>
        <a href="{{ url_for('cruzar_carteira') }}" class="btn" style="background: rgba(63, 185, 80, 0.2); border: 1px solid #3fb950; color: #3fb950;">
            <i class="fas fa-sync-alt"></i> Executar Cruzamento
        </a>
        <form action="{{ url_for('reconciliar_carteira') }}" method="POST" style="display: inline;">
            <button type="submit" class="btn" style="background: rgba(130, 80, 223, 0.2); border: 1px solid #a371f7; color: #a371f7;"
                title="Busca match na Carteira para imagens que n√£o tiveram match anteriormente">
                <i class="fas fa-link"></i> Reconciliar Imagens
            </button>
        </form>
        <a href="{{ url_for('export_carteira') }}" class="btn" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);">
            <i class="fas fa-file-export"></i> Exportar CSV
        </a>
        {% if total_carteira > 0 %}
        <button onclick="confirmarLimparTudo()" class="btn" style="background: rgba(248, 81, 73, 0.2); border: 1px solid #f85149; color: #f85149;">
            <i class="fas fa-trash-alt"></i> Limpar Tudo
        </button>
        {% endif %}
    </div>
</div>

<div class="dashboard-stats" style="margin-bottom: 2rem;">
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Total na Carteira</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ total_carteira }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(31, 111, 235, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-wallet" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Com Foto</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #3fb950;">{{ com_foto }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(63, 185, 80, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-check-circle" style="color: #3fb950; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Sem Foto</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #f85149;">{{ sem_foto }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(248, 81, 73, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times-circle" style="color: #f85149; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Pendente</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #d29922;">{{ pendente }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(210, 153, 34, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-clock" style="color: #d29922; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>
</div>

{% if lotes and lotes|length > 0 %}
<div class="stat-card" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;"><i class="fas fa-layer-group" style="color: var(--accent-blue);"></i> Lotes de Importa√ß√£o</h3>
        {% if lote_selecionado %}
        <a href="{{ url_for('carteira') }}" class="btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.85rem; padding: 0.5rem 1rem;">
            <i class="fas fa-times"></i> Ver Todos os Lotes
        </a>
        {% endif %}
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
        {% for lote in lotes %}
        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; border: 1px solid {% if lote_selecionado == lote.lote_importacao %}var(--accent-blue){% else %}var(--border-color){% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                <div>
                    <div style="font-weight: 600; font-size: 0.85rem; color: var(--text-primary); font-family: monospace; word-break: break-all;">{{ lote.lote_importacao }}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        {{ lote.data_importacao.strftime('%d/%m/%Y %H:%M') if lote.data_importacao else '-' }}
                    </div>
                </div>
                <span style="background: var(--accent-blue); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                    {{ lote.total_itens }} itens
                </span>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <a href="{{ url_for('carteira', lote=lote.lote_importacao) }}" class="btn" style="flex: 1; background: rgba(31, 111, 235, 0.1); border: 1px solid var(--accent-blue); color: var(--accent-blue); font-size: 0.8rem; padding: 0.5rem;">
                    <i class="fas fa-eye"></i> Ver
                </a>
                <button onclick="confirmarDeletarLote('{{ lote.lote_importacao }}', {{ lote.total_itens }})" class="btn" style="background: rgba(248, 81, 73, 0.1); border: 1px solid #f85149; color: #f85149; font-size: 0.8rem; padding: 0.5rem;">
                    <i class="fas fa-trash"></i> Deletar
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="stat-card" style="margin-bottom: 2rem;">
    <form action="{{ url_for('carteira') }}" method="GET" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 250px;">
            <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Buscar</label>
            <div style="position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                <input type="text" name="search" class="form-control" style="padding-left: 40px;" placeholder="SKU, descri√ß√£o..." value="{{ search_query or '' }}">
            </div>
        </div>

        <div style="min-width: 180px;">
            <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Status</label>
            <select name="status" class="form-control">
                <option value="">Todos os Status</option>
                <option value="Com Foto" {% if request.args.get('status') == 'Com Foto' %}selected{% endif %}>Com Foto</option>
                <option value="Sem Foto" {% if request.args.get('status') == 'Sem Foto' %}selected{% endif %}>Sem Foto</option>
                <option value="Pendente" {% if request.args.get('status') == 'Pendente' %}selected{% endif %}>Pendente</option>
            </select>
        </div>

        <div style="display: flex; gap: 0.5rem;">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-filter"></i> Filtrar
            </button>
            <a href="{{ url_for('carteira') }}" class="btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                <i class="fas fa-times"></i> Limpar
            </a>
        </div>
    </form>
</div>

{% if lote_selecionado %}
<div style="background: rgba(31, 111, 235, 0.1); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <span style="color: var(--accent-blue);"><i class="fas fa-filter"></i></span>
        <strong>Filtrando por lote:</strong> <code style="background: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ lote_selecionado }}</code>
        <span style="color: var(--text-secondary); margin-left: 1rem;">({{ itens_carteira|length }} itens)</span>
    </div>
    <a href="{{ url_for('carteira') }}" class="btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.85rem; padding: 0.5rem 1rem;">
        <i class="fas fa-times"></i> Remover Filtro
    </a>
</div>
{% endif %}

{% if itens_carteira %}
<div class="stat-card" style="padding: 0; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">SKU</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Descri√ß√£o</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Cor</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Categoria</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Quantidade</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Status</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Lote</th>
            </tr>
        </thead>
        <tbody>
            {% for item in itens_carteira %}
            <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 1rem; font-weight: 500; font-family: monospace;">{{ item.sku }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ item.descricao or '-' }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ item.cor or '-' }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ item.categoria or '-' }}</td>
                <td style="padding: 1rem; text-align: center; font-weight: 500;">{{ item.quantidade }}</td>
                <td style="padding: 1rem; text-align: center;">
                    {% if item.status_foto == 'Com Foto' %}
                    <span class="status-badge" style="background-color: rgba(63, 185, 80, 0.2); color: #3fb950;">
                        <i class="fas fa-check"></i> Com Foto
                    </span>
                    {% elif item.status_foto == 'Sem Foto' %}
                    <span class="status-badge" style="background-color: rgba(248, 81, 73, 0.2); color: #f85149;">
                        <i class="fas fa-times"></i> Sem Foto
                    </span>
                    {% else %}
                    <span class="status-badge" style="background-color: rgba(210, 153, 34, 0.2); color: #d29922;">
                        <i class="fas fa-clock"></i> Pendente
                    </span>
                    {% endif %}
                </td>
                <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.8rem;">
                    {% if item.lote_importacao %}
                    <a href="{{ url_for('carteira', lote=item.lote_importacao) }}" style="color: var(--accent-blue); text-decoration: none;">
                        {{ item.lote_importacao[:20] }}...
                    </a>
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="stat-card" style="text-align: center; padding: 4rem;">
    <div style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;">
        <i class="fas fa-wallet"></i>
    </div>
    <h3>Carteira Vazia</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Importe um arquivo Excel ou CSV para popular a carteira de produtos.</p>
    <a href="{{ url_for('importar_carteira') }}" class="btn btn-primary">
        <i class="fas fa-file-import"></i> Importar Excel/CSV
    </a>
</div>
{% endif %}

<form id="formDeletarLote" method="POST" style="display: none;">
</form>

<form id="formLimparTudo" action="{{ url_for('limpar_toda_carteira') }}" method="POST" style="display: none;">
</form>

<script>
function confirmarDeletarLote(loteId, totalItens) {
    if (confirm(`Tem certeza que deseja deletar o lote "${loteId}"?\n\nIsso ir√° remover ${totalItens} itens permanentemente.`)) {
        const form = document.getElementById('formDeletarLote');
        form.action = `/carteira/lote/${encodeURIComponent(loteId)}/delete`;
        form.submit();
    }
}

function confirmarLimparTudo() {
    if (confirm('Tem certeza que deseja LIMPAR TODA a carteira de compras?\n\nEsta a√ß√£o √© irrevers√≠vel e todos os itens ser√£o removidos permanentemente.')) {
        if (confirm('ATEN√á√ÉO: Voc√™ est√° prestes a deletar TODOS os dados da carteira.\n\nDigite OK para confirmar.')) {
            document.getElementById('formLimparTudo').submit();
        }
    }
}
</script>
{% endblock %}

================================================================================
FILE: templates/collections/detail.html
================================================================================
{% extends "base.html" %}

{% block title %}{{ collection.name }} - OAZ Smart Image Bank{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <nav style="margin-bottom: 0.5rem;">
            <a href="{{ url_for('collections') }}" style="color: var(--text-secondary); text-decoration: none;">
                <i class="fas fa-arrow-left"></i> Voltar para Cole√ß√µes
            </a>
        </nav>
        <h1 style="margin-bottom: 0.25rem;">{{ collection.name }}</h1>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            {% if collection.year %}
            <span style="background: var(--accent-blue); color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.85rem;">
                {{ collection.year }}
            </span>
            {% endif %}
            {% if collection.season %}
            <span style="background: var(--bg-tertiary); padding: 4px 12px; border-radius: 6px; font-size: 0.85rem;">
                {{ collection.season }}
            </span>
            {% endif %}
            {% if collection.campanha %}
            <span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 4px 12px; border-radius: 6px; font-size: 0.85rem;">
                {{ collection.campanha }}
            </span>
            {% endif %}
        </div>
    </div>
    <div style="display: flex; gap: 0.75rem;">
        <a href="{{ url_for('edit_collection', id=collection.id) }}" class="btn btn-secondary">
            <i class="fas fa-edit"></i> Editar Cole√ß√£o
        </a>
        <a href="{{ url_for('batch_new') }}?collection_id={{ collection.id }}" class="btn btn-primary">
            <i class="fas fa-upload"></i> Upload em Lote
        </a>
        <form action="{{ url_for('reprocessar_colecao', id=collection.id) }}" method="POST" style="display: inline;">
            <button type="submit" class="btn" style="background: rgba(139, 92, 246, 0.2); border: 1px solid #8b5cf6; color: #8b5cf6;"
                onclick="return confirm('Reprocessar todas as imagens desta cole√ß√£o?\n\nIsso ir√° tentar fazer match com a Carteira e atualizar os dados.')">
                <i class="fas fa-sync-alt"></i> Reprocessar
            </button>
        </form>
    </div>
</div>

{% if collection.description %}
<p style="color: var(--text-secondary); margin-bottom: 1.5rem;">{{ collection.description }}</p>
{% endif %}

<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 2rem;">
    <div class="stat-card" style="text-align: center; padding: 1rem;">
        <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">{{ stats.total }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">Total</div>
    </div>
    <div class="stat-card" style="text-align: center; padding: 1rem;">
        <div style="font-size: 2rem; font-weight: 700; color: #fbbf24;">{{ stats.pendentes }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">Pendentes</div>
    </div>
    <div class="stat-card" style="text-align: center; padding: 1rem;">
        <div style="font-size: 2rem; font-weight: 700; color: #10b981;">{{ stats.aprovadas }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">Aprovadas</div>
    </div>
    <div class="stat-card" style="text-align: center; padding: 1rem;">
        <div style="font-size: 2rem; font-weight: 700; color: #f85149;">{{ stats.rejeitadas }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">Rejeitadas</div>
    </div>
    <div class="stat-card" style="text-align: center; padding: 1rem;">
        <div style="font-size: 2rem; font-weight: 700; color: #8b5cf6;">{{ stats.pendente_ia }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">Pendente IA</div>
    </div>
</div>

<div class="stat-card" style="margin-bottom: 1.5rem; padding: 1rem 1.5rem;">
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
            <span style="font-weight: 600; color: var(--text-secondary); white-space: nowrap;">
                <i class="fas fa-layer-group"></i> Subcole√ß√µes:
            </span>
            {% if subcolecoes %}
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="{{ url_for('collection_detail', id=collection.id) }}" 
                   class="subcol-chip {% if not subcolecao_id %}active{% endif %}">
                    Todas
                </a>
                {% for sub in subcolecoes %}
                <a href="{{ url_for('collection_detail', id=collection.id, subcolecao_id=sub.id) }}" 
                   class="subcol-chip {% if subcolecao_id == sub.id %}active{% endif %}"
                   title="{% if sub.tipo_campanha %}{{ sub.tipo_campanha }}{% endif %}{% if sub.data_inicio %} | {{ sub.data_inicio.strftime('%d/%m') }}{% endif %}{% if sub.data_fim %} - {{ sub.data_fim.strftime('%d/%m') }}{% endif %}">
                    {{ sub.nome }}
                </a>
                {% endfor %}
            </div>
            {% else %}
            <span style="color: var(--text-secondary); font-size: 0.9rem;">Nenhuma subcole√ß√£o cadastrada</span>
            {% endif %}
        </div>
        <a href="{{ url_for('new_subcolecao') }}?colecao_id={{ collection.id }}" class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px;">
            <i class="fas fa-plus"></i> Nova Subcole√ß√£o
        </a>
    </div>
</div>

<div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    <form method="GET" action="{{ url_for('collection_detail', id=collection.id) }}" style="display: flex; gap: 1rem; flex: 1; flex-wrap: wrap;">
        {% if subcolecao_id %}
        <input type="hidden" name="subcolecao_id" value="{{ subcolecao_id }}">
        {% endif %}
        <div class="search-bar" style="flex: 1; min-width: 250px;">
            <i class="fas fa-search"></i>
            <input type="text" name="search" placeholder="Buscar por SKU ou descri√ß√£o..." value="{{ request.args.get('search', '') }}">
        </div>
        <select name="status" class="form-control" style="width: 180px;" onchange="this.form.submit()">
            <option value="">Todos os Status</option>
            <option value="Pendente" {% if request.args.get('status') == 'Pendente' %}selected{% endif %}>Pendente</option>
            <option value="Aprovado" {% if request.args.get('status') == 'Aprovado' %}selected{% endif %}>Aprovado</option>
            <option value="Rejeitado" {% if request.args.get('status') == 'Rejeitado' %}selected{% endif %}>Rejeitado</option>
            <option value="Pendente An√°lise IA" {% if request.args.get('status') == 'Pendente An√°lise IA' %}selected{% endif %}>Pendente An√°lise IA</option>
        </select>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i> Buscar
        </button>
    </form>
</div>

{% if images %}
<div class="images-grid">
    {% for image in images %}
    <div class="image-card">
        <a href="{{ url_for('image_detail', id=image.id) }}">
            <img src="{{ image.image_url }}" alt="{{ image.original_name }}" loading="lazy">
        </a>
        <div class="image-info">
            <div class="image-sku">{{ image.sku or 'Sem SKU' }}</div>
            {% if image.subcolecao %}
            <span style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">
                {{ image.subcolecao.nome }}
            </span>
            {% endif %}
            <div class="image-status {{ image.status|lower|replace(' ', '-') }}">{{ image.status }}</div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="stat-card" style="text-align: center; padding: 4rem;">
    <div style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;">
        <i class="fas fa-images"></i>
    </div>
    <h3>Nenhuma Imagem Encontrada</h3>
    {% if subcolecao_id or request.args.get('status') or request.args.get('search') %}
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Tente ajustar os filtros para ver mais imagens.</p>
    <a href="{{ url_for('collection_detail', id=collection.id) }}" class="btn btn-secondary">Limpar Filtros</a>
    {% else %}
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Fa√ßa o upload de imagens para esta cole√ß√£o.</p>
    <a href="{{ url_for('batch_new') }}?collection_id={{ collection.id }}" class="btn btn-primary">
        <i class="fas fa-upload"></i> Upload em Lote
    </a>
    {% endif %}
</div>
{% endif %}

<style>
.subcol-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 14px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.85rem;
    transition: all 0.2s;
}
.subcol-chip:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: #8b5cf6;
    color: #8b5cf6;
}
.subcol-chip.active {
    background: #8b5cf6;
    border-color: #8b5cf6;
    color: white;
}

.images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 1.25rem;
}
.image-card {
    background: var(--bg-secondary);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border-color);
    transition: transform 0.2s, box-shadow 0.2s;
}
.image-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
}
.image-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
}
.image-info {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.image-sku {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.image-status {
    font-size: 0.75rem;
    padding: 3px 8px;
    border-radius: 4px;
    text-align: center;
    width: fit-content;
}
.image-status.pendente {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}
.image-status.aprovado {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}
.image-status.rejeitado {
    background: rgba(248, 81, 73, 0.2);
    color: #f85149;
}
.image-status.pendente-an√°lise-ia {
    background: rgba(139, 92, 246, 0.2);
    color: #8b5cf6;
}
</style>
{% endblock %}

================================================================================
FILE: templates/collections/edit.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
        <h1>Editar Cole√ß√£o</h1>
        <p style="color: var(--text-secondary);">Atualize as informa√ß√µes da cole√ß√£o.</p>
    </div>

    <div class="card">
        <form method="POST" action="{{ url_for('edit_collection', id=collection.id) }}">
            <div class="form-group">
                <label class="form-label">Nome da Cole√ß√£o *</label>
                <input type="text" name="name" class="form-control" value="{{ collection.name }}" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label">Ano</label>
                    <select name="year" class="form-control">
                        <option value="">Selecione...</option>
                        {% for y in years %}
                        <option value="{{ y }}" {% if collection.year == y %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Esta√ß√£o</label>
                    <select name="season" class="form-control">
                        <option value="">Selecione...</option>
                        <option value="Primavera/Ver√£o" {% if collection.season == 'Primavera/Ver√£o' %}selected{% endif %}>Primavera/Ver√£o</option>
                        <option value="Outono/Inverno" {% if collection.season == 'Outono/Inverno' %}selected{% endif %}>Outono/Inverno</option>
                        <option value="Alto Ver√£o" {% if collection.season == 'Alto Ver√£o' %}selected{% endif %}>Alto Ver√£o</option>
                        <option value="Cruise" {% if collection.season == 'Cruise' %}selected{% endif %}>Cruise</option>
                        <option value="Resort" {% if collection.season == 'Resort' %}selected{% endif %}>Resort</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Campanha</label>
                    <input type="text" name="campanha" class="form-control" value="{{ collection.campanha or '' }}" placeholder="Ex: Lan√ßamento Ver√£o">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Descri√ß√£o</label>
                <textarea name="description" class="form-control" rows="4">{{ collection.description or '' }}</textarea>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <form method="POST" action="{{ url_for('delete_collection', id=collection.id) }}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir esta cole√ß√£o?');">
                    <button type="submit" class="btn" style="color: #ef4444; border: 1px solid #ef4444;">
                        <i class="fas fa-trash"></i> Excluir Cole√ß√£o
                    </button>
                </form>
                
                <div style="display: flex; gap: 1rem;">
                    <a href="{{ url_for('collections') }}" class="btn" style="border: 1px solid var(--border-color); color: var(--text-primary);">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </div>
        </form>
    </div>
    
    {% if collection.images %}
    <div class="card" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1rem;">Imagens nesta Cole√ß√£o ({{ collection.images | length }})</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem;">
            {% for img in collection.images[:12] %}
            <a href="{{ url_for('image_detail', id=img.id) }}">
                <img src="{{ url_for('static', filename='uploads/' + img.filename) }}" 
                     alt="{{ img.original_name }}"
                     style="width: 100%; height: 100px; object-fit: cover; border-radius: 4px;">
            </a>
            {% endfor %}
        </div>
        {% if collection.images | length > 12 %}
        <a href="{{ url_for('catalog') }}?collection_id={{ collection.id }}" style="display: block; text-align: center; margin-top: 1rem; color: var(--accent-blue);">
            Ver todas as {{ collection.images | length }} imagens <i class="fas fa-arrow-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

================================================================================
FILE: templates/collections/list.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1>Cole√ß√µes</h1>
        <p style="color: var(--text-secondary);">Gerencie e catalogue todas as cole√ß√µes de imagens.</p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('new_collection') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nova Cole√ß√£o
        </a>
        {% if collections %}
        <button type="button" onclick="confirmarDeletarTodas()" class="btn" style="background: rgba(248, 81, 73, 0.1); border: 1px solid #f85149; color: #f85149;">
            <i class="fas fa-trash-alt"></i> Deletar Todas
        </button>
        {% endif %}
    </div>
</div>

<!-- Modal Deletar Todas Cole√ß√µes -->
<div id="modalDeletarTodas" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div class="stat-card" style="max-width: 450px; margin: auto; text-align: center;">
        <div style="font-size: 3rem; color: #f85149; margin-bottom: 1rem;">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 style="margin-bottom: 1rem;">Deletar Todas as Cole√ß√µes?</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            Esta a√ß√£o ir√° remover <strong style="color: #f85149;">{{ collections|length }} cole√ß√µes</strong> do sistema.
            <br><br>
            <strong>Esta a√ß√£o n√£o pode ser desfeita!</strong>
        </p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button type="button" onclick="fecharModalColecoes()" class="btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <form action="{{ url_for('delete_all_collections') }}" method="POST" style="display: inline;">
                <button type="submit" class="btn" style="background: #f85149; color: white; border: none;">
                    <i class="fas fa-trash-alt"></i> Sim, Deletar Todas
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function confirmarDeletarTodas() {
    document.getElementById('modalDeletarTodas').style.display = 'flex';
}

function fecharModalColecoes() {
    document.getElementById('modalDeletarTodas').style.display = 'none';
}

document.getElementById('modalDeletarTodas').addEventListener('click', function(e) {
    if (e.target === this) fecharModalColecoes();
});
</script>

<div style="margin-bottom: 2rem; display: flex; gap: 1rem;">
    <form method="GET" action="{{ url_for('collections') }}" style="display: flex; gap: 1rem; flex: 1;">
        <div class="search-bar" style="flex: 1; width: auto;">
            <i class="fas fa-search"></i>
            <input type="text" name="search" placeholder="Buscar por nome da cole√ß√£o..." value="{{ request.args.get('search', '') }}">
        </div>
        <select name="season" class="form-control" style="width: 180px;" onchange="this.form.submit()">
            <option value="">Todas as Esta√ß√µes</option>
            <option value="Primavera/Ver√£o" {% if request.args.get('season') == 'Primavera/Ver√£o' %}selected{% endif %}>Primavera/Ver√£o</option>
            <option value="Outono/Inverno" {% if request.args.get('season') == 'Outono/Inverno' %}selected{% endif %}>Outono/Inverno</option>
            <option value="Alto Ver√£o" {% if request.args.get('season') == 'Alto Ver√£o' %}selected{% endif %}>Alto Ver√£o</option>
            <option value="Cruise" {% if request.args.get('season') == 'Cruise' %}selected{% endif %}>Cruise</option>
            <option value="Resort" {% if request.args.get('season') == 'Resort' %}selected{% endif %}>Resort</option>
        </select>
        <select name="year" class="form-control" style="width: 120px;" onchange="this.form.submit()">
            <option value="">Todos os Anos</option>
            {% for y in range(2020, 2028) %}
            <option value="{{ y }}" {% if request.args.get('year')|int == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
    </form>
</div>

{% if collections %}
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;">
    {% for collection in collections %}
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
                <h3 style="margin-bottom: 0.25rem;">{{ collection.name }}</h3>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                    {% if collection.year %}
                    <span style="background: var(--accent-blue); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">
                        {{ collection.year }}
                    </span>
                    {% endif %}
                    {% if collection.season %}
                    <span style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">
                        {{ collection.season }}
                    </span>
                    {% endif %}
                    {% if collection.campanha %}
                    <span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">
                        {{ collection.campanha }}
                    </span>
                    {% endif %}
                </div>
            </div>
            <span style="background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-size: 0.8rem;">
                {{ collection.images | length }} imagens
            </span>
        </div>

        {% if collection.description %}
        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
            {{ collection.description[:100] }}{% if collection.description|length > 100 %}...{% endif %}
        </p>
        {% endif %}

        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--text-secondary); border-top: 1px solid var(--border-color); padding-top: 1rem;">
            <span>Criado em {{ collection.created_at.strftime('%d/%m/%Y') }}</span>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <a href="{{ url_for('edit_collection', id=collection.id) }}" style="color: var(--text-secondary);">
                    <i class="fas fa-edit"></i> Editar
                </a>
                <form action="{{ url_for('delete_collection', id=collection.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir esta cole√ß√£o?');">
                    <button type="submit" style="background: none; border: none; color: #f85149; cursor: pointer; font-size: 0.85rem; padding: 0;">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </form>
                <a href="{{ url_for('collection_detail', id=collection.id) }}" style="color: var(--accent-blue);">
                    Ver detalhes <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="stat-card" style="text-align: center; padding: 4rem;">
    <div style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;">
        <i class="fas fa-folder-open"></i>
    </div>
    <h3>Nenhuma Cole√ß√£o Encontrada</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Crie sua primeira cole√ß√£o para organizar imagens.</p>
    <a href="{{ url_for('new_collection') }}" class="btn btn-primary">Criar Nova Cole√ß√£o</a>
</div>
{% endif %}
{% endblock %}

================================================================================
FILE: templates/collections/new.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
        <h1>Nova Cole√ß√£o</h1>
        <p style="color: var(--text-secondary);">Crie uma nova cole√ß√£o para organizar suas imagens.</p>
    </div>

    <div class="card">
        <form method="POST" action="{{ url_for('new_collection') }}">
            <div class="form-group">
                <label class="form-label">Nome da Cole√ß√£o *</label>
                <input type="text" name="name" class="form-control" placeholder="Ex: Ver√£o 2025" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label">Ano</label>
                    <select name="year" class="form-control">
                        <option value="">Selecione...</option>
                        {% for y in years %}
                        <option value="{{ y }}">{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Esta√ß√£o</label>
                    <select name="season" class="form-control">
                        <option value="">Selecione...</option>
                        <option value="Primavera/Ver√£o">Primavera/Ver√£o</option>
                        <option value="Outono/Inverno">Outono/Inverno</option>
                        <option value="Alto Ver√£o">Alto Ver√£o</option>
                        <option value="Cruise">Cruise</option>
                        <option value="Resort">Resort</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Campanha</label>
                    <input type="text" name="campanha" class="form-control" placeholder="Ex: Lan√ßamento Ver√£o">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Descri√ß√£o</label>
                <textarea name="description" class="form-control" rows="4"
                    placeholder="Descri√ß√£o da cole√ß√£o..."></textarea>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                <a href="{{ url_for('collections') }}" class="btn"
                    style="border: 1px solid var(--border-color); color: var(--text-primary);">Cancelar</a>
                <button type="submit" class="btn btn-primary">Criar Cole√ß√£o</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

================================================================================
FILE: templates/dashboard/index.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Painel</h1>
    <p style="color: var(--text-secondary);">Bem-vindo de volta, aqui est√° uma vis√£o geral do seu banco de imagens.</p>
</div>

<div class="dashboard-stats">
    <div class="stat-card" data-tutorial-title="Total de Imagens" data-tutorial-desc="Quantidade total de imagens no banco, independente do status. Mostra tamb√©m quantos SKUs √∫nicos existem.">
        <div class="stat-title">Total de Imagens</div>
        <div class="stat-value">{{ total_images }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">
            {{ total_skus }} SKUs √∫nicos
        </div>
    </div>
    <div class="stat-card" data-tutorial-title="Imagens Com Match" data-tutorial-desc="Imagens que fizeram match autom√°tico com SKUs da Carteira de Compras. Est√£o pendentes de revis√£o para aprova√ß√£o ou rejei√ß√£o.">
        <div class="stat-title">Com Match (Pendentes)</div>
        <div class="stat-value" style="color: #d29922;">{{ pending_images }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">
            {{ pending_skus }} SKUs aguardando revis√£o
        </div>
    </div>
    <div class="stat-card" data-tutorial-title="Imagens Sem Match" data-tutorial-desc="Imagens que n√£o encontraram SKU correspondente na Carteira. Precisam de an√°lise por Intelig√™ncia Artificial para identifica√ß√£o.">
        <div class="stat-title">Sem Match (An√°lise IA)</div>
        <div class="stat-value" style="color: #9333ea;">{{ pending_ia_images }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">
            {{ pending_ia_skus }} SKUs sem dados
        </div>
    </div>
    <div class="stat-card" data-tutorial-title="Imagens Aprovadas" data-tutorial-desc="Imagens que passaram pela revis√£o e foram aprovadas. Est√£o prontas para uso em cat√°logos, e-commerce e materiais.">
        <div class="stat-title">Aprovadas</div>
        <div class="stat-value" style="color: #3fb950;">{{ approved_images }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">
            prontas para uso
        </div>
    </div>
    <div class="stat-card" data-tutorial-title="Imagens Rejeitadas" data-tutorial-desc="Imagens que foram rejeitadas na revis√£o (qualidade inadequada, foto incorreta, etc). Precisam de nova captura.">
        <div class="stat-title">Rejeitadas</div>
        <div class="stat-value" style="color: #f85149;">{{ rejected_images }}</div>
        <div style="font-size: 0.85rem; color: var(--text-secondary);">
            precisam aten√ß√£o
        </div>
    </div>
</div>

<div class="charts-grid">
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="chart-card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <h3>Resumo</h3>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="far fa-folder" style="font-size: 1.5rem; color: var(--accent-blue);"></i>
                            <span>Cole√ß√µes</span>
                        </div>
                        <strong style="font-size: 1.25rem;">{{ total_collections }}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-tag" style="font-size: 1.5rem; color: var(--accent-blue);"></i>
                            <span>Marcas</span>
                        </div>
                        <strong style="font-size: 1.25rem;">{{ total_brands }}</strong>
                    </div>
                </div>
            </div>
            <div class="chart-card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <h3>Distribui√ß√£o por Status</h3>
                </div>
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card" style="background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(139,92,246,0.1));">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3><i class="fas fa-camera" style="color: #ff6b35; margin-right: 8px;"></i>SKUs Pendentes de Foto</h3>
                <a href="{{ url_for('skus_sem_foto') }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-list"></i> Ver Lista Completa
                </a>
            </div>
            <div style="display: flex; gap: 20px; margin-bottom: 1rem;">
                <div style="text-align: center; padding: 15px 25px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <div style="font-size: 2rem; font-weight: 700; color: #ff6b35;">{{ total_skus_sem_foto }}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">SKUs sem foto</div>
                </div>
                <div style="text-align: center; padding: 15px 25px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <div style="font-size: 2rem; font-weight: 700; color: #3fb950;">{{ total_skus_carteira - total_skus_sem_foto }}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">SKUs com foto</div>
                </div>
                <div style="text-align: center; padding: 15px 25px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">{{ total_skus_carteira }}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Total na Carteira</div>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                {% for item in skus_pendentes_foto %}
                <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">{{ item.colecao }}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            {{ item.com_foto }}/{{ item.total }} SKUs fotografados
                        </div>
                    </div>
                    <div style="width: 150px;">
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div style="width: {{ item.percentual }}%; height: 100%; background: linear-gradient(90deg, #3fb950, #28a745); border-radius: 4px;"></div>
                        </div>
                    </div>
                    <div style="width: 50px; text-align: right; font-weight: 600; color: {% if item.percentual >= 80 %}#3fb950{% elif item.percentual >= 50 %}#d29922{% else %}#f85149{% endif %};">
                        {{ item.percentual }}%
                    </div>
                    <div style="color: #f85149; font-weight: 600; min-width: 80px; text-align: right;">
                        {{ item.sem_foto }} pendentes
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div class="stat-card" style="padding: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="font-size: 1rem;">Imagens Recentes</h3>
                <a href="{{ url_for('catalog') }}" style="font-size: 0.85rem;">Ver todas</a>
            </div>

            {% if recent_images %}
                {% for image in recent_images %}
                <div style="display: flex; gap: 10px; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <img src="{{ image.image_url }}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.9rem;">{{ image.sku or image.original_name[:20] }}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            <span class="status-badge status-{{ image.status.lower() }}" style="font-size: 0.7rem;">{{ image.status }}</span>
                        </div>
                    </div>
                    <a href="{{ url_for('image_detail', id=image.id) }}" style="color: var(--accent-blue); font-size: 0.85rem;">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                {% endfor %}
            {% else %}
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Nenhuma imagem ainda.</p>
            {% endif %}

            <div style="text-align: center; margin-top: 1rem;">
                <a href="{{ url_for('upload') }}" class="btn btn-primary" style="width: 100%; justify-content: center;">
                    <i class="fas fa-cloud-upload-alt"></i> Enviar Nova Imagem
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['Com Match', 'Sem Match (IA)', 'Aprovado', 'Rejeitado'],
            datasets: [{
                data: [{{ pending_images }}, {{ pending_ia_images }}, {{ approved_images }}, {{ rejected_images }}],
                backgroundColor: ['#d29922', '#9333ea', '#3fb950', '#f85149'],
                borderWidth: 0
            }]
        },
        options: {
            plugins: {
                legend: { position: 'bottom', labels: { color: '#9ca3af' } }
            }
        }
    });
</script>
{% endblock %}

================================================================================
FILE: templates/images/catalog.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1>Busca & Cat√°logo de Imagens</h1>
        <p style="color: var(--text-secondary);">Mostrando {{ sku_groups|length }} de {{ total_skus }} SKUs √∫nicos (p√°gina {{ page }} de {{ total_pages }})</p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('upload') }}" class="btn btn-primary"
            data-tutorial-title="Enviar Nova Imagem"
            data-tutorial-desc="Abre a tela de upload para enviar uma nova imagem individual ao banco.">
            <i class="fas fa-cloud-upload-alt"></i> Enviar Nova
        </a>
        <button class="btn"
            style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);"
            data-tutorial-title="Exportar para CSV"
            data-tutorial-desc="Exporta os dados filtrados do cat√°logo em formato CSV para uso em planilhas e outros sistemas.">
            <i class="fas fa-file-export"></i> Exportar para CSV
        </button>
    </div>
</div>

<div style="display: flex; gap: 2rem;">
    <!-- Filters Sidebar -->
    <div style="width: 250px; flex-shrink: 0;">
        <form action="{{ url_for('catalog') }}" method="GET" style="margin-bottom: 1.5rem;"
            data-tutorial-title="Filtros de Busca"
            data-tutorial-desc="Use os filtros para encontrar imagens espec√≠ficas. Combine busca por texto com cole√ß√£o, marca e status.">
            <h3 style="font-size: 1rem; margin-bottom: 1rem;">Filtros</h3>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Buscar</label>
                <input type="text" name="q" class="form-control" placeholder="SKU, descri√ß√£o, tags..." value="{{ search_query or '' }}"
                    data-tutorial-title="Campo de Busca"
                    data-tutorial-desc="Digite SKU, descri√ß√£o, tags ou qualquer texto para buscar nas imagens. A busca √© feita em todos os campos.">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Cole√ß√£o</label>
                <select name="collection_id" class="form-control"
                    data-tutorial-title="Filtro por Cole√ß√£o"
                    data-tutorial-desc="Selecione uma cole√ß√£o espec√≠fica para ver apenas as imagens dessa temporada ou linha de produtos.">
                    <option value="all">Todas as Cole√ß√µes</option>
                    {% for collection in collections %}
                    <option value="{{ collection.id }}" {% if request.args.get('collection_id')==collection.id|string %}selected{% endif %}>
                        {{ collection.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Marca</label>
                <select name="brand_id" class="form-control"
                    data-tutorial-title="Filtro por Marca"
                    data-tutorial-desc="Selecione uma marca espec√≠fica para ver apenas os produtos desse fabricante ou fornecedor.">
                    <option value="all">Todas as Marcas</option>
                    {% for brand in brands %}
                    <option value="{{ brand.id }}" {% if request.args.get('brand_id')==brand.id|string %}selected{% endif %}>
                        {{ brand.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Status</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <input type="checkbox" name="status" value="Aprovado" {% if 'Aprovado' in request.args.getlist('status') %}checked{% endif %}> Aprovado
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <input type="checkbox" name="status" value="Pendente" {% if 'Pendente' in request.args.getlist('status') %}checked{% endif %}> Pendente
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <input type="checkbox" name="status" value="Pendente An√°lise IA" {% if 'Pendente An√°lise IA' in request.args.getlist('status') %}checked{% endif %}> Pendente An√°lise IA
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <input type="checkbox" name="status" value="Rejeitado" {% if 'Rejeitado' in request.args.getlist('status') %}checked{% endif %}> Rejeitado
                    </label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">Aplicar Filtros</button>
            <a href="{{ url_for('catalog') }}" class="btn" style="width: 100%; justify-content: center; margin-top: 0.5rem; border: 1px solid var(--border-color); color: var(--text-primary);">Limpar</a>
        </form>
    </div>

    <!-- Image Grid -->
    <div style="flex: 1;">
        <div class="image-grid">
            {% for group in sku_groups %}
            <div class="image-card sku-card" data-sku="{{ group.sku_base }}" data-image-ids="{{ group.images|map(attribute='id')|list|join(',') }}">
                <div class="carousel-container">
                    <div class="carousel-track" data-index="0">
                        {% for img in group.images %}
                        <div class="carousel-slide {% if loop.first %}active{% endif %}">
                            <a href="{{ url_for('image_detail', id=img.id) }}">
                                <img data-src="{{ url_for('serve_thumbnail', image_id=img.id) }}" 
                                     {% if loop.first %}src="{{ url_for('serve_thumbnail', image_id=img.id) }}"{% endif %}
                                     class="image-preview carousel-image"
                                     alt="{{ img.original_name }}"
                                     loading="lazy">
                            </a>
                            <div class="carousel-image-status status-badge status-{{ img.status.lower().replace(' ', '-') }}">
                                {{ img.sequencia or loop.index }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if group.images|length > 1 %}
                    <button class="carousel-nav carousel-prev" onclick="carouselNav(this, -1); event.stopPropagation();" aria-label="Anterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-nav carousel-next" onclick="carouselNav(this, 1); event.stopPropagation();" aria-label="Pr√≥ximo">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <div class="carousel-dots">
                        {% for img in group.images %}
                        <span class="carousel-dot {% if loop.first %}active{% endif %}" data-index="{{ loop.index0 }}"></span>
                        {% endfor %}
                    </div>
                    
                    <div class="carousel-counter">
                        <span class="current-index">1</span> / {{ group.images|length }}
                    </div>
                    {% endif %}
                    
                    <div class="card-select-checkbox" style="position: absolute; top: 8px; left: 8px; z-index: 15;">
                        <input type="checkbox" class="sku-checkbox" data-sku="{{ group.sku_base }}" 
                               style="width: 20px; height: 20px; cursor: pointer; accent-color: #a371f7;"
                               onclick="event.stopPropagation(); toggleSelection(this);">
                    </div>
                    
                    <button class="card-ai-btn" onclick="event.stopPropagation(); selectAndAnalyze(this);" title="Gerar Descri√ß√£o com IA">
                        <i class="fas fa-magic"></i>
                    </button>
                </div>
                
                <div class="image-info">
                    <div class="image-title">{{ group.sku_base }}</div>
                    <div class="image-meta">{{ group.brand }}</div>
                    <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px;">
                        {% if group.has_approved %}
                        <span class="status-indicator status-approved" title="Aprovado"></span>
                        {% endif %}
                        {% if group.has_pending %}
                        <span class="status-indicator status-pending" title="Pendente"></span>
                        {% endif %}
                        {% if group.has_rejected %}
                        <span class="status-indicator status-rejected" title="Rejeitado"></span>
                        {% endif %}
                        {% if group.needs_ai %}
                        <span class="status-indicator status-needs-ai" title="Sem descri√ß√£o IA"></span>
                        {% endif %}
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">{{ group.images|length }} foto{% if group.images|length > 1 %}s{% endif %}</span>
                    </div>
                    <div style="margin-top: 0.5rem; display: flex; gap: 4px; flex-wrap: wrap;">
                        {% for tag in group.tag_list[:3] %}
                        <span style="font-size: 0.7rem; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">{{ tag }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div style="grid-column: 1 / -1; text-align: center; padding: 4rem; color: var(--text-secondary);">
                <i class="far fa-images" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>Nenhuma imagem encontrada. Envie algumas imagens para come√ßar.</p>
            </div>
            {% endfor %}
        </div>
        
        {% if total_pages > 1 %}
        <div class="pagination" style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem; margin-bottom: 80px;">
            {% if page > 1 %}
            <a href="{{ url_for('catalog', page=page-1, q=search_query, collection_id=request.args.get('collection_id'), brand_id=request.args.get('brand_id'), status=request.args.getlist('status')) }}" class="btn" style="background: var(--bg-secondary); border: 1px solid var(--border-color);">
                <i class="fas fa-chevron-left"></i> Anterior
            </a>
            {% endif %}
            
            <span style="display: flex; align-items: center; padding: 0 1rem; color: var(--text-secondary);">
                P√°gina {{ page }} de {{ total_pages }}
            </span>
            
            {% if page < total_pages %}
            <a href="{{ url_for('catalog', page=page+1, q=search_query, collection_id=request.args.get('collection_id'), brand_id=request.args.get('brand_id'), status=request.args.getlist('status')) }}" class="btn" style="background: var(--bg-secondary); border: 1px solid var(--border-color);">
                Pr√≥xima <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<div id="selectionBar" class="selection-bar" style="display: none;">
    <div class="selection-bar-content">
        <span class="selection-count">
            <i class="fas fa-check-circle"></i>
            <span id="selectedCount">0</span> SKU(s) selecionado(s)
        </span>
        <div class="selection-actions">
            <button class="btn selection-btn-ai" onclick="openBatchAnalyzeModal()">
                <i class="fas fa-magic"></i> Gerar Descri√ß√£o IA
            </button>
            <button class="btn selection-btn-clear" onclick="clearSelection()">
                <i class="fas fa-times"></i> Limpar
            </button>
        </div>
    </div>
</div>

<div id="batchAnalyzeModal" class="batch-modal" style="display: none;">
    <div class="batch-modal-content">
        <div class="batch-modal-header">
            <h3>
                <i class="fas fa-magic" style="color: #a371f7;"></i> An√°lise de IA em Lote
            </h3>
            <button onclick="closeBatchAnalyzeModal()" class="batch-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="modalConfigSection">
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                <span id="modalSkuCount">0</span> SKU(s) selecionado(s) ser√£o analisados.
            </p>
            
            <div class="batch-field-options">
                <label class="batch-field-option batch-field-all">
                    <input type="checkbox" id="batchAllFields" onchange="toggleBatchAllFields(this.checked)">
                    <span><i class="fas fa-check-double"></i> Todos os campos</span>
                </label>
                
                <div class="batch-field-separator"></div>
                
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="descricao" class="batch-field-checkbox" checked>
                    <span>Descri√ß√£o/Observa√ß√µes</span>
                </label>
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="tags" class="batch-field-checkbox">
                    <span>Tags</span>
                </label>
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="cor" class="batch-field-checkbox">
                    <span>Cor</span>
                </label>
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="tipo" class="batch-field-checkbox">
                    <span>Tipo de Pe√ßa</span>
                </label>
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="material" class="batch-field-checkbox">
                    <span>Material</span>
                </label>
            </div>
            
            <div class="batch-modal-actions">
                <button type="button" onclick="closeBatchAnalyzeModal()" class="btn" style="flex: 1; background: var(--bg-tertiary); color: var(--text-primary);">
                    Cancelar
                </button>
                <button type="button" id="startBatchAnalysis" onclick="startBatchAnalysis()" class="btn" style="flex: 1; background: #a371f7; color: white;">
                    <i class="fas fa-magic"></i> Iniciar An√°lise
                </button>
            </div>
        </div>
        
        <div id="modalProgressSection" style="display: none;">
            <div class="batch-progress-container">
                <div class="batch-progress-header">
                    <span id="progressText">Processando...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="batch-progress-bar">
                    <div id="progressFill" class="batch-progress-fill" style="width: 0%;"></div>
                </div>
                <div class="batch-progress-details">
                    <span id="progressDetails">0 de 0 imagens</span>
                </div>
            </div>
            
            <div id="progressLog" class="batch-progress-log"></div>
            
            <div id="progressComplete" class="batch-progress-complete" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span id="completeMessage">An√°lise conclu√≠da!</span>
            </div>
            
            <div class="batch-modal-actions" id="progressActions" style="display: none;">
                <button type="button" onclick="closeBatchAnalyzeModal(); location.reload();" class="btn" style="width: 100%; background: #a371f7; color: white;">
                    <i class="fas fa-check"></i> Conclu√≠do
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.carousel-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px 8px 0 0;
}

.carousel-track {
    display: flex;
    transition: transform 0.3s ease;
}

.carousel-slide {
    min-width: 100%;
    position: relative;
}

.carousel-slide:not(.active) {
    display: none;
}

.carousel-image {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
}

.carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.6);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s, background 0.2s;
    z-index: 10;
}

.carousel-container:hover .carousel-nav {
    opacity: 1;
}

.carousel-nav:hover {
    background: rgba(0, 0, 0, 0.8);
}

.carousel-prev {
    left: 8px;
}

.carousel-next {
    right: 8px;
}

.carousel-dots {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 4px;
    z-index: 10;
}

.carousel-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
}

.carousel-dot.active {
    background: white;
    transform: scale(1.2);
}

.carousel-counter {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    z-index: 10;
}

.carousel-image-status {
    position: absolute;
    bottom: 24px;
    right: 8px;
    font-size: 0.7rem;
    padding: 2px 6px;
}

.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-indicator.status-approved {
    background: #3fb950;
}

.status-indicator.status-pending {
    background: #d29922;
}

.status-indicator.status-rejected {
    background: #f85149;
}

.status-indicator.status-needs-ai {
    background: #a371f7;
}

.status-pendente-an√°lise-ia {
    background: #9333ea !important;
    color: white;
}

.card-ai-btn {
    position: absolute;
    bottom: 32px;
    left: 8px;
    background: rgba(163, 113, 247, 0.9);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s, background 0.2s, transform 0.2s;
    z-index: 15;
    font-size: 0.8rem;
}

.carousel-container:hover .card-ai-btn {
    opacity: 1;
}

.card-ai-btn:hover {
    background: #a371f7;
    transform: scale(1.1);
}

.sku-card.selected {
    outline: 3px solid #a371f7;
    outline-offset: -3px;
}

.sku-card.selected .carousel-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(163, 113, 247, 0.1);
    pointer-events: none;
    z-index: 5;
}

.selection-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, rgba(30, 30, 40, 0.98) 0%, rgba(40, 30, 50, 0.98) 100%);
    border-top: 1px solid rgba(163, 113, 247, 0.3);
    padding: 16px 24px;
    z-index: 1000;
    animation: slideUp 0.3s ease;
    backdrop-filter: blur(10px);
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.selection-bar-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.selection-count {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #a371f7;
    font-weight: 600;
    font-size: 1rem;
}

.selection-actions {
    display: flex;
    gap: 12px;
}

.selection-btn-ai {
    background: linear-gradient(135deg, #a371f7 0%, #8b5cf6 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    font-weight: 500;
}

.selection-btn-ai:hover {
    background: linear-gradient(135deg, #b794f6 0%, #a371f7 100%);
}

.selection-btn-clear {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.batch-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.batch-modal-content {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 28px;
    max-width: 450px;
    width: 90%;
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.batch-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.batch-modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.batch-modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 4px;
}

.batch-modal-close:hover {
    color: var(--text-primary);
}

.batch-field-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 24px;
}

.batch-field-option {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    padding: 10px 14px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    transition: background 0.2s;
}

.batch-field-option:hover {
    background: rgba(163, 113, 247, 0.1);
}

.batch-field-option input {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #a371f7;
}

.batch-field-all {
    background: rgba(163, 113, 247, 0.15);
    border: 1px solid rgba(163, 113, 247, 0.3);
}

.batch-field-all span {
    font-weight: 500;
}

.batch-field-separator {
    border-top: 1px solid var(--border-color);
    margin: 8px 0;
}

.batch-modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}

.batch-progress-container {
    margin-bottom: 20px;
}

.batch-progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.batch-progress-bar {
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
}

.batch-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #a371f7 0%, #8b5cf6 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.batch-progress-details {
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-align: center;
}

.batch-progress-log {
    max-height: 150px;
    overflow-y: auto;
    background: var(--bg-tertiary);
    border-radius: 8px;
    padding: 12px;
    font-size: 0.8rem;
    font-family: monospace;
    margin-bottom: 16px;
}

.batch-progress-log .log-success {
    color: #3fb950;
}

.batch-progress-log .log-error {
    color: #f85149;
}

.batch-progress-log .log-info {
    color: var(--text-secondary);
}

.batch-progress-complete {
    text-align: center;
    padding: 20px;
    color: #3fb950;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.batch-progress-complete i {
    font-size: 1.5rem;
}
</style>

<script>
let selectedSkus = new Set();

function toggleSelection(checkbox) {
    const card = checkbox.closest('.sku-card');
    const sku = card.dataset.sku;
    
    if (checkbox.checked) {
        selectedSkus.add(sku);
        card.classList.add('selected');
    } else {
        selectedSkus.delete(sku);
        card.classList.remove('selected');
    }
    
    updateSelectionBar();
}

function selectAndAnalyze(btn) {
    const card = btn.closest('.sku-card');
    const sku = card.dataset.sku;
    const checkbox = card.querySelector('.sku-checkbox');
    
    if (!checkbox.checked) {
        checkbox.checked = true;
        selectedSkus.add(sku);
        card.classList.add('selected');
        updateSelectionBar();
    }
    
    openBatchAnalyzeModal();
}

function updateSelectionBar() {
    const bar = document.getElementById('selectionBar');
    const count = document.getElementById('selectedCount');
    
    if (selectedSkus.size > 0) {
        bar.style.display = 'block';
        count.textContent = selectedSkus.size;
    } else {
        bar.style.display = 'none';
    }
}

function clearSelection() {
    selectedSkus.clear();
    document.querySelectorAll('.sku-checkbox').forEach(cb => {
        cb.checked = false;
    });
    document.querySelectorAll('.sku-card').forEach(card => {
        card.classList.remove('selected');
    });
    updateSelectionBar();
}

function openBatchAnalyzeModal() {
    if (selectedSkus.size === 0) {
        alert('Selecione pelo menos um SKU para analisar.');
        return;
    }
    
    document.getElementById('modalSkuCount').textContent = selectedSkus.size;
    document.getElementById('modalConfigSection').style.display = 'block';
    document.getElementById('modalProgressSection').style.display = 'none';
    document.getElementById('batchAnalyzeModal').style.display = 'flex';
}

function closeBatchAnalyzeModal() {
    document.getElementById('batchAnalyzeModal').style.display = 'none';
}

function toggleBatchAllFields(checked) {
    document.querySelectorAll('.batch-field-checkbox').forEach(cb => {
        cb.checked = checked;
    });
}

function getSelectedImageIds() {
    const imageIds = [];
    selectedSkus.forEach(sku => {
        const card = document.querySelector(`.sku-card[data-sku="${sku}"]`);
        if (card && card.dataset.imageIds) {
            const ids = card.dataset.imageIds.split(',').filter(id => id);
            imageIds.push(...ids);
        }
    });
    return imageIds;
}

function getSelectedFields() {
    const allFields = document.getElementById('batchAllFields').checked;
    if (allFields) {
        return ['descricao', 'tags', 'cor', 'tipo', 'material'];
    }
    
    const fields = [];
    document.querySelectorAll('.batch-field-checkbox:checked').forEach(cb => {
        fields.push(cb.value);
    });
    return fields;
}

async function startBatchAnalysis() {
    const imageIds = getSelectedImageIds();
    const fields = getSelectedFields();
    
    if (imageIds.length === 0) {
        alert('Nenhuma imagem encontrada nos SKUs selecionados.');
        return;
    }
    
    if (fields.length === 0) {
        alert('Selecione pelo menos um campo para preencher.');
        return;
    }
    
    document.getElementById('modalConfigSection').style.display = 'none';
    document.getElementById('modalProgressSection').style.display = 'block';
    document.getElementById('progressActions').style.display = 'none';
    document.getElementById('progressComplete').style.display = 'none';
    
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const progressPercent = document.getElementById('progressPercent');
    const progressDetails = document.getElementById('progressDetails');
    const progressLog = document.getElementById('progressLog');
    
    progressLog.innerHTML = '';
    progressFill.style.width = '0%';
    progressText.textContent = 'Iniciando an√°lise...';
    progressDetails.textContent = `0 de ${imageIds.length} imagens`;
    
    let successCount = 0;
    let errorCount = 0;
    
    for (let i = 0; i < imageIds.length; i++) {
        const imageId = imageIds[i];
        const percent = Math.round(((i + 1) / imageIds.length) * 100);
        
        progressText.textContent = `Analisando imagem ${i + 1} de ${imageIds.length}...`;
        progressPercent.textContent = `${percent}%`;
        progressDetails.textContent = `${i + 1} de ${imageIds.length} imagens`;
        progressFill.style.width = `${percent}%`;
        
        try {
            const response = await fetch('/api/analyze-single', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_id: parseInt(imageId),
                    fields: fields
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                successCount++;
                addLogEntry(progressLog, `‚úì Imagem ${imageId}: ${result.message || 'Analisada com sucesso'}`, 'success');
            } else {
                errorCount++;
                addLogEntry(progressLog, `‚úó Imagem ${imageId}: ${result.error || 'Erro desconhecido'}`, 'error');
            }
        } catch (err) {
            errorCount++;
            addLogEntry(progressLog, `‚úó Imagem ${imageId}: Erro de conex√£o`, 'error');
        }
        
        progressLog.scrollTop = progressLog.scrollHeight;
    }
    
    progressText.textContent = 'An√°lise conclu√≠da!';
    progressPercent.textContent = '100%';
    progressFill.style.width = '100%';
    
    document.getElementById('progressComplete').style.display = 'flex';
    document.getElementById('completeMessage').textContent = 
        `${successCount} sucesso, ${errorCount} erro(s)`;
    document.getElementById('progressActions').style.display = 'flex';
}

function addLogEntry(container, message, type) {
    const entry = document.createElement('div');
    entry.className = `log-${type}`;
    entry.textContent = message;
    container.appendChild(entry);
}

function carouselNav(btn, direction) {
    const container = btn.closest('.carousel-container');
    const track = container.querySelector('.carousel-track');
    const slides = container.querySelectorAll('.carousel-slide');
    const dots = container.querySelectorAll('.carousel-dot');
    const counter = container.querySelector('.current-index');
    
    let currentIndex = parseInt(track.dataset.index) || 0;
    let newIndex = currentIndex + direction;
    
    if (newIndex < 0) newIndex = slides.length - 1;
    if (newIndex >= slides.length) newIndex = 0;
    
    slides[currentIndex].classList.remove('active');
    slides[newIndex].classList.add('active');
    
    const img = slides[newIndex].querySelector('img');
    if (img.dataset.src && !img.src) {
        img.src = img.dataset.src;
    }
    
    if (dots.length > 0) {
        dots[currentIndex].classList.remove('active');
        dots[newIndex].classList.add('active');
    }
    
    if (counter) {
        counter.textContent = newIndex + 1;
    }
    
    track.dataset.index = newIndex;
}

document.addEventListener('DOMContentLoaded', function() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                }
                observer.unobserve(img);
            }
        });
    }, { rootMargin: '100px' });
    
    document.querySelectorAll('.carousel-slide.active img[data-src]').forEach(img => {
        observer.observe(img);
    });
    
    document.querySelectorAll('.carousel-dot').forEach(dot => {
        dot.addEventListener('click', function() {
            const container = this.closest('.carousel-container');
            const track = container.querySelector('.carousel-track');
            const slides = container.querySelectorAll('.carousel-slide');
            const dots = container.querySelectorAll('.carousel-dot');
            const counter = container.querySelector('.current-index');
            
            const currentIndex = parseInt(track.dataset.index) || 0;
            const newIndex = parseInt(this.dataset.index);
            
            if (currentIndex === newIndex) return;
            
            slides[currentIndex].classList.remove('active');
            slides[newIndex].classList.add('active');
            
            const img = slides[newIndex].querySelector('img');
            if (img.dataset.src) {
                img.src = img.dataset.src;
            }
            
            dots[currentIndex].classList.remove('active');
            dots[newIndex].classList.add('active');
            
            if (counter) {
                counter.textContent = newIndex + 1;
            }
            
            track.dataset.index = newIndex;
        });
    });
});
</script>
{% endblock %}

================================================================================
FILE: templates/images/detail.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
        Cole√ß√µes / {{ image.collection.name if image.collection else 'Sem Categoria' }} / {{ image.original_name }}
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>{{ image.original_name }}</h1>
        <div style="display: flex; gap: 1rem;">
            <a href="{{ url_for('edit_image', id=image.id) }}" class="btn" style="background: var(--accent-blue); color: white;">
                <i class="fas fa-edit"></i> Editar
            </a>
            <a href="{{ image.image_url }}" download class="btn" style="background: var(--bg-tertiary); color: var(--text-primary);">
                <i class="fas fa-download"></i> Baixar
            </a>
            <button onclick="copyToClipboard('direct-url')" class="btn" style="background: var(--bg-tertiary); color: var(--text-primary);">
                <i class="fas fa-link"></i> Copiar Link
            </button>
            <button type="button" class="btn" style="background: rgba(130, 80, 223, 0.15); color: #a371f7; border: 1px solid rgba(130, 80, 223, 0.4);"
                onclick="openAnalyzeModal()">
                <i class="fas fa-magic"></i> Analisar IA
            </button>
            <form action="{{ url_for('delete_image', id=image.id) }}" method="POST" style="display: inline;"
                onsubmit="return confirm('Tem certeza que deseja deletar esta imagem? Esta a√ß√£o n√£o pode ser desfeita.');">
                <button type="submit" class="btn"
                    style="background: rgba(248, 81, 73, 0.1); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.4);">
                    <i class="fas fa-trash-alt"></i> Deletar
                </button>
            </form>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Image View -->
    <div class="stat-card"
        style="padding: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; background: black; height: 600px; position: relative;">
        <img src="{{ image.image_url }}"
            style="max-width: 100%; max-height: 100%; object-fit: contain;">
        
        {% if group_images %}
        <div style="position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 20px;">
            {% if prev_image %}
            <a href="{{ url_for('image_detail', id=prev_image.id) }}" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                <i class="fas fa-chevron-left"></i> Anterior
            </a>
            {% else %}
            <span style="color: rgba(255,255,255,0.3); display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                <i class="fas fa-chevron-left"></i> Anterior
            </span>
            {% endif %}
            
            <span style="color: white; font-size: 0.85rem; padding: 0 8px;">
                {{ current_index + 1 }} / {{ group_images|length }}
            </span>
            
            {% if next_image %}
            <a href="{{ url_for('image_detail', id=next_image.id) }}" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                Pr√≥xima <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <span style="color: rgba(255,255,255,0.3); display: flex; align-items: center; gap: 4px; font-size: 0.9rem;">
                Pr√≥xima <i class="fas fa-chevron-right"></i>
            </span>
            {% endif %}
        </div>
        
        <div style="position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px;">
            {% for img in group_images %}
            <a href="{{ url_for('image_detail', id=img.id) }}" 
               style="width: 40px; height: 40px; border-radius: 4px; overflow: hidden; border: 2px solid {% if img.id == image.id %}var(--accent-blue){% else %}transparent{% endif %}; opacity: {% if img.id == image.id %}1{% else %}0.6{% endif %};">
                <img src="{{ url_for('serve_thumbnail', image_id=img.id) }}" 
                     style="width: 100%; height: 100%; object-fit: cover;">
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Metadata Sidebar -->
    <div class="stat-card">
        <div style="border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; padding-bottom: 0.5rem;">
            <div style="display: flex; gap: 1.5rem; font-size: 0.9rem; font-weight: 500;">
                <span id="tab-metadata" class="tab-button active-tab"
                    style="cursor: pointer; padding-bottom: 6px; transition: all 0.3s; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue);"
                    onclick="switchTab('metadata')">Metadados</span>
                <span id="tab-ai" class="tab-button"
                    style="cursor: pointer; padding-bottom: 6px; transition: all 0.3s; color: var(--text-secondary); border-bottom: 2px solid transparent;"
                    onclick="switchTab('ai')">IA & Tags</span>
                <span id="tab-links" class="tab-button"
                    style="cursor: pointer; padding-bottom: 6px; transition: all 0.3s; color: var(--text-secondary); border-bottom: 2px solid transparent;"
                    onclick="switchTab('links')">Links</span>
            </div>
        </div>


        <!-- Tab Content: Metadados -->
        <div id="content-metadata" class="tab-content" style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Nome da Cole√ß√£o</span>
                <span>{{ image.collection.name if image.collection else '-' }}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Nome da Marca</span>
                <span>{{ image.brand_ref.name if image.brand_ref else '-' }}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">SKU</span>
                <span>{{ image.sku or '-' }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--text-secondary);">Status</span>
                <span class="status-badge status-{{ image.status.lower() }}">{{ image.status }}</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                <form action="{{ url_for('update_image_status', id=image.id, status='Aprovado') }}" method="POST" style="flex: 1;">
                    <button type="submit" class="btn" style="width: 100%; background: rgba(63, 185, 80, 0.1); color: #3fb950; border: 1px solid rgba(63, 185, 80, 0.3); font-size: 0.8rem;">
                        <i class="fas fa-check"></i> Aprovar
                    </button>
                </form>
                <form action="{{ url_for('update_image_status', id=image.id, status='Rejeitado') }}" method="POST" style="flex: 1;">
                    <button type="submit" class="btn" style="width: 100%; background: rgba(248, 81, 73, 0.1); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.3); font-size: 0.8rem;">
                        <i class="fas fa-times"></i> Rejeitar
                    </button>
                </form>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Data de Upload</span>
                <span>{{ image.upload_date.strftime('%Y-%m-%d') }}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-secondary);">Enviado por</span>
                <span>{{ image.uploader_id }}</span>
            </div>

            <div style="margin-top: 1rem;">
                <span style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Observa√ß√µes</span>
                <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 6px; font-size: 0.9rem;">
                    {{ image.description or 'Sem observa√ß√µes.' }}
                </div>
            </div>

            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <h4 style="font-size: 0.95rem; margin-bottom: 1rem;">Detalhes T√©cnicos</h4>
                {% if image.nome_peca %}
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                    <span style="color: var(--text-secondary);">Nome da Pe√ßa</span>
                    <span style="font-weight: 500; color: var(--accent-green);">{{ image.nome_peca }}</span>
                </div>
                {% endif %}
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                    <span style="color: var(--text-secondary);">Formato</span>
                    <span>{{ image.filename.split('.')[-1].upper() }}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                    <span style="color: var(--text-secondary);">Nome do Arquivo</span>
                    <span style="font-size: 0.8rem;">{{ image.filename }}</span>
                </div>
            </div>
        </div>

        <!-- Tab Content: IA & Tags -->
        <div id="content-ai" class="tab-content" style="display: none; flex-direction: column; gap: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h4 style="font-size: 0.95rem; display: flex; align-items: center; gap: 8px; margin: 0;">
                    <i class="fas fa-magic" style="color: var(--accent-blue);"></i>
                    An√°lise de IA
                </h4>
                <button type="button" class="btn" style="background: rgba(130, 80, 223, 0.1); color: #a371f7; border: 1px solid rgba(130, 80, 223, 0.3); font-size: 0.75rem; padding: 4px 10px;"
                    onclick="openAnalyzeModal()">
                    <i class="fas fa-sync-alt"></i> Re-analisar
                </button>
            </div>
            
            {% if image.items and image.items|length > 0 %}
            <div style="background: rgba(130, 80, 223, 0.1); border: 1px solid rgba(130, 80, 223, 0.3); border-radius: 6px; padding: 8px 12px; margin-bottom: 0.5rem;">
                <span style="color: #a371f7; font-size: 0.85rem;">
                    <i class="fas fa-layer-group"></i> {{ image.items|length }} pe√ßa(s) detectada(s) nesta imagem
                </span>
            </div>
            
            {% for item in image.items|sort(attribute='item_order') %}
            <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 3px solid var(--accent-blue);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <span style="font-weight: 600; color: var(--accent-blue); font-size: 0.9rem;">
                        <i class="fas fa-tshirt"></i> {{ item.position_ref or 'Pe√ßa ' ~ item.item_order }}
                    </span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">#{{ item.item_order }}</span>
                        {% if image.items|length > 1 %}
                        <form action="{{ url_for('delete_image_item', image_id=image.id, item_id=item.id) }}" method="POST" style="margin: 0;"
                            onsubmit="return confirm('Remover esta pe√ßa?');">
                            <button type="submit" style="background: rgba(220, 53, 69, 0.1); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.3); 
                                font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; cursor: pointer;" title="Remover pe√ßa">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                
                {% if item.tag_list %}
                <div style="margin-bottom: 0.75rem;">
                    <span style="color: var(--text-secondary); display: block; font-size: 0.75rem; margin-bottom: 0.3rem;">Tags</span>
                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                        {% for tag in item.tag_list %}
                        <span style="font-size: 0.7rem; background: var(--bg-secondary); padding: 2px 8px; border-radius: 10px; color: var(--text-primary);">{{ tag }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                    {% if item.ai_item_type %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.7rem;">Tipo</span>
                        <span style="font-weight: 500;">{{ item.ai_item_type }}</span>
                    </div>
                    {% endif %}
                    {% if item.ai_color %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.7rem;">Cor</span>
                        <span style="font-weight: 500;">{{ item.ai_color }}</span>
                    </div>
                    {% endif %}
                    {% if item.ai_material %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.7rem;">Material</span>
                        <span style="font-weight: 500;">{{ item.ai_material }}</span>
                    </div>
                    {% endif %}
                    {% if item.ai_pattern %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.7rem;">Padr√£o</span>
                        <span style="font-weight: 500;">{{ item.ai_pattern }}</span>
                    </div>
                    {% endif %}
                    {% if item.ai_style %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.7rem;">Estilo</span>
                        <span style="font-weight: 500;">{{ item.ai_style }}</span>
                    </div>
                    {% endif %}
                </div>
                
                {% if item.description %}
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                    <span style="color: var(--text-secondary); display: block; font-size: 0.7rem; margin-bottom: 0.3rem;">Descri√ß√£o</span>
                    <p style="font-size: 0.8rem; color: var(--text-primary); margin: 0; line-height: 1.4;">{{ item.description }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            
            {% else %}
            <div>
                <span style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Tags IA</span>
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    {% for tag in image.tag_list %}
                    <span style="font-size: 0.8rem; background: var(--bg-tertiary); padding: 4px 10px; border-radius: 12px; color: var(--text-primary);">{{ tag }}</span>
                    {% else %}
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Nenhuma tag gerada.</span>
                    {% endfor %}
                </div>
            </div>

            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <h4 style="font-size: 0.9rem; margin-bottom: 0.75rem;">Atributos Extra√≠dos</h4>
                {% if image.ai_item_type or image.ai_color or image.ai_material or image.ai_pattern or image.ai_style %}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem;">
                    {% if image.ai_item_type %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Tipo de Item</span>
                        <span style="font-weight: 500;">{{ image.ai_item_type }}</span>
                    </div>
                    {% endif %}
                    {% if image.ai_color %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Cor</span>
                        <span style="font-weight: 500;">{{ image.ai_color }}</span>
                    </div>
                    {% endif %}
                    {% if image.ai_material %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Material</span>
                        <span style="font-weight: 500;">{{ image.ai_material }}</span>
                    </div>
                    {% endif %}
                    {% if image.ai_pattern %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Padr√£o</span>
                        <span style="font-weight: 500;">{{ image.ai_pattern }}</span>
                    </div>
                    {% endif %}
                    {% if image.ai_style %}
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Estilo</span>
                        <span style="font-weight: 500;">{{ image.ai_style }}</span>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Nenhum atributo IA extra√≠do. Configure a chave OpenAI em Configura√ß√µes para an√°lise autom√°tica.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Tab Content: Links -->
        <div id="content-links" class="tab-content" style="display: none; flex-direction: column; gap: 1rem;">
            <div>
                <h4 style="font-size: 0.95rem; margin-bottom: 1rem;">Links de Compartilhamento</h4>

                <div style="margin-bottom: 1.5rem;">
                    <label
                        style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">URL
                        Direta da Imagem</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="direct-url" readonly
                            value="{{ request.url_root.rstrip('/') }}{{ image.image_url }}"
                            style="flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; color: var(--text-primary); font-size: 0.85rem;">
                        <button onclick="copyToClipboard('direct-url')" class="btn"
                            style="background: var(--accent-blue); color: white;">
                            <i class="fas fa-copy"></i> Copiar
                        </button>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label
                        style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Link
                        para esta P√°gina</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="page-url" readonly value="{{ request.url }}"
                            style="flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; color: var(--text-primary); font-size: 0.85rem;">
                        <button onclick="copyToClipboard('page-url')" class="btn"
                            style="background: var(--accent-blue); color: white;">
                            <i class="fas fa-copy"></i> Copiar
                        </button>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label
                        style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">C√≥digo
                        HTML para Embed</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <textarea id="html-embed" readonly rows="3"
                            style="flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; font-family: monospace; resize: vertical;">&lt;img src="{{ request.url_root.rstrip('/') }}{{ image.image_url }}" alt="{{ image.original_name }}" /&gt;</textarea>
                        <button onclick="copyToClipboard('html-embed')" class="btn"
                            style="background: var(--accent-blue); color: white;">
                            <i class="fas fa-copy"></i> Copiar
                        </button>
                    </div>
                </div>

                <div
                    style="padding: 1rem; background: rgba(31, 111, 235, 0.05); border: 1px solid rgba(31, 111, 235, 0.2); border-radius: 6px;">
                    <div
                        style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; color: var(--accent-blue);">
                        <i class="fas fa-info-circle"></i>
                        <strong style="font-size: 0.9rem;">Dica</strong>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">Voc√™ pode compartilhar estes
                        links com sua equipe ou usar o c√≥digo HTML para incorporar a imagem em sites externos.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function switchTab(tabName) {
        // Hide all tab contents
        const contents = document.querySelectorAll('.tab-content');
        contents.forEach(content => {
            content.style.display = 'none';
        });

        // Remove active state from all tabs
        const tabs = document.querySelectorAll('.tab-button');
        tabs.forEach(tab => {
            tab.style.color = 'var(--text-secondary)';
            tab.style.borderBottom = '2px solid transparent';
        });

        // Show selected tab content
        const selectedContent = document.getElementById('content-' + tabName);
        if (selectedContent) {
            selectedContent.style.display = 'flex';
        }

        // Activate selected tab
        const selectedTab = document.getElementById('tab-' + tabName);
        if (selectedTab) {
            selectedTab.style.color = 'var(--accent-blue)';
            selectedTab.style.borderBottom = '2px solid var(--accent-blue)';
        }
    }

    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        element.select();
        element.setSelectionRange(0, 99999); // For mobile devices

        navigator.clipboard.writeText(element.value).then(() => {
            // Show temporary feedback
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
            btn.style.background = '#2da44e';

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = 'var(--accent-blue)';
            }, 2000);
        });
    }
    
    function openAnalyzeModal() {
        document.getElementById('analyzeModal').style.display = 'flex';
    }
    
    function closeAnalyzeModal() {
        document.getElementById('analyzeModal').style.display = 'none';
    }
    
    function submitAnalysis() {
        const form = document.getElementById('analyzeForm');
        const btn = document.getElementById('submitAnalyzeBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
        btn.disabled = true;
        form.submit();
    }
    
    function toggleAllFields(checked) {
        const checkboxes = document.querySelectorAll('.field-checkbox');
        checkboxes.forEach(cb => cb.checked = checked);
    }
</script>

<div id="analyzeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; font-size: 1.1rem;">
                <i class="fas fa-magic" style="color: #a371f7;"></i> An√°lise de IA
            </h3>
            <button onclick="closeAnalyzeModal()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
            Selecione os campos que deseja preencher com IA:
        </p>
        
        <form id="analyzeForm" action="{{ url_for('reanalyze_image', id=image.id) }}" method="POST">
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px;">
                    <input type="checkbox" name="all_fields" onchange="toggleAllFields(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: 500;"><i class="fas fa-check-double"></i> Todos os campos</span>
                </label>
                
                <div style="border-top: 1px solid var(--border-color); padding-top: 10px; display: flex; flex-direction: column; gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 6px 12px;">
                        <input type="checkbox" name="fields" value="descricao" class="field-checkbox" checked style="width: 16px; height: 16px; cursor: pointer;">
                        <span>Descri√ß√£o/Observa√ß√µes</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 6px 12px;">
                        <input type="checkbox" name="fields" value="tags" class="field-checkbox" style="width: 16px; height: 16px; cursor: pointer;">
                        <span>Tags</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 6px 12px;">
                        <input type="checkbox" name="fields" value="cor" class="field-checkbox" style="width: 16px; height: 16px; cursor: pointer;">
                        <span>Cor</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 6px 12px;">
                        <input type="checkbox" name="fields" value="tipo" class="field-checkbox" style="width: 16px; height: 16px; cursor: pointer;">
                        <span>Tipo de Pe√ßa</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 6px 12px;">
                        <input type="checkbox" name="fields" value="material" class="field-checkbox" style="width: 16px; height: 16px; cursor: pointer;">
                        <span>Material</span>
                    </label>
                </div>
            </div>
            
            {% if image.nome_peca %}
            <div style="background: rgba(46, 160, 67, 0.1); border: 1px solid rgba(46, 160, 67, 0.3); border-radius: 6px; padding: 10px; margin-bottom: 16px;">
                <p style="margin: 0; font-size: 0.8rem; color: #3fb950;">
                    <i class="fas fa-info-circle"></i> Esta imagem tem dados da Carteira. Campos como categoria, subcategoria e origem N√ÉO ser√£o sobrescritos.
                </p>
            </div>
            {% endif %}
            
            <div style="display: flex; gap: 10px;">
                <button type="button" onclick="closeAnalyzeModal()" class="btn" style="flex: 1; background: var(--bg-tertiary); color: var(--text-primary);">
                    Cancelar
                </button>
                <button type="button" id="submitAnalyzeBtn" onclick="submitAnalysis()" class="btn" style="flex: 1; background: #a371f7; color: white;">
                    <i class="fas fa-magic"></i> Analisar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

================================================================================
FILE: templates/images/edit.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
        <a href="{{ url_for('catalog') }}" style="color: var(--text-secondary); text-decoration: none;">Cat√°logo</a> / 
        <a href="{{ url_for('image_detail', id=image.id) }}" style="color: var(--text-secondary); text-decoration: none;">{{ image.original_name }}</a> / 
        Editar
    </div>
    <h1>Editar Imagem</h1>
</div>

<div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem;">
    <div class="stat-card" style="padding: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; background: black; height: 300px;">
        <img src="{{ image.image_url }}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
    </div>

    <div class="stat-card">
        <form action="{{ url_for('edit_image', id=image.id) }}" method="POST">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div>
                    <label class="form-label">SKU / C√≥digo do Produto</label>
                    <input type="text" name="sku" class="form-control" value="{{ image.sku or '' }}" placeholder="Ex: CAMISA-001">
                </div>
                
                <div>
                    <label class="form-label">C√≥digo √önico</label>
                    <input type="text" class="form-control" value="{{ image.unique_code or '-' }}" disabled style="background: var(--bg-tertiary); cursor: not-allowed;">
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">Gerado automaticamente</small>
                </div>
                
                <div>
                    <label class="form-label">Cole√ß√£o</label>
                    <select name="collection_id" class="form-control">
                        <option value="">Sem cole√ß√£o</option>
                        {% for collection in collections %}
                        <option value="{{ collection.id }}" {% if image.collection_id == collection.id %}selected{% endif %}>
                            {{ collection.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="form-label">Marca</label>
                    <select name="brand_id" class="form-control">
                        <option value="">Sem marca</option>
                        {% for brand in brands %}
                        <option value="{{ brand.id }}" {% if image.brand_id == brand.id %}selected{% endif %}>
                            {{ brand.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="form-label">Fot√≥grafo</label>
                    <input type="text" name="photographer" class="form-control" value="{{ image.photographer or '' }}" placeholder="Nome do fot√≥grafo">
                </div>
                
                <div>
                    <label class="form-label">Data do Shooting</label>
                    <input type="date" name="shooting_date" class="form-control" value="{{ image.shooting_date.strftime('%Y-%m-%d') if image.shooting_date else '' }}">
                </div>
            </div>
            
            <div style="margin-top: 1.5rem;">
                <label class="form-label">Descri√ß√£o / Observa√ß√µes</label>
                <textarea name="description" class="form-control" rows="4" placeholder="Descri√ß√£o detalhada do produto ou observa√ß√µes...">{{ image.description or '' }}</textarea>
            </div>
            
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <h4 style="font-size: 0.95rem; margin-bottom: 1rem; color: var(--text-secondary);">
                    <i class="fas fa-robot"></i> Atributos da IA (somente leitura)
                </h4>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; font-size: 0.9rem;">
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Tipo</span>
                        <span>{{ image.ai_item_type or '-' }}</span>
                    </div>
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Cor</span>
                        <span>{{ image.ai_color or '-' }}</span>
                    </div>
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Material</span>
                        <span>{{ image.ai_material or '-' }}</span>
                    </div>
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Padr√£o</span>
                        <span>{{ image.ai_pattern or '-' }}</span>
                    </div>
                    <div>
                        <span style="color: var(--text-secondary); display: block; font-size: 0.8rem;">Estilo</span>
                        <span>{{ image.ai_style or '-' }}</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <a href="{{ url_for('image_detail', id=image.id) }}" class="btn" style="background: var(--bg-tertiary); color: var(--text-primary);">
                    <i class="fas fa-times"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

================================================================================
FILE: templates/images/upload.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Enviar Nova Imagem</h1>
    <p style="color: var(--text-secondary);">Banco de Imagens / Todas as Imagens / Enviar Nova Imagem</p>
</div>

<form method="POST" enctype="multipart/form-data"
    style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; height: calc(100vh - 200px);">

    <!-- Left: Upload Area -->
    <div>
        <div class="upload-area" id="drop-zone">
            <i class="fas fa-cloud-upload-alt upload-icon"></i>
            <h3>Arraste e Solte Sua Imagem Aqui</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Ou, navegue pelos arquivos do seu computador
            </p>
            <input type="file" name="image" id="file-input" style="display: none;" accept="image/*">
            <button type="button" class="btn"
                style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);"
                onclick="document.getElementById('file-input').click()">
                Procurar Arquivos
            </button>
        </div>
        <div id="preview-container" style="display: none; margin-top: 1rem; text-align: center;">
            <img id="image-preview"
                style="max-height: 300px; border-radius: 8px; border: 1px solid var(--border-color);">
        </div>
    </div>

    <!-- Right: Metadata Form -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div class="stat-card" style="padding: 1.5rem;">
            <div class="form-group">
                <label class="form-label">Cole√ß√£o *</label>
                <select name="collection_id" class="form-control">
                    <option value="">Selecione uma cole√ß√£o</option>
                    {% for collection in collections %}
                    <option value="{{ collection.id }}">{{ collection.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Marca *</label>
                <select name="brand_id" class="form-control">
                    <option value="">Selecione uma marca</option>
                    {% for brand in brands %}
                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">SKU (Opcional)</label>
                <input type="text" name="sku" class="form-control" placeholder="ex: ABC-12345">
            </div>

            <div class="form-group">
                <label class="form-label">Fot√≥grafo (Opcional)</label>
                <input type="text" name="photographer" class="form-control" placeholder="Nome do fot√≥grafo">
            </div>

            <div class="form-group">
                <label class="form-label">Observa√ß√µes</label>
                <textarea name="observations" class="form-control" rows="3" placeholder="Adicione notas..."></textarea>
            </div>
        </div>

        <!-- AI Suggestions Mockup -->
        <div class="stat-card"
            style="padding: 1.5rem; background: rgba(31, 111, 235, 0.05); border-color: rgba(31, 111, 235, 0.2);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem; color: var(--accent-blue);">
                <i class="fas fa-magic"></i>
                <h3 style="font-size: 1rem; margin: 0;">Sugest√µes com IA</h3>
            </div>

            <div style="margin-bottom: 1rem;">
                <label class="form-label" style="font-size: 0.8rem;">Descri√ß√£o IA</label>
                <div
                    style="background: var(--bg-tertiary); padding: 10px; border-radius: 6px; font-size: 0.85rem; color: var(--text-secondary); font-style: italic;">
                    Envie uma imagem para gerar uma descri√ß√£o...
                </div>
            </div>

            <div>
                <label class="form-label" style="font-size: 0.8rem;">Tags IA</label>
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <span
                        style="font-size: 0.75rem; background: var(--bg-tertiary); padding: 2px 8px; border-radius: 12px; opacity: 0.5;">tag1</span>
                    <span
                        style="font-size: 0.75rem; background: var(--bg-tertiary); padding: 2px 8px; border-radius: 12px; opacity: 0.5;">tag2</span>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;">
            Enviar e Salvar Imagem
        </button>
    </div>
</form>

<script>
    const fileInput = document.getElementById('file-input');
    const previewContainer = document.getElementById('preview-container');
    const imagePreview = document.getElementById('image-preview');
    const dropZone = document.getElementById('drop-zone');

    fileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                imagePreview.src = e.target.result;
                previewContainer.style.display = 'block';
                dropZone.style.display = 'none';
            }
            reader.readAsDataURL(file);
        }
    });
</script>
{% endblock %}

================================================================================
FILE: templates/integrations/index.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Integra√ß√µes</h1>
    <p style="color: var(--text-secondary);">Gerencie conex√µes com plataformas de e-commerce e servi√ßos externos.</p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
    <!-- Shopify Integration -->
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="width: 48px; height: 48px; background: #95BF47; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 1.2rem;">
                    S
                </div>
                <div>
                    <h3 style="margin: 0;">Shopify</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">E-commerce</span>
                </div>
            </div>
            <span class="status-badge status-approved"
                style="background: rgba(63, 185, 80, 0.1); color: #3fb950;">Conectado</span>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
            Sincronize automaticamente imagens de produtos com sua loja Shopify.
        </p>
        <div
            style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 6px;">
            <div>
                <div style="color: var(--text-secondary);">√öltima Sincroniza√ß√£o</div>
                <div style="font-weight: 600; margin-top: 0.25rem;">2 minutos atr√°s</div>
            </div>
            <div style="text-align: right;">
                <div style="color: var(--text-secondary);">Imagens Sincronizadas</div>
                <div style="font-weight: 600; margin-top: 0.25rem;">1,234</div>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn"
                style="flex: 1; background: var(--bg-tertiary); color: var(--text-primary); justify-content: center;">
                <i class="fas fa-cog"></i> Configurar
            </button>
            <button class="btn"
                style="background: rgba(248, 81, 73, 0.1); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.4);">
                <i class="fas fa-unlink"></i>
            </button>
        </div>
    </div>

    <!-- Magento Integration -->
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="width: 48px; height: 48px; background: #EE672F; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 1.2rem;">
                    M
                </div>
                <div>
                    <h3 style="margin: 0;">Magento</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">E-commerce</span>
                </div>
            </div>
            <span class="status-badge status-rejected"
                style="background: rgba(248, 81, 73, 0.1); color: #f85149;">Erro</span>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
            Integra√ß√£o com Magento para sincroniza√ß√£o de cat√°logo de produtos.
        </p>
        <div
            style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 1rem; padding: 0.75rem; background: rgba(248, 81, 73, 0.05); border: 1px solid rgba(248, 81, 73, 0.2); border-radius: 6px;">
            <div>
                <div style="color: #f85149;">Erro de Autentica√ß√£o</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">Verifique suas
                    credenciais</div>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" style="flex: 1; justify-content: center;">
                <i class="fas fa-sync"></i> Reconectar
            </button>
            <button class="btn" style="background: var(--bg-tertiary); color: var(--text-primary);">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>

    <!-- WooCommerce Integration -->
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="width: 48px; height: 48px; background: #96588A; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 1.2rem;">
                    W
                </div>
                <div>
                    <h3 style="margin: 0;">WooCommerce</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">E-commerce</span>
                </div>
            </div>
            <span class="status-badge status-pending"
                style="background: rgba(210, 153, 34, 0.1); color: #d29922;">Dispon√≠vel</span>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
            Conecte seu banco de imagens com lojas WooCommerce.
        </p>
        <div style="padding: 2rem 0; text-align: center; color: var(--text-secondary);">
            <i class="fas fa-plug" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
            <div style="font-size: 0.9rem;">N√£o configurado</div>
        </div>
        <button class="btn btn-primary" style="width: 100%; justify-content: center;">
            <i class="fas fa-plus"></i> Conectar Agora
        </button>
    </div>

    <!-- Google Drive Integration -->
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="width: 48px; height: 48px; background: linear-gradient(135deg, #4285F4, #34A853, #FBBC05); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 1.2rem;">
                    G
                </div>
                <div>
                    <h3 style="margin: 0;">Google Drive</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Armazenamento</span>
                </div>
            </div>
            <span class="status-badge status-pending"
                style="background: rgba(210, 153, 34, 0.1); color: #d29922;">Dispon√≠vel</span>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
            Fa√ßa backup autom√°tico das suas imagens no Google Drive.
        </p>
        <div style="padding: 2rem 0; text-align: center; color: var(--text-secondary);">
            <i class="fas fa-cloud" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
            <div style="font-size: 0.9rem;">N√£o configurado</div>
        </div>
        <button class="btn btn-primary" style="width: 100%; justify-content: center;">
            <i class="fas fa-plus"></i> Conectar Agora
        </button>
    </div>

    <!-- Dropbox Integration -->
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="width: 48px; height: 48px; background: #0061FF; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 1.2rem;">
                    D
                </div>
                <div>
                    <h3 style="margin: 0;">Dropbox</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Armazenamento</span>
                </div>
            </div>
            <span class="status-badge status-pending"
                style="background: rgba(210, 153, 34, 0.1); color: #d29922;">Dispon√≠vel</span>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
            Sincronize imagens com sua conta Dropbox Business.
        </p>
        <div style="padding: 2rem 0; text-align: center; color: var(--text-secondary);">
            <i class="fas fa-folder" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
            <div style="font-size: 0.9rem;">N√£o configurado</div>
        </div>
        <button class="btn btn-primary" style="width: 100%; justify-content: center;">
            <i class="fas fa-plus"></i> Conectar Agora
        </button>
    </div>

    <!-- Webhook Integration -->
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="width: 48px; height: 48px; background: var(--accent-purple); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 1.2rem;">
                    <i class="fas fa-code"></i>
                </div>
                <div>
                    <h3 style="margin: 0;">Webhooks</h3>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">API Personalizada</span>
                </div>
            </div>
            <span class="status-badge status-pending"
                style="background: rgba(210, 153, 34, 0.1); color: #d29922;">Dispon√≠vel</span>
        </div>
        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
            Configure webhooks personalizados para integra√ß√£o com sistemas externos.
        </p>
        <div style="padding: 2rem 0; text-align: center; color: var(--text-secondary);">
            <i class="fas fa-terminal" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
            <div style="font-size: 0.9rem;">N√£o configurado</div>
        </div>
        <button class="btn btn-primary" style="width: 100%; justify-content: center;">
            <i class="fas fa-plus"></i> Configurar Webhook
        </button>
    </div>
</div>

<div class="stat-card"
    style="margin-top: 2rem; padding: 1.5rem; background: rgba(31, 111, 235, 0.05); border-color: rgba(31, 111, 235, 0.2);">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <i class="fas fa-info-circle" style="font-size: 1.5rem; color: var(--accent-blue);"></i>
        <div>
            <h4 style="margin: 0 0 0.25rem 0;">Precisa de uma integra√ß√£o personalizada?</h4>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                Entre em contato com nossa equipe de suporte para discutir integra√ß√µes customizadas para seu neg√≥cio.
            </p>
        </div>
        <button class="btn btn-primary" style="margin-left: auto;">
            <i class="fas fa-envelope"></i> Contatar Suporte
        </button>
    </div>
</div>
{% endblock %}

================================================================================
FILE: templates/produtos/edit.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="{{ url_for('produtos') }}" style="color: var(--text-secondary); font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-arrow-left"></i> Voltar para Produtos
    </a>
    <h1 style="margin-top: 1rem;">Editar Produto</h1>
    <p style="color: var(--text-secondary);">Atualize as informa√ß√µes do produto.</p>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <div>
        <div class="stat-card">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-edit" style="color: var(--accent-blue);"></i> Informa√ß√µes do Produto
            </h3>
            <form action="{{ url_for('edit_produto', id=produto.id) }}" method="POST" id="editForm">
                <input type="hidden" name="sku_original" value="{{ produto.sku }}">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">
                            SKU <span style="color: #f85149;">*</span>
                        </label>
                        <input type="text" name="sku" id="skuInput" class="form-control" required value="{{ produto.sku }}" onchange="checkSkuChange()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Descri√ß√£o <span style="color: #f85149;">*</span>
                        </label>
                        <input type="text" name="descricao" class="form-control" required value="{{ produto.descricao }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cor</label>
                        <input type="text" name="cor" class="form-control" value="{{ produto.cor or '' }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <input type="text" name="categoria" class="form-control" value="{{ produto.categoria or '' }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Marca</label>
                        <select name="marca_id" class="form-control">
                            <option value="">Selecione uma marca</option>
                            {% for marca in marcas %}
                            <option value="{{ marca.id }}" {% if produto.marca_id == marca.id %}selected{% endif %}>{{ marca.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cole√ß√£o</label>
                        <select name="colecao_id" class="form-control">
                            <option value="">Selecione uma cole√ß√£o</option>
                            {% for colecao in colecoes %}
                            <option value="{{ colecao.id }}" {% if produto.colecao_id == colecao.id %}selected{% endif %}>{{ colecao.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="form-label">Atributos T√©cnicos</label>
                    <textarea name="atributos_tecnicos" class="form-control" rows="4">{{ produto.atributos_tecnicos or '' }}</textarea>
                </div>

                <div id="motivoAlteracaoDiv" style="display: none; margin-top: 1.5rem; padding: 1rem; background: rgba(210, 153, 34, 0.1); border: 1px solid #d29922; border-radius: 8px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="color: #d29922;">
                            <i class="fas fa-exclamation-triangle"></i> Motivo da Altera√ß√£o do SKU <span style="color: #f85149;">*</span>
                        </label>
                        <textarea name="motivo_alteracao" id="motivoAlteracao" class="form-control" rows="2" placeholder="Descreva o motivo da altera√ß√£o do SKU"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Altera√ß√µes
                    </button>
                    <a href="{{ url_for('produtos') }}" class="btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>

        {% if historico_sku %}
        <div class="stat-card" style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-history" style="color: #d29922;"></i> Hist√≥rico de Altera√ß√µes de SKU
            </h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">SKU Antigo</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">SKU Novo</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Data</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Motivo</th>
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Usu√°rio</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in historico_sku %}
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 0.75rem; font-family: monospace; color: #f85149;">{{ item.sku_antigo }}</td>
                        <td style="padding: 0.75rem; font-family: monospace; color: #3fb950;">{{ item.sku_novo }}</td>
                        <td style="padding: 0.75rem; color: var(--text-secondary);">{{ item.data_alteracao.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td style="padding: 0.75rem; color: var(--text-secondary);">{{ item.motivo or '-' }}</td>
                        <td style="padding: 0.75rem; color: var(--text-secondary);">{{ item.usuario.username if item.usuario else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <div>
        <div class="stat-card">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-images" style="color: var(--accent-blue);"></i> Imagens Associadas
            </h3>

            {% if produto.imagens %}
            <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                {% for imagem in produto.imagens %}
                <div style="display: flex; gap: 0.75rem; align-items: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="width: 50px; height: 50px; border-radius: 6px; overflow: hidden; flex-shrink: 0;">
                        <img src="{{ url_for('static', filename='uploads/' + imagem.filename) }}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ imagem.sku or imagem.original_name }}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ imagem.status }}</div>
                    </div>
                    <form action="{{ url_for('desassociar_imagem', produto_id=produto.id, imagem_id=imagem.id) }}" method="POST" onsubmit="return confirm('Desassociar esta imagem?');">
                        <button type="submit" style="background: none; border: none; color: #f85149; cursor: pointer; padding: 4px;" title="Desassociar">
                            <i class="fas fa-unlink"></i>
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary); background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 1.5rem;">
                <i class="fas fa-image" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                <p style="font-size: 0.9rem;">Nenhuma imagem associada</p>
            </div>
            {% endif %}

            <form action="{{ url_for('associar_imagem', produto_id=produto.id) }}" method="POST" style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Associar Nova Imagem</label>
                    <select name="imagem_id" class="form-control" required>
                        <option value="">Selecione uma imagem</option>
                        {% for imagem in imagens_disponiveis %}
                        <option value="{{ imagem.id }}">{{ imagem.sku or imagem.original_name }} - {{ imagem.status }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                    <i class="fas fa-link"></i> Associar
                </button>
            </form>
        </div>
    </div>
</div>

<script>
const skuOriginal = "{{ produto.sku }}";

function checkSkuChange() {
    const skuAtual = document.getElementById('skuInput').value;
    const motivoDiv = document.getElementById('motivoAlteracaoDiv');
    const motivoInput = document.getElementById('motivoAlteracao');
    
    if (skuAtual !== skuOriginal) {
        motivoDiv.style.display = 'block';
        motivoInput.required = true;
    } else {
        motivoDiv.style.display = 'none';
        motivoInput.required = false;
    }
}

document.getElementById('skuInput').addEventListener('input', checkSkuChange);
</script>
{% endblock %}

================================================================================
FILE: templates/produtos/list.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1>Produtos</h1>
        <p style="color: var(--text-secondary);">Gerencie os produtos cadastrados no sistema.</p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('new_produto') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Novo Produto
        </a>
        <a href="{{ url_for('export_produtos_csv') }}" class="btn" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);">
            <i class="fas fa-file-export"></i> Exportar CSV
        </a>
        {% if total_produtos > 0 %}
        <button type="button" onclick="confirmarDeletarTodos()" class="btn" style="background: rgba(248, 81, 73, 0.1); border: 1px solid #f85149; color: #f85149;">
            <i class="fas fa-trash-alt"></i> Deletar Todos
        </button>
        {% endif %}
    </div>
</div>

<!-- Modal Deletar Todos -->
<div id="modalDeletarTodos" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div class="stat-card" style="max-width: 450px; margin: auto; text-align: center;">
        <div style="font-size: 3rem; color: #f85149; margin-bottom: 1rem;">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 style="margin-bottom: 1rem;">Deletar Todos os Produtos?</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            Esta a√ß√£o ir√° remover <strong style="color: #f85149;">{{ total_produtos }} produtos</strong> do sistema.
            <br><br>
            <strong>Esta a√ß√£o n√£o pode ser desfeita!</strong>
        </p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button type="button" onclick="fecharModal()" class="btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <form action="{{ url_for('delete_all_produtos') }}" method="POST" style="display: inline;">
                <button type="submit" class="btn" style="background: #f85149; color: white; border: none;">
                    <i class="fas fa-trash-alt"></i> Sim, Deletar Todos
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function confirmarDeletarTodos() {
    document.getElementById('modalDeletarTodos').style.display = 'flex';
}

function fecharModal() {
    document.getElementById('modalDeletarTodos').style.display = 'none';
}

document.getElementById('modalDeletarTodos').addEventListener('click', function(e) {
    if (e.target === this) fecharModal();
});
</script>

<div class="dashboard-stats" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 2rem;">
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Total de Produtos</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ total_produtos }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(31, 111, 235, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-box" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Com Foto</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #3fb950;">{{ com_foto }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(63, 185, 80, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-image" style="color: #3fb950; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Sem Foto</p>
                <h2 style="font-size: 2rem; font-weight: 600; color: #f85149;">{{ sem_foto }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(248, 81, 73, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-image" style="color: #f85149; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>
</div>

<div class="stat-card" style="margin-bottom: 2rem;">
    <form action="{{ url_for('produtos') }}" method="GET" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Buscar</label>
            <div style="position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                <input type="text" name="q" class="form-control" style="padding-left: 40px;" placeholder="SKU, descri√ß√£o..." value="{{ search_query or '' }}">
            </div>
        </div>

        <div style="min-width: 150px;">
            <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Marca</label>
            <select name="marca_id" class="form-control">
                <option value="">Todas as Marcas</option>
                {% for marca in marcas %}
                <option value="{{ marca.id }}" {% if request.args.get('marca_id') == marca.id|string %}selected{% endif %}>
                    {{ marca.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div style="min-width: 150px;">
            <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Cole√ß√£o</label>
            <select name="colecao_id" class="form-control">
                <option value="">Todas as Cole√ß√µes</option>
                {% for colecao in colecoes %}
                <option value="{{ colecao.id }}" {% if request.args.get('colecao_id') == colecao.id|string %}selected{% endif %}>
                    {{ colecao.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div style="min-width: 150px;">
            <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Status Foto</label>
            <select name="status_foto" class="form-control">
                <option value="">Todos</option>
                <option value="com_foto" {% if request.args.get('status_foto') == 'com_foto' %}selected{% endif %}>Com Foto</option>
                <option value="sem_foto" {% if request.args.get('status_foto') == 'sem_foto' %}selected{% endif %}>Sem Foto</option>
            </select>
        </div>

        <div style="display: flex; gap: 0.5rem;">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-filter"></i> Filtrar
            </button>
            <a href="{{ url_for('produtos') }}" class="btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                <i class="fas fa-times"></i> Limpar
            </a>
        </div>
    </form>
</div>

{% if produtos %}
<div class="stat-card" style="padding: 0; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">SKU</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Descri√ß√£o</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Cor</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Categoria</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Marca</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Cole√ß√£o</th>
                <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">Status Foto</th>
                <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary);">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for produto in produtos %}
            <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 1rem; font-weight: 500;">{{ produto.sku }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ produto.descricao }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ produto.cor or '-' }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ produto.categoria or '-' }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ produto.marca.name if produto.marca else '-' }}</td>
                <td style="padding: 1rem; color: var(--text-secondary);">{{ produto.colecao.name if produto.colecao else '-' }}</td>
                <td style="padding: 1rem;">
                    {% if produto.tem_foto %}
                    <span class="status-badge" style="background-color: rgba(63, 185, 80, 0.2); color: #3fb950;">
                        <i class="fas fa-check"></i> Com Foto
                    </span>
                    {% else %}
                    <span class="status-badge" style="background-color: rgba(248, 81, 73, 0.2); color: #f85149;">
                        <i class="fas fa-times"></i> Sem Foto
                    </span>
                    {% endif %}
                </td>
                <td style="padding: 1rem; text-align: center;">
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <a href="{{ url_for('edit_produto', id=produto.id) }}" class="btn" style="padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--accent-blue);" title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>
                        <form action="{{ url_for('delete_produto', id=produto.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir este produto?');">
                            <button type="submit" class="btn" style="padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: #f85149;" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="stat-card" style="text-align: center; padding: 4rem;">
    <div style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;">
        <i class="fas fa-box-open"></i>
    </div>
    <h3>Nenhum Produto Encontrado</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Cadastre seu primeiro produto para come√ßar.</p>
    <a href="{{ url_for('new_produto') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Novo Produto
    </a>
</div>
{% endif %}
{% endblock %}

================================================================================
FILE: templates/produtos/new.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="{{ url_for('produtos') }}" style="color: var(--text-secondary); font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem;">
        <i class="fas fa-arrow-left"></i> Voltar para Produtos
    </a>
    <h1 style="margin-top: 1rem;">Novo Produto</h1>
    <p style="color: var(--text-secondary);">Preencha os campos abaixo para cadastrar um novo produto.</p>
</div>

<div class="stat-card" style="max-width: 800px;">
    <form action="{{ url_for('new_produto') }}" method="POST">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="form-group">
                <label class="form-label">
                    SKU <span style="color: #f85149;">*</span>
                </label>
                <input type="text" name="sku" class="form-control" required placeholder="Ex: ABC-12345">
            </div>

            <div class="form-group">
                <label class="form-label">
                    Descri√ß√£o <span style="color: #f85149;">*</span>
                </label>
                <input type="text" name="descricao" class="form-control" required placeholder="Nome do produto">
            </div>

            <div class="form-group">
                <label class="form-label">Cor</label>
                <input type="text" name="cor" class="form-control" placeholder="Ex: Azul, Vermelho">
            </div>

            <div class="form-group">
                <label class="form-label">Categoria</label>
                <input type="text" name="categoria" class="form-control" placeholder="Ex: Eletr√¥nicos, Roupas">
            </div>

            <div class="form-group">
                <label class="form-label">Marca</label>
                <select name="marca_id" class="form-control">
                    <option value="">Selecione uma marca</option>
                    {% for marca in marcas %}
                    <option value="{{ marca.id }}">{{ marca.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Cole√ß√£o</label>
                <select name="colecao_id" class="form-control">
                    <option value="">Selecione uma cole√ß√£o</option>
                    {% for colecao in colecoes %}
                    <option value="{{ colecao.id }}">{{ colecao.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-group" style="margin-top: 1.5rem;">
            <label class="form-label">Atributos T√©cnicos</label>
            <textarea name="atributos_tecnicos" class="form-control" rows="4" placeholder="Descreva os atributos t√©cnicos do produto (material, dimens√µes, peso, etc.)"></textarea>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Cadastrar Produto
            </button>
            <a href="{{ url_for('produtos') }}" class="btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                Cancelar
            </a>
        </div>
    </form>
</div>
{% endblock %}

================================================================================
FILE: templates/reports/index.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>Relat√≥rios</h1>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">M√©tricas e estat√≠sticas do banco de imagens</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('export_report', report_type='all') }}" class="btn btn-primary">
                <i class="fas fa-download"></i> Exportar Tudo (CSV)
            </a>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Total de Imagens</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ total_images }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(31, 111, 235, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-images" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Com SKU</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ images_with_sku }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(63, 185, 80, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-barcode" style="color: #3fb950; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Sem SKU</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ images_without_sku }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(248, 81, 73, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-exclamation-triangle" style="color: #f85149; font-size: 1.25rem;"></i>
            </div>
        </div>
        {% if images_without_sku > 0 %}
        <a href="{{ url_for('export_report', report_type='without_sku') }}" style="color: var(--accent-blue); font-size: 0.85rem; margin-top: 0.5rem; display: inline-block;">
            <i class="fas fa-download"></i> Exportar lista
        </a>
        {% endif %}
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Com An√°lise IA</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ images_with_ai }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(130, 80, 223, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-robot" style="color: #8250df; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Sem An√°lise IA</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ images_without_ai }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(201, 209, 217, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-robot" style="color: #8b949e; font-size: 1.25rem;"></i>
            </div>
        </div>
        {% if images_without_ai > 0 %}
        <a href="{{ url_for('export_report', report_type='without_ai') }}" style="color: var(--accent-blue); font-size: 0.85rem; margin-top: 0.5rem; display: inline-block;">
            <i class="fas fa-download"></i> Exportar lista
        </a>
        {% endif %}
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1rem;">Por Status</h3>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="status-badge status-pendente">Pendente</span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-weight: 600;">{{ pending_images }}</span>
                    <a href="{{ url_for('export_report', report_type='pending') }}" style="color: var(--accent-blue); font-size: 0.8rem;">
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="status-badge status-aprovado">Aprovado</span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-weight: 600;">{{ approved_images }}</span>
                    <a href="{{ url_for('export_report', report_type='approved') }}" style="color: var(--accent-blue); font-size: 0.8rem;">
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="status-badge status-rejeitado">Rejeitado</span>
                </div>
                <span style="font-weight: 600;">{{ rejected_images }}</span>
            </div>
        </div>
        {% if total_images > 0 %}
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; display: flex;">
                {% set approved_pct = (approved_images / total_images * 100)|round(1) %}
                {% set pending_pct = (pending_images / total_images * 100)|round(1) %}
                {% set rejected_pct = (rejected_images / total_images * 100)|round(1) %}
                <div style="width: {{ approved_pct }}%; background: #3fb950;"></div>
                <div style="width: {{ pending_pct }}%; background: #d29922;"></div>
                <div style="width: {{ rejected_pct }}%; background: #f85149;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                <span><span style="color: #3fb950;">‚óè</span> {{ approved_pct }}% Aprovado</span>
                <span><span style="color: #d29922;">‚óè</span> {{ pending_pct }}% Pendente</span>
                <span><span style="color: #f85149;">‚óè</span> {{ rejected_pct }}% Rejeitado</span>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1rem;">Por Marca</h3>
        </div>
        {% if brands_stats %}
        <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 200px; overflow-y: auto;">
            {% for brand in brands_stats %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px;">
                <span style="font-weight: 500;">{{ brand.name }}</span>
                <div style="display: flex; gap: 1rem; font-size: 0.85rem;">
                    <span style="color: var(--text-secondary);">{{ brand.total }} total</span>
                    <span style="color: #3fb950;">{{ brand.approved }} <i class="fas fa-check"></i></span>
                    <span style="color: #d29922;">{{ brand.pending }} <i class="fas fa-clock"></i></span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Nenhuma marca cadastrada.</p>
        {% endif %}
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1rem;">Por Cole√ß√£o</h3>
        </div>
        {% if collections_stats %}
        <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 200px; overflow-y: auto;">
            {% for collection in collections_stats %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px;">
                <span style="font-weight: 500;">{{ collection.name }}</span>
                <span style="color: var(--text-secondary);">{{ collection.total }} imagens</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Nenhuma cole√ß√£o cadastrada.</p>
        {% endif %}
    </div>
</div>

<div class="stat-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="font-size: 1rem;">√öltimos Uploads</h3>
        <a href="{{ url_for('catalog') }}" style="color: var(--accent-blue); font-size: 0.9rem;">Ver todos <i class="fas fa-arrow-right"></i></a>
    </div>
    
    {% if recent_uploads %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">Imagem</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">SKU</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">Marca</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">Status</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">Data</th>
                    <th style="text-align: right; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for img in recent_uploads %}
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <img src="{{ url_for('static', filename='uploads/' + img.filename) }}" 
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">
                            <span style="font-size: 0.9rem;">{{ img.original_name[:30] }}{% if img.original_name|length > 30 %}...{% endif %}</span>
                        </div>
                    </td>
                    <td style="padding: 0.75rem; font-size: 0.9rem;">{{ img.sku or '-' }}</td>
                    <td style="padding: 0.75rem; font-size: 0.9rem;">{{ img.brand_ref.name if img.brand_ref else '-' }}</td>
                    <td style="padding: 0.75rem;">
                        <span class="status-badge status-{{ img.status.lower() }}">{{ img.status }}</span>
                    </td>
                    <td style="padding: 0.75rem; font-size: 0.9rem; color: var(--text-secondary);">{{ img.upload_date.strftime('%d/%m/%Y') }}</td>
                    <td style="padding: 0.75rem; text-align: right;">
                        <a href="{{ url_for('image_detail', id=img.id) }}" class="btn" style="padding: 0.4rem 0.75rem; font-size: 0.8rem; background: var(--bg-tertiary);">
                            <i class="fas fa-eye"></i> Ver
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Nenhuma imagem enviada ainda.</p>
    {% endif %}
</div>
{% endblock %}

================================================================================
FILE: templates/reports/skus_sem_foto.html
================================================================================
{% extends "base.html" %}

{% block title %}SKUs Pendentes de Foto - OAZ Smart Image Bank{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-camera" style="color: #ff6b35;"></i> SKUs Pendentes de Foto</h1>
    <div class="header-actions">
        <a href="{{ url_for('exportar_skus_sem_foto') }}" class="btn btn-success">
            <i class="fas fa-file-csv"></i> Exportar CSV
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<div class="stats-row" style="display: flex; gap: 20px; margin-bottom: 2rem;">
    <div class="stat-card" style="flex: 1; text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; color: #ff6b35;">{{ total_sem_foto }}</div>
        <div style="color: var(--text-secondary);">SKUs Sem Foto</div>
    </div>
    <div class="stat-card" style="flex: 1; text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; color: #3fb950;">{{ total_com_foto }}</div>
        <div style="color: var(--text-secondary);">SKUs Com Foto</div>
    </div>
    <div class="stat-card" style="flex: 1; text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-blue);">{{ total_carteira }}</div>
        <div style="color: var(--text-secondary);">Total na Carteira</div>
    </div>
    <div class="stat-card" style="flex: 1; text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; color: {% if percentual >= 80 %}#3fb950{% elif percentual >= 50 %}#d29922{% else %}#f85149{% endif %};">{{ percentual }}%</div>
        <div style="color: var(--text-secondary);">Cobertura</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Filtrar por Cole√ß√£o</h3>
        <div class="filter-tabs">
            <a href="{{ url_for('skus_sem_foto') }}" class="filter-tab {% if not colecao_filter %}active{% endif %}">Todas</a>
            {% for col in colecoes %}
            <a href="{{ url_for('skus_sem_foto', colecao=col.id) }}" 
               class="filter-tab {% if colecao_filter == col.id %}active{% endif %}">{{ col.name }}</a>
            {% endfor %}
        </div>
    </div>
    <div class="card-body">
        {% if skus_sem_foto %}
        <table class="table">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>Cole√ß√£o</th>
                    <th>Marca</th>
                    <th>Categoria</th>
                    <th>Subcategoria</th>
                </tr>
            </thead>
            <tbody>
                {% for item in skus_sem_foto %}
                <tr>
                    <td><strong>{{ item.sku }}</strong></td>
                    <td>{{ item.colecao or '-' }}</td>
                    <td>{{ item.marca or '-' }}</td>
                    <td>{{ item.categoria or '-' }}</td>
                    <td>{{ item.subcategoria or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if pagination.pages > 1 %}
        <div class="pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            {% if pagination.has_prev %}
            <a href="{{ url_for('skus_sem_foto', page=pagination.prev_num, colecao=colecao_filter) }}" class="btn btn-sm btn-secondary">
                <i class="fas fa-chevron-left"></i> Anterior
            </a>
            {% endif %}
            
            <span style="padding: 8px 16px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                P√°gina {{ pagination.page }} de {{ pagination.pages }}
            </span>
            
            {% if pagination.has_next %}
            <a href="{{ url_for('skus_sem_foto', page=pagination.next_num, colecao=colecao_filter) }}" class="btn btn-sm btn-secondary">
                Pr√≥ximo <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state" style="text-align: center; padding: 3rem;">
            <i class="fas fa-check-circle" style="font-size: 4rem; color: #3fb950; margin-bottom: 1rem;"></i>
            <h3>Todos os SKUs t√™m foto!</h3>
            <p style="color: var(--text-secondary);">N√£o h√° SKUs pendentes de fotografia nesta cole√ß√£o.</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
.header-actions {
    display: flex;
    gap: 10px;
}
.btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}
.filter-tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.filter-tab {
    padding: 6px 14px;
    background: rgba(255,255,255,0.05);
    border-radius: 20px;
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.2s;
}
.filter-tab:hover {
    background: rgba(255,255,255,0.1);
    color: white;
}
.filter-tab.active {
    background: var(--primary-color);
    color: white;
}
.stat-card {
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border-color);
}
</style>
{% endblock %}

================================================================================
FILE: templates/subcolecoes/edit.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
        <a href="{{ url_for('subcolecoes') }}" style="color: var(--text-secondary);">
            <i class="fas fa-arrow-left"></i> Voltar para Subcole√ß√µes
        </a>
    </div>

    <div class="stat-card">
        <h2 style="margin-bottom: 1.5rem;">Editar Subcole√ß√£o</h2>
        
        <form method="post">
            <div class="form-group">
                <label for="nome">Nome da Subcole√ß√£o *</label>
                <input type="text" id="nome" name="nome" class="form-control" required 
                       value="{{ subcolecao.nome }}">
            </div>

            <div class="form-group">
                <label for="colecao_id">Cole√ß√£o *</label>
                <select id="colecao_id" name="colecao_id" class="form-control" required>
                    <option value="">Selecione uma cole√ß√£o...</option>
                    {% for colecao in colecoes %}
                    <option value="{{ colecao.id }}" {% if subcolecao.colecao_id == colecao.id %}selected{% endif %}>
                        {{ colecao.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="tipo_campanha">Tipo de Campanha</label>
                <select id="tipo_campanha" name="tipo_campanha" class="form-control">
                    <option value="">Selecione...</option>
                    <option value="Lan√ßamento" {% if subcolecao.tipo_campanha == 'Lan√ßamento' %}selected{% endif %}>Lan√ßamento</option>
                    <option value="Cole√ß√£o Principal" {% if subcolecao.tipo_campanha == 'Cole√ß√£o Principal' %}selected{% endif %}>Cole√ß√£o Principal</option>
                    <option value="Preview" {% if subcolecao.tipo_campanha == 'Preview' %}selected{% endif %}>Preview</option>
                    <option value="Drop" {% if subcolecao.tipo_campanha == 'Drop' %}selected{% endif %}>Drop</option>
                    <option value="Dia das M√£es" {% if subcolecao.tipo_campanha == 'Dia das M√£es' %}selected{% endif %}>Dia das M√£es</option>
                    <option value="Natal" {% if subcolecao.tipo_campanha == 'Natal' %}selected{% endif %}>Natal</option>
                    <option value="R√©veillon" {% if subcolecao.tipo_campanha == 'R√©veillon' %}selected{% endif %}>R√©veillon</option>
                    <option value="Alto Ver√£o" {% if subcolecao.tipo_campanha == 'Alto Ver√£o' %}selected{% endif %}>Alto Ver√£o</option>
                    <option value="Perene" {% if subcolecao.tipo_campanha == 'Perene' %}selected{% endif %}>Perene</option>
                    <option value="Atacado" {% if subcolecao.tipo_campanha == 'Atacado' %}selected{% endif %}>Atacado</option>
                </select>
            </div>

            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="data_inicio">Data In√≠cio (opcional)</label>
                    <input type="date" id="data_inicio" name="data_inicio" class="form-control"
                           value="{{ subcolecao.data_inicio.strftime('%Y-%m-%d') if subcolecao.data_inicio else '' }}">
                </div>
                <div class="form-group">
                    <label for="data_fim">Data Fim (opcional)</label>
                    <input type="date" id="data_fim" name="data_fim" class="form-control"
                           value="{{ subcolecao.data_fim.strftime('%Y-%m-%d') if subcolecao.data_fim else '' }}">
                </div>
            </div>

            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.5rem;">Estat√≠sticas</h4>
                <div style="display: flex; gap: 2rem;">
                    <div>
                        <span style="color: var(--text-secondary);">Imagens:</span>
                        <strong>{{ subcolecao.images|length }}</strong>
                    </div>
                    <div>
                        <span style="color: var(--text-secondary);">Produtos:</span>
                        <strong>{{ subcolecao.produtos|length }}</strong>
                    </div>
                    <div>
                        <span style="color: var(--text-secondary);">Carteira:</span>
                        <strong>{{ subcolecao.itens_carteira|length }}</strong>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
                <a href="{{ url_for('subcolecoes') }}" class="btn" style="flex: 1; text-align: center;">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

================================================================================
FILE: templates/subcolecoes/list.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1>Subcole√ß√µes / Campanhas</h1>
        <p style="color: var(--text-secondary);">Gerencie as campanhas dentro de cada cole√ß√£o (Dia das M√£es, Natal, R√©veillon, etc.)</p>
    </div>
    <a href="{{ url_for('new_subcolecao') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nova Subcole√ß√£o
    </a>
</div>

<div style="margin-bottom: 1.5rem;">
    <form method="get" style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <select name="colecao_id" class="form-control" style="max-width: 200px;" onchange="this.form.submit()">
            <option value="">Todas as Cole√ß√µes</option>
            {% for colecao in colecoes %}
            <option value="{{ colecao.id }}" {% if request.args.get('colecao_id')|int == colecao.id %}selected{% endif %}>
                {{ colecao.name }}
            </option>
            {% endfor %}
        </select>
    </form>
</div>

{% if subcolecoes %}
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
    {% for subcolecao in subcolecoes %}
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
                <h3 style="margin-bottom: 0.25rem;">{{ subcolecao.nome }}</h3>
                <span style="color: var(--accent-purple); font-size: 0.8rem;">
                    {{ subcolecao.colecao.name if subcolecao.colecao else 'Sem cole√ß√£o' }}
                </span>
            </div>
            {% if subcolecao.tipo_campanha %}
            <span class="badge" style="background: var(--accent-blue); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">
                {{ subcolecao.tipo_campanha }}
            </span>
            {% endif %}
        </div>

        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <div>
                <small style="color: var(--text-secondary);">Imagens</small>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-green);">{{ subcolecao.images|length }}</div>
            </div>
            <div>
                <small style="color: var(--text-secondary);">Produtos</small>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-purple);">{{ subcolecao.produtos|length }}</div>
            </div>
            <div>
                <small style="color: var(--text-secondary);">Carteira</small>
                <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-blue);">{{ subcolecao.itens_carteira|length }}</div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--text-secondary); border-top: 1px solid var(--border-color); padding-top: 1rem;">
            <span>Criado em {{ subcolecao.created_at.strftime('%d/%m/%Y') }}</span>
            <div style="display: flex; gap: 0.5rem;">
                <a href="{{ url_for('edit_subcolecao', id=subcolecao.id) }}" class="btn btn-sm" style="padding: 0.3rem 0.6rem;">
                    <i class="fas fa-edit"></i>
                </a>
                <a href="{{ url_for('catalog') }}?subcolecao_id={{ subcolecao.id }}" style="color: var(--accent-blue);">
                    Ver imagens <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="stat-card" style="text-align: center; padding: 4rem;">
    <div style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;">
        <i class="fas fa-layer-group"></i>
    </div>
    <h3>Nenhuma Subcole√ß√£o Cadastrada</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">As subcole√ß√µes s√£o criadas automaticamente ao importar a Carteira de Compras ou manualmente.</p>
    <a href="{{ url_for('new_subcolecao') }}" class="btn btn-primary">Criar Nova Subcole√ß√£o</a>
</div>
{% endif %}
{% endblock %}

================================================================================
FILE: templates/subcolecoes/new.html
================================================================================
{% extends "base.html" %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
        {% if colecao_id_preselect %}
        <a href="{{ url_for('collection_detail', id=colecao_id_preselect) }}" style="color: var(--text-secondary);">
            <i class="fas fa-arrow-left"></i> Voltar para Cole√ß√£o
        </a>
        {% else %}
        <a href="{{ url_for('collections') }}" style="color: var(--text-secondary);">
            <i class="fas fa-arrow-left"></i> Voltar para Cole√ß√µes
        </a>
        {% endif %}
    </div>

    <div class="stat-card">
        <h2 style="margin-bottom: 1.5rem;">Nova Subcole√ß√£o / Campanha</h2>
        
        <form method="post">
            <div class="form-group">
                <label for="nome">Nome da Subcole√ß√£o *</label>
                <input type="text" id="nome" name="nome" class="form-control" required 
                       placeholder="Ex: Dia das M√£es, Lan√ßamento, Natal...">
            </div>

            <div class="form-group">
                <label for="colecao_id">Cole√ß√£o *</label>
                <select id="colecao_id" name="colecao_id" class="form-control" required>
                    <option value="">Selecione uma cole√ß√£o...</option>
                    {% for colecao in colecoes %}
                    <option value="{{ colecao.id }}" {% if colecao_id_preselect == colecao.id %}selected{% endif %}>{{ colecao.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="tipo_campanha">Tipo de Campanha</label>
                <select id="tipo_campanha" name="tipo_campanha" class="form-control">
                    <option value="">Selecione...</option>
                    <option value="Lan√ßamento">Lan√ßamento</option>
                    <option value="Cole√ß√£o Principal">Cole√ß√£o Principal</option>
                    <option value="Preview">Preview</option>
                    <option value="Drop">Drop</option>
                    <option value="Dia das M√£es">Dia das M√£es</option>
                    <option value="Natal">Natal</option>
                    <option value="R√©veillon">R√©veillon</option>
                    <option value="Alto Ver√£o">Alto Ver√£o</option>
                    <option value="Perene">Perene</option>
                    <option value="Atacado">Atacado</option>
                </select>
            </div>

            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="data_inicio">Data In√≠cio (opcional)</label>
                    <input type="date" id="data_inicio" name="data_inicio" class="form-control">
                </div>
                <div class="form-group">
                    <label for="data_fim">Data Fim (opcional)</label>
                    <input type="date" id="data_fim" name="data_fim" class="form-control">
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-save"></i> Criar Subcole√ß√£o
                </button>
                {% if colecao_id_preselect %}
                <a href="{{ url_for('collection_detail', id=colecao_id_preselect) }}" class="btn" style="flex: 1; text-align: center;">
                    Cancelar
                </a>
                {% else %}
                <a href="{{ url_for('collections') }}" class="btn" style="flex: 1; text-align: center;">
                    Cancelar
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}

================================================================================
FILE: test_login.py
================================================================================
from app import app, db, User

with app.app_context():
    user = User.query.filter_by(username='admin').first()
    if user:
        print(f'User found: {user.username}')
        print(f'Email: {user.email}')
        print(f'Has password hash: {user.password_hash is not None}')
        print(f'Password check for "admin": {user.check_password("admin")}')
    else:
        print('No admin user found!')

================================================================================
FILE: upload_orchestrator.py
================================================================================
"""
Upload Orchestrator - Sistema de fila ass√≠ncrona para uploads em grande escala
Gerencia pool de workers com cleanup de recursos e processamento FIFO
"""

import os
import gc
import shutil
import tempfile
import threading
import traceback
from queue import Queue, Empty
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor
from threading import Lock, Event

MAX_UPLOAD_WORKERS = 3
BATCH_INSERT_SIZE = 500
PROGRESS_UPDATE_INTERVAL = 50

class UploadJob:
    """Representa um job de upload na fila"""
    def __init__(self, batch_id, archive_path, temp_dir, metadata):
        self.batch_id = batch_id
        self.archive_path = archive_path
        self.temp_dir = temp_dir
        self.metadata = metadata
        self.created_at = datetime.utcnow()
        self.status = 'queued'
        self.error = None


class UploadOrchestrator:
    """
    Orquestrador de uploads em grande escala
    - Fila FIFO para jobs de upload
    - Pool de workers com limite m√°ximo
    - Cleanup de recursos ap√≥s cada job
    - Bulk inserts para performance
    """
    
    _instance = None
    _lock = Lock()
    
    def __new__(cls, *args, **kwargs):
        with cls._lock:
            if cls._instance is None:
                cls._instance = super().__new__(cls)
                cls._instance._initialized = False
            return cls._instance
    
    def __init__(self, app=None, db=None, object_storage=None):
        if self._initialized:
            return
        
        self.app = app
        self.db = db
        self.object_storage = object_storage
        
        self.job_queue = Queue()
        self.active_jobs = {}
        self.completed_jobs = {}
        
        self.max_workers = MAX_UPLOAD_WORKERS
        self.workers = []
        self.workers_started = False
        self.shutdown_event = Event()
        self.stats_lock = Lock()
        
        self.stats = {
            'total_queued': 0,
            'total_processed': 0,
            'total_errors': 0,
            'active_workers': 0
        }
        
        self._initialized = True
    
    def configure(self, app, db, object_storage):
        """Configura o orquestrador com inst√¢ncias da aplica√ß√£o e inicia workers"""
        self.app = app
        self.db = db
        self.object_storage = object_storage
        
        if not self.workers_started:
            self._recover_stuck_items()
            self._start_workers()
            self._start_watchdog()
            self.workers_started = True
    
    def _recover_stuck_items(self):
        """Recupera itens que estavam em 'processing' ou 'receiving' quando o servidor caiu"""
        from datetime import timedelta
        import shutil
        
        TEMP_UPLOAD_DIR = '/tmp/batch_uploads'
        
        with self.app.app_context():
            self.db.session.remove()
            from app import BatchItem, BatchUpload
            
            receiving_items = BatchItem.query.filter(
                BatchItem.reception_status == 'receiving'
            ).all()
            
            if receiving_items:
                print(f"[WATCHDOG] Found {len(receiving_items)} items stuck in 'receiving', marking as failed...")
                for item in receiving_items:
                    item.reception_status = 'failed'
                    item.status = 'Erro'
                    item.last_error = 'Reception interrupted by server restart'
                    if item.received_path and os.path.exists(item.received_path):
                        try:
                            os.remove(item.received_path)
                        except:
                            pass
                self.db.session.commit()
            
            stuck_items = BatchItem.query.filter(
                BatchItem.processing_status == 'processing'
            ).all()
            
            if stuck_items:
                print(f"[WATCHDOG] Found {len(stuck_items)} stuck items in 'processing', resetting to retry...")
                for item in stuck_items:
                    item.processing_status = 'retry'
                    item.status = 'Pendente'
                    item.retry_count = (item.retry_count or 0) + 1
                    item.last_error = 'Recovered after server restart'
                    item.worker_id = None
                    item.heartbeat_at = None
                self.db.session.commit()
            
            stuck_batches = BatchUpload.query.filter(
                BatchUpload.status.in_(['Processando', 'Recebendo'])
            ).all()
            
            if stuck_batches:
                print(f"[WATCHDOG] Found {len(stuck_batches)} stuck batches, checking status...")
                for batch in stuck_batches:
                    pending_count = BatchItem.query.filter(
                        BatchItem.batch_id == batch.id,
                        BatchItem.processing_status.in_(['pending', 'retry'])
                    ).count()
                    
                    completed_count = BatchItem.query.filter(
                        BatchItem.batch_id == batch.id,
                        BatchItem.processing_status == 'completed'
                    ).count()
                    
                    failed_count = BatchItem.query.filter(
                        BatchItem.batch_id == batch.id,
                        BatchItem.processing_status == 'failed'
                    ).count()
                    
                    if pending_count > 0:
                        batch.status = 'Pendente'
                        print(f"[WATCHDOG] Batch {batch.id} has {pending_count} pending items, marked as Pendente")
                    elif failed_count > 0 and completed_count == 0:
                        batch.status = 'Erro'
                        batch.finished_at = datetime.utcnow()
                    else:
                        batch.status = 'Conclu√≠do'
                        batch.finished_at = datetime.utcnow()
                    
                    batch.sucesso = completed_count
                    batch.falhas = failed_count
                    batch.processados = completed_count + failed_count
                
                self.db.session.commit()
            
            self.db.session.remove()
    
    def _start_watchdog(self):
        """Inicia thread watchdog para detectar itens travados"""
        watchdog = threading.Thread(
            target=self._watchdog_loop,
            name='UploadWatchdog',
            daemon=True
        )
        watchdog.start()
        print("[WATCHDOG] Started watchdog thread")
    
    def _watchdog_loop(self):
        """Loop do watchdog - verifica itens travados a cada 60 segundos"""
        from datetime import timedelta
        
        STUCK_TIMEOUT_SECONDS = 300  # 5 minutos sem heartbeat = travado
        CHECK_INTERVAL = 60  # Verifica a cada 60 segundos
        
        while not self.shutdown_event.is_set():
            try:
                self.shutdown_event.wait(CHECK_INTERVAL)
                if self.shutdown_event.is_set():
                    break
                
                with self.app.app_context():
                    self.db.session.remove()
                    from app import BatchItem
                    
                    timeout_threshold = datetime.utcnow() - timedelta(seconds=STUCK_TIMEOUT_SECONDS)
                    
                    stuck_items = BatchItem.query.filter(
                        BatchItem.processing_status == 'processing',
                        BatchItem.heartbeat_at < timeout_threshold
                    ).all()
                    
                    if stuck_items:
                        print(f"[WATCHDOG] Found {len(stuck_items)} items stuck for > {STUCK_TIMEOUT_SECONDS}s")
                        for item in stuck_items:
                            if item.retry_count < item.max_retries:
                                item.processing_status = 'retry'
                                item.retry_count += 1
                                item.last_error = f'Timeout after {STUCK_TIMEOUT_SECONDS}s'
                                item.worker_id = None
                            else:
                                item.processing_status = 'failed'
                                item.status = 'Erro'
                                item.last_error = f'Max retries ({item.max_retries}) exceeded'
                        
                        self.db.session.commit()
                    
                    self.db.session.remove()
                    
            except Exception as e:
                print(f"[WATCHDOG] Error: {e}")
    
    def _start_workers(self):
        """Inicia workers em background"""
        for i in range(self.max_workers):
            worker = threading.Thread(
                target=self._worker_loop,
                name=f'UploadWorker-{i}',
                daemon=True
            )
            worker.start()
            self.workers.append(worker)
        print(f"[ORCHESTRATOR] Started {self.max_workers} upload workers")
    
    def _worker_loop(self):
        """Loop principal de cada worker"""
        while not self.shutdown_event.is_set():
            try:
                job = self.job_queue.get(timeout=1.0)
            except Empty:
                continue
            
            worker_name = threading.current_thread().name
            print(f"[{worker_name}] Processing job for batch {job.batch_id}")
            
            with self.stats_lock:
                self.stats['active_workers'] += 1
            
            try:
                self._process_job(job)
                job.status = 'completed'
                with self.stats_lock:
                    self.stats['total_processed'] += 1
            except Exception as e:
                job.status = 'failed'
                job.error = str(e)
                print(f"[{worker_name}] Job failed: {e}")
                traceback.print_exc()
                with self.stats_lock:
                    self.stats['total_errors'] += 1
            finally:
                self._cleanup_job(job)
                with self.stats_lock:
                    self.stats['active_workers'] -= 1
                
                self.completed_jobs[job.batch_id] = job
                if job.batch_id in self.active_jobs:
                    del self.active_jobs[job.batch_id]
                
                self.job_queue.task_done()
                gc.collect()
                
                print(f"[{worker_name}] Job completed. Queue size: {self.job_queue.qsize()}")
    
    def _process_job(self, job):
        """Processa um job de upload"""
        from batch_processor import extract_zip_to_temp, extract_sku_from_filename
        from app import BatchUpload, BatchItem, Image, ImageItem, CarteiraCompras
        
        with self.app.app_context():
            self.db.session.remove()
            
            batch = self.db.session.get(BatchUpload, job.batch_id)
            if not batch:
                raise ValueError(f"Batch {job.batch_id} not found")
            
            batch.status = 'Extraindo'
            self.db.session.commit()
            
            files_data = extract_zip_to_temp(job.archive_path, job.temp_dir)
            
            if not files_data:
                batch.status = 'Erro'
                batch.erro_mensagem = 'Nenhuma imagem v√°lida encontrada no ZIP'
                self.db.session.commit()
                return
            
            for i, file_info in enumerate(files_data):
                file_info['file_index'] = i
            
            batch.total_arquivos = len(files_data)
            batch.status = 'Processando'
            batch.started_at = datetime.utcnow()
            self.db.session.commit()
            
            carteira_cache = self._warm_carteira_cache_in_session()
            
            batch_items_to_insert = []
            for i, file_info in enumerate(files_data):
                batch_items_to_insert.append({
                    'batch_id': job.batch_id,
                    'sku': file_info['sku'],
                    'filename_original': file_info['filename'],
                    'status': 'Pendente',
                    'tentativas': 0
                })
            
            for i in range(0, len(batch_items_to_insert), BATCH_INSERT_SIZE):
                chunk = batch_items_to_insert[i:i + BATCH_INSERT_SIZE]
                self.db.session.bulk_insert_mappings(BatchItem, chunk)
            self.db.session.commit()
            
            items = BatchItem.query.filter_by(batch_id=job.batch_id).order_by(BatchItem.id).all()
            
            for i, item in enumerate(items):
                if i < len(files_data):
                    files_data[i]['item_id'] = item.id
            
            self._process_files_parallel(job, files_data, carteira_cache)
            
            batch = self.db.session.get(BatchUpload, job.batch_id)
            batch.status = 'Conclu√≠do'
            batch.finished_at = datetime.utcnow()
            self.db.session.commit()
    
    def _warm_carteira_cache_in_session(self):
        """Carrega cache da Carteira usando a sess√£o atual"""
        from app import CarteiraCompras
        
        cache = {}
        carteiras = CarteiraCompras.query.all()
        for c in carteiras:
            sku_upper = c.sku.upper().strip() if c.sku else ''
            cache[sku_upper] = {
                'id': c.id,
                'descricao': c.descricao or '',
                'cor': c.cor or '',
                'categoria': c.categoria or '',
                'subcategoria': c.subcategoria or '',
                'colecao_id': c.colecao_id,
                'subcolecao_id': c.subcolecao_id,
                'marca_id': c.marca_id,
                'estilista': c.estilista or '',
                'origem': c.origem or '',
                'referencia_estilo': c.referencia_estilo or '',
                'material': c.material or c.categoria or '',
                'tipo_peca': c.tipo_peca or c.subcategoria or '',
                'posicao_peca': c.posicao_peca or ''
            }
        
        print(f"[CACHE] Loaded {len(cache)} Carteira entries")
        return cache
    
    def _process_files_parallel(self, job, files_data, carteira_cache):
        """Processa arquivos em LOTES DE 20 com sess√µes isoladas - resiliente a falhas"""
        BATCH_SIZE = 20  # Processa 20 imagens por vez
        processed = 0
        successes = 0
        failures = 0
        progress_lock = Lock()
        total_files = len(files_data)
        
        print(f"[BATCH] Processing {total_files} files in batches of {BATCH_SIZE}")
        
        def process_with_isolated_session(file_info):
            """Wrapper que garante sess√£o isolada por thread"""
            nonlocal processed, successes, failures
            
            with self.app.app_context():
                self.db.session.remove()
                
                try:
                    result = self._process_single_file_in_session(
                        job.batch_id,
                        file_info,
                        carteira_cache
                    )
                    
                    with progress_lock:
                        processed += 1
                        if result.get('success'):
                            successes += 1
                        else:
                            failures += 1
                    
                    return result
                    
                except Exception as e:
                    with progress_lock:
                        processed += 1
                        failures += 1
                    print(f"[ERROR] Processing {file_info.get('sku')}: {e}")
                    return {'success': False, 'error': str(e)}
                    
                finally:
                    temp_path = file_info.get('temp_path')
                    if temp_path and os.path.exists(temp_path):
                        try:
                            os.remove(temp_path)
                        except:
                            pass
                    self.db.session.remove()
        
        for batch_start in range(0, total_files, BATCH_SIZE):
            batch_end = min(batch_start + BATCH_SIZE, total_files)
            batch_files = files_data[batch_start:batch_end]
            batch_num = (batch_start // BATCH_SIZE) + 1
            total_batches = (total_files + BATCH_SIZE - 1) // BATCH_SIZE
            
            print(f"[BATCH {batch_num}/{total_batches}] Processing files {batch_start+1}-{batch_end} of {total_files}")
            
            with ThreadPoolExecutor(max_workers=BATCH_SIZE) as executor:
                futures = [executor.submit(process_with_isolated_session, f) for f in batch_files]
                
                for future in futures:
                    try:
                        future.result()
                    except Exception as e:
                        print(f"[ERROR] Future failed: {e}")
            
            with self.app.app_context():
                self.db.session.remove()
                from app import BatchUpload
                batch = self.db.session.get(BatchUpload, job.batch_id)
                if batch:
                    batch.processados = processed
                    batch.sucesso = successes
                    batch.falhas = failures
                    self.db.session.commit()
                self.db.session.remove()
            
            print(f"[BATCH {batch_num}/{total_batches}] Completed. Progress: {processed}/{total_files} ({successes} success, {failures} failed)")
            
            gc.collect()
        
        with self.app.app_context():
            self.db.session.remove()
            from app import BatchUpload
            batch = self.db.session.get(BatchUpload, job.batch_id)
            if batch:
                batch.processados = processed
                batch.sucesso = successes
                batch.falhas = failures
                self.db.session.commit()
        
        print(f"[BATCH] All batches completed: {processed}/{total_files} files processed")
    
    def _process_single_file_in_session(self, batch_id, file_info, carteira_cache):
        """Processa um √∫nico arquivo (j√° dentro de sess√£o isolada)"""
        import json
        import uuid as uuid_lib
        from app import BatchUpload, BatchItem, Image, CarteiraCompras
        from batch_processor import extract_sku_base_and_sequence
        
        temp_path = file_info.get('temp_path')
        sku = file_info.get('sku')
        original_filename = file_info.get('filename')
        item_id = file_info.get('item_id')
        
        try:
            if not temp_path or not os.path.exists(temp_path):
                raise FileNotFoundError(f"File not found: {temp_path}")
            
            sku_base, sequencia = extract_sku_base_and_sequence(sku)
            
            sku_upper = sku.upper().strip()
            sku_base_upper = sku_base.upper().strip() if sku_base else sku_upper
            
            carteira_data = carteira_cache.get(sku_upper)
            if not carteira_data and sku_base_upper != sku_upper:
                carteira_data = carteira_cache.get(sku_base_upper)
            
            storage_result = self._upload_file_streaming(temp_path, original_filename)
            storage_path = storage_result.get('storage_path')
            
            unique_code = f"IMG-{uuid_lib.uuid4().hex[:8].upper()}"
            
            batch = self.db.session.get(BatchUpload, batch_id)
            
            if carteira_data:
                tags_list = []
                if carteira_data.get('categoria'):
                    tags_list.append(carteira_data['categoria'])
                if carteira_data.get('subcategoria'):
                    tags_list.append(carteira_data['subcategoria'])
                if carteira_data.get('cor'):
                    tags_list.append(carteira_data['cor'])
                
                image_status = 'Pendente'
                collection_id = carteira_data.get('colecao_id') or (batch.colecao_id if batch else None)
                subcolecao_id = carteira_data.get('subcolecao_id')
                brand_id = carteira_data.get('marca_id') or (batch.marca_id if batch else None)
                
                carteira = self.db.session.get(CarteiraCompras, carteira_data['id'])
                if carteira:
                    carteira.status_foto = 'Com Foto'
                
                match_source = 'carteira'
            else:
                tags_list = []
                image_status = 'Pendente An√°lise IA'
                collection_id = batch.colecao_id if batch else None
                subcolecao_id = None
                brand_id = batch.marca_id if batch else None
                match_source = 'sem_match'
            
            ext = os.path.splitext(original_filename)[1] or '.jpg'
            new_image = Image(
                filename=f"{sku}{ext}",
                original_name=original_filename,
                storage_path=storage_path,
                sku=sku,
                sku_base=sku_base,
                sequencia=sequencia,
                description=carteira_data.get('descricao', '') if carteira_data else '',
                tags=json.dumps(tags_list),
                ai_item_type=carteira_data.get('tipo_peca') if carteira_data else None,
                ai_color=carteira_data.get('cor') if carteira_data else None,
                ai_material=carteira_data.get('material') if carteira_data else None,
                uploader_id=batch.usuario_id if batch else None,
                collection_id=collection_id,
                subcolecao_id=subcolecao_id,
                brand_id=brand_id,
                unique_code=unique_code,
                status=image_status,
                estilista=carteira_data.get('estilista') if carteira_data else None,
                origem=carteira_data.get('origem') if carteira_data else None,
                referencia_estilo=carteira_data.get('referencia_estilo') if carteira_data else None
            )
            self.db.session.add(new_image)
            self.db.session.flush()
            
            if item_id:
                item = self.db.session.get(BatchItem, item_id)
                if item:
                    item.status = 'Sucesso'
                    item.processing_status = 'completed'
                    item.storage_path = storage_path
                    item.image_id = new_image.id
                    item.processed_at = datetime.utcnow()
                    item.heartbeat_at = datetime.utcnow()
            
            self.db.session.commit()
            
            return {'success': True, 'image_id': new_image.id}
            
        except Exception as e:
            self.db.session.rollback()
            
            if item_id:
                try:
                    item = self.db.session.get(BatchItem, item_id)
                    if item:
                        item.status = 'Erro'
                        item.processing_status = 'failed'
                        item.erro_mensagem = str(e)[:500]
                        item.last_error = str(e)[:500]
                        item.retry_count = (item.retry_count or 0) + 1
                        self.db.session.commit()
                except:
                    pass
            
            return {'success': False, 'error': str(e)}
    
    def _upload_file_streaming(self, file_path, original_filename):
        """Upload de arquivo usando streaming real (20MB chunks)"""
        result = self.object_storage.upload_file_streaming(file_path, original_filename)
        return result
    
    def _cleanup_job(self, job):
        """Limpa todos os recursos de um job"""
        if job.archive_path and os.path.exists(job.archive_path):
            try:
                os.remove(job.archive_path)
            except Exception as e:
                print(f"[CLEANUP] Failed to remove archive: {e}")
        
        if job.temp_dir and os.path.exists(job.temp_dir):
            try:
                shutil.rmtree(job.temp_dir, ignore_errors=True)
            except Exception as e:
                print(f"[CLEANUP] Failed to remove temp dir: {e}")
        
        gc.collect()
    
    def enqueue(self, batch_id, archive_path, temp_dir, metadata=None):
        """Adiciona um job √† fila"""
        job = UploadJob(batch_id, archive_path, temp_dir, metadata or {})
        self.active_jobs[batch_id] = job
        self.job_queue.put(job)
        
        with self.stats_lock:
            self.stats['total_queued'] += 1
        
        print(f"[ORCHESTRATOR] Enqueued batch {batch_id}. Queue size: {self.job_queue.qsize()}")
        
        return {
            'batch_id': batch_id,
            'queue_position': self.job_queue.qsize(),
            'status': 'queued'
        }
    
    def get_status(self):
        """Retorna status do orquestrador"""
        with self.stats_lock:
            return {
                'queue_size': self.job_queue.qsize(),
                'active_workers': self.stats['active_workers'],
                'total_queued': self.stats['total_queued'],
                'total_processed': self.stats['total_processed'],
                'total_errors': self.stats['total_errors'],
                'active_jobs': list(self.active_jobs.keys())
            }
    
    def shutdown(self):
        """Encerra o orquestrador graciosamente"""
        self.shutdown_event.set()
        for worker in self.workers:
            worker.join(timeout=5.0)


upload_orchestrator = None

def get_upload_orchestrator(app=None, db=None, object_storage=None):
    """Factory function para obter inst√¢ncia do orquestrador"""
    global upload_orchestrator
    if upload_orchestrator is None:
        upload_orchestrator = UploadOrchestrator(app, db, object_storage)
    elif app and db and object_storage:
        upload_orchestrator.configure(app, db, object_storage)
    return upload_orchestrator

================================================================================
FIM DO BUNDLE
================================================================================
