{% extends "base.html" %}

{% block title %}Upload em Lote - OAZ Smart Image Bank{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Upload em Lote</h1>
    <div class="header-actions">
        <a href="{{ url_for('batch_queue') }}" class="btn btn-success">
            <i class="fas fa-layer-group"></i> Fila de Múltiplos Batches
        </a>
        <a href="{{ url_for('batch_new') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Novo Lote
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Lotes de Upload</h3>
    </div>
    <div class="card-body">
        {% if batches %}
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Status</th>
                    <th>Progresso</th>
                    <th>Total</th>
                    <th>Sucesso</th>
                    <th>Falhas</th>
                    <th>Data</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for batch in batches %}
                <tr>
                    <td>{{ batch.id }}</td>
                    <td>{{ batch.nome or 'Sem nome' }}</td>
                    <td>
                        <span class="status-badge status-{{ batch.status|lower|replace(' ', '-') }}">
                            {{ batch.status }}
                        </span>
                    </td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: {{ batch.progresso }}%"></div>
                            <span class="progress-text">{{ batch.progresso }}%</span>
                        </div>
                    </td>
                    <td>{{ batch.total_arquivos }}</td>
                    <td class="text-success">{{ batch.sucesso }}</td>
                    <td class="text-danger">{{ batch.falhas }}</td>
                    <td>{{ batch.created_at.strftime('%d/%m/%Y %H:%M') if batch.created_at else '-' }}</td>
                    <td class="actions-cell">
                        <a href="{{ url_for('batch_detail', batch_id=batch.id) }}" class="btn btn-sm btn-secondary">
                            <i class="fas fa-eye"></i> Ver
                        </a>
                        <button class="btn btn-sm btn-danger" onclick="deleteBatch({{ batch.id }}, '{{ batch.nome or 'Lote ' ~ batch.id }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>Nenhum lote de upload</h3>
            <p>Crie seu primeiro lote para fazer upload de múltiplas imagens de uma vez.</p>
            <a href="{{ url_for('batch_new') }}" class="btn btn-primary">Criar Lote</a>
        </div>
        {% endif %}
    </div>
</div>

<style>
.header-actions {
    display: flex;
    gap: 10px;
}
.btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}
.btn-success:hover {
    background: linear-gradient(135deg, #218838, #1eb389);
}
.progress-bar-container {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    height: 20px;
    position: relative;
    overflow: hidden;
    min-width: 100px;
}
.progress-bar {
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}
.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    font-weight: 600;
}
.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}
.status-pendente {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}
.status-processando {
    background: rgba(0, 123, 255, 0.2);
    color: #007bff;
}
.status-concluído {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}
.status-erro {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}
.text-success { color: #28a745; }
.text-danger { color: #dc3545; }
.actions-cell {
    display: flex;
    gap: 8px;
}
.btn-danger {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
}
.btn-danger:hover {
    background: rgba(220, 53, 69, 0.4);
}
.status-recebendo {
    background: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
}
</style>

<script>
async function deleteBatch(batchId, batchName) {
    if (!confirm(`Tem certeza que deseja excluir "${batchName}"?\n\nTodos os itens do lote serão removidos permanentemente.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/batch/${batchId}/delete`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Erro ao excluir lote: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro ao excluir lote: ' + error.message);
    }
}
</script>
{% endblock %}
