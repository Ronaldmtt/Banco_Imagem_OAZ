{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1>Busca & Catálogo de Imagens</h1>
        <p style="color: var(--text-secondary);">Mostrando {{ sku_groups|length }} de {{ total_skus }} SKUs únicos (página {{ page }} de {{ total_pages }})</p>
    </div>
    <div style="display: flex; gap: 1rem;">
        {% if storage_backend == 'sharepoint' %}
        <span class="btn btn-primary" style="opacity: 0.6; cursor: not-allowed;">
            <i class="fas fa-cloud-upload-alt"></i> Upload desativado
        </span>
        {% else %}
        <a href="{{ url_for('upload') }}" class="btn btn-primary"
            data-tutorial-title="Enviar Nova Imagem"
            data-tutorial-desc="Abre a tela de upload para enviar uma nova imagem individual ao banco.">
            <i class="fas fa-cloud-upload-alt"></i> Enviar Nova
        </a>
        {% endif %}
        <button class="btn"
            style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);"
            data-tutorial-title="Exportar para CSV"
            data-tutorial-desc="Exporta os dados filtrados do catálogo em formato CSV para uso em planilhas e outros sistemas.">
            <i class="fas fa-file-export"></i> Exportar para CSV
        </button>
    </div>
</div>

<div style="display: flex; gap: 2rem;">
    <!-- Filters Sidebar -->
    <div style="width: 250px; flex-shrink: 0;">
        <form action="{{ url_for('catalog') }}" method="GET" style="margin-bottom: 1.5rem;"
            data-tutorial-title="Filtros de Busca"
            data-tutorial-desc="Use os filtros para encontrar imagens específicas. Combine busca por texto com coleção, marca e status.">
            <h3 style="font-size: 1rem; margin-bottom: 1rem;">Filtros</h3>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Buscar</label>
                <input type="text" name="q" class="form-control" placeholder="SKU, descrição, tags..." value="{{ search_query or '' }}"
                    data-tutorial-title="Campo de Busca"
                    data-tutorial-desc="Digite SKU, descrição, tags ou qualquer texto para buscar nas imagens. A busca é feita em todos os campos.">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Coleção</label>
                <select name="collection_id" class="form-control"
                    data-tutorial-title="Filtro por Coleção"
                    data-tutorial-desc="Selecione uma coleção específica para ver apenas as imagens dessa temporada ou linha de produtos.">
                    <option value="all">Todas as Coleções</option>
                    {% for collection in collections %}
                    <option value="{{ collection.id }}" {% if request.args.get('collection_id')==collection.id|string %}selected{% endif %}>
                        {{ collection.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Marca</label>
                <select name="brand_id" class="form-control"
                    data-tutorial-title="Filtro por Marca"
                    data-tutorial-desc="Selecione uma marca específica para ver apenas os produtos desse fabricante ou fornecedor.">
                    <option value="all">Todas as Marcas</option>
                    {% for brand in brands %}
                    <option value="{{ brand.id }}" {% if request.args.get('brand_id')==brand.id|string %}selected{% endif %}>
                        {{ brand.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Status</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <input type="checkbox" name="status" value="Aprovado" {% if 'Aprovado' in request.args.getlist('status') %}checked{% endif %}> Aprovado
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <input type="checkbox" name="status" value="Pendente" {% if 'Pendente' in request.args.getlist('status') %}checked{% endif %}> Pendente
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <input type="checkbox" name="status" value="Pendente Análise IA" {% if 'Pendente Análise IA' in request.args.getlist('status') %}checked{% endif %}> Pendente Análise IA
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                        <input type="checkbox" name="status" value="Rejeitado" {% if 'Rejeitado' in request.args.getlist('status') %}checked{% endif %}> Rejeitado
                    </label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">Aplicar Filtros</button>
            <a href="{{ url_for('catalog') }}" class="btn" style="width: 100%; justify-content: center; margin-top: 0.5rem; border: 1px solid var(--border-color); color: var(--text-primary);">Limpar</a>
        </form>
    </div>

    <!-- Image Grid -->
    <div style="flex: 1;">
        <div class="image-grid">
            {% for group in sku_groups %}
            <div class="image-card sku-card" data-sku="{{ group.sku_base }}" data-image-ids="{{ group.images|map(attribute='id')|list|join(',') }}">
                <div class="carousel-container">
                    <div class="carousel-track" data-index="0">
                        {% for img in group.images %}
                        <div class="carousel-slide {% if loop.first %}active{% endif %}">
                            <a href="{{ url_for('image_detail', id=img.id) }}">
                                <img data-src="{{ url_for('serve_thumbnail', image_id=img.id) }}" 
                                     {% if loop.first %}src="{{ url_for('serve_thumbnail', image_id=img.id) }}"{% endif %}
                                     class="image-preview carousel-image"
                                     alt="{{ img.original_name }}"
                                     loading="lazy">
                            </a>
                            <div class="carousel-image-status status-badge status-{{ img.status.lower().replace(' ', '-') }}">
                                {{ img.sequencia or loop.index }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if group.images|length > 1 %}
                    <button class="carousel-nav carousel-prev" onclick="carouselNav(this, -1); event.stopPropagation();" aria-label="Anterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-nav carousel-next" onclick="carouselNav(this, 1); event.stopPropagation();" aria-label="Próximo">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <div class="carousel-dots">
                        {% for img in group.images %}
                        <span class="carousel-dot {% if loop.first %}active{% endif %}" data-index="{{ loop.index0 }}"></span>
                        {% endfor %}
                    </div>
                    
                    <div class="carousel-counter">
                        <span class="current-index">1</span> / {{ group.images|length }}
                    </div>
                    {% endif %}
                    
                    <div class="card-select-checkbox" style="position: absolute; top: 8px; left: 8px; z-index: 15;">
                        <input type="checkbox" class="sku-checkbox" data-sku="{{ group.sku_base }}" 
                               style="width: 20px; height: 20px; cursor: pointer; accent-color: #a371f7;"
                               onclick="event.stopPropagation(); toggleSelection(this);">
                    </div>
                    
                    <button class="card-ai-btn" onclick="event.stopPropagation(); selectAndAnalyze(this);" title="Gerar Descrição com IA">
                        <i class="fas fa-magic"></i>
                    </button>
                </div>
                
                <div class="image-info">
                    <div class="image-title">{{ group.sku_base }}</div>
                    <div class="image-meta">{{ group.brand }}</div>
                    <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px;">
                        {% if group.has_approved %}
                        <span class="status-indicator status-approved" title="Aprovado"></span>
                        {% endif %}
                        {% if group.has_pending %}
                        <span class="status-indicator status-pending" title="Pendente"></span>
                        {% endif %}
                        {% if group.has_rejected %}
                        <span class="status-indicator status-rejected" title="Rejeitado"></span>
                        {% endif %}
                        {% if group.needs_ai %}
                        <span class="status-indicator status-needs-ai" title="Sem descrição IA"></span>
                        {% endif %}
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">{{ group.images|length }} foto{% if group.images|length > 1 %}s{% endif %}</span>
                    </div>
                    <div style="margin-top: 0.5rem; display: flex; gap: 4px; flex-wrap: wrap;">
                        {% for tag in group.tag_list[:3] %}
                        <span style="font-size: 0.7rem; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">{{ tag }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div style="grid-column: 1 / -1; text-align: center; padding: 4rem; color: var(--text-secondary);">
                <i class="far fa-images" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>Nenhuma imagem encontrada. Envie algumas imagens para começar.</p>
            </div>
            {% endfor %}
        </div>
        
        {% if total_pages > 1 %}
        <div class="pagination" style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem; margin-bottom: 80px;">
            {% if page > 1 %}
            <a href="{{ url_for('catalog', page=page-1, q=search_query, collection_id=request.args.get('collection_id'), brand_id=request.args.get('brand_id'), status=request.args.getlist('status')) }}" class="btn" style="background: var(--bg-secondary); border: 1px solid var(--border-color);">
                <i class="fas fa-chevron-left"></i> Anterior
            </a>
            {% endif %}
            
            <span style="display: flex; align-items: center; padding: 0 1rem; color: var(--text-secondary);">
                Página {{ page }} de {{ total_pages }}
            </span>
            
            {% if page < total_pages %}
            <a href="{{ url_for('catalog', page=page+1, q=search_query, collection_id=request.args.get('collection_id'), brand_id=request.args.get('brand_id'), status=request.args.getlist('status')) }}" class="btn" style="background: var(--bg-secondary); border: 1px solid var(--border-color);">
                Próxima <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<div id="selectionBar" class="selection-bar" style="display: none;">
    <div class="selection-bar-content">
        <span class="selection-count">
            <i class="fas fa-check-circle"></i>
            <span id="selectedCount">0</span> SKU(s) selecionado(s)
        </span>
        <div class="selection-actions">
            <button class="btn selection-btn-ai" onclick="openBatchAnalyzeModal()">
                <i class="fas fa-magic"></i> Gerar Descrição IA
            </button>
            <button class="btn selection-btn-clear" onclick="clearSelection()">
                <i class="fas fa-times"></i> Limpar
            </button>
        </div>
    </div>
</div>

<div id="batchAnalyzeModal" class="batch-modal" style="display: none;">
    <div class="batch-modal-content">
        <div class="batch-modal-header">
            <h3>
                <i class="fas fa-magic" style="color: #a371f7;"></i> Análise de IA em Lote
            </h3>
            <button onclick="closeBatchAnalyzeModal()" class="batch-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="modalConfigSection">
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                <span id="modalSkuCount">0</span> SKU(s) selecionado(s) serão analisados.
            </p>
            
            <div class="batch-field-options">
                <label class="batch-field-option batch-field-all">
                    <input type="checkbox" id="batchAllFields" onchange="toggleBatchAllFields(this.checked)">
                    <span><i class="fas fa-check-double"></i> Todos os campos</span>
                </label>
                
                <div class="batch-field-separator"></div>
                
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="descricao" class="batch-field-checkbox" checked>
                    <span>Descrição/Observações</span>
                </label>
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="tags" class="batch-field-checkbox">
                    <span>Tags</span>
                </label>
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="cor" class="batch-field-checkbox">
                    <span>Cor</span>
                </label>
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="tipo" class="batch-field-checkbox">
                    <span>Tipo de Peça</span>
                </label>
                <label class="batch-field-option">
                    <input type="checkbox" name="batchFields" value="material" class="batch-field-checkbox">
                    <span>Material</span>
                </label>
            </div>
            
            <div class="batch-modal-actions">
                <button type="button" onclick="closeBatchAnalyzeModal()" class="btn" style="flex: 1; background: var(--bg-tertiary); color: var(--text-primary);">
                    Cancelar
                </button>
                <button type="button" id="startBatchAnalysis" onclick="startBatchAnalysis()" class="btn" style="flex: 1; background: #a371f7; color: white;">
                    <i class="fas fa-magic"></i> Iniciar Análise
                </button>
            </div>
        </div>
        
        <div id="modalProgressSection" style="display: none;">
            <div class="batch-progress-container">
                <div class="batch-progress-header">
                    <span id="progressText">Processando...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="batch-progress-bar">
                    <div id="progressFill" class="batch-progress-fill" style="width: 0%;"></div>
                </div>
                <div class="batch-progress-details">
                    <span id="progressDetails">0 de 0 imagens</span>
                </div>
            </div>
            
            <div id="progressLog" class="batch-progress-log"></div>
            
            <div id="progressComplete" class="batch-progress-complete" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span id="completeMessage">Análise concluída!</span>
            </div>
            
            <div class="batch-modal-actions" id="progressActions" style="display: none;">
                <button type="button" onclick="closeBatchAnalyzeModal(); location.reload();" class="btn" style="width: 100%; background: #a371f7; color: white;">
                    <i class="fas fa-check"></i> Concluído
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.carousel-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px 8px 0 0;
}

.carousel-track {
    display: flex;
    transition: transform 0.3s ease;
}

.carousel-slide {
    min-width: 100%;
    position: relative;
}

.carousel-slide:not(.active) {
    display: none;
}

.carousel-image {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
}

.carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.6);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s, background 0.2s;
    z-index: 10;
}

.carousel-container:hover .carousel-nav {
    opacity: 1;
}

.carousel-nav:hover {
    background: rgba(0, 0, 0, 0.8);
}

.carousel-prev {
    left: 8px;
}

.carousel-next {
    right: 8px;
}

.carousel-dots {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 4px;
    z-index: 10;
}

.carousel-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
}

.carousel-dot.active {
    background: white;
    transform: scale(1.2);
}

.carousel-counter {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    z-index: 10;
}

.carousel-image-status {
    position: absolute;
    bottom: 24px;
    right: 8px;
    font-size: 0.7rem;
    padding: 2px 6px;
}

.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-indicator.status-approved {
    background: #3fb950;
}

.status-indicator.status-pending {
    background: #d29922;
}

.status-indicator.status-rejected {
    background: #f85149;
}

.status-indicator.status-needs-ai {
    background: #a371f7;
}

.status-pendente-análise-ia {
    background: #9333ea !important;
    color: white;
}

.card-ai-btn {
    position: absolute;
    bottom: 32px;
    left: 8px;
    background: rgba(163, 113, 247, 0.9);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s, background 0.2s, transform 0.2s;
    z-index: 15;
    font-size: 0.8rem;
}

.carousel-container:hover .card-ai-btn {
    opacity: 1;
}

.card-ai-btn:hover {
    background: #a371f7;
    transform: scale(1.1);
}

.sku-card.selected {
    outline: 3px solid #a371f7;
    outline-offset: -3px;
}

.sku-card.selected .carousel-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(163, 113, 247, 0.1);
    pointer-events: none;
    z-index: 5;
}

.selection-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, rgba(30, 30, 40, 0.98) 0%, rgba(40, 30, 50, 0.98) 100%);
    border-top: 1px solid rgba(163, 113, 247, 0.3);
    padding: 16px 24px;
    z-index: 1000;
    animation: slideUp 0.3s ease;
    backdrop-filter: blur(10px);
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.selection-bar-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.selection-count {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #a371f7;
    font-weight: 600;
    font-size: 1rem;
}

.selection-actions {
    display: flex;
    gap: 12px;
}

.selection-btn-ai {
    background: linear-gradient(135deg, #a371f7 0%, #8b5cf6 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    font-weight: 500;
}

.selection-btn-ai:hover {
    background: linear-gradient(135deg, #b794f6 0%, #a371f7 100%);
}

.selection-btn-clear {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.batch-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.batch-modal-content {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 28px;
    max-width: 450px;
    width: 90%;
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.batch-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.batch-modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.batch-modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 4px;
}

.batch-modal-close:hover {
    color: var(--text-primary);
}

.batch-field-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 24px;
}

.batch-field-option {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    padding: 10px 14px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    transition: background 0.2s;
}

.batch-field-option:hover {
    background: rgba(163, 113, 247, 0.1);
}

.batch-field-option input {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #a371f7;
}

.batch-field-all {
    background: rgba(163, 113, 247, 0.15);
    border: 1px solid rgba(163, 113, 247, 0.3);
}

.batch-field-all span {
    font-weight: 500;
}

.batch-field-separator {
    border-top: 1px solid var(--border-color);
    margin: 8px 0;
}

.batch-modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}

.batch-progress-container {
    margin-bottom: 20px;
}

.batch-progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.batch-progress-bar {
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
}

.batch-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #a371f7 0%, #8b5cf6 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.batch-progress-details {
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-align: center;
}

.batch-progress-log {
    max-height: 150px;
    overflow-y: auto;
    background: var(--bg-tertiary);
    border-radius: 8px;
    padding: 12px;
    font-size: 0.8rem;
    font-family: monospace;
    margin-bottom: 16px;
}

.batch-progress-log .log-success {
    color: #3fb950;
}

.batch-progress-log .log-error {
    color: #f85149;
}

.batch-progress-log .log-info {
    color: var(--text-secondary);
}

.batch-progress-complete {
    text-align: center;
    padding: 20px;
    color: #3fb950;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.batch-progress-complete i {
    font-size: 1.5rem;
}
</style>

<script>
let selectedSkus = new Set();

function toggleSelection(checkbox) {
    const card = checkbox.closest('.sku-card');
    const sku = card.dataset.sku;
    
    if (checkbox.checked) {
        selectedSkus.add(sku);
        card.classList.add('selected');
    } else {
        selectedSkus.delete(sku);
        card.classList.remove('selected');
    }
    
    updateSelectionBar();
}

function selectAndAnalyze(btn) {
    const card = btn.closest('.sku-card');
    const sku = card.dataset.sku;
    const checkbox = card.querySelector('.sku-checkbox');
    
    if (!checkbox.checked) {
        checkbox.checked = true;
        selectedSkus.add(sku);
        card.classList.add('selected');
        updateSelectionBar();
    }
    
    openBatchAnalyzeModal();
}

function updateSelectionBar() {
    const bar = document.getElementById('selectionBar');
    const count = document.getElementById('selectedCount');
    
    if (selectedSkus.size > 0) {
        bar.style.display = 'block';
        count.textContent = selectedSkus.size;
    } else {
        bar.style.display = 'none';
    }
}

function clearSelection() {
    selectedSkus.clear();
    document.querySelectorAll('.sku-checkbox').forEach(cb => {
        cb.checked = false;
    });
    document.querySelectorAll('.sku-card').forEach(card => {
        card.classList.remove('selected');
    });
    updateSelectionBar();
}

function openBatchAnalyzeModal() {
    if (selectedSkus.size === 0) {
        alert('Selecione pelo menos um SKU para analisar.');
        return;
    }
    
    document.getElementById('modalSkuCount').textContent = selectedSkus.size;
    document.getElementById('modalConfigSection').style.display = 'block';
    document.getElementById('modalProgressSection').style.display = 'none';
    document.getElementById('batchAnalyzeModal').style.display = 'flex';
}

function closeBatchAnalyzeModal() {
    document.getElementById('batchAnalyzeModal').style.display = 'none';
}

function toggleBatchAllFields(checked) {
    document.querySelectorAll('.batch-field-checkbox').forEach(cb => {
        cb.checked = checked;
    });
}

function getSelectedImageIds() {
    const imageIds = [];
    selectedSkus.forEach(sku => {
        const card = document.querySelector(`.sku-card[data-sku="${sku}"]`);
        if (card && card.dataset.imageIds) {
            const ids = card.dataset.imageIds.split(',').filter(id => id);
            imageIds.push(...ids);
        }
    });
    return imageIds;
}

function getSelectedFields() {
    const allFields = document.getElementById('batchAllFields').checked;
    if (allFields) {
        return ['descricao', 'tags', 'cor', 'tipo', 'material'];
    }
    
    const fields = [];
    document.querySelectorAll('.batch-field-checkbox:checked').forEach(cb => {
        fields.push(cb.value);
    });
    return fields;
}

async function startBatchAnalysis() {
    const imageIds = getSelectedImageIds();
    const fields = getSelectedFields();
    
    if (imageIds.length === 0) {
        alert('Nenhuma imagem encontrada nos SKUs selecionados.');
        return;
    }
    
    if (fields.length === 0) {
        alert('Selecione pelo menos um campo para preencher.');
        return;
    }
    
    document.getElementById('modalConfigSection').style.display = 'none';
    document.getElementById('modalProgressSection').style.display = 'block';
    document.getElementById('progressActions').style.display = 'none';
    document.getElementById('progressComplete').style.display = 'none';
    
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const progressPercent = document.getElementById('progressPercent');
    const progressDetails = document.getElementById('progressDetails');
    const progressLog = document.getElementById('progressLog');
    
    progressLog.innerHTML = '';
    progressFill.style.width = '0%';
    progressText.textContent = 'Iniciando análise...';
    progressDetails.textContent = `0 de ${imageIds.length} imagens`;
    
    let successCount = 0;
    let errorCount = 0;
    
    for (let i = 0; i < imageIds.length; i++) {
        const imageId = imageIds[i];
        const percent = Math.round(((i + 1) / imageIds.length) * 100);
        
        progressText.textContent = `Analisando imagem ${i + 1} de ${imageIds.length}...`;
        progressPercent.textContent = `${percent}%`;
        progressDetails.textContent = `${i + 1} de ${imageIds.length} imagens`;
        progressFill.style.width = `${percent}%`;
        
        try {
            const response = await fetch('/api/analyze-single', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_id: parseInt(imageId),
                    fields: fields
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                successCount++;
                addLogEntry(progressLog, `✓ Imagem ${imageId}: ${result.message || 'Analisada com sucesso'}`, 'success');
            } else {
                errorCount++;
                addLogEntry(progressLog, `✗ Imagem ${imageId}: ${result.error || 'Erro desconhecido'}`, 'error');
            }
        } catch (err) {
            errorCount++;
            addLogEntry(progressLog, `✗ Imagem ${imageId}: Erro de conexão`, 'error');
        }
        
        progressLog.scrollTop = progressLog.scrollHeight;
    }
    
    progressText.textContent = 'Análise concluída!';
    progressPercent.textContent = '100%';
    progressFill.style.width = '100%';
    
    document.getElementById('progressComplete').style.display = 'flex';
    document.getElementById('completeMessage').textContent = 
        `${successCount} sucesso, ${errorCount} erro(s)`;
    document.getElementById('progressActions').style.display = 'flex';
}

function addLogEntry(container, message, type) {
    const entry = document.createElement('div');
    entry.className = `log-${type}`;
    entry.textContent = message;
    container.appendChild(entry);
}

function carouselNav(btn, direction) {
    const container = btn.closest('.carousel-container');
    const track = container.querySelector('.carousel-track');
    const slides = container.querySelectorAll('.carousel-slide');
    const dots = container.querySelectorAll('.carousel-dot');
    const counter = container.querySelector('.current-index');
    
    let currentIndex = parseInt(track.dataset.index) || 0;
    let newIndex = currentIndex + direction;
    
    if (newIndex < 0) newIndex = slides.length - 1;
    if (newIndex >= slides.length) newIndex = 0;
    
    slides[currentIndex].classList.remove('active');
    slides[newIndex].classList.add('active');
    
    const img = slides[newIndex].querySelector('img');
    if (img.dataset.src && !img.src) {
        img.src = img.dataset.src;
    }
    
    if (dots.length > 0) {
        dots[currentIndex].classList.remove('active');
        dots[newIndex].classList.add('active');
    }
    
    if (counter) {
        counter.textContent = newIndex + 1;
    }
    
    track.dataset.index = newIndex;
}

document.addEventListener('DOMContentLoaded', function() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                }
                observer.unobserve(img);
            }
        });
    }, { rootMargin: '100px' });
    
    document.querySelectorAll('.carousel-slide.active img[data-src]').forEach(img => {
        observer.observe(img);
    });
    
    document.querySelectorAll('.carousel-dot').forEach(dot => {
        dot.addEventListener('click', function() {
            const container = this.closest('.carousel-container');
            const track = container.querySelector('.carousel-track');
            const slides = container.querySelectorAll('.carousel-slide');
            const dots = container.querySelectorAll('.carousel-dot');
            const counter = container.querySelector('.current-index');
            
            const currentIndex = parseInt(track.dataset.index) || 0;
            const newIndex = parseInt(this.dataset.index);
            
            if (currentIndex === newIndex) return;
            
            slides[currentIndex].classList.remove('active');
            slides[newIndex].classList.add('active');
            
            const img = slides[newIndex].querySelector('img');
            if (img.dataset.src) {
                img.src = img.dataset.src;
            }
            
            dots[currentIndex].classList.remove('active');
            dots[newIndex].classList.add('active');
            
            if (counter) {
                counter.textContent = newIndex + 1;
            }
            
            track.dataset.index = newIndex;
        });
    });
});
</script>
{% endblock %}
