{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>Relatórios</h1>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">Métricas e estatísticas do banco de imagens</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('export_report', report_type='all') }}" class="btn btn-primary">
                <i class="fas fa-download"></i> Exportar Tudo (CSV)
            </a>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Total de Imagens</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ total_images }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(31, 111, 235, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-images" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Com SKU</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ images_with_sku }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(63, 185, 80, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-barcode" style="color: #3fb950; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Sem SKU</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ images_without_sku }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(248, 81, 73, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-exclamation-triangle" style="color: #f85149; font-size: 1.25rem;"></i>
            </div>
        </div>
        {% if images_without_sku > 0 %}
        <a href="{{ url_for('export_report', report_type='without_sku') }}" style="color: var(--accent-blue); font-size: 0.85rem; margin-top: 0.5rem; display: inline-block;">
            <i class="fas fa-download"></i> Exportar lista
        </a>
        {% endif %}
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Com Análise IA</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ images_with_ai }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(130, 80, 223, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-robot" style="color: #8250df; font-size: 1.25rem;"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">Sem Análise IA</p>
                <h2 style="font-size: 2rem; font-weight: 600;">{{ images_without_ai }}</h2>
            </div>
            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(201, 209, 217, 0.1); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-robot" style="color: #8b949e; font-size: 1.25rem;"></i>
            </div>
        </div>
        {% if images_without_ai > 0 %}
        <a href="{{ url_for('export_report', report_type='without_ai') }}" style="color: var(--accent-blue); font-size: 0.85rem; margin-top: 0.5rem; display: inline-block;">
            <i class="fas fa-download"></i> Exportar lista
        </a>
        {% endif %}
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1rem;">Por Status</h3>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="status-badge status-pendente">Pendente</span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-weight: 600;">{{ pending_images }}</span>
                    <a href="{{ url_for('export_report', report_type='pending') }}" style="color: var(--accent-blue); font-size: 0.8rem;">
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="status-badge status-aprovado">Aprovado</span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-weight: 600;">{{ approved_images }}</span>
                    <a href="{{ url_for('export_report', report_type='approved') }}" style="color: var(--accent-blue); font-size: 0.8rem;">
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="status-badge status-rejeitado">Rejeitado</span>
                </div>
                <span style="font-weight: 600;">{{ rejected_images }}</span>
            </div>
        </div>
        {% if total_images > 0 %}
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; display: flex;">
                {% set approved_pct = (approved_images / total_images * 100)|round(1) %}
                {% set pending_pct = (pending_images / total_images * 100)|round(1) %}
                {% set rejected_pct = (rejected_images / total_images * 100)|round(1) %}
                <div style="width: {{ approved_pct }}%; background: #3fb950;"></div>
                <div style="width: {{ pending_pct }}%; background: #d29922;"></div>
                <div style="width: {{ rejected_pct }}%; background: #f85149;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                <span><span style="color: #3fb950;">●</span> {{ approved_pct }}% Aprovado</span>
                <span><span style="color: #d29922;">●</span> {{ pending_pct }}% Pendente</span>
                <span><span style="color: #f85149;">●</span> {{ rejected_pct }}% Rejeitado</span>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1rem;">Por Marca</h3>
        </div>
        {% if brands_stats %}
        <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 200px; overflow-y: auto;">
            {% for brand in brands_stats %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px;">
                <span style="font-weight: 500;">{{ brand.name }}</span>
                <div style="display: flex; gap: 1rem; font-size: 0.85rem;">
                    <span style="color: var(--text-secondary);">{{ brand.total }} total</span>
                    <span style="color: #3fb950;">{{ brand.approved }} <i class="fas fa-check"></i></span>
                    <span style="color: #d29922;">{{ brand.pending }} <i class="fas fa-clock"></i></span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Nenhuma marca cadastrada.</p>
        {% endif %}
    </div>

    <div class="stat-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1rem;">Por Coleção</h3>
        </div>
        {% if collections_stats %}
        <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 200px; overflow-y: auto;">
            {% for collection in collections_stats %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px;">
                <span style="font-weight: 500;">{{ collection.name }}</span>
                <span style="color: var(--text-secondary);">{{ collection.total }} imagens</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Nenhuma coleção cadastrada.</p>
        {% endif %}
    </div>
</div>

<div class="stat-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="font-size: 1rem;">Últimos Uploads</h3>
        <a href="{{ url_for('catalog') }}" style="color: var(--accent-blue); font-size: 0.9rem;">Ver todos <i class="fas fa-arrow-right"></i></a>
    </div>
    
    {% if recent_uploads %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">Imagem</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">SKU</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">Marca</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">Status</th>
                    <th style="text-align: left; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">Data</th>
                    <th style="text-align: right; padding: 0.75rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for img in recent_uploads %}
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <img src="{{ url_for('static', filename='uploads/' + img.filename) }}" 
                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">
                            <span style="font-size: 0.9rem;">{{ img.original_name[:30] }}{% if img.original_name|length > 30 %}...{% endif %}</span>
                        </div>
                    </td>
                    <td style="padding: 0.75rem; font-size: 0.9rem;">{{ img.sku or '-' }}</td>
                    <td style="padding: 0.75rem; font-size: 0.9rem;">{{ img.brand_ref.name if img.brand_ref else '-' }}</td>
                    <td style="padding: 0.75rem;">
                        <span class="status-badge status-{{ img.status.lower() }}">{{ img.status }}</span>
                    </td>
                    <td style="padding: 0.75rem; font-size: 0.9rem; color: var(--text-secondary);">{{ img.upload_date.strftime('%d/%m/%Y') }}</td>
                    <td style="padding: 0.75rem; text-align: right;">
                        <a href="{{ url_for('image_detail', id=img.id) }}" class="btn" style="padding: 0.4rem 0.75rem; font-size: 0.8rem; background: var(--bg-tertiary);">
                            <i class="fas fa-eye"></i> Ver
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Nenhuma imagem enviada ainda.</p>
    {% endif %}
</div>
{% endblock %}
